(self["webpackChunk"]=self["webpackChunk"]||[]).push([[976],{86976:function(e,t,r){"use strict";var n=r(70655),i=r(24932),a=r(59854),o=(r(17445),r(13071)),s=r(77728),u=r(26729),l=r(9187),c=r.n(l);const f=1e20;class d{constructor({fontSize:e=24,buffer:t=3,radius:r=8,cutoff:n=.25,fontFamily:i="sans-serif",fontWeight:a="normal",fontStyle:o="normal"}={}){this.buffer=t,this.cutoff=n,this.radius=r;const s=this.size=e+4*t,u=this._createCanvas(s),l=this.ctx=u.getContext("2d",{willReadFrequently:!0});l.font=`${o} ${a} ${e}px ${i}`,l.textBaseline="alphabetic",l.textAlign="left",l.fillStyle="black",this.gridOuter=new Float64Array(s*s),this.gridInner=new Float64Array(s*s),this.f=new Float64Array(s),this.z=new Float64Array(s+1),this.v=new Uint16Array(s)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:n,actualBoundingBoxLeft:i,actualBoundingBoxRight:a}=this.ctx.measureText(e),o=Math.ceil(r),s=0,u=Math.min(this.size-this.buffer,Math.ceil(a-i)),l=Math.min(this.size-this.buffer,o+Math.ceil(n)),c=u+2*this.buffer,d=l+2*this.buffer,_=Math.max(c*d,0),p=new Uint8ClampedArray(_),v={data:p,width:c,height:d,glyphWidth:u,glyphHeight:l,glyphTop:o,glyphLeft:s,glyphAdvance:t};if(0===u||0===l)return v;const{ctx:E,buffer:R,gridInner:g,gridOuter:T}=this;E.clearRect(R,R,u,l),E.fillText(e,R,R+o);const m=E.getImageData(R,R,u,l);T.fill(f,0,_),g.fill(0,0,_);for(let h=0;h<l;h++)for(let e=0;e<u;e++){const t=m.data[4*(h*u+e)+3]/255;if(0===t)continue;const r=(h+R)*c+e+R;if(1===t)T[r]=0,g[r]=f;else{const e=.5-t;T[r]=e>0?e*e:0,g[r]=e<0?e*e:0}}h(T,0,0,c,d,c,this.f,this.v,this.z),h(g,R,R,u,l,c,this.f,this.v,this.z);for(let f=0;f<_;f++){const e=Math.sqrt(T[f])-Math.sqrt(g[f]);p[f]=Math.round(255-255*(e/this.radius+this.cutoff))}return v}}function h(e,t,r,n,i,a,o,s,u){for(let l=t;l<t+n;l++)_(e,r*a+l,a,i,o,s,u);for(let l=r;l<r+i;l++)_(e,l*a+t,1,n,o,s,u)}function _(e,t,r,n,i,a,o){a[0]=0,o[0]=-f,o[1]=f,i[0]=e[t];for(let s=1,u=0,l=0;s<n;s++){i[s]=e[t+s*r];const n=s*s;do{const e=a[u];l=(i[s]-i[e]+n-e*e)/(s-e)/2}while(l<=o[u]&&--u>-1);u++,a[u]=s,o[u]=l,o[u+1]=f}for(let s=0,u=0;s<n;s++){while(o[u+1]<s)u++;const n=a[u],l=s-n;e[t+s*r]=i[n]+l*l}}function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach((function(t){A(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function E(e,t,r,n,i,a,o){try{var s=e[a](o),u=s.value}catch(l){return void r(l)}s.done?t(u):Promise.resolve(u).then(n,i)}function R(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var a=e.apply(t,r);function o(e){E(a,n,i,o,s,"next",e)}function s(e){E(a,n,i,o,s,"throw",e)}o(void 0)}))}}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function T(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function m(e,t,r){return t&&T(e.prototype,t),r&&T(e,r),e}function A(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function S(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&C(e,t)}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}function C(e,t){return C=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},C(e,t)}function B(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function O(e,t){if(null==e)return{};var r,n,i={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}function x(e,t){if(null==e)return{};var r,n,i=O(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function D(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function N(e,t){if(t&&("object"===typeof t||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return D(e)}function F(e){var t=B();return function(){var r,n=y(e);if(t){var i=y(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return N(this,r)}}function P(e,t){while(!Object.prototype.hasOwnProperty.call(e,t))if(e=y(e),null===e)break;return e}function I(){return I="undefined"!==typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=P(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},I.apply(this,arguments)}function M(e,t){return k(e)||w(e,t)||W(e,t)||H()}function b(e){return k(e)||G(e)||W(e)||H()}function L(e){return U(e)||G(e)||W(e)||V()}function U(e){if(Array.isArray(e))return X(e)}function k(e){if(Array.isArray(e))return e}function G(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function w(e,t){var r=null==e?null:"undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,a=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(n=r.next()).done);o=!0)if(a.push(n.value),t&&a.length===t)break}catch(u){s=!0,i=u}finally{try{o||null==r["return"]||r["return"]()}finally{if(s)throw i}}return a}}function W(e,t){if(e){if("string"===typeof e)return X(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?X(e,t):void 0}}function X(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function V(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function H(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Y(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=W(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}var K=function e(){g(this,e),this.pickingId=void 0,this.encodedPickingColor=void 0,this.meshes=[]};K.tag="c-renderable-3d";var z,q,Z,j,Q,J,$,ee,te,re,ne,ie,ae,oe,se,ue,le,ce,fe,de,he,_e,pe,ve,Ee,Re,ge,Te,me=function(){function e(){g(this,e),this.counter=0,this.id2DisplayObjectMap={}}return m(e,[{key:"getId",value:function(e){var t=this.counter++;return this.id2DisplayObjectMap[t]=e,t}},{key:"getById",value:function(e){return this.id2DisplayObjectMap[e]}},{key:"reset",value:function(){this.counter=0,this.id2DisplayObjectMap={}}},{key:"decodePickingColor",value:function(e){var t=M(e,3),r=t[0],n=t[1],i=t[2],a=r+256*n+65536*i-1;return a}},{key:"encodePickingColor",value:function(e){return[e+1&255,e+1>>8&255,e+1>>8>>8&255]}}]),e}();function Ae(e,t,r,n){var i=oe.n2D,a=1,o=se.Sampled;return{dimension:i,pixelFormat:e,width:t,height:r,depth:a,numLevels:n,usage:o}}function Se(e){return e}function ye(e,t,r){return e<<16|t<<8|r}function Ce(e){return e>>>8&255}function Be(e){return e>>>16&255}function Oe(e){return 255&e}function xe(e){switch(e){case _e.F32:case _e.U32:case _e.S32:return 4;case _e.U16:case _e.S16:case _e.F16:return 2;case _e.U8:case _e.S8:return 1;default:throw"whoops"}}function De(e){return xe(Be(e))}function Ne(e){var t=xe(Be(e)),r=Se(Ce(e));return t*r}function Fe(e){var t=Oe(e);if(t&ve.Depth)return ce.Depth;if(t&ve.Normalized)return ce.Float;var r=Be(e);if(r===_e.F16||r===_e.F32)return ce.Float;if(r===_e.U8||r===_e.U16||r===_e.U32)return ce.Uint;if(r===_e.S8||r===_e.S16||r===_e.S32)return ce.Sint;throw"whoops"}function Pe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!e)throw console.error((new Error).stack),new Error("Assert fail: ".concat(t))}function Ie(e){if(void 0!==e&&null!==e)return e;throw new Error("Missing object")}function Me(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}function be(e,t){e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a}function Le(e){var t=e.r,r=e.g,n=e.b,i=e.a;return{r:t,g:r,b:n,a:i}}function Ue(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return{r:e,g:t,b:r,a:n}}me=(0,n.gn)([(0,o.ri)()],me),function(e){e[e["Buffer"]=0]="Buffer",e[e["Texture"]=1]="Texture",e[e["RenderTarget"]=2]="RenderTarget",e[e["Sampler"]=3]="Sampler",e[e["Program"]=4]="Program",e[e["Bindings"]=5]="Bindings",e[e["InputLayout"]=6]="InputLayout",e[e["InputState"]=7]="InputState",e[e["RenderPipeline"]=8]="RenderPipeline",e[e["ComputePipeline"]=9]="ComputePipeline",e[e["Readback"]=10]="Readback",e[e["QueryPool"]=11]="QueryPool"}(z||(z={})),function(e){e[e["Never"]=512]="Never",e[e["Less"]=513]="Less",e[e["Equal"]=514]="Equal",e[e["LessEqual"]=515]="LessEqual",e[e["Greater"]=516]="Greater",e[e["NotEqual"]=517]="NotEqual",e[e["GreaterEqual"]=518]="GreaterEqual",e[e["Always"]=519]="Always"}(q||(q={})),function(e){e[e["CCW"]=2305]="CCW",e[e["CW"]=2304]="CW"}(Z||(Z={})),function(e){e[e["None"]=0]="None",e[e["Front"]=1]="Front",e[e["Back"]=2]="Back",e[e["FrontAndBack"]=3]="FrontAndBack"}(j||(j={})),function(e){e[e["Zero"]=0]="Zero",e[e["One"]=1]="One",e[e["Src"]=768]="Src",e[e["OneMinusSrc"]=769]="OneMinusSrc",e[e["Dst"]=774]="Dst",e[e["OneMinusDst"]=775]="OneMinusDst",e[e["SrcAlpha"]=770]="SrcAlpha",e[e["OneMinusSrcAlpha"]=771]="OneMinusSrcAlpha",e[e["DstAlpha"]=772]="DstAlpha",e[e["OneMinusDstAlpha"]=773]="OneMinusDstAlpha"}(Q||(Q={})),function(e){e[e["Add"]=32774]="Add",e[e["Subtract"]=32778]="Subtract",e[e["ReverseSubtract"]=32779]="ReverseSubtract"}(J||(J={})),function(e){e[e["Clamp"]=0]="Clamp",e[e["Repeat"]=1]="Repeat",e[e["Mirror"]=2]="Mirror"}($||($={})),function(e){e[e["Point"]=0]="Point",e[e["Bilinear"]=1]="Bilinear"}(ee||(ee={})),function(e){e[e["NoMip"]=0]="NoMip",e[e["Nearest"]=1]="Nearest",e[e["Linear"]=2]="Linear"}(te||(te={})),function(e){e[e["Points"]=0]="Points",e[e["Triangles"]=1]="Triangles",e[e["TriangleStrip"]=2]="TriangleStrip",e[e["Lines"]=3]="Lines",e[e["LineStrip"]=4]="LineStrip"}(re||(re={})),function(e){e[e["MAP_READ"]=1]="MAP_READ",e[e["MAP_WRITE"]=2]="MAP_WRITE",e[e["COPY_SRC"]=4]="COPY_SRC",e[e["COPY_DST"]=8]="COPY_DST",e[e["INDEX"]=16]="INDEX",e[e["VERTEX"]=32]="VERTEX",e[e["UNIFORM"]=64]="UNIFORM",e[e["STORAGE"]=128]="STORAGE",e[e["INDIRECT"]=256]="INDIRECT",e[e["QUERY_RESOLVE"]=512]="QUERY_RESOLVE"}(ne||(ne={})),function(e){e[e["Static"]=1]="Static",e[e["Dynamic"]=2]="Dynamic"}(ie||(ie={})),function(e){e[e["PerVertex"]=1]="PerVertex",e[e["PerInstance"]=2]="PerInstance"}(ae||(ae={})),function(e){e[e["n2D"]=0]="n2D",e[e["n2DArray"]=1]="n2DArray",e[e["n3D"]=2]="n3D",e[e["Cube"]=3]="Cube"}(oe||(oe={})),function(e){e[e["Sampled"]=1]="Sampled",e[e["RenderTarget"]=2]="RenderTarget"}(se||(se={})),function(e){e[e["None"]=0]="None",e[e["Red"]=1]="Red",e[e["Green"]=2]="Green",e[e["Blue"]=4]="Blue",e[e["Alpha"]=8]="Alpha",e[e["RGB"]=7]="RGB",e[e["AllChannels"]=15]="AllChannels"}(ue||(ue={})),function(e){e[e["Keep"]=7680]="Keep",e[e["Zero"]=0]="Zero",e[e["Replace"]=7681]="Replace",e[e["Invert"]=5386]="Invert",e[e["IncrementClamp"]=7682]="IncrementClamp",e[e["DecrementClamp"]=7683]="DecrementClamp",e[e["IncrementWrap"]=34055]="IncrementWrap",e[e["DecrementWrap"]=34056]="DecrementWrap"}(le||(le={})),function(e){e[e["Float"]=0]="Float",e[e["Uint"]=1]="Uint",e[e["Sint"]=2]="Sint",e[e["Depth"]=3]="Depth"}(ce||(ce={})),function(e){e[e["LowerLeft"]=0]="LowerLeft",e[e["UpperLeft"]=1]="UpperLeft"}(fe||(fe={})),function(e){e[e["NegativeOne"]=0]="NegativeOne",e[e["Zero"]=1]="Zero"}(de||(de={})),function(e){e[e["OcclusionConservative"]=0]="OcclusionConservative"}(he||(he={})),function(e){e[e["U8"]=1]="U8",e[e["U16"]=2]="U16",e[e["U32"]=3]="U32",e[e["S8"]=4]="S8",e[e["S16"]=5]="S16",e[e["S32"]=6]="S32",e[e["F16"]=7]="F16",e[e["F32"]=8]="F32",e[e["BC1"]=65]="BC1",e[e["BC2"]=66]="BC2",e[e["BC3"]=67]="BC3",e[e["BC4_UNORM"]=68]="BC4_UNORM",e[e["BC4_SNORM"]=69]="BC4_SNORM",e[e["BC5_UNORM"]=70]="BC5_UNORM",e[e["BC5_SNORM"]=71]="BC5_SNORM",e[e["U16_PACKED_5551"]=97]="U16_PACKED_5551",e[e["D24"]=129]="D24",e[e["D32F"]=130]="D32F",e[e["D24S8"]=131]="D24S8",e[e["D32FS8"]=132]="D32FS8"}(_e||(_e={})),function(e){e[e["R"]=1]="R",e[e["RG"]=2]="RG",e[e["RGB"]=3]="RGB",e[e["RGBA"]=4]="RGBA",e[e["A"]=5]="A",e[e["MAT3"]=6]="MAT3",e[e["MAT4"]=7]="MAT4"}(pe||(pe={})),function(e){e[e["None"]=0]="None",e[e["Normalized"]=1]="Normalized",e[e["sRGB"]=2]="sRGB",e[e["Depth"]=4]="Depth",e[e["Stencil"]=8]="Stencil",e[e["RenderTarget"]=16]="RenderTarget"}(ve||(ve={})),function(e){e[e["ALPHA"]=ye(_e.U8,pe.A,ve.None)]="ALPHA",e[e["F16_RG"]=ye(_e.F16,pe.RG,ve.None)]="F16_RG",e[e["F16_RGB"]=ye(_e.F16,pe.RGB,ve.None)]="F16_RGB",e[e["F16_RGBA"]=ye(_e.F16,pe.RGBA,ve.None)]="F16_RGBA",e[e["F32_R"]=ye(_e.F32,pe.R,ve.None)]="F32_R",e[e["F32_RG"]=ye(_e.F32,pe.RG,ve.None)]="F32_RG",e[e["F32_RGB"]=ye(_e.F32,pe.RGB,ve.None)]="F32_RGB",e[e["F32_RGBA"]=ye(_e.F32,pe.RGBA,ve.None)]="F32_RGBA",e[e["F32_MAT3"]=ye(_e.F32,pe.MAT3,ve.None)]="F32_MAT3",e[e["F32_MAT4"]=ye(_e.F32,pe.MAT4,ve.None)]="F32_MAT4",e[e["U8_R"]=ye(_e.U8,pe.R,ve.None)]="U8_R",e[e["U8_R_NORM"]=ye(_e.U8,pe.R,ve.Normalized)]="U8_R_NORM",e[e["U8_RG"]=ye(_e.U8,pe.RG,ve.None)]="U8_RG",e[e["U8_RG_NORM"]=ye(_e.U8,pe.RG,ve.Normalized)]="U8_RG_NORM",e[e["U8_RGB"]=ye(_e.U8,pe.RGB,ve.None)]="U8_RGB",e[e["U8_RGB_NORM"]=ye(_e.U8,pe.RGB,ve.Normalized)]="U8_RGB_NORM",e[e["U8_RGB_SRGB"]=ye(_e.U8,pe.RGB,ve.sRGB|ve.Normalized)]="U8_RGB_SRGB",e[e["U8_RGBA"]=ye(_e.U8,pe.RGBA,ve.None)]="U8_RGBA",e[e["U8_RGBA_NORM"]=ye(_e.U8,pe.RGBA,ve.Normalized)]="U8_RGBA_NORM",e[e["U8_RGBA_SRGB"]=ye(_e.U8,pe.RGBA,ve.sRGB|ve.Normalized)]="U8_RGBA_SRGB",e[e["U16_R"]=ye(_e.U16,pe.R,ve.None)]="U16_R",e[e["U16_R_NORM"]=ye(_e.U16,pe.R,ve.Normalized)]="U16_R_NORM",e[e["U16_RG_NORM"]=ye(_e.U16,pe.RG,ve.Normalized)]="U16_RG_NORM",e[e["U16_RGBA_NORM"]=ye(_e.U16,pe.RGBA,ve.Normalized)]="U16_RGBA_NORM",e[e["U16_RGB"]=ye(_e.U16,pe.RGB,ve.None)]="U16_RGB",e[e["U32_R"]=ye(_e.U32,pe.R,ve.None)]="U32_R",e[e["U32_RG"]=ye(_e.U32,pe.RG,ve.None)]="U32_RG",e[e["S8_R"]=ye(_e.S8,pe.R,ve.None)]="S8_R",e[e["S8_R_NORM"]=ye(_e.S8,pe.R,ve.Normalized)]="S8_R_NORM",e[e["S8_RG_NORM"]=ye(_e.S8,pe.RG,ve.Normalized)]="S8_RG_NORM",e[e["S8_RGB_NORM"]=ye(_e.S8,pe.RGB,ve.Normalized)]="S8_RGB_NORM",e[e["S8_RGBA_NORM"]=ye(_e.S8,pe.RGBA,ve.Normalized)]="S8_RGBA_NORM",e[e["S16_R"]=ye(_e.S16,pe.R,ve.None)]="S16_R",e[e["S16_RG"]=ye(_e.S16,pe.RG,ve.None)]="S16_RG",e[e["S16_RG_NORM"]=ye(_e.S16,pe.RG,ve.Normalized)]="S16_RG_NORM",e[e["S16_RGB_NORM"]=ye(_e.S16,pe.RGB,ve.Normalized)]="S16_RGB_NORM",e[e["S16_RGBA"]=ye(_e.S16,pe.RGBA,ve.None)]="S16_RGBA",e[e["S16_RGBA_NORM"]=ye(_e.S16,pe.RGBA,ve.Normalized)]="S16_RGBA_NORM",e[e["S32_R"]=ye(_e.S32,pe.R,ve.None)]="S32_R",e[e["U16_RGBA_5551"]=ye(_e.U16_PACKED_5551,pe.RGBA,ve.Normalized)]="U16_RGBA_5551",e[e["BC1"]=ye(_e.BC1,pe.RGBA,ve.None)]="BC1",e[e["BC1_SRGB"]=ye(_e.BC1,pe.RGBA,ve.sRGB)]="BC1_SRGB",e[e["BC2"]=ye(_e.BC2,pe.RGBA,ve.None)]="BC2",e[e["BC2_SRGB"]=ye(_e.BC2,pe.RGBA,ve.sRGB)]="BC2_SRGB",e[e["BC3"]=ye(_e.BC3,pe.RGBA,ve.None)]="BC3",e[e["BC3_SRGB"]=ye(_e.BC3,pe.RGBA,ve.sRGB)]="BC3_SRGB",e[e["BC4_UNORM"]=ye(_e.BC4_UNORM,pe.R,ve.None)]="BC4_UNORM",e[e["BC4_SNORM"]=ye(_e.BC4_SNORM,pe.R,ve.None)]="BC4_SNORM",e[e["BC5_UNORM"]=ye(_e.BC5_UNORM,pe.RG,ve.None)]="BC5_UNORM",e[e["BC5_SNORM"]=ye(_e.BC5_SNORM,pe.RG,ve.None)]="BC5_SNORM",e[e["D24"]=ye(_e.D24,pe.R,ve.Depth)]="D24",e[e["D24_S8"]=ye(_e.D24S8,pe.RG,ve.Depth|ve.Stencil)]="D24_S8",e[e["D32F"]=ye(_e.D32F,pe.R,ve.Depth)]="D32F",e[e["D32F_S8"]=ye(_e.D32FS8,pe.RG,ve.Depth|ve.Stencil)]="D32F_S8",e[e["U8_RGB_RT"]=ye(_e.U8,pe.RGB,ve.RenderTarget)]="U8_RGB_RT",e[e["U8_RGBA_RT"]=ye(_e.U8,pe.RGBA,ve.RenderTarget)]="U8_RGBA_RT",e[e["U8_RGBA_RT_SRGB"]=ye(_e.U8,pe.RGBA,ve.RenderTarget|ve.sRGB)]="U8_RGBA_RT_SRGB"}(Ee||(Ee={})),function(e){e[e["COPY_SRC"]=1]="COPY_SRC",e[e["COPY_DST"]=2]="COPY_DST",e[e["TEXTURE_BINDING"]=4]="TEXTURE_BINDING",e[e["STORAGE_BINDING"]=8]="STORAGE_BINDING",e[e["STORAGE"]=8]="STORAGE",e[e["RENDER_ATTACHMENT"]=16]="RENDER_ATTACHMENT"}(Re||(Re={})),function(e){e[e["READ"]=1]="READ",e[e["WRITE"]=2]="WRITE"}(ge||(ge={})),function(e){e[e["DEPTH_BUFFER_BIT"]=256]="DEPTH_BUFFER_BIT",e[e["STENCIL_BUFFER_BIT"]=1024]="STENCIL_BUFFER_BIT",e[e["COLOR_BUFFER_BIT"]=16384]="COLOR_BUFFER_BIT",e[e["POINTS"]=0]="POINTS",e[e["LINES"]=1]="LINES",e[e["LINE_LOOP"]=2]="LINE_LOOP",e[e["LINE_STRIP"]=3]="LINE_STRIP",e[e["TRIANGLES"]=4]="TRIANGLES",e[e["TRIANGLE_STRIP"]=5]="TRIANGLE_STRIP",e[e["TRIANGLE_FAN"]=6]="TRIANGLE_FAN",e[e["ZERO"]=0]="ZERO",e[e["ONE"]=1]="ONE",e[e["SRC_COLOR"]=768]="SRC_COLOR",e[e["ONE_MINUS_SRC_COLOR"]=769]="ONE_MINUS_SRC_COLOR",e[e["SRC_ALPHA"]=770]="SRC_ALPHA",e[e["ONE_MINUS_SRC_ALPHA"]=771]="ONE_MINUS_SRC_ALPHA",e[e["DST_ALPHA"]=772]="DST_ALPHA",e[e["ONE_MINUS_DST_ALPHA"]=773]="ONE_MINUS_DST_ALPHA",e[e["DST_COLOR"]=774]="DST_COLOR",e[e["ONE_MINUS_DST_COLOR"]=775]="ONE_MINUS_DST_COLOR",e[e["SRC_ALPHA_SATURATE"]=776]="SRC_ALPHA_SATURATE",e[e["CONSTANT_COLOR"]=32769]="CONSTANT_COLOR",e[e["ONE_MINUS_CONSTANT_COLOR"]=32770]="ONE_MINUS_CONSTANT_COLOR",e[e["CONSTANT_ALPHA"]=32771]="CONSTANT_ALPHA",e[e["ONE_MINUS_CONSTANT_ALPHA"]=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e["FUNC_ADD"]=32774]="FUNC_ADD",e[e["FUNC_SUBTRACT"]=32778]="FUNC_SUBTRACT",e[e["FUNC_REVERSE_SUBTRACT"]=32779]="FUNC_REVERSE_SUBTRACT",e[e["BLEND_EQUATION"]=32777]="BLEND_EQUATION",e[e["BLEND_EQUATION_RGB"]=32777]="BLEND_EQUATION_RGB",e[e["BLEND_EQUATION_ALPHA"]=34877]="BLEND_EQUATION_ALPHA",e[e["BLEND_DST_RGB"]=32968]="BLEND_DST_RGB",e[e["BLEND_SRC_RGB"]=32969]="BLEND_SRC_RGB",e[e["BLEND_DST_ALPHA"]=32970]="BLEND_DST_ALPHA",e[e["BLEND_SRC_ALPHA"]=32971]="BLEND_SRC_ALPHA",e[e["BLEND_COLOR"]=32773]="BLEND_COLOR",e[e["ARRAY_BUFFER_BINDING"]=34964]="ARRAY_BUFFER_BINDING",e[e["ELEMENT_ARRAY_BUFFER_BINDING"]=34965]="ELEMENT_ARRAY_BUFFER_BINDING",e[e["LINE_WIDTH"]=2849]="LINE_WIDTH",e[e["ALIASED_POINT_SIZE_RANGE"]=33901]="ALIASED_POINT_SIZE_RANGE",e[e["ALIASED_LINE_WIDTH_RANGE"]=33902]="ALIASED_LINE_WIDTH_RANGE",e[e["CULL_FACE_MODE"]=2885]="CULL_FACE_MODE",e[e["FRONT_FACE"]=2886]="FRONT_FACE",e[e["DEPTH_RANGE"]=2928]="DEPTH_RANGE",e[e["DEPTH_WRITEMASK"]=2930]="DEPTH_WRITEMASK",e[e["DEPTH_CLEAR_VALUE"]=2931]="DEPTH_CLEAR_VALUE",e[e["DEPTH_FUNC"]=2932]="DEPTH_FUNC",e[e["STENCIL_CLEAR_VALUE"]=2961]="STENCIL_CLEAR_VALUE",e[e["STENCIL_FUNC"]=2962]="STENCIL_FUNC",e[e["STENCIL_FAIL"]=2964]="STENCIL_FAIL",e[e["STENCIL_PASS_DEPTH_FAIL"]=2965]="STENCIL_PASS_DEPTH_FAIL",e[e["STENCIL_PASS_DEPTH_PASS"]=2966]="STENCIL_PASS_DEPTH_PASS",e[e["STENCIL_REF"]=2967]="STENCIL_REF",e[e["STENCIL_VALUE_MASK"]=2963]="STENCIL_VALUE_MASK",e[e["STENCIL_WRITEMASK"]=2968]="STENCIL_WRITEMASK",e[e["STENCIL_BACK_FUNC"]=34816]="STENCIL_BACK_FUNC",e[e["STENCIL_BACK_FAIL"]=34817]="STENCIL_BACK_FAIL",e[e["STENCIL_BACK_PASS_DEPTH_FAIL"]=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",e[e["STENCIL_BACK_PASS_DEPTH_PASS"]=34819]="STENCIL_BACK_PASS_DEPTH_PASS",e[e["STENCIL_BACK_REF"]=36003]="STENCIL_BACK_REF",e[e["STENCIL_BACK_VALUE_MASK"]=36004]="STENCIL_BACK_VALUE_MASK",e[e["STENCIL_BACK_WRITEMASK"]=36005]="STENCIL_BACK_WRITEMASK",e[e["VIEWPORT"]=2978]="VIEWPORT",e[e["SCISSOR_BOX"]=3088]="SCISSOR_BOX",e[e["COLOR_CLEAR_VALUE"]=3106]="COLOR_CLEAR_VALUE",e[e["COLOR_WRITEMASK"]=3107]="COLOR_WRITEMASK",e[e["UNPACK_ALIGNMENT"]=3317]="UNPACK_ALIGNMENT",e[e["PACK_ALIGNMENT"]=3333]="PACK_ALIGNMENT",e[e["MAX_TEXTURE_SIZE"]=3379]="MAX_TEXTURE_SIZE",e[e["MAX_VIEWPORT_DIMS"]=3386]="MAX_VIEWPORT_DIMS",e[e["SUBPIXEL_BITS"]=3408]="SUBPIXEL_BITS",e[e["RED_BITS"]=3410]="RED_BITS",e[e["GREEN_BITS"]=3411]="GREEN_BITS",e[e["BLUE_BITS"]=3412]="BLUE_BITS",e[e["ALPHA_BITS"]=3413]="ALPHA_BITS",e[e["DEPTH_BITS"]=3414]="DEPTH_BITS",e[e["STENCIL_BITS"]=3415]="STENCIL_BITS",e[e["POLYGON_OFFSET_UNITS"]=10752]="POLYGON_OFFSET_UNITS",e[e["POLYGON_OFFSET_FACTOR"]=32824]="POLYGON_OFFSET_FACTOR",e[e["TEXTURE_BINDING_2D"]=32873]="TEXTURE_BINDING_2D",e[e["SAMPLE_BUFFERS"]=32936]="SAMPLE_BUFFERS",e[e["SAMPLES"]=32937]="SAMPLES",e[e["SAMPLE_COVERAGE_VALUE"]=32938]="SAMPLE_COVERAGE_VALUE",e[e["SAMPLE_COVERAGE_INVERT"]=32939]="SAMPLE_COVERAGE_INVERT",e[e["COMPRESSED_TEXTURE_FORMATS"]=34467]="COMPRESSED_TEXTURE_FORMATS",e[e["VENDOR"]=7936]="VENDOR",e[e["RENDERER"]=7937]="RENDERER",e[e["VERSION"]=7938]="VERSION",e[e["IMPLEMENTATION_COLOR_READ_TYPE"]=35738]="IMPLEMENTATION_COLOR_READ_TYPE",e[e["IMPLEMENTATION_COLOR_READ_FORMAT"]=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",e[e["BROWSER_DEFAULT_WEBGL"]=37444]="BROWSER_DEFAULT_WEBGL",e[e["STATIC_DRAW"]=35044]="STATIC_DRAW",e[e["STREAM_DRAW"]=35040]="STREAM_DRAW",e[e["DYNAMIC_DRAW"]=35048]="DYNAMIC_DRAW",e[e["ARRAY_BUFFER"]=34962]="ARRAY_BUFFER",e[e["ELEMENT_ARRAY_BUFFER"]=34963]="ELEMENT_ARRAY_BUFFER",e[e["BUFFER_SIZE"]=34660]="BUFFER_SIZE",e[e["BUFFER_USAGE"]=34661]="BUFFER_USAGE",e[e["CURRENT_VERTEX_ATTRIB"]=34342]="CURRENT_VERTEX_ATTRIB",e[e["VERTEX_ATTRIB_ARRAY_ENABLED"]=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",e[e["VERTEX_ATTRIB_ARRAY_SIZE"]=34339]="VERTEX_ATTRIB_ARRAY_SIZE",e[e["VERTEX_ATTRIB_ARRAY_STRIDE"]=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",e[e["VERTEX_ATTRIB_ARRAY_TYPE"]=34341]="VERTEX_ATTRIB_ARRAY_TYPE",e[e["VERTEX_ATTRIB_ARRAY_NORMALIZED"]=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",e[e["VERTEX_ATTRIB_ARRAY_POINTER"]=34373]="VERTEX_ATTRIB_ARRAY_POINTER",e[e["VERTEX_ATTRIB_ARRAY_BUFFER_BINDING"]=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",e[e["CULL_FACE"]=2884]="CULL_FACE",e[e["FRONT"]=1028]="FRONT",e[e["BACK"]=1029]="BACK",e[e["FRONT_AND_BACK"]=1032]="FRONT_AND_BACK",e[e["BLEND"]=3042]="BLEND",e[e["DEPTH_TEST"]=2929]="DEPTH_TEST",e[e["DITHER"]=3024]="DITHER",e[e["POLYGON_OFFSET_FILL"]=32823]="POLYGON_OFFSET_FILL",e[e["SAMPLE_ALPHA_TO_COVERAGE"]=32926]="SAMPLE_ALPHA_TO_COVERAGE",e[e["SAMPLE_COVERAGE"]=32928]="SAMPLE_COVERAGE",e[e["SCISSOR_TEST"]=3089]="SCISSOR_TEST",e[e["STENCIL_TEST"]=2960]="STENCIL_TEST",e[e["NO_ERROR"]=0]="NO_ERROR",e[e["INVALID_ENUM"]=1280]="INVALID_ENUM",e[e["INVALID_VALUE"]=1281]="INVALID_VALUE",e[e["INVALID_OPERATION"]=1282]="INVALID_OPERATION",e[e["OUT_OF_MEMORY"]=1285]="OUT_OF_MEMORY",e[e["CONTEXT_LOST_WEBGL"]=37442]="CONTEXT_LOST_WEBGL",e[e["CW"]=2304]="CW",e[e["CCW"]=2305]="CCW",e[e["DONT_CARE"]=4352]="DONT_CARE",e[e["FASTEST"]=4353]="FASTEST",e[e["NICEST"]=4354]="NICEST",e[e["GENERATE_MIPMAP_HINT"]=33170]="GENERATE_MIPMAP_HINT",e[e["BYTE"]=5120]="BYTE",e[e["UNSIGNED_BYTE"]=5121]="UNSIGNED_BYTE",e[e["SHORT"]=5122]="SHORT",e[e["UNSIGNED_SHORT"]=5123]="UNSIGNED_SHORT",e[e["INT"]=5124]="INT",e[e["UNSIGNED_INT"]=5125]="UNSIGNED_INT",e[e["FLOAT"]=5126]="FLOAT",e[e["DOUBLE"]=5130]="DOUBLE",e[e["DEPTH_COMPONENT"]=6402]="DEPTH_COMPONENT",e[e["ALPHA"]=6406]="ALPHA",e[e["RGB"]=6407]="RGB",e[e["RGBA"]=6408]="RGBA",e[e["LUMINANCE"]=6409]="LUMINANCE",e[e["LUMINANCE_ALPHA"]=6410]="LUMINANCE_ALPHA",e[e["UNSIGNED_SHORT_4_4_4_4"]=32819]="UNSIGNED_SHORT_4_4_4_4",e[e["UNSIGNED_SHORT_5_5_5_1"]=32820]="UNSIGNED_SHORT_5_5_5_1",e[e["UNSIGNED_SHORT_5_6_5"]=33635]="UNSIGNED_SHORT_5_6_5",e[e["FRAGMENT_SHADER"]=35632]="FRAGMENT_SHADER",e[e["VERTEX_SHADER"]=35633]="VERTEX_SHADER",e[e["COMPILE_STATUS"]=35713]="COMPILE_STATUS",e[e["DELETE_STATUS"]=35712]="DELETE_STATUS",e[e["LINK_STATUS"]=35714]="LINK_STATUS",e[e["VALIDATE_STATUS"]=35715]="VALIDATE_STATUS",e[e["ATTACHED_SHADERS"]=35717]="ATTACHED_SHADERS",e[e["ACTIVE_ATTRIBUTES"]=35721]="ACTIVE_ATTRIBUTES",e[e["ACTIVE_UNIFORMS"]=35718]="ACTIVE_UNIFORMS",e[e["MAX_VERTEX_ATTRIBS"]=34921]="MAX_VERTEX_ATTRIBS",e[e["MAX_VERTEX_UNIFORM_VECTORS"]=36347]="MAX_VERTEX_UNIFORM_VECTORS",e[e["MAX_VARYING_VECTORS"]=36348]="MAX_VARYING_VECTORS",e[e["MAX_COMBINED_TEXTURE_IMAGE_UNITS"]=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",e[e["MAX_VERTEX_TEXTURE_IMAGE_UNITS"]=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",e[e["MAX_TEXTURE_IMAGE_UNITS"]=34930]="MAX_TEXTURE_IMAGE_UNITS",e[e["MAX_FRAGMENT_UNIFORM_VECTORS"]=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",e[e["SHADER_TYPE"]=35663]="SHADER_TYPE",e[e["SHADING_LANGUAGE_VERSION"]=35724]="SHADING_LANGUAGE_VERSION",e[e["CURRENT_PROGRAM"]=35725]="CURRENT_PROGRAM",e[e["NEVER"]=512]="NEVER",e[e["ALWAYS"]=519]="ALWAYS",e[e["LESS"]=513]="LESS",e[e["EQUAL"]=514]="EQUAL",e[e["LEQUAL"]=515]="LEQUAL",e[e["GREATER"]=516]="GREATER",e[e["GEQUAL"]=518]="GEQUAL",e[e["NOTEQUAL"]=517]="NOTEQUAL",e[e["KEEP"]=7680]="KEEP",e[e["REPLACE"]=7681]="REPLACE",e[e["INCR"]=7682]="INCR",e[e["DECR"]=7683]="DECR",e[e["INVERT"]=5386]="INVERT",e[e["INCR_WRAP"]=34055]="INCR_WRAP",e[e["DECR_WRAP"]=34056]="DECR_WRAP",e[e["NEAREST"]=9728]="NEAREST",e[e["LINEAR"]=9729]="LINEAR",e[e["NEAREST_MIPMAP_NEAREST"]=9984]="NEAREST_MIPMAP_NEAREST",e[e["LINEAR_MIPMAP_NEAREST"]=9985]="LINEAR_MIPMAP_NEAREST",e[e["NEAREST_MIPMAP_LINEAR"]=9986]="NEAREST_MIPMAP_LINEAR",e[e["LINEAR_MIPMAP_LINEAR"]=9987]="LINEAR_MIPMAP_LINEAR",e[e["TEXTURE_MAG_FILTER"]=10240]="TEXTURE_MAG_FILTER",e[e["TEXTURE_MIN_FILTER"]=10241]="TEXTURE_MIN_FILTER",e[e["TEXTURE_WRAP_S"]=10242]="TEXTURE_WRAP_S",e[e["TEXTURE_WRAP_T"]=10243]="TEXTURE_WRAP_T",e[e["TEXTURE_2D"]=3553]="TEXTURE_2D",e[e["TEXTURE"]=5890]="TEXTURE",e[e["TEXTURE_CUBE_MAP"]=34067]="TEXTURE_CUBE_MAP",e[e["TEXTURE_BINDING_CUBE_MAP"]=34068]="TEXTURE_BINDING_CUBE_MAP",e[e["TEXTURE_CUBE_MAP_POSITIVE_X"]=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e["TEXTURE_CUBE_MAP_NEGATIVE_X"]=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e["TEXTURE_CUBE_MAP_POSITIVE_Y"]=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e["TEXTURE_CUBE_MAP_NEGATIVE_Y"]=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e["TEXTURE_CUBE_MAP_POSITIVE_Z"]=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e["TEXTURE_CUBE_MAP_NEGATIVE_Z"]=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",e[e["MAX_CUBE_MAP_TEXTURE_SIZE"]=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",e[e["TEXTURE0"]=33984]="TEXTURE0",e[e["ACTIVE_TEXTURE"]=34016]="ACTIVE_TEXTURE",e[e["REPEAT"]=10497]="REPEAT",e[e["CLAMP_TO_EDGE"]=33071]="CLAMP_TO_EDGE",e[e["MIRRORED_REPEAT"]=33648]="MIRRORED_REPEAT",e[e["TEXTURE_WIDTH"]=4096]="TEXTURE_WIDTH",e[e["TEXTURE_HEIGHT"]=4097]="TEXTURE_HEIGHT",e[e["FLOAT_VEC2"]=35664]="FLOAT_VEC2",e[e["FLOAT_VEC3"]=35665]="FLOAT_VEC3",e[e["FLOAT_VEC4"]=35666]="FLOAT_VEC4",e[e["INT_VEC2"]=35667]="INT_VEC2",e[e["INT_VEC3"]=35668]="INT_VEC3",e[e["INT_VEC4"]=35669]="INT_VEC4",e[e["BOOL"]=35670]="BOOL",e[e["BOOL_VEC2"]=35671]="BOOL_VEC2",e[e["BOOL_VEC3"]=35672]="BOOL_VEC3",e[e["BOOL_VEC4"]=35673]="BOOL_VEC4",e[e["FLOAT_MAT2"]=35674]="FLOAT_MAT2",e[e["FLOAT_MAT3"]=35675]="FLOAT_MAT3",e[e["FLOAT_MAT4"]=35676]="FLOAT_MAT4",e[e["SAMPLER_2D"]=35678]="SAMPLER_2D",e[e["SAMPLER_CUBE"]=35680]="SAMPLER_CUBE",e[e["LOW_FLOAT"]=36336]="LOW_FLOAT",e[e["MEDIUM_FLOAT"]=36337]="MEDIUM_FLOAT",e[e["HIGH_FLOAT"]=36338]="HIGH_FLOAT",e[e["LOW_INT"]=36339]="LOW_INT",e[e["MEDIUM_INT"]=36340]="MEDIUM_INT",e[e["HIGH_INT"]=36341]="HIGH_INT",e[e["FRAMEBUFFER"]=36160]="FRAMEBUFFER",e[e["RENDERBUFFER"]=36161]="RENDERBUFFER",e[e["RGBA4"]=32854]="RGBA4",e[e["RGB5_A1"]=32855]="RGB5_A1",e[e["RGB565"]=36194]="RGB565",e[e["DEPTH_COMPONENT16"]=33189]="DEPTH_COMPONENT16",e[e["STENCIL_INDEX"]=6401]="STENCIL_INDEX",e[e["STENCIL_INDEX8"]=36168]="STENCIL_INDEX8",e[e["DEPTH_STENCIL"]=34041]="DEPTH_STENCIL",e[e["RENDERBUFFER_WIDTH"]=36162]="RENDERBUFFER_WIDTH",e[e["RENDERBUFFER_HEIGHT"]=36163]="RENDERBUFFER_HEIGHT",e[e["RENDERBUFFER_INTERNAL_FORMAT"]=36164]="RENDERBUFFER_INTERNAL_FORMAT",e[e["RENDERBUFFER_RED_SIZE"]=36176]="RENDERBUFFER_RED_SIZE",e[e["RENDERBUFFER_GREEN_SIZE"]=36177]="RENDERBUFFER_GREEN_SIZE",e[e["RENDERBUFFER_BLUE_SIZE"]=36178]="RENDERBUFFER_BLUE_SIZE",e[e["RENDERBUFFER_ALPHA_SIZE"]=36179]="RENDERBUFFER_ALPHA_SIZE",e[e["RENDERBUFFER_DEPTH_SIZE"]=36180]="RENDERBUFFER_DEPTH_SIZE",e[e["RENDERBUFFER_STENCIL_SIZE"]=36181]="RENDERBUFFER_STENCIL_SIZE",e[e["FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE"]=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",e[e["FRAMEBUFFER_ATTACHMENT_OBJECT_NAME"]=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",e[e["FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL"]=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",e[e["FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE"]=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",e[e["COLOR_ATTACHMENT0"]=36064]="COLOR_ATTACHMENT0",e[e["DEPTH_ATTACHMENT"]=36096]="DEPTH_ATTACHMENT",e[e["STENCIL_ATTACHMENT"]=36128]="STENCIL_ATTACHMENT",e[e["DEPTH_STENCIL_ATTACHMENT"]=33306]="DEPTH_STENCIL_ATTACHMENT",e[e["NONE"]=0]="NONE",e[e["FRAMEBUFFER_COMPLETE"]=36053]="FRAMEBUFFER_COMPLETE",e[e["FRAMEBUFFER_INCOMPLETE_ATTACHMENT"]=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",e[e["FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT"]=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",e[e["FRAMEBUFFER_INCOMPLETE_DIMENSIONS"]=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",e[e["FRAMEBUFFER_UNSUPPORTED"]=36061]="FRAMEBUFFER_UNSUPPORTED",e[e["FRAMEBUFFER_BINDING"]=36006]="FRAMEBUFFER_BINDING",e[e["RENDERBUFFER_BINDING"]=36007]="RENDERBUFFER_BINDING",e[e["READ_FRAMEBUFFER"]=36008]="READ_FRAMEBUFFER",e[e["DRAW_FRAMEBUFFER"]=36009]="DRAW_FRAMEBUFFER",e[e["MAX_RENDERBUFFER_SIZE"]=34024]="MAX_RENDERBUFFER_SIZE",e[e["INVALID_FRAMEBUFFER_OPERATION"]=1286]="INVALID_FRAMEBUFFER_OPERATION",e[e["UNPACK_FLIP_Y_WEBGL"]=37440]="UNPACK_FLIP_Y_WEBGL",e[e["UNPACK_PREMULTIPLY_ALPHA_WEBGL"]=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",e[e["UNPACK_COLORSPACE_CONVERSION_WEBGL"]=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",e[e["READ_BUFFER"]=3074]="READ_BUFFER",e[e["UNPACK_ROW_LENGTH"]=3314]="UNPACK_ROW_LENGTH",e[e["UNPACK_SKIP_ROWS"]=3315]="UNPACK_SKIP_ROWS",e[e["UNPACK_SKIP_PIXELS"]=3316]="UNPACK_SKIP_PIXELS",e[e["PACK_ROW_LENGTH"]=3330]="PACK_ROW_LENGTH",e[e["PACK_SKIP_ROWS"]=3331]="PACK_SKIP_ROWS",e[e["PACK_SKIP_PIXELS"]=3332]="PACK_SKIP_PIXELS",e[e["TEXTURE_BINDING_3D"]=32874]="TEXTURE_BINDING_3D",e[e["UNPACK_SKIP_IMAGES"]=32877]="UNPACK_SKIP_IMAGES",e[e["UNPACK_IMAGE_HEIGHT"]=32878]="UNPACK_IMAGE_HEIGHT",e[e["MAX_3D_TEXTURE_SIZE"]=32883]="MAX_3D_TEXTURE_SIZE",e[e["MAX_ELEMENTS_VERTICES"]=33e3]="MAX_ELEMENTS_VERTICES",e[e["MAX_ELEMENTS_INDICES"]=33001]="MAX_ELEMENTS_INDICES",e[e["MAX_TEXTURE_LOD_BIAS"]=34045]="MAX_TEXTURE_LOD_BIAS",e[e["MAX_FRAGMENT_UNIFORM_COMPONENTS"]=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",e[e["MAX_VERTEX_UNIFORM_COMPONENTS"]=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",e[e["MAX_ARRAY_TEXTURE_LAYERS"]=35071]="MAX_ARRAY_TEXTURE_LAYERS",e[e["MIN_PROGRAM_TEXEL_OFFSET"]=35076]="MIN_PROGRAM_TEXEL_OFFSET",e[e["MAX_PROGRAM_TEXEL_OFFSET"]=35077]="MAX_PROGRAM_TEXEL_OFFSET",e[e["MAX_VARYING_COMPONENTS"]=35659]="MAX_VARYING_COMPONENTS",e[e["FRAGMENT_SHADER_DERIVATIVE_HINT"]=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",e[e["RASTERIZER_DISCARD"]=35977]="RASTERIZER_DISCARD",e[e["VERTEX_ARRAY_BINDING"]=34229]="VERTEX_ARRAY_BINDING",e[e["MAX_VERTEX_OUTPUT_COMPONENTS"]=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",e[e["MAX_FRAGMENT_INPUT_COMPONENTS"]=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",e[e["MAX_SERVER_WAIT_TIMEOUT"]=37137]="MAX_SERVER_WAIT_TIMEOUT",e[e["MAX_ELEMENT_INDEX"]=36203]="MAX_ELEMENT_INDEX",e[e["RED"]=6403]="RED",e[e["RGB8"]=32849]="RGB8",e[e["RGBA8"]=32856]="RGBA8",e[e["RGB10_A2"]=32857]="RGB10_A2",e[e["TEXTURE_3D"]=32879]="TEXTURE_3D",e[e["TEXTURE_WRAP_R"]=32882]="TEXTURE_WRAP_R",e[e["TEXTURE_MIN_LOD"]=33082]="TEXTURE_MIN_LOD",e[e["TEXTURE_MAX_LOD"]=33083]="TEXTURE_MAX_LOD",e[e["TEXTURE_BASE_LEVEL"]=33084]="TEXTURE_BASE_LEVEL",e[e["TEXTURE_MAX_LEVEL"]=33085]="TEXTURE_MAX_LEVEL",e[e["TEXTURE_COMPARE_MODE"]=34892]="TEXTURE_COMPARE_MODE",e[e["TEXTURE_COMPARE_FUNC"]=34893]="TEXTURE_COMPARE_FUNC",e[e["SRGB"]=35904]="SRGB",e[e["SRGB8"]=35905]="SRGB8",e[e["SRGB8_ALPHA8"]=35907]="SRGB8_ALPHA8",e[e["COMPARE_REF_TO_TEXTURE"]=34894]="COMPARE_REF_TO_TEXTURE",e[e["RGBA32F"]=34836]="RGBA32F",e[e["RGB32F"]=34837]="RGB32F",e[e["RGBA16F"]=34842]="RGBA16F",e[e["RGB16F"]=34843]="RGB16F",e[e["TEXTURE_2D_ARRAY"]=35866]="TEXTURE_2D_ARRAY",e[e["TEXTURE_BINDING_2D_ARRAY"]=35869]="TEXTURE_BINDING_2D_ARRAY",e[e["R11F_G11F_B10F"]=35898]="R11F_G11F_B10F",e[e["RGB9_E5"]=35901]="RGB9_E5",e[e["RGBA32UI"]=36208]="RGBA32UI",e[e["RGB32UI"]=36209]="RGB32UI",e[e["RGBA16UI"]=36214]="RGBA16UI",e[e["RGB16UI"]=36215]="RGB16UI",e[e["RGBA8UI"]=36220]="RGBA8UI",e[e["RGB8UI"]=36221]="RGB8UI",e[e["RGBA32I"]=36226]="RGBA32I",e[e["RGB32I"]=36227]="RGB32I",e[e["RGBA16I"]=36232]="RGBA16I",e[e["RGB16I"]=36233]="RGB16I",e[e["RGBA8I"]=36238]="RGBA8I",e[e["RGB8I"]=36239]="RGB8I",e[e["RED_INTEGER"]=36244]="RED_INTEGER",e[e["RGB_INTEGER"]=36248]="RGB_INTEGER",e[e["RGBA_INTEGER"]=36249]="RGBA_INTEGER",e[e["R8"]=33321]="R8",e[e["RG8"]=33323]="RG8",e[e["R16F"]=33325]="R16F",e[e["R32F"]=33326]="R32F",e[e["RG16F"]=33327]="RG16F",e[e["RG32F"]=33328]="RG32F",e[e["R8I"]=33329]="R8I",e[e["R8UI"]=33330]="R8UI",e[e["R16I"]=33331]="R16I",e[e["R16UI"]=33332]="R16UI",e[e["R32I"]=33333]="R32I",e[e["R32UI"]=33334]="R32UI",e[e["RG8I"]=33335]="RG8I",e[e["RG8UI"]=33336]="RG8UI",e[e["RG16I"]=33337]="RG16I",e[e["RG16UI"]=33338]="RG16UI",e[e["RG32I"]=33339]="RG32I",e[e["RG32UI"]=33340]="RG32UI",e[e["R8_SNORM"]=36756]="R8_SNORM",e[e["RG8_SNORM"]=36757]="RG8_SNORM",e[e["RGB8_SNORM"]=36758]="RGB8_SNORM",e[e["RGBA8_SNORM"]=36759]="RGBA8_SNORM",e[e["RGB10_A2UI"]=36975]="RGB10_A2UI",e[e["TEXTURE_IMMUTABLE_FORMAT"]=37167]="TEXTURE_IMMUTABLE_FORMAT",e[e["TEXTURE_IMMUTABLE_LEVELS"]=33503]="TEXTURE_IMMUTABLE_LEVELS",e[e["UNSIGNED_INT_2_10_10_10_REV"]=33640]="UNSIGNED_INT_2_10_10_10_REV",e[e["UNSIGNED_INT_10F_11F_11F_REV"]=35899]="UNSIGNED_INT_10F_11F_11F_REV",e[e["UNSIGNED_INT_5_9_9_9_REV"]=35902]="UNSIGNED_INT_5_9_9_9_REV",e[e["FLOAT_32_UNSIGNED_INT_24_8_REV"]=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",e[e["UNSIGNED_INT_24_8"]=34042]="UNSIGNED_INT_24_8",e[e["HALF_FLOAT"]=5131]="HALF_FLOAT",e[e["RG"]=33319]="RG",e[e["RG_INTEGER"]=33320]="RG_INTEGER",e[e["INT_2_10_10_10_REV"]=36255]="INT_2_10_10_10_REV",e[e["CURRENT_QUERY"]=34917]="CURRENT_QUERY",e[e["QUERY_RESULT"]=34918]="QUERY_RESULT",e[e["QUERY_RESULT_AVAILABLE"]=34919]="QUERY_RESULT_AVAILABLE",e[e["ANY_SAMPLES_PASSED"]=35887]="ANY_SAMPLES_PASSED",e[e["ANY_SAMPLES_PASSED_CONSERVATIVE"]=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",e[e["MAX_DRAW_BUFFERS"]=34852]="MAX_DRAW_BUFFERS",e[e["DRAW_BUFFER0"]=34853]="DRAW_BUFFER0",e[e["DRAW_BUFFER1"]=34854]="DRAW_BUFFER1",e[e["DRAW_BUFFER2"]=34855]="DRAW_BUFFER2",e[e["DRAW_BUFFER3"]=34856]="DRAW_BUFFER3",e[e["DRAW_BUFFER4"]=34857]="DRAW_BUFFER4",e[e["DRAW_BUFFER5"]=34858]="DRAW_BUFFER5",e[e["DRAW_BUFFER6"]=34859]="DRAW_BUFFER6",e[e["DRAW_BUFFER7"]=34860]="DRAW_BUFFER7",e[e["DRAW_BUFFER8"]=34861]="DRAW_BUFFER8",e[e["DRAW_BUFFER9"]=34862]="DRAW_BUFFER9",e[e["DRAW_BUFFER10"]=34863]="DRAW_BUFFER10",e[e["DRAW_BUFFER11"]=34864]="DRAW_BUFFER11",e[e["DRAW_BUFFER12"]=34865]="DRAW_BUFFER12",e[e["DRAW_BUFFER13"]=34866]="DRAW_BUFFER13",e[e["DRAW_BUFFER14"]=34867]="DRAW_BUFFER14",e[e["DRAW_BUFFER15"]=34868]="DRAW_BUFFER15",e[e["MAX_COLOR_ATTACHMENTS"]=36063]="MAX_COLOR_ATTACHMENTS",e[e["COLOR_ATTACHMENT1"]=36065]="COLOR_ATTACHMENT1",e[e["COLOR_ATTACHMENT2"]=36066]="COLOR_ATTACHMENT2",e[e["COLOR_ATTACHMENT3"]=36067]="COLOR_ATTACHMENT3",e[e["COLOR_ATTACHMENT4"]=36068]="COLOR_ATTACHMENT4",e[e["COLOR_ATTACHMENT5"]=36069]="COLOR_ATTACHMENT5",e[e["COLOR_ATTACHMENT6"]=36070]="COLOR_ATTACHMENT6",e[e["COLOR_ATTACHMENT7"]=36071]="COLOR_ATTACHMENT7",e[e["COLOR_ATTACHMENT8"]=36072]="COLOR_ATTACHMENT8",e[e["COLOR_ATTACHMENT9"]=36073]="COLOR_ATTACHMENT9",e[e["COLOR_ATTACHMENT10"]=36074]="COLOR_ATTACHMENT10",e[e["COLOR_ATTACHMENT11"]=36075]="COLOR_ATTACHMENT11",e[e["COLOR_ATTACHMENT12"]=36076]="COLOR_ATTACHMENT12",e[e["COLOR_ATTACHMENT13"]=36077]="COLOR_ATTACHMENT13",e[e["COLOR_ATTACHMENT14"]=36078]="COLOR_ATTACHMENT14",e[e["COLOR_ATTACHMENT15"]=36079]="COLOR_ATTACHMENT15",e[e["SAMPLER_3D"]=35679]="SAMPLER_3D",e[e["SAMPLER_2D_SHADOW"]=35682]="SAMPLER_2D_SHADOW",e[e["SAMPLER_2D_ARRAY"]=36289]="SAMPLER_2D_ARRAY",e[e["SAMPLER_2D_ARRAY_SHADOW"]=36292]="SAMPLER_2D_ARRAY_SHADOW",e[e["SAMPLER_CUBE_SHADOW"]=36293]="SAMPLER_CUBE_SHADOW",e[e["INT_SAMPLER_2D"]=36298]="INT_SAMPLER_2D",e[e["INT_SAMPLER_3D"]=36299]="INT_SAMPLER_3D",e[e["INT_SAMPLER_CUBE"]=36300]="INT_SAMPLER_CUBE",e[e["INT_SAMPLER_2D_ARRAY"]=36303]="INT_SAMPLER_2D_ARRAY",e[e["UNSIGNED_INT_SAMPLER_2D"]=36306]="UNSIGNED_INT_SAMPLER_2D",e[e["UNSIGNED_INT_SAMPLER_3D"]=36307]="UNSIGNED_INT_SAMPLER_3D",e[e["UNSIGNED_INT_SAMPLER_CUBE"]=36308]="UNSIGNED_INT_SAMPLER_CUBE",e[e["UNSIGNED_INT_SAMPLER_2D_ARRAY"]=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",e[e["MAX_SAMPLES"]=36183]="MAX_SAMPLES",e[e["SAMPLER_BINDING"]=35097]="SAMPLER_BINDING",e[e["PIXEL_PACK_BUFFER"]=35051]="PIXEL_PACK_BUFFER",e[e["PIXEL_UNPACK_BUFFER"]=35052]="PIXEL_UNPACK_BUFFER",e[e["PIXEL_PACK_BUFFER_BINDING"]=35053]="PIXEL_PACK_BUFFER_BINDING",e[e["PIXEL_UNPACK_BUFFER_BINDING"]=35055]="PIXEL_UNPACK_BUFFER_BINDING",e[e["COPY_READ_BUFFER"]=36662]="COPY_READ_BUFFER",e[e["COPY_WRITE_BUFFER"]=36663]="COPY_WRITE_BUFFER",e[e["COPY_READ_BUFFER_BINDING"]=36662]="COPY_READ_BUFFER_BINDING",e[e["COPY_WRITE_BUFFER_BINDING"]=36663]="COPY_WRITE_BUFFER_BINDING",e[e["FLOAT_MAT2x3"]=35685]="FLOAT_MAT2x3",e[e["FLOAT_MAT2x4"]=35686]="FLOAT_MAT2x4",e[e["FLOAT_MAT3x2"]=35687]="FLOAT_MAT3x2",e[e["FLOAT_MAT3x4"]=35688]="FLOAT_MAT3x4",e[e["FLOAT_MAT4x2"]=35689]="FLOAT_MAT4x2",e[e["FLOAT_MAT4x3"]=35690]="FLOAT_MAT4x3",e[e["UNSIGNED_INT_VEC2"]=36294]="UNSIGNED_INT_VEC2",e[e["UNSIGNED_INT_VEC3"]=36295]="UNSIGNED_INT_VEC3",e[e["UNSIGNED_INT_VEC4"]=36296]="UNSIGNED_INT_VEC4",e[e["UNSIGNED_NORMALIZED"]=35863]="UNSIGNED_NORMALIZED",e[e["SIGNED_NORMALIZED"]=36764]="SIGNED_NORMALIZED",e[e["VERTEX_ATTRIB_ARRAY_INTEGER"]=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",e[e["VERTEX_ATTRIB_ARRAY_DIVISOR"]=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",e[e["TRANSFORM_FEEDBACK_BUFFER_MODE"]=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",e[e["MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS"]=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",e[e["TRANSFORM_FEEDBACK_VARYINGS"]=35971]="TRANSFORM_FEEDBACK_VARYINGS",e[e["TRANSFORM_FEEDBACK_BUFFER_START"]=35972]="TRANSFORM_FEEDBACK_BUFFER_START",e[e["TRANSFORM_FEEDBACK_BUFFER_SIZE"]=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",e[e["TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN"]=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",e[e["MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS"]=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",e[e["MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS"]=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",e[e["INTERLEAVED_ATTRIBS"]=35980]="INTERLEAVED_ATTRIBS",e[e["SEPARATE_ATTRIBS"]=35981]="SEPARATE_ATTRIBS",e[e["TRANSFORM_FEEDBACK_BUFFER"]=35982]="TRANSFORM_FEEDBACK_BUFFER",e[e["TRANSFORM_FEEDBACK_BUFFER_BINDING"]=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",e[e["TRANSFORM_FEEDBACK"]=36386]="TRANSFORM_FEEDBACK",e[e["TRANSFORM_FEEDBACK_PAUSED"]=36387]="TRANSFORM_FEEDBACK_PAUSED",e[e["TRANSFORM_FEEDBACK_ACTIVE"]=36388]="TRANSFORM_FEEDBACK_ACTIVE",e[e["TRANSFORM_FEEDBACK_BINDING"]=36389]="TRANSFORM_FEEDBACK_BINDING",e[e["FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING"]=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",e[e["FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE"]=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",e[e["FRAMEBUFFER_ATTACHMENT_RED_SIZE"]=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",e[e["FRAMEBUFFER_ATTACHMENT_GREEN_SIZE"]=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",e[e["FRAMEBUFFER_ATTACHMENT_BLUE_SIZE"]=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",e[e["FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE"]=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",e[e["FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE"]=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",e[e["FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE"]=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",e[e["FRAMEBUFFER_DEFAULT"]=33304]="FRAMEBUFFER_DEFAULT",e[e["DEPTH24_STENCIL8"]=35056]="DEPTH24_STENCIL8",e[e["DRAW_FRAMEBUFFER_BINDING"]=36006]="DRAW_FRAMEBUFFER_BINDING",e[e["READ_FRAMEBUFFER_BINDING"]=36010]="READ_FRAMEBUFFER_BINDING",e[e["RENDERBUFFER_SAMPLES"]=36011]="RENDERBUFFER_SAMPLES",e[e["FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER"]=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",e[e["FRAMEBUFFER_INCOMPLETE_MULTISAMPLE"]=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",e[e["UNIFORM_BUFFER"]=35345]="UNIFORM_BUFFER",e[e["UNIFORM_BUFFER_BINDING"]=35368]="UNIFORM_BUFFER_BINDING",e[e["UNIFORM_BUFFER_START"]=35369]="UNIFORM_BUFFER_START",e[e["UNIFORM_BUFFER_SIZE"]=35370]="UNIFORM_BUFFER_SIZE",e[e["MAX_VERTEX_UNIFORM_BLOCKS"]=35371]="MAX_VERTEX_UNIFORM_BLOCKS",e[e["MAX_FRAGMENT_UNIFORM_BLOCKS"]=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",e[e["MAX_COMBINED_UNIFORM_BLOCKS"]=35374]="MAX_COMBINED_UNIFORM_BLOCKS",e[e["MAX_UNIFORM_BUFFER_BINDINGS"]=35375]="MAX_UNIFORM_BUFFER_BINDINGS",e[e["MAX_UNIFORM_BLOCK_SIZE"]=35376]="MAX_UNIFORM_BLOCK_SIZE",e[e["MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS"]=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",e[e["MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS"]=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",e[e["UNIFORM_BUFFER_OFFSET_ALIGNMENT"]=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",e[e["ACTIVE_UNIFORM_BLOCKS"]=35382]="ACTIVE_UNIFORM_BLOCKS",e[e["UNIFORM_TYPE"]=35383]="UNIFORM_TYPE",e[e["UNIFORM_SIZE"]=35384]="UNIFORM_SIZE",e[e["UNIFORM_BLOCK_INDEX"]=35386]="UNIFORM_BLOCK_INDEX",e[e["UNIFORM_OFFSET"]=35387]="UNIFORM_OFFSET",e[e["UNIFORM_ARRAY_STRIDE"]=35388]="UNIFORM_ARRAY_STRIDE",e[e["UNIFORM_MATRIX_STRIDE"]=35389]="UNIFORM_MATRIX_STRIDE",e[e["UNIFORM_IS_ROW_MAJOR"]=35390]="UNIFORM_IS_ROW_MAJOR",e[e["UNIFORM_BLOCK_BINDING"]=35391]="UNIFORM_BLOCK_BINDING",e[e["UNIFORM_BLOCK_DATA_SIZE"]=35392]="UNIFORM_BLOCK_DATA_SIZE",e[e["UNIFORM_BLOCK_ACTIVE_UNIFORMS"]=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",e[e["UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES"]=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",e[e["UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER"]=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",e[e["UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER"]=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",e[e["OBJECT_TYPE"]=37138]="OBJECT_TYPE",e[e["SYNC_CONDITION"]=37139]="SYNC_CONDITION",e[e["SYNC_STATUS"]=37140]="SYNC_STATUS",e[e["SYNC_FLAGS"]=37141]="SYNC_FLAGS",e[e["SYNC_FENCE"]=37142]="SYNC_FENCE",e[e["SYNC_GPU_COMMANDS_COMPLETE"]=37143]="SYNC_GPU_COMMANDS_COMPLETE",e[e["UNSIGNALED"]=37144]="UNSIGNALED",e[e["SIGNALED"]=37145]="SIGNALED",e[e["ALREADY_SIGNALED"]=37146]="ALREADY_SIGNALED",e[e["TIMEOUT_EXPIRED"]=37147]="TIMEOUT_EXPIRED",e[e["CONDITION_SATISFIED"]=37148]="CONDITION_SATISFIED",e[e["WAIT_FAILED"]=37149]="WAIT_FAILED",e[e["SYNC_FLUSH_COMMANDS_BIT"]=1]="SYNC_FLUSH_COMMANDS_BIT",e[e["COLOR"]=6144]="COLOR",e[e["DEPTH"]=6145]="DEPTH",e[e["STENCIL"]=6146]="STENCIL",e[e["MIN"]=32775]="MIN",e[e["MAX"]=32776]="MAX",e[e["DEPTH_COMPONENT24"]=33190]="DEPTH_COMPONENT24",e[e["STREAM_READ"]=35041]="STREAM_READ",e[e["STREAM_COPY"]=35042]="STREAM_COPY",e[e["STATIC_READ"]=35045]="STATIC_READ",e[e["STATIC_COPY"]=35046]="STATIC_COPY",e[e["DYNAMIC_READ"]=35049]="DYNAMIC_READ",e[e["DYNAMIC_COPY"]=35050]="DYNAMIC_COPY",e[e["DEPTH_COMPONENT32F"]=36012]="DEPTH_COMPONENT32F",e[e["DEPTH32F_STENCIL8"]=36013]="DEPTH32F_STENCIL8",e[e["INVALID_INDEX"]=4294967295]="INVALID_INDEX",e[e["TIMEOUT_IGNORED"]=-1]="TIMEOUT_IGNORED",e[e["MAX_CLIENT_WAIT_TIMEOUT_WEBGL"]=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",e[e["VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE"]=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE",e[e["UNMASKED_VENDOR_WEBGL"]=37445]="UNMASKED_VENDOR_WEBGL",e[e["UNMASKED_RENDERER_WEBGL"]=37446]="UNMASKED_RENDERER_WEBGL",e[e["MAX_TEXTURE_MAX_ANISOTROPY_EXT"]=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",e[e["TEXTURE_MAX_ANISOTROPY_EXT"]=34046]="TEXTURE_MAX_ANISOTROPY_EXT",e[e["COMPRESSED_RGB_S3TC_DXT1_EXT"]=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e["COMPRESSED_RGBA_S3TC_DXT1_EXT"]=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e["COMPRESSED_RGBA_S3TC_DXT3_EXT"]=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e["COMPRESSED_RGBA_S3TC_DXT5_EXT"]=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e["COMPRESSED_R11_EAC"]=37488]="COMPRESSED_R11_EAC",e[e["COMPRESSED_SIGNED_R11_EAC"]=37489]="COMPRESSED_SIGNED_R11_EAC",e[e["COMPRESSED_RG11_EAC"]=37490]="COMPRESSED_RG11_EAC",e[e["COMPRESSED_SIGNED_RG11_EAC"]=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e["COMPRESSED_RGB8_ETC2"]=37492]="COMPRESSED_RGB8_ETC2",e[e["COMPRESSED_RGBA8_ETC2_EAC"]=37493]="COMPRESSED_RGBA8_ETC2_EAC",e[e["COMPRESSED_SRGB8_ETC2"]=37494]="COMPRESSED_SRGB8_ETC2",e[e["COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"]=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e["COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2"]=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e["COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2"]=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e["COMPRESSED_RGB_PVRTC_4BPPV1_IMG"]=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e["COMPRESSED_RGBA_PVRTC_4BPPV1_IMG"]=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e["COMPRESSED_RGB_PVRTC_2BPPV1_IMG"]=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e["COMPRESSED_RGBA_PVRTC_2BPPV1_IMG"]=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e["COMPRESSED_RGB_ETC1_WEBGL"]=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e["COMPRESSED_RGB_ATC_WEBGL"]=35986]="COMPRESSED_RGB_ATC_WEBGL",e[e["COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL"]=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",e[e["COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL"]=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",e[e["UNSIGNED_INT_24_8_WEBGL"]=34042]="UNSIGNED_INT_24_8_WEBGL",e[e["HALF_FLOAT_OES"]=36193]="HALF_FLOAT_OES",e[e["RGBA32F_EXT"]=34836]="RGBA32F_EXT",e[e["RGB32F_EXT"]=34837]="RGB32F_EXT",e[e["FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT"]=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e["UNSIGNED_NORMALIZED_EXT"]=35863]="UNSIGNED_NORMALIZED_EXT",e[e["MIN_EXT"]=32775]="MIN_EXT",e[e["MAX_EXT"]=32776]="MAX_EXT",e[e["SRGB_EXT"]=35904]="SRGB_EXT",e[e["SRGB_ALPHA_EXT"]=35906]="SRGB_ALPHA_EXT",e[e["SRGB8_ALPHA8_EXT"]=35907]="SRGB8_ALPHA8_EXT",e[e["FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT"]=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT",e[e["FRAGMENT_SHADER_DERIVATIVE_HINT_OES"]=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT_OES",e[e["COLOR_ATTACHMENT0_WEBGL"]=36064]="COLOR_ATTACHMENT0_WEBGL",e[e["COLOR_ATTACHMENT1_WEBGL"]=36065]="COLOR_ATTACHMENT1_WEBGL",e[e["COLOR_ATTACHMENT2_WEBGL"]=36066]="COLOR_ATTACHMENT2_WEBGL",e[e["COLOR_ATTACHMENT3_WEBGL"]=36067]="COLOR_ATTACHMENT3_WEBGL",e[e["COLOR_ATTACHMENT4_WEBGL"]=36068]="COLOR_ATTACHMENT4_WEBGL",e[e["COLOR_ATTACHMENT5_WEBGL"]=36069]="COLOR_ATTACHMENT5_WEBGL",e[e["COLOR_ATTACHMENT6_WEBGL"]=36070]="COLOR_ATTACHMENT6_WEBGL",e[e["COLOR_ATTACHMENT7_WEBGL"]=36071]="COLOR_ATTACHMENT7_WEBGL",e[e["COLOR_ATTACHMENT8_WEBGL"]=36072]="COLOR_ATTACHMENT8_WEBGL",e[e["COLOR_ATTACHMENT9_WEBGL"]=36073]="COLOR_ATTACHMENT9_WEBGL",e[e["COLOR_ATTACHMENT10_WEBGL"]=36074]="COLOR_ATTACHMENT10_WEBGL",e[e["COLOR_ATTACHMENT11_WEBGL"]=36075]="COLOR_ATTACHMENT11_WEBGL",e[e["COLOR_ATTACHMENT12_WEBGL"]=36076]="COLOR_ATTACHMENT12_WEBGL",e[e["COLOR_ATTACHMENT13_WEBGL"]=36077]="COLOR_ATTACHMENT13_WEBGL",e[e["COLOR_ATTACHMENT14_WEBGL"]=36078]="COLOR_ATTACHMENT14_WEBGL",e[e["COLOR_ATTACHMENT15_WEBGL"]=36079]="COLOR_ATTACHMENT15_WEBGL",e[e["DRAW_BUFFER0_WEBGL"]=34853]="DRAW_BUFFER0_WEBGL",e[e["DRAW_BUFFER1_WEBGL"]=34854]="DRAW_BUFFER1_WEBGL",e[e["DRAW_BUFFER2_WEBGL"]=34855]="DRAW_BUFFER2_WEBGL",e[e["DRAW_BUFFER3_WEBGL"]=34856]="DRAW_BUFFER3_WEBGL",e[e["DRAW_BUFFER4_WEBGL"]=34857]="DRAW_BUFFER4_WEBGL",e[e["DRAW_BUFFER5_WEBGL"]=34858]="DRAW_BUFFER5_WEBGL",e[e["DRAW_BUFFER6_WEBGL"]=34859]="DRAW_BUFFER6_WEBGL",e[e["DRAW_BUFFER7_WEBGL"]=34860]="DRAW_BUFFER7_WEBGL",e[e["DRAW_BUFFER8_WEBGL"]=34861]="DRAW_BUFFER8_WEBGL",e[e["DRAW_BUFFER9_WEBGL"]=34862]="DRAW_BUFFER9_WEBGL",e[e["DRAW_BUFFER10_WEBGL"]=34863]="DRAW_BUFFER10_WEBGL",e[e["DRAW_BUFFER11_WEBGL"]=34864]="DRAW_BUFFER11_WEBGL",e[e["DRAW_BUFFER12_WEBGL"]=34865]="DRAW_BUFFER12_WEBGL",e[e["DRAW_BUFFER13_WEBGL"]=34866]="DRAW_BUFFER13_WEBGL",e[e["DRAW_BUFFER14_WEBGL"]=34867]="DRAW_BUFFER14_WEBGL",e[e["DRAW_BUFFER15_WEBGL"]=34868]="DRAW_BUFFER15_WEBGL",e[e["MAX_COLOR_ATTACHMENTS_WEBGL"]=36063]="MAX_COLOR_ATTACHMENTS_WEBGL",e[e["MAX_DRAW_BUFFERS_WEBGL"]=34852]="MAX_DRAW_BUFFERS_WEBGL",e[e["VERTEX_ARRAY_BINDING_OES"]=34229]="VERTEX_ARRAY_BINDING_OES",e[e["QUERY_COUNTER_BITS_EXT"]=34916]="QUERY_COUNTER_BITS_EXT",e[e["CURRENT_QUERY_EXT"]=34917]="CURRENT_QUERY_EXT",e[e["QUERY_RESULT_EXT"]=34918]="QUERY_RESULT_EXT",e[e["QUERY_RESULT_AVAILABLE_EXT"]=34919]="QUERY_RESULT_AVAILABLE_EXT",e[e["TIME_ELAPSED_EXT"]=35007]="TIME_ELAPSED_EXT",e[e["TIMESTAMP_EXT"]=36392]="TIMESTAMP_EXT",e[e["GPU_DISJOINT_EXT"]=36795]="GPU_DISJOINT_EXT"}(Te||(Te={}));var ke=Ue(0,0,0,0),Ge=Ue(0,0,0,1),we=Ue(1,1,1,0),We=Ue(1,1,1,1);function Xe(e){return e&&0===(e&e-1)}function Ve(e,t){return null!==e&&void 0!==e?e:t}function He(e){return void 0===e?null:e}function Ye(e,t,r){e.length=t,e.fill(r)}function Ke(e,t){var r=t-1;return e+r&~r}function ze(e,t){return((e+t-1)/t|0)*t}function qe(e,t,r){var n=0,i=e.length;while(n<i){var a=n+(i-n>>>1),o=r(t,e[a]);o<0?i=a:n=a+1}return n}function Ze(e,t,r){var n=qe(e,t,r);e.splice(n,0,t)}function je(e,t,r){return r?e|=t:e&=~t,e}function Qe(e,t){for(var r=new Array(e),n=0;n<e;n++)r[n]=t();return r}function Je(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=e.split("\n");return r.map((function(e,r){return"".concat($e(""+(t+r),4," "),"  ").concat(e)})).join("\n")}function $e(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"0";while(e.length<t)e="".concat(r).concat(e);return e}function et(e,t){e.blendDstFactor=t.blendDstFactor,e.blendSrcFactor=t.blendSrcFactor,e.blendMode=t.blendMode}function tt(e,t){return void 0===e&&(e={rgbBlendState:{},alphaBlendState:{},channelWriteMask:0}),et(e.rgbBlendState,t.rgbBlendState),et(e.alphaBlendState,t.alphaBlendState),e.channelWriteMask=t.channelWriteMask,e}function rt(e,t){e.length!==t.length&&(e.length=t.length);for(var r=0;r<t.length;r++)e[r]=tt(e[r],t[r])}function nt(e,t){void 0!==t.attachmentsState&&rt(e.attachmentsState,t.attachmentsState),void 0!==t.blendConstant&&be(e.blendConstant,t.blendConstant),e.depthCompare=Ve(t.depthCompare,e.depthCompare),e.depthWrite=Ve(t.depthWrite,e.depthWrite),e.stencilCompare=Ve(t.stencilCompare,e.stencilCompare),e.stencilWrite=Ve(t.stencilWrite,e.stencilWrite),e.stencilPassOp=Ve(t.stencilPassOp,e.stencilPassOp),e.stencilRef=Ve(t.stencilRef,e.stencilRef),e.cullMode=Ve(t.cullMode,e.cullMode),e.frontFace=Ve(t.frontFace,e.frontFace),e.polygonOffset=Ve(t.polygonOffset,e.polygonOffset)}function it(e){var t=Object.assign({},e);return t.attachmentsState=[],rt(t.attachmentsState,e.attachmentsState),t.blendConstant=Le(t.blendConstant),t}function at(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ct,r=it(t);return null!==e&&nt(r,e),r}function ot(e,t){void 0!==t.channelWriteMask&&(e.channelWriteMask=t.channelWriteMask),void 0!==t.rgbBlendMode&&(e.rgbBlendState.blendMode=t.rgbBlendMode),void 0!==t.alphaBlendMode&&(e.alphaBlendState.blendMode=t.alphaBlendMode),void 0!==t.rgbBlendSrcFactor&&(e.rgbBlendState.blendSrcFactor=t.rgbBlendSrcFactor),void 0!==t.alphaBlendSrcFactor&&(e.alphaBlendState.blendSrcFactor=t.alphaBlendSrcFactor),void 0!==t.rgbBlendDstFactor&&(e.rgbBlendState.blendDstFactor=t.rgbBlendDstFactor),void 0!==t.alphaBlendDstFactor&&(e.alphaBlendState.blendDstFactor=t.alphaBlendDstFactor)}function st(e,t){return void 0===e.attachmentsState&&(e.attachmentsState=[],rt(e.attachmentsState,ct.attachmentsState)),ot(e.attachmentsState[0],t),e}var ut,lt={blendMode:J.Add,blendSrcFactor:Q.One,blendDstFactor:Q.Zero},ct={attachmentsState:[{channelWriteMask:ue.RGB,rgbBlendState:lt,alphaBlendState:lt}],blendConstant:Le(ke),depthWrite:!0,depthCompare:q.LessEqual,stencilCompare:q.Always,stencilWrite:!1,stencilPassOp:le.Keep,stencilRef:0,cullMode:j.None,frontFace:Z.CCW,polygonOffset:!1};at({depthCompare:q.Always,depthWrite:!1},ct);function ft(e,t,r){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!r(e[n],t[n]))return!1;return!0}function dt(e,t){for(var r=Array(e.length),n=0;n<e.length;n++)r[n]=t(e[n]);return r}function ht(e,t){return e.buffer===t.buffer&&e.wordCount===t.wordCount}function _t(e,t){return null===e?null===t:null!==t&&(e.sampler===t.sampler&&e.texture===t.texture)}function pt(e,t){return e.numSamplers===t.numSamplers&&e.numUniformBuffers===t.numUniformBuffers}function vt(e,t){return e.samplerBindings.length===t.samplerBindings.length&&(!!ft(e.samplerBindings,t.samplerBindings,_t)&&(!!ft(e.uniformBufferBindings,t.uniformBufferBindings,ht)&&!!Tt(e.bindingLayout,t.bindingLayout)))}function Et(e,t){return e.blendMode==t.blendMode&&e.blendSrcFactor===t.blendSrcFactor&&e.blendDstFactor===t.blendDstFactor}function Rt(e,t){return!!Et(e.rgbBlendState,t.rgbBlendState)&&(!!Et(e.alphaBlendState,t.alphaBlendState)&&e.channelWriteMask===t.channelWriteMask)}function gt(e,t){return!!ft(e.attachmentsState,t.attachmentsState,Rt)&&(!!Me(e.blendConstant,t.blendConstant)&&(e.depthCompare===t.depthCompare&&e.depthWrite===t.depthWrite&&e.stencilCompare===t.stencilCompare&&e.stencilWrite===t.stencilWrite&&e.stencilPassOp===t.stencilPassOp&&e.stencilRef===t.stencilRef&&e.cullMode===t.cullMode&&e.frontFace===t.frontFace&&e.polygonOffset===t.polygonOffset))}function Tt(e,t){return e.numSamplers===t.numSamplers&&e.numUniformBuffers===t.numUniformBuffers}function mt(e,t){return e.id===t.id}function At(e,t){return e===t}function St(e,t){return e.topology===t.topology&&(e.inputLayout===t.inputLayout&&(e.sampleCount===t.sampleCount&&(!!gt(e.megaStateDescriptor,t.megaStateDescriptor)&&(!!mt(e.program,t.program)&&(!!ft(e.bindingLayouts,t.bindingLayouts,Tt)&&(!!ft(e.colorAttachmentFormats,t.colorAttachmentFormats,At)&&e.depthStencilAttachmentFormat===t.depthStencilAttachmentFormat))))))}function yt(e,t){return e.bufferIndex===t.bufferIndex&&e.bufferByteOffset===t.bufferByteOffset&&e.location===t.location&&e.format===t.format}function Ct(e,t){return(0,s.UM)(e)?(0,s.UM)(t):!(0,s.UM)(t)&&(e.byteStride===t.byteStride&&e.frequency===t.frequency)}function Bt(e,t){return e.indexBufferFormat===t.indexBufferFormat&&(!!ft(e.vertexBufferDescriptors,t.vertexBufferDescriptors,Ct)&&!!ft(e.vertexAttributeDescriptors,t.vertexAttributeDescriptors,yt))}function Ot(e,t){return e.wrapS===t.wrapS&&e.wrapT===t.wrapT&&e.minFilter===t.minFilter&&e.magFilter===t.magFilter&&e.mipFilter===t.mipFilter&&e.minLOD===t.minLOD&&e.maxLOD===t.maxLOD}function xt(e){var t=e.sampler,r=e.texture,n=e.lateBinding;return{sampler:t,texture:r,lateBinding:n}}function Dt(e){var t=e.buffer,r=e.wordCount;return{buffer:t,wordCount:r}}function Nt(e){var t=e.bindingLayout,r=dt(e.samplerBindings,xt),n=dt(e.uniformBufferBindings,Dt);return{bindingLayout:t,samplerBindings:r,uniformBufferBindings:n,pipeline:e.pipeline}}function Ft(e){var t=e.dimension,r=e.formatKind;return{dimension:t,formatKind:r}}function Pt(e){var t=e.numSamplers,r=e.numUniformBuffers,n=void 0!==e.samplerEntries?dt(e.samplerEntries,Ft):void 0;return{numSamplers:t,numUniformBuffers:r,samplerEntries:n}}function It(e){var t=dt(e.bindingLayouts,Pt),r=e.inputLayout,n=e.program,i=e.topology,a=it(e.megaStateDescriptor),o=e.colorAttachmentFormats.slice(),s=e.depthStencilAttachmentFormat,u=e.sampleCount;return{bindingLayouts:t,inputLayout:r,megaStateDescriptor:a,program:n,topology:i,colorAttachmentFormats:o,depthStencilAttachmentFormat:s,sampleCount:u}}function Mt(e){var t=e.location,r=e.format,n=e.bufferIndex,i=e.bufferByteOffset,a=e.byteStride,o=e.divisor;return{location:t,format:r,bufferIndex:n,bufferByteOffset:i,byteStride:a,divisor:o}}function bt(e){if((0,s.UM)(e))return e;var t=e.byteStride,r=e.frequency;return{byteStride:t,frequency:r}}function Lt(e){var t=dt(e.vertexAttributeDescriptors,Mt),r=dt(e.vertexBufferDescriptors,bt),n=e.indexBufferFormat;return{vertexAttributeDescriptors:t,vertexBufferDescriptors:r,indexBufferFormat:n}}(function(e){e[e["LITTLE_ENDIAN"]=0]="LITTLE_ENDIAN",e[e["BIG_ENDIAN"]=1]="BIG_ENDIAN"})(ut||(ut={}));var Ut,kt=new Uint16Array([65279]),Gt=new DataView(kt.buffer),wt=(255==Gt.getUint8(0)?ut.LITTLE_ENDIAN:ut.BIG_ENDIAN,/([^[]*)(\[[0-9]+\])?/);function Wt(e){if("]"!==e[e.length-1])return{name:e,length:1,isArray:!1};var t=e.match(wt);if(!t||t.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(e));return{name:t[1],length:Number(t[2])||1,isArray:Boolean(t[2])}}function Xt(e,t,r){var n=tr[r.type];if(!n)throw new Error("Unknown GLSL uniform type ".concat(r.type));return n().bind(null,e,t)}function Vt(){var e=null;return function(t,r,n){var i=e!==n;return i&&(t.uniform1i(r,n),e=n),i}}function Ht(e,t,r,n){var i=null,a=null;return function(o,s,u){var l=t(u,r),c=l.length,f=!1;if(null===i)i=new Float32Array(c),a=c,f=!0;else{Pe(a===c,"Uniform length cannot change.");for(var d=0;d<c;++d)if(l[d]!==i[d]){f=!0;break}}return f&&(n(o,e,s,l),i.set(l)),f}}function Yt(e,t,r,n){e[t](r,n)}function Kt(e,t,r,n){e[t](r,!1,n)}var zt={},qt={},Zt={},jt=[0];function Qt(e,t,r,n){1===t&&"boolean"===typeof e&&(e=e?1:0),Number.isFinite(e)&&(jt[0]=e,e=jt);var i=e.length;if(e instanceof r)return e;var a=n[i];a||(a=new r(i),n[i]=a);for(var o=0;o<i;o++)a[o]=e[o];return a}function Jt(e,t){return Qt(e,t,Float32Array,zt)}function $t(e,t){return Qt(e,t,Int32Array,qt)}function er(e,t){return Qt(e,t,Uint32Array,Zt)}var tr=(Ut={},A(Ut,Te.FLOAT,Ht.bind(null,"uniform1fv",Jt,1,Yt)),A(Ut,Te.FLOAT_VEC2,Ht.bind(null,"uniform2fv",Jt,2,Yt)),A(Ut,Te.FLOAT_VEC3,Ht.bind(null,"uniform3fv",Jt,3,Yt)),A(Ut,Te.FLOAT_VEC4,Ht.bind(null,"uniform4fv",Jt,4,Yt)),A(Ut,Te.INT,Ht.bind(null,"uniform1iv",$t,1,Yt)),A(Ut,Te.INT_VEC2,Ht.bind(null,"uniform2iv",$t,2,Yt)),A(Ut,Te.INT_VEC3,Ht.bind(null,"uniform3iv",$t,3,Yt)),A(Ut,Te.INT_VEC4,Ht.bind(null,"uniform4iv",$t,4,Yt)),A(Ut,Te.BOOL,Ht.bind(null,"uniform1iv",$t,1,Yt)),A(Ut,Te.BOOL_VEC2,Ht.bind(null,"uniform2iv",$t,2,Yt)),A(Ut,Te.BOOL_VEC3,Ht.bind(null,"uniform3iv",$t,3,Yt)),A(Ut,Te.BOOL_VEC4,Ht.bind(null,"uniform4iv",$t,4,Yt)),A(Ut,Te.FLOAT_MAT2,Ht.bind(null,"uniformMatrix2fv",Jt,4,Kt)),A(Ut,Te.FLOAT_MAT3,Ht.bind(null,"uniformMatrix3fv",Jt,9,Kt)),A(Ut,Te.FLOAT_MAT4,Ht.bind(null,"uniformMatrix4fv",Jt,16,Kt)),A(Ut,Te.SAMPLER_2D,Vt),A(Ut,Te.SAMPLER_CUBE,Vt),A(Ut,Te.UNSIGNED_INT,Ht.bind(null,"uniform1uiv",er,1,Yt)),A(Ut,Te.UNSIGNED_INT_VEC2,Ht.bind(null,"uniform2uiv",er,2,Yt)),A(Ut,Te.UNSIGNED_INT_VEC3,Ht.bind(null,"uniform3uiv",er,3,Yt)),A(Ut,Te.UNSIGNED_INT_VEC4,Ht.bind(null,"uniform4uiv",er,4,Yt)),A(Ut,Te.FLOAT_MAT2x3,Ht.bind(null,"uniformMatrix2x3fv",Jt,6,Kt)),A(Ut,Te.FLOAT_MAT2x4,Ht.bind(null,"uniformMatrix2x4fv",Jt,8,Kt)),A(Ut,Te.FLOAT_MAT3x2,Ht.bind(null,"uniformMatrix3x2fv",Jt,6,Kt)),A(Ut,Te.FLOAT_MAT3x4,Ht.bind(null,"uniformMatrix3x4fv",Jt,12,Kt)),A(Ut,Te.FLOAT_MAT4x2,Ht.bind(null,"uniformMatrix4x2fv",Jt,8,Kt)),A(Ut,Te.FLOAT_MAT4x3,Ht.bind(null,"uniformMatrix4x3fv",Jt,12,Kt)),A(Ut,Te.SAMPLER_2D,Vt),A(Ut,Te.SAMPLER_CUBE,Vt),A(Ut,Te.SAMPLER_3D,Vt),A(Ut,Te.SAMPLER_2D_SHADOW,Vt),A(Ut,Te.SAMPLER_2D_ARRAY,Vt),A(Ut,Te.SAMPLER_2D_ARRAY_SHADOW,Vt),A(Ut,Te.SAMPLER_CUBE_SHADOW,Vt),A(Ut,Te.INT_SAMPLER_2D,Vt),A(Ut,Te.INT_SAMPLER_3D,Vt),A(Ut,Te.INT_SAMPLER_CUBE,Vt),A(Ut,Te.INT_SAMPLER_2D_ARRAY,Vt),A(Ut,Te.UNSIGNED_INT_SAMPLER_2D,Vt),A(Ut,Te.UNSIGNED_INT_SAMPLER_3D,Vt),A(Ut,Te.UNSIGNED_INT_SAMPLER_CUBE,Vt),A(Ut,Te.UNSIGNED_INT_SAMPLER_2D_ARRAY,Vt),Ut),rr=function(){function e(t){g(this,e),this.device=void 0,this.uniformBufferWordAlignment=void 0,this.uniformBufferMaxPageWordSize=void 0,this.currentBufferWordSize=-1,this.currentWordOffset=0,this.buffer=null,this.shadowBufferF32=null,this.shadowBufferU8=null,this.device=t;var r=t.queryLimits();this.uniformBufferWordAlignment=r.uniformBufferWordAlignment,this.uniformBufferMaxPageWordSize=r.uniformBufferMaxPageWordSize}return m(e,[{key:"isSupportedUBO",value:function(){return"WebGL1"!==this.device.queryVendorInfo().platformString}},{key:"findPageIndex",value:function(e){return e/this.uniformBufferMaxPageWordSize|0}},{key:"allocateChunk",value:function(e){e=ze(e,this.uniformBufferWordAlignment),Pe(e<this.uniformBufferMaxPageWordSize);var t=this.currentWordOffset;return this.findPageIndex(t)!==this.findPageIndex(t+e-1)&&(t=ze(t,this.uniformBufferMaxPageWordSize)),this.currentWordOffset=t+e,this.ensureShadowBuffer(t,e),t}},{key:"ensureShadowBuffer",value:function(e,t){if(null===this.shadowBufferU8||null===this.shadowBufferF32){var r=ze(this.currentWordOffset,this.uniformBufferMaxPageWordSize);this.shadowBufferU8=new Uint8Array(4*r),this.shadowBufferF32=new Float32Array(this.shadowBufferU8.buffer)}else if(e+t>=this.shadowBufferF32.length){Pe(e<this.currentWordOffset&&e+t<=this.currentWordOffset);var n=ze(Math.max(this.currentWordOffset,2*this.shadowBufferF32.length),this.uniformBufferMaxPageWordSize),i=new Uint8Array(4*n);if(i.set(this.shadowBufferU8,0),this.shadowBufferU8=i,this.shadowBufferF32=new Float32Array(this.shadowBufferU8.buffer),!(this.currentWordOffset<=n))throw new Error("Assert fail: this.currentWordOffset [".concat(this.currentWordOffset,"] <= newWordCount [").concat(n,"]"))}}},{key:"mapBufferF32",value:function(){return Ie(this.shadowBufferF32)}},{key:"prepareToRender",value:function(){if(null!==this.shadowBufferF32){var e=Ie(this.shadowBufferF32);e.length!==this.currentBufferWordSize&&(this.currentBufferWordSize=e.length,null!==this.buffer&&this.buffer.destroy(),this.buffer=this.device.createBuffer({viewOrSize:this.currentBufferWordSize,usage:ne.UNIFORM,hint:ie.Dynamic}));var t=ze(this.currentWordOffset,this.uniformBufferMaxPageWordSize);if(!(t<=this.currentBufferWordSize))throw new Error("Assert fail: wordCount [".concat(t,"] (").concat(this.currentWordOffset," aligned ").concat(this.uniformBufferMaxPageWordSize,") <= this.currentBufferWordSize [").concat(this.currentBufferWordSize,"]"));if(this.isSupportedUBO()){var r=Ie(this.buffer);r.setSubData(0,this.shadowBufferU8,0,4*t)}this.currentWordOffset=0}}},{key:"destroy",value:function(){null!==this.buffer&&this.buffer.destroy(),this.shadowBufferF32=null,this.shadowBufferU8=null}}]),e}();function nr(e,t){return e+=t,e+=e<<10,e+=e>>>6,e>>>0}function ir(e){return e+=e<<3,e^=e>>>11,e+=e<<15,e>>>0}function ar(e){return 0}var or=function e(){g(this,e),this.keys=[],this.values=[]},sr=function(){function e(t,r){g(this,e),this.keyEqualFunc=void 0,this.keyHashFunc=void 0,this.buckets=new Map,this.keyEqualFunc=t,this.keyHashFunc=r}return m(e,[{key:"findBucketIndex",value:function(e,t){for(var r=0;r<e.keys.length;r++)if(this.keyEqualFunc(t,e.keys[r]))return r;return-1}},{key:"findBucket",value:function(e){var t=this.keyHashFunc(e);return this.buckets.get(t)}},{key:"get",value:function(e){var t=this.findBucket(e);if(void 0===t)return null;var r=this.findBucketIndex(t,e);return r<0?null:t.values[r]}},{key:"add",value:function(e,t){var r=this.keyHashFunc(e);void 0===this.buckets.get(r)&&this.buckets.set(r,new or);var n=this.buckets.get(r);n.keys.push(e),n.values.push(t)}},{key:"delete",value:function(e){var t=this.findBucket(e);if(void 0!==t){var r=this.findBucketIndex(t,e);-1!==r&&(t.keys.splice(r,1),t.values.splice(r,1))}}},{key:"clear",value:function(){this.buckets.clear()}},{key:"size",value:function(){var e,t=0,r=Y(this.buckets.values());try{for(r.s();!(e=r.n()).done;){var n=e.value;t+=n.values.length}}catch(i){r.e(i)}finally{r.f()}return t}},{key:"values",value:regeneratorRuntime.mark((function e(){var t,r,n,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:t=Y(this.buckets.values()),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=14;break}n=r.value,i=n.values.length-1;case 6:if(!(i>=0)){e.next=12;break}return e.next=9,n.values[i];case 9:i--,e.next=6;break;case 12:e.next=3;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e["catch"](1),t.e(e.t0);case 19:return e.prev=19,t.f(),e.finish(19);case 22:case"end":return e.stop()}}),e,this,[[1,16,19,22]])}))}]),e}();function ur(e,t){return Pe(""!==e.preprocessedVert&&""!==t.preprocessedVert),Pe(""!==e.preprocessedFrag&&""!==t.preprocessedFrag),e.preprocessedVert===t.preprocessedVert&&e.preprocessedFrag===t.preprocessedFrag}function lr(e){var t=e.preprocessedVert,r=e.preprocessedFrag,n=e.vert,i=e.frag;return{preprocessedVert:t,preprocessedFrag:r,vert:n,frag:i}}function cr(e,t){return e=nr(e,t.numUniformBuffers),e=nr(e,t.numSamplers),e}function fr(e,t){return e=nr(e,t.blendMode),e=nr(e,t.blendSrcFactor),e=nr(e,t.blendDstFactor),e}function dr(e,t){return e=fr(e,t.rgbBlendState),e=fr(e,t.alphaBlendState),e=nr(e,t.channelWriteMask),e}function hr(e,t){return e=nr(e,t.r<<24|t.g<<16|t.b<<8|t.a),e}function _r(e,t){for(var r=0;r<t.attachmentsState.length;r++)e=dr(e,t.attachmentsState[r]);return e=hr(e,t.blendConstant),e=nr(e,t.depthCompare),e=nr(e,t.depthWrite?1:0),e=nr(e,t.stencilCompare),e=nr(e,t.stencilPassOp),e=nr(e,t.stencilWrite?1:0),e=nr(e,t.cullMode),e=nr(e,t.frontFace?1:0),e=nr(e,t.polygonOffset?1:0),e}function pr(e){var t=0;t=nr(t,e.program.id),null!==e.inputLayout&&(t=nr(t,e.inputLayout.id));for(var r=0;r<e.bindingLayouts.length;r++)t=cr(t,e.bindingLayouts[r]);t=_r(t,e.megaStateDescriptor);for(var n=0;n<e.colorAttachmentFormats.length;n++)t=nr(t,e.colorAttachmentFormats[n]||0);return t=nr(t,e.depthStencilAttachmentFormat||0),ir(t)}function vr(e){for(var t=0,r=0;r<e.samplerBindings.length;r++){var n=e.samplerBindings[r];null!==n&&null!==n.texture&&(t=nr(t,n.texture.id))}for(var i=0;i<e.uniformBufferBindings.length;i++){var a=e.uniformBufferBindings[i];null!==a&&null!==a.buffer&&(t=nr(t,a.buffer.id),t=nr(t,a.wordCount))}return ir(t)}var Er,Rr=function(){function e(t){g(this,e),this.device=void 0,this.bindingsCache=new sr(vt,vr),this.renderPipelinesCache=new sr(St,pr),this.inputLayoutsCache=new sr(Bt,ar),this.programCache=new sr(ur,ar),this.samplerCache=new sr(Ot,ar),this.device=t}return m(e,[{key:"createBindings",value:function(e){var t=this.bindingsCache.get(e);if(null===t){var r=Nt(e);t=this.device.createBindings(r),this.bindingsCache.add(r,t)}return t}},{key:"createRenderPipeline",value:function(e){var t=this.renderPipelinesCache.get(e);if(null===t){var r=It(e);t=this.device.createRenderPipeline(r),this.renderPipelinesCache.add(r,t)}return t}},{key:"createInputLayout",value:function(e){var t=this.inputLayoutsCache.get(e);if(null===t){var r=Lt(e);t=this.device.createInputLayout(r),this.inputLayoutsCache.add(r,t)}return t}},{key:"createProgramSimple",value:function(e){var t=this.programCache.get(e);if(null===t){var r=lr(e);t=this.device.createProgramSimple(r),this.programCache.add(r,t)}return t}},{key:"createProgram",value:function(e){return e.ensurePreprocessed(this.device.queryVendorInfo()),this.createProgramSimple(e)}},{key:"createSampler",value:function(e){var t=this.samplerCache.get(e);return null===t&&(t=this.device.createSampler(e),this.samplerCache.add(e,t)),t}},{key:"destroy",value:function(){var e,t=Y(this.bindingsCache.values());try{for(t.s();!(e=t.n()).done;){var r=e.value;r.destroy()}}catch(p){t.e(p)}finally{t.f()}var n,i=Y(this.renderPipelinesCache.values());try{for(i.s();!(n=i.n()).done;){var a=n.value;a.destroy()}}catch(p){i.e(p)}finally{i.f()}var o,s=Y(this.inputLayoutsCache.values());try{for(s.s();!(o=s.n()).done;){var u=o.value;u.destroy()}}catch(p){s.e(p)}finally{s.f()}var l,c=Y(this.programCache.values());try{for(c.s();!(l=c.n()).done;){var f=l.value;f.destroy()}}catch(p){c.e(p)}finally{c.f()}var d,h=Y(this.samplerCache.values());try{for(h.s();!(d=h.n()).done;){var _=d.value;_.destroy()}}catch(p){h.e(p)}finally{h.f()}this.bindingsCache.clear(),this.renderPipelinesCache.clear(),this.inputLayoutsCache.clear(),this.programCache.clear(),this.samplerCache.clear()}}]),e}();(function(e){e[e["Color0"]=0]="Color0",e[e["Color1"]=1]="Color1",e[e["Color2"]=2]="Color2",e[e["Color3"]=3]="Color3",e[e["ColorMax"]=3]="ColorMax",e[e["DepthStencil"]=4]="DepthStencil"})(Er||(Er={}));var gr,Tr={x:0,y:0,w:1,h:1},mr=function(){function e(){g(this,e),this.renderTargetIDs=[],this.resolveTextureOutputIDs=[],this.resolveTextureOutputExternalTextures=[],this.resolveTextureInputIDs=[],this.renderTargetExtraRefs=[],this.viewport=Tr,this.resolveTextureInputTextures=[],this.renderTargets=[],this.descriptor={colorAttachment:[],colorResolveTo:[],colorStore:[],depthStencilAttachment:null,depthStencilResolveTo:null,depthStencilStore:!0,colorClearColor:["load"],depthClearValue:"load",stencilClearValue:"load",occlusionQueryPool:null},this.viewportX=0,this.viewportY=0,this.viewportW=0,this.viewportH=0,this.execFunc=null,this.postFunc=null,this.debugName=void 0,this.debugThumbnails=[]}return m(e,[{key:"setDebugName",value:function(e){this.debugName=e}},{key:"pushDebugThumbnail",value:function(e){this.debugThumbnails[e]=!0}},{key:"setViewport",value:function(e){this.viewport=e}},{key:"attachRenderTargetID",value:function(e,t){Pe(void 0===this.renderTargetIDs[e]),this.renderTargetIDs[e]=t}},{key:"attachResolveTexture",value:function(e){this.resolveTextureInputIDs.push(e)}},{key:"attachOcclusionQueryPool",value:function(e){this.descriptor.occlusionQueryPool=e}},{key:"resolveToExternalTexture",value:function(e,t){this.resolveTextureOutputExternalTextures[e]=t}},{key:"exec",value:function(e){Pe(null===this.execFunc),this.execFunc=e}},{key:"post",value:function(e){Pe(null===this.postFunc),this.postFunc=e}},{key:"addExtraRef",value:function(e){this.renderTargetExtraRefs[e]=!0}}]),e}(),Ar=function(){function e(t,r){g(this,e),this.debugName=void 0,this.dimension=oe.n2D,this.depth=1,this.numLevels=1,this.pixelFormat=void 0,this.width=0,this.height=0,this.sampleCount=0,this.usage=se.RenderTarget,this.immutable=!0,this.needsClear=!0,this.texture=null,this.attachment=void 0,this.age=0,this.pixelFormat=r.pixelFormat,this.width=r.width,this.height=r.height,this.sampleCount=r.sampleCount,Pe(this.sampleCount>=1),this.sampleCount>1?this.attachment=t.createRenderTarget(this):(this.texture=t.createTexture(this),t.setResourceName(this.texture,this.debugName),this.attachment=t.createRenderTargetFromTexture(this.texture)),t.setResourceName(this.attachment,this.debugName)}return m(e,[{key:"matchesDescription",value:function(e){return this.pixelFormat===e.pixelFormat&&this.width===e.width&&this.height===e.height&&this.sampleCount===e.sampleCount}},{key:"reset",value:function(e){Pe(this.matchesDescription(e)),this.age=0}},{key:"destroy",value:function(e){null!==this.texture&&this.texture.destroy(),this.attachment.destroy()}}]),e}(),Sr=function(){function e(t,r){g(this,e),this.dimension=oe.n2D,this.depth=1,this.numLevels=1,this.usage=se.RenderTarget,this.pixelFormat=void 0,this.width=0,this.height=0,this.texture=void 0,this.age=0,this.immutable=!0,this.pixelFormat=r.pixelFormat,this.width=r.width,this.height=r.height,this.texture=t.createTexture(this)}return m(e,[{key:"matchesDescription",value:function(e){return this.pixelFormat===e.pixelFormat&&this.width===e.width&&this.height===e.height}},{key:"reset",value:function(e){Pe(this.matchesDescription(e)),this.age=0}},{key:"destroy",value:function(e){this.texture.destroy()}}]),e}();gr=Symbol.species;var yr,Cr=function e(){g(this,e),this[gr]=void 0,this.renderTargetDescriptions=[],this.resolveTextureRenderTargetIDs=[],this.passes=[],this.renderTargetDebugNames=[]},Br=function(){function e(t){g(this,e),this.device=void 0,this.currentPass=null,this.renderTargetDeadPool=[],this.singleSampledTextureDeadPool=[],this.currentGraph=null,this.renderTargetOutputCount=[],this.renderTargetResolveCount=[],this.resolveTextureUseCount=[],this.renderTargetAliveForID=[],this.singleSampledTextureForResolveTextureID=[],this.device=t}return m(e,[{key:"acquireRenderTargetForDescription",value:function(e){for(var t=0;t<this.renderTargetDeadPool.length;t++){var r=this.renderTargetDeadPool[t];if(r.matchesDescription(e))return r.reset(e),this.renderTargetDeadPool.splice(t--,1),r}return new Ar(this.device,e)}},{key:"acquireSingleSampledTextureForDescription",value:function(e){for(var t=0;t<this.singleSampledTextureDeadPool.length;t++){var r=this.singleSampledTextureDeadPool[t];if(r.matchesDescription(e))return r.reset(e),this.singleSampledTextureDeadPool.splice(t--,1),r}return new Sr(this.device,e)}},{key:"beginGraphBuilder",value:function(){Pe(null===this.currentGraph),this.currentGraph=new Cr}},{key:"pushPass",value:function(e){var t=new mr;e(t),this.currentGraph.passes.push(t)}},{key:"createRenderTargetID",value:function(e,t){return this.currentGraph.renderTargetDebugNames.push(t),this.currentGraph.renderTargetDescriptions.push(e)-1}},{key:"createResolveTextureID",value:function(e){return this.currentGraph.resolveTextureRenderTargetIDs.push(e)-1}},{key:"findMostRecentPassThatAttachedRenderTarget",value:function(e){for(var t=this.currentGraph.passes.length-1;t>=0;t--){var r=this.currentGraph.passes[t];if(r.renderTargetIDs.includes(e))return r}return null}},{key:"resolveRenderTargetPassAttachmentSlot",value:function(e,t){var r=e;if(void 0===r.resolveTextureOutputIDs[t]){var n=r.renderTargetIDs[t],i=this.createResolveTextureID(n);r.resolveTextureOutputIDs[t]=i}return r.resolveTextureOutputIDs[t]}},{key:"findPassForResolveRenderTarget",value:function(e){var t=Ie(this.findMostRecentPassThatAttachedRenderTarget(e)),r=t.renderTargetIDs.indexOf(e);return Pe(void 0===t.resolveTextureOutputExternalTextures[r]),t}},{key:"resolveRenderTarget",value:function(e){var t=this.findPassForResolveRenderTarget(e),r=t.renderTargetIDs.indexOf(e);return this.resolveRenderTargetPassAttachmentSlot(t,r)}},{key:"resolveRenderTargetToExternalTexture",value:function(e,t){var r=this.findPassForResolveRenderTarget(e),n=r.renderTargetIDs.indexOf(e);Pe(void 0===r.resolveTextureOutputIDs[n]),r.resolveTextureOutputExternalTextures[n]=t}},{key:"getRenderTargetDescription",value:function(e){return Ie(this.currentGraph.renderTargetDescriptions[e])}},{key:"scheduleAddUseCount",value:function(e,t){for(var r=0;r<t.renderTargetIDs.length;r++){var n=t.renderTargetIDs[r];void 0!==n&&(this.renderTargetOutputCount[n]++,t.renderTargetExtraRefs[r]&&this.renderTargetOutputCount[n]++)}for(var i=0;i<t.resolveTextureInputIDs.length;i++){var a=t.resolveTextureInputIDs[i];if(void 0!==a){this.resolveTextureUseCount[a]++;var o=e.resolveTextureRenderTargetIDs[a];this.renderTargetResolveCount[o]++}}}},{key:"acquireRenderTargetForID",value:function(e,t){if(void 0===t)return null;if(Pe(this.renderTargetOutputCount[t]>0),!this.renderTargetAliveForID[t]){var r=e.renderTargetDescriptions[t],n=this.acquireRenderTargetForDescription(r);n.debugName=e.renderTargetDebugNames[t],this.renderTargetAliveForID[t]=n}return this.renderTargetAliveForID[t]}},{key:"releaseRenderTargetForID",value:function(e,t){if(void 0===e)return null;var r=Ie(this.renderTargetAliveForID[e]);return t?(Pe(this.renderTargetOutputCount[e]>0),this.renderTargetOutputCount[e]--):(Pe(this.renderTargetResolveCount[e]>0),this.renderTargetResolveCount[e]--),0===this.renderTargetOutputCount[e]&&0===this.renderTargetResolveCount[e]&&(r.needsClear=!0,delete this.renderTargetAliveForID[e],this.renderTargetDeadPool.push(r)),r}},{key:"acquireResolveTextureInputTextureForID",value:function(e,t){var r=e.resolveTextureRenderTargetIDs[t];Pe(this.resolveTextureUseCount[t]>0),this.resolveTextureUseCount[t]--;var n=Ie(this.releaseRenderTargetForID(r,!1));if(void 0!==this.singleSampledTextureForResolveTextureID[t]){var i=this.singleSampledTextureForResolveTextureID[t];return 0===this.resolveTextureUseCount[t]&&this.singleSampledTextureDeadPool.push(i),i.texture}return Ie(n.texture)}},{key:"determineResolveParam",value:function(e,t,r){var n=t.renderTargetIDs[r],i=t.resolveTextureOutputIDs[r],a=t.resolveTextureOutputExternalTextures[r],o=void 0!==i,s=void 0!==a;Pe(!(o&&s));var u=null,l=!1;if(this.renderTargetOutputCount[n]>1&&(l=!0),o){Pe(e.resolveTextureRenderTargetIDs[i]===n),Pe(this.resolveTextureUseCount[i]>0),Pe(this.renderTargetOutputCount[n]>0);var c=Ie(this.renderTargetAliveForID[n]);if(null!==c.texture&&1===this.renderTargetOutputCount[n])u=null,l=!0;else{if(!this.singleSampledTextureForResolveTextureID[i]){var f=Ie(e.renderTargetDescriptions[n]);this.singleSampledTextureForResolveTextureID[i]=this.acquireSingleSampledTextureForDescription(f),this.device.setResourceName(this.singleSampledTextureForResolveTextureID[i].texture,c.debugName+" (Resolve ".concat(i,")"))}u=this.singleSampledTextureForResolveTextureID[i].texture}}else u=s?a:null;return{resolveTo:u,store:l}}},{key:"schedulePass",value:function(e,t){for(var r=t.renderTargetIDs[Er.DepthStencil],n=Er.Color0;n<=Er.ColorMax;n++){var i=t.renderTargetIDs[n],a=this.acquireRenderTargetForID(e,i);t.renderTargets[n]=a,t.descriptor.colorAttachment[n]=null!==a?a.attachment:null;var o=this.determineResolveParam(e,t,n),s=o.resolveTo,u=o.store;t.descriptor.colorResolveTo[n]=s,t.descriptor.colorStore[n]=u,t.descriptor.colorClearColor[n]=null!==a&&a.needsClear?e.renderTargetDescriptions[i].colorClearColor:"load"}var l=this.acquireRenderTargetForID(e,r);t.renderTargets[Er.DepthStencil]=l,t.descriptor.depthStencilAttachment=null!==l?l.attachment:null;var c=this.determineResolveParam(e,t,Er.DepthStencil),f=c.resolveTo,d=c.store;t.descriptor.depthStencilResolveTo=f,t.descriptor.depthStencilStore=d,t.descriptor.depthClearValue=null!==l&&l.needsClear?e.renderTargetDescriptions[r].depthClearValue:"load",t.descriptor.stencilClearValue=null!==l&&l.needsClear?e.renderTargetDescriptions[r].stencilClearValue:"load";for(var h=0,_=0,p=0,v=0;v<t.renderTargets.length;v++){var E=t.renderTargets[v];E&&(0===h&&(h=E.width,_=E.height,p=E.sampleCount),Pe(E.width===h),Pe(E.height===_),Pe(E.sampleCount===p),E.needsClear=!1)}if(h>0&&_>0){var R=h*t.viewport.x,g=_*t.viewport.y,T=h*t.viewport.w,m=_*t.viewport.h;t.viewportX=R,t.viewportY=g,t.viewportW=T,t.viewportH=m}for(var A=0;A<t.resolveTextureInputIDs.length;A++){var S=t.resolveTextureInputIDs[A];t.resolveTextureInputTextures[A]=this.acquireResolveTextureInputTextureForID(e,S)}for(var y=0;y<t.renderTargetIDs.length;y++)this.releaseRenderTargetForID(t.renderTargetIDs[y],!0);for(var C=0;C<t.renderTargetExtraRefs.length;C++)t.renderTargetExtraRefs[C]&&this.releaseRenderTargetForID(t.renderTargetIDs[C],!0)}},{key:"scheduleGraph",value:function(e){Pe(0===this.renderTargetOutputCount.length),Pe(0===this.renderTargetResolveCount.length),Pe(0===this.resolveTextureUseCount.length);for(var t=0;t<this.renderTargetDeadPool.length;t++)this.renderTargetDeadPool[t].age++;for(var r=0;r<this.singleSampledTextureDeadPool.length;r++)this.singleSampledTextureDeadPool[r].age++;Ye(this.renderTargetOutputCount,e.renderTargetDescriptions.length,0),Ye(this.renderTargetResolveCount,e.renderTargetDescriptions.length,0),Ye(this.resolveTextureUseCount,e.resolveTextureRenderTargetIDs.length,0);for(var n=0;n<e.passes.length;n++)this.scheduleAddUseCount(e,e.passes[n]);for(var i=0;i<e.passes.length;i++)this.schedulePass(e,e.passes[i]);for(var a=0;a<this.renderTargetOutputCount.length;a++)Pe(0===this.renderTargetOutputCount[a]);for(var o=0;o<this.renderTargetResolveCount.length;o++)Pe(0===this.renderTargetResolveCount[o]);for(var s=0;s<this.resolveTextureUseCount.length;s++)Pe(0===this.resolveTextureUseCount[s]);for(var u=0;u<this.renderTargetAliveForID.length;u++)Pe(void 0===this.renderTargetAliveForID[u]);for(var l=1,c=0;c<this.renderTargetDeadPool.length;c++)this.renderTargetDeadPool[c].age>=l&&(this.renderTargetDeadPool[c].destroy(this.device),this.renderTargetDeadPool.splice(c--,1));for(var f=0;f<this.singleSampledTextureDeadPool.length;f++)this.singleSampledTextureDeadPool[f].age>=l&&(this.singleSampledTextureDeadPool[f].destroy(this.device),this.singleSampledTextureDeadPool.splice(f--,1));this.renderTargetResolveCount.length=0,this.renderTargetOutputCount.length=0,this.resolveTextureUseCount.length=0}},{key:"execPass",value:function(e){Pe(null===this.currentPass),this.currentPass=e;var t=this.device.createRenderPass(e.descriptor);t.beginDebugGroup(e.debugName),t.setViewport(e.viewportX,e.viewportY,e.viewportW,e.viewportH),null!==e.execFunc&&e.execFunc(t,this),t.endDebugGroup(),this.device.submitPass(t),null!==e.postFunc&&e.postFunc(this),this.currentPass=null}},{key:"execGraph",value:function(e){var t=this;this.scheduleGraph(e),e.passes.forEach((function(e){t.execPass(e)})),this.singleSampledTextureForResolveTextureID.length=0}},{key:"execute",value:function(){var e=Ie(this.currentGraph);this.execGraph(e),this.currentGraph=null}},{key:"getDebug",value:function(){return this}},{key:"getPasses",value:function(){return this.currentGraph.passes}},{key:"getPassDebugThumbnails",value:function(e){return e.debugThumbnails}},{key:"getPassRenderTargetID",value:function(e,t){return e.renderTargetIDs[t]}},{key:"getRenderTargetIDDebugName",value:function(e){return this.currentGraph.renderTargetDebugNames[e]}},{key:"getResolveTextureForID",value:function(e){var t=this.currentPass,r=t.resolveTextureInputIDs.indexOf(e);return Pe(r>=0),Ie(t.resolveTextureInputTextures[r])}},{key:"getRenderTargetAttachment",value:function(e){var t=this.currentPass,r=t.renderTargets[e];return r?r.attachment:null}},{key:"getRenderTargetTexture",value:function(e){var t=this.currentPass,r=t.renderTargets[e];return r?r.texture:null}},{key:"newGraphBuilder",value:function(){return this.beginGraphBuilder(),this}},{key:"destroy",value:function(){for(var e=0;e<this.renderTargetAliveForID.length;e++)Pe(void 0===this.renderTargetAliveForID[e]);for(var t=0;t<this.singleSampledTextureForResolveTextureID.length;t++)Pe(void 0===this.singleSampledTextureForResolveTextureID[t]);for(var r=0;r<this.renderTargetDeadPool.length;r++)this.renderTargetDeadPool[r].destroy(this.device);for(var n=0;n<this.singleSampledTextureDeadPool.length;n++)this.singleSampledTextureDeadPool[n].destroy(this.device)}}]),e}();(function(e){e[e["BACKGROUND"]=0]="BACKGROUND",e[e["ALPHA_TEST"]=16]="ALPHA_TEST",e[e["OPAQUE"]=32]="OPAQUE",e[e["TRANSLUCENT"]=128]="TRANSLUCENT"})(yr||(yr={}));function Or(e,t){return(16777215&e|(255&t)<<24)>>>0}function xr(e,t){var r=!!(e>>>31&1);return r?e:(4278190335&e|(65535&t)<<8)>>>0}function Dr(e,t){return Or(xr(0,t),e)}var Nr="undefined"!==typeof Float32Array?Float32Array:Array;function Fr(){var e=new Nr(16);return Nr!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Pr(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Ir(e,t,r,n,i,a,o,s,u,l,c,f,d,h,_,p){var v=new Nr(16);return v[0]=e,v[1]=t,v[2]=r,v[3]=n,v[4]=i,v[5]=a,v[6]=o,v[7]=s,v[8]=u,v[9]=l,v[10]=c,v[11]=f,v[12]=d,v[13]=h,v[14]=_,v[15]=p,v}function Mr(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],u=t[5],l=t[6],c=t[7],f=t[8],d=t[9],h=t[10],_=t[11],p=t[12],v=t[13],E=t[14],R=t[15],g=r[0],T=r[1],m=r[2],A=r[3];return e[0]=g*n+T*s+m*f+A*p,e[1]=g*i+T*u+m*d+A*v,e[2]=g*a+T*l+m*h+A*E,e[3]=g*o+T*c+m*_+A*R,g=r[4],T=r[5],m=r[6],A=r[7],e[4]=g*n+T*s+m*f+A*p,e[5]=g*i+T*u+m*d+A*v,e[6]=g*a+T*l+m*h+A*E,e[7]=g*o+T*c+m*_+A*R,g=r[8],T=r[9],m=r[10],A=r[11],e[8]=g*n+T*s+m*f+A*p,e[9]=g*i+T*u+m*d+A*v,e[10]=g*a+T*l+m*h+A*E,e[11]=g*o+T*c+m*_+A*R,g=r[12],T=r[13],m=r[14],A=r[15],e[12]=g*n+T*s+m*f+A*p,e[13]=g*i+T*u+m*d+A*v,e[14]=g*a+T*l+m*h+A*E,e[15]=g*o+T*c+m*_+A*R,e}function br(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}Math.hypot||(Math.hypot=function(){var e=0,t=arguments.length;while(t--)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var Lr=Mr;function Ur(){var e=new Nr(3);return Nr!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function kr(e,t,r){var n=new Nr(3);return n[0]=e,n[1]=t,n[2]=r,n}(function(){var e=Ur()})();function Gr(){var e=new Nr(2);return Nr!=Float32Array&&(e[0]=0,e[1]=0),e}function wr(e,t){var r=t[0],n=t[1],i=r*r+n*n;return i>0&&(i=1/Math.sqrt(i)),e[0]=t[0]*i,e[1]=t[1]*i,e}function Wr(e,t){return e[0]*t[0]+e[1]*t[1]}function Xr(e,t){return e[0]===t[0]&&e[1]===t[1]}(function(){var e=Gr()})(),Ir(1,0,0,0,0,1,0,0,0,0,2,0,0,0,-1,1);var Vr,Hr;Ir(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);function Yr(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return e[t+0]=r,e[t+1]=n,e[t+2]=i,e[t+3]=a,4}(function(e){e.saturate="\n  float saturate(float v) { return clamp(v, 0.0, 1.0); }\n  vec2 saturate(vec2 v) { return clamp(v, vec2(0.0), vec2(1.0)); }\n  vec3 saturate(vec3 v) { return clamp(v, vec3(0.0), vec3(1.0)); }\n  vec4 saturate(vec4 v) { return clamp(v, vec4(0.0), vec4(1.0)); }\n  ",e.invlerp="\n  float invlerp(float a, float b, float v) { return (v - a) / (b - a); }\n  ",e.fullscreenVS="\nlayout(location = 0) attribute vec2 a_Position;\n\nvarying vec2 v_TexCoord;\n\nvoid main() {\n  v_TexCoord = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n\n  #ifdef VIEWPORT_ORIGIN_TL\n    v_TexCoord.y = 1.0 - v_TexCoord.y;\n  #endif\n}\n  ",e.fullscreenBlitOneTexPS="\nuniform sampler2D u_Texture;\nvarying vec2 v_TexCoord;\n\nvoid main() {\n  gl_FragColor = texture(SAMPLER_2D(u_Texture), v_TexCoord);\n}\n  ",e.monochromeNTSC="\n  float MonochromeNTSC(vec3 t_Color) {\n      // NTSC primaries.\n      return dot(t_Color.rgb, vec3(0.299, 0.587, 0.114));\n  }\n  ",e.fxaa="\nvec4 FXAA(PD_SAMPLER_2D(t_Texture), in vec2 t_PixelCenter, in vec2 t_InvResolution) {\n    // FXAA v2, based on implementations:\n    // http://www.geeks3d.com/20110405/fxaa-fast-approximate-anti-aliasing-demo-glsl-opengl-test-radeon-geforce/\n    // https://github.com/mitsuhiko/webgl-meincraft\n\n    float lumaMM = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy).rgb);\n\n#if 1\n    vec2 t_PixelTopLeft = t_PixelCenter.xy - t_InvResolution.xy * 0.5;\n    float lumaNW = MonochromeNTSC(texture      (PU_SAMPLER_2D(t_Texture), t_PixelTopLeft.xy)             .rgb);\n    float lumaNE = MonochromeNTSC(textureOffset(PU_SAMPLER_2D(t_Texture), t_PixelTopLeft.xy, ivec2(1, 0)).rgb);\n    float lumaSW = MonochromeNTSC(textureOffset(PU_SAMPLER_2D(t_Texture), t_PixelTopLeft.xy, ivec2(0, 1)).rgb);\n    float lumaSE = MonochromeNTSC(textureOffset(PU_SAMPLER_2D(t_Texture), t_PixelTopLeft.xy, ivec2(1, 1)).rgb);\n#else\n    // We're at the pixel center -- pixel edges are 0.5 units away.\n    // NOTE(jstpierre): mitsuhiko's port seems to get this wrong?\n    vec2 t_PixelSize = t_InvResolution.xy * 0.5;\n\n    float lumaNW = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + t_PixelSize * vec2(-1.0, -1.0)).rgb);\n    float lumaNE = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + t_PixelSize * vec2( 1.0, -1.0)).rgb);\n    float lumaSW = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + t_PixelSize * vec2(-1.0,  1.0)).rgb);\n    float lumaSE = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + t_PixelSize * vec2( 1.0,  1.0)).rgb);\n#endif\n\n    vec2 dir; \n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n    const float FXAA_REDUCE_MIN = 1.0/128.0;\n    const float FXAA_REDUCE_MUL = 1.0/8.0;\n    const float FXAA_SPAN_MAX = 8.0;\n\n    float dirReduce = max(\n        (lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),\n        FXAA_REDUCE_MIN);\n\n    float rcpDirMin = 1.0/(min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_InvResolution.xy;\n\n    float lumaMin = min(lumaMM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaMM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n    vec4 rgbA = (1.0/2.0) * (\n        texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + dir * (1.0/3.0 - 0.5)) +\n        texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + dir * (2.0/3.0 - 0.5)));\n    vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (\n        texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + dir * (0.0/3.0 - 0.5)) +\n        texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + dir * (3.0/3.0 - 0.5)));\n    float lumaB = MonochromeNTSC(rgbB.rgb);\n\n    vec4 rgbOutput = ((lumaB < lumaMin) || (lumaB > lumaMax)) ? rgbA : rgbB;\n    return rgbOutput;\n}\n"})(Vr||(Vr={})),function(e){e[e["Indexed"]=1]="Indexed",e[e["AllowSkippingIfPipelineNotReady"]=2]="AllowSkippingIfPipelineNotReady",e[e["Template"]=4]="Template",e[e["Draw"]=8]="Draw",e[e["InheritedFlags"]=3]="InheritedFlags"}(Hr||(Hr={}));var Kr,zr=function(){function e(){g(this,e),this.sortKey=0,this.debug=null,this.renderPipelineDescriptor=void 0,this.uniformBuffer=void 0,this.uniforms=[],this.bindingDescriptors=Qe(1,(function(){return{bindingLayout:null,samplerBindings:[],uniformBufferBindings:[]}})),this.dynamicUniformBufferByteOffsets=Qe(4,(function(){return 0})),this.flags=0,this.inputState=null,this.drawStart=0,this.drawCount=0,this.drawInstanceCount=0,this.renderPipelineDescriptor={bindingLayouts:[],inputLayout:null,megaStateDescriptor:it(ct),program:null,topology:re.Triangles,colorAttachmentFormats:[],depthStencilAttachmentFormat:null,sampleCount:1},this.reset()}return m(e,[{key:"reset",value:function(){this.sortKey=0,this.flags=Hr.AllowSkippingIfPipelineNotReady,this.inputState=null,this.renderPipelineDescriptor.inputLayout=null}},{key:"setFromTemplate",value:function(e){nt(this.renderPipelineDescriptor.megaStateDescriptor,e.renderPipelineDescriptor.megaStateDescriptor),this.renderPipelineDescriptor.program=e.renderPipelineDescriptor.program,this.renderPipelineDescriptor.inputLayout=e.renderPipelineDescriptor.inputLayout,this.renderPipelineDescriptor.topology=e.renderPipelineDescriptor.topology,this.renderPipelineDescriptor.colorAttachmentFormats.length=Math.max(this.renderPipelineDescriptor.colorAttachmentFormats.length,e.renderPipelineDescriptor.colorAttachmentFormats.length);for(var t=0;t<e.renderPipelineDescriptor.colorAttachmentFormats.length;t++)this.renderPipelineDescriptor.colorAttachmentFormats[t]=e.renderPipelineDescriptor.colorAttachmentFormats[t];this.renderPipelineDescriptor.depthStencilAttachmentFormat=e.renderPipelineDescriptor.depthStencilAttachmentFormat,this.renderPipelineDescriptor.sampleCount=e.renderPipelineDescriptor.sampleCount,this.inputState=e.inputState,this.uniformBuffer=e.uniformBuffer,this.uniforms=L(e.uniforms),this.drawCount=e.drawCount,this.drawStart=e.drawStart,this.drawInstanceCount=e.drawInstanceCount,this.flags=this.flags&~Hr.InheritedFlags|e.flags&Hr.InheritedFlags,this.sortKey=e.sortKey;var r=this.bindingDescriptors[0],n=e.bindingDescriptors[0];null!==n.bindingLayout&&this.setBindingLayout(n.bindingLayout);for(var i=0;i<Math.min(r.uniformBufferBindings.length,n.uniformBufferBindings.length);i++)r.uniformBufferBindings[i].wordCount=e.bindingDescriptors[0].uniformBufferBindings[i].wordCount;this.setSamplerBindingsFromTextureMappings(n.samplerBindings);for(var a=0;a<e.dynamicUniformBufferByteOffsets.length;a++)this.dynamicUniformBufferByteOffsets[a]=e.dynamicUniformBufferByteOffsets[a]}},{key:"setProgram",value:function(e){this.renderPipelineDescriptor.program=e}},{key:"setMegaStateFlags",value:function(e){return nt(this.renderPipelineDescriptor.megaStateDescriptor,e),this.renderPipelineDescriptor.megaStateDescriptor}},{key:"getMegaStateFlags",value:function(){return this.renderPipelineDescriptor.megaStateDescriptor}},{key:"setInputLayoutAndState",value:function(e,t){this.inputState=t,this.renderPipelineDescriptor.inputLayout=e}},{key:"setBindingLayout",value:function(e){Pe(e.numUniformBuffers<this.dynamicUniformBufferByteOffsets.length),this.renderPipelineDescriptor.bindingLayouts[0]=e,this.bindingDescriptors[0].bindingLayout=e;for(var t=this.bindingDescriptors[0].uniformBufferBindings.length;t<e.numUniformBuffers;t++)this.bindingDescriptors[0].uniformBufferBindings.push({buffer:null,wordCount:0});for(var r=this.bindingDescriptors[0].samplerBindings.length;r<e.numSamplers;r++)this.bindingDescriptors[0].samplerBindings.push({sampler:null,texture:null,lateBinding:null})}},{key:"setBindingLayouts",value:function(e){Pe(e.length<=this.bindingDescriptors.length),Pe(1===e.length),this.setBindingLayout(e[0])}},{key:"drawIndexes",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.flags=je(this.flags,Hr.Indexed,!0),this.drawCount=e,this.drawStart=t,this.drawInstanceCount=1}},{key:"drawIndexesInstanced",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.flags=je(this.flags,Hr.Indexed,!0),this.drawCount=e,this.drawStart=r,this.drawInstanceCount=t}},{key:"drawPrimitives",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.flags=je(this.flags,Hr.Indexed,!1),this.drawCount=e,this.drawStart=t,this.drawInstanceCount=1}},{key:"setUniforms",value:function(e,t){this.uniforms[e]=t;var r=0,n=[];t.forEach((function(e){e.name;var t=e.value,i="number"===typeof t?[t]:t,a=i.length>4?4:i.length,o=4-r%4;if(4!==o)if(o>=a);else{r+=o;for(var s=0;s<o;s++)n.push(0)}r+=i.length,n.push.apply(n,L(i))}));var i=4-n.length%4;if(4!==i)for(var a=0;a<i;a++)n.push(0);for(var o=this.allocateUniformBuffer(e,n.length),s=this.mapUniformBufferF32(e),u=0;u<n.length;u+=4)o+=Yr(s,o,n[u],n[u+1],n[u+2],n[u+3])}},{key:"setUniformBuffer",value:function(e){this.uniformBuffer=e}},{key:"allocateUniformBuffer",value:function(e,t){Pe(this.bindingDescriptors[0].bindingLayout.numUniformBuffers<this.dynamicUniformBufferByteOffsets.length),this.dynamicUniformBufferByteOffsets[e]=this.uniformBuffer.allocateChunk(t)<<2;var r=this.bindingDescriptors[0].uniformBufferBindings[e];return r.wordCount=t,this.getUniformBufferOffset(e)}},{key:"getUniformBufferOffset",value:function(e){var t=this.dynamicUniformBufferByteOffsets[e]>>>2;return t}},{key:"setUniformBufferOffset",value:function(e,t,r){this.dynamicUniformBufferByteOffsets[e]=t<<2;var n=this.bindingDescriptors[0].uniformBufferBindings[e];n.wordCount=r}},{key:"mapUniformBufferF32",value:function(e){return this.uniformBuffer.mapBufferF32()}},{key:"getUniformBuffer",value:function(){return this.uniformBuffer}},{key:"setSamplerBindingsFromTextureMappings",value:function(e){e=e.filter((function(e){return e}));for(var t=0;t<this.bindingDescriptors[0].samplerBindings.length;t++){var r=this.bindingDescriptors[0].samplerBindings[t],n=e[t];void 0!==n&&null!==n?(r.texture=n.texture,r.sampler=n.sampler,r.lateBinding=n.lateBinding):(r.texture=null,r.sampler=null,r.lateBinding=null)}}},{key:"hasLateSamplerBinding",value:function(e){for(var t=0;t<this.bindingDescriptors[0].samplerBindings.length;t++){var r=this.bindingDescriptors[0].samplerBindings[t];if(r.lateBinding===e)return!0}return!1}},{key:"resolveLateSamplerBinding",value:function(e,t){for(var r=0;r<this.bindingDescriptors[0].samplerBindings.length;r++){var n=this.bindingDescriptors[0].samplerBindings[r];n.lateBinding===e&&(null===t?(n.texture=null,n.sampler=null):(Pe(null===t.lateBinding),n.texture=t.texture,null!==t.sampler&&(n.sampler=t.sampler)),n.lateBinding=null)}}},{key:"queryPipelineReady",value:function(e){var t=e.createRenderPipeline(this.renderPipelineDescriptor);return e.device.queryPipelineReady(t)}},{key:"setAllowSkippingIfPipelineNotReady",value:function(e){this.flags=je(this.flags,Hr.AllowSkippingIfPipelineNotReady,e)}},{key:"setAttachmentFormatsFromRenderPass",value:function(e,t){for(var r=e.queryRenderPass(t),n=-1,i=0;i<r.colorAttachment.length;i++){var a=null!==r.colorAttachment[i]?e.queryRenderTarget(r.colorAttachment[i]):null;this.renderPipelineDescriptor.colorAttachmentFormats[i]=null!==a?a.pixelFormat:null,null!==a&&(-1===n?n=a.sampleCount:Pe(n===a.sampleCount))}var o=null!==r.depthStencilAttachment?e.queryRenderTarget(r.depthStencilAttachment):null;this.renderPipelineDescriptor.depthStencilAttachmentFormat=null!==o?o.pixelFormat:null,null!==o&&(-1===n?n=o.sampleCount:Pe(n==o.sampleCount)),Pe(n>0),this.renderPipelineDescriptor.sampleCount=n}},{key:"drawOnPass",value:function(e,t){var r=this,n=e.device;this.setAttachmentFormatsFromRenderPass(n,t);var i=e.createRenderPipeline(this.renderPipelineDescriptor),a=n.queryPipelineReady(i);if(!a){if(this.flags&Hr.AllowSkippingIfPipelineNotReady)return!1;n.pipelineForceReady(i)}t.setPipeline(i),t.setInputState(this.inputState);for(var o=0;o<this.bindingDescriptors[0].uniformBufferBindings.length;o++)this.bindingDescriptors[0].uniformBufferBindings[o].buffer=Ie(this.uniformBuffer.buffer);this.renderPipelineDescriptor.program.gl_program&&this.uniforms.forEach((function(e){var t={};e.forEach((function(e){var r=e.name,n=e.value;t[r]=n})),r.renderPipelineDescriptor.program.setUniforms(t)}));var s=e.createBindings(v(v({},this.bindingDescriptors[0]),{},{pipeline:i}));return t.setBindings(0,s,this.dynamicUniformBufferByteOffsets),this.drawInstanceCount>1?(Pe(!!(this.flags&Hr.Indexed)),t.drawIndexedInstanced(this.drawCount,this.drawStart,this.drawInstanceCount)):this.flags&Hr.Indexed?t.drawIndexed(this.drawCount,this.drawStart):t.draw(this.drawCount,this.drawStart),!0}}]),e}();function qr(e,t){return e.sortKey-t.sortKey}(function(e){e[e["Forwards"]=0]="Forwards",e[e["Backwards"]=1]="Backwards"})(Kr||(Kr={}));var Zr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:qr,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Kr.Forwards;g(this,e),this.renderInsts=[],this.compareFunction=void 0,this.executionOrder=void 0,this.usePostSort=!1,this.compareFunction=t,this.executionOrder=r}return m(e,[{key:"checkUsePostSort",value:function(){this.usePostSort=null!==this.compareFunction&&this.renderInsts.length>=500}},{key:"insertSorted",value:function(e){null===this.compareFunction||this.usePostSort?this.renderInsts.push(e):Ze(this.renderInsts,e,this.compareFunction),this.checkUsePostSort()}},{key:"submitRenderInst",value:function(e){e.flags|=Hr.Draw,this.insertSorted(e)}},{key:"hasLateSamplerBinding",value:function(e){for(var t=0;t<this.renderInsts.length;t++)if(this.renderInsts[t].hasLateSamplerBinding(e))return!0;return!1}},{key:"resolveLateSamplerBinding",value:function(e,t){for(var r=0;r<this.renderInsts.length;r++)this.renderInsts[r].resolveLateSamplerBinding(e,t)}},{key:"ensureSorted",value:function(){this.usePostSort&&(0!==this.renderInsts.length&&this.renderInsts.sort(this.compareFunction),this.usePostSort=!1)}},{key:"drawOnPassRendererNoReset",value:function(e,t){this.ensureSorted();var r=0;if(this.executionOrder===Kr.Forwards)for(var n=0;n<this.renderInsts.length;n++)this.renderInsts[n].drawOnPass(e,t)&&r++;else for(var i=this.renderInsts.length-1;i>=0;i--)this.renderInsts[i].drawOnPass(e,t)&&r++;return r}},{key:"reset",value:function(){this.renderInsts.length=0}},{key:"drawOnPassRenderer",value:function(e,t){var r=this.drawOnPassRendererNoReset(e,t);return this.reset(),r}}]),e}(),jr=function(){function e(){g(this,e),this.pool=[],this.allocCount=0}return m(e,[{key:"allocRenderInstIndex",value:function(){return this.allocCount++,this.allocCount>this.pool.length&&this.pool.push(new zr),this.allocCount-1}},{key:"popRenderInst",value:function(){this.allocCount--}},{key:"reset",value:function(){for(var e=0;e<this.pool.length;e++)this.pool[e].reset();this.allocCount=0}},{key:"destroy",value:function(){this.pool.length=0,this.allocCount=0}}]),e}(),Qr=function(){function e(t){g(this,e),this.renderCache=void 0,this.instPool=new jr,this.templatePool=new jr,this.simpleRenderInstList=new Zr,this.currentRenderInstList=this.simpleRenderInstList,this.renderCache=t}return m(e,[{key:"newRenderInst",value:function(){var e=this.templatePool.allocCount-1,t=this.instPool.allocRenderInstIndex(),r=this.instPool.pool[t];return r.debug=null,e>=0&&r.setFromTemplate(this.templatePool.pool[e]),r}},{key:"submitRenderInst",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.currentRenderInstList;t.submitRenderInst(e)}},{key:"setCurrentRenderInstList",value:function(e){Pe(null===this.simpleRenderInstList),this.currentRenderInstList=e}},{key:"pushTemplateRenderInst",value:function(){var e=this.templatePool.allocCount-1,t=this.templatePool.allocRenderInstIndex(),r=this.templatePool.pool[t];return e>=0&&r.setFromTemplate(this.templatePool.pool[e]),r.flags|=Hr.Template,r}},{key:"popTemplateRenderInst",value:function(){this.templatePool.popRenderInst()}},{key:"getTemplateRenderInst",value:function(){var e=this.templatePool.allocCount-1;return this.templatePool.pool[e]}},{key:"resetRenderInsts",value:function(){this.instPool.reset(),null!==this.simpleRenderInstList&&this.simpleRenderInstList.reset(),Pe(0===this.templatePool.allocCount)}},{key:"destroy",value:function(){this.instPool.destroy(),this.renderCache.destroy()}},{key:"disableSimpleMode",value:function(){this.simpleRenderInstList=null}},{key:"drawListOnPassRenderer",value:function(e,t){e.drawOnPassRenderer(this.renderCache,t)}},{key:"drawOnPassRenderer",value:function(e){var t=Ie(this.simpleRenderInstList);t.drawOnPassRenderer(this.renderCache,e)}},{key:"drawOnPassRendererNoReset",value:function(e){var t=Ie(this.simpleRenderInstList);t.drawOnPassRendererNoReset(this.renderCache,e)}}]),e}(),Jr=function(){function e(){g(this,e),this.renderCache=void 0,this.renderGraph=void 0,this.renderInstManager=void 0,this.uniformBuffer=void 0,this.device=void 0}return m(e,[{key:"getDevice",value:function(){return this.device}},{key:"setDevice",value:function(e){this.device=e,this.renderCache=new Rr(e),this.renderGraph=new Br(this.device),this.renderInstManager=new Qr(this.renderCache),this.uniformBuffer=new rr(this.device)}},{key:"pushTemplateRenderInst",value:function(){var e=this.renderInstManager.pushTemplateRenderInst();return e.setUniformBuffer(this.uniformBuffer),e}},{key:"prepareToRender",value:function(){this.uniformBuffer.prepareToRender()}},{key:"destroy",value:function(){this.uniformBuffer.destroy(),this.renderInstManager.destroy(),this.renderCache.destroy(),this.renderGraph.destroy()}},{key:"getCache",value:function(){return this.renderCache}}]),e}();Jr=(0,n.gn)([(0,o.ri)()],Jr);var $r=function(){function e(){g(this,e),this.offscreenCanvas=void 0,this.textureCache={},this.gradientCache={}}return m(e,[{key:"getOrCreateTexture",value:function(e,t,r,n){var i=this,a="string"===typeof t?t:t.src||"";if(!this.textureCache[a])if(this.textureCache[a]=e.createTexture(v({pixelFormat:Ee.U8_RGBA_NORM,width:1,height:1,depth:1,numLevels:1,dimension:oe.n2D,usage:se.Sampled,pixelStore:{unpackFlipY:!1},immutable:!1},r)),"string"!==typeof t)this.textureCache[a].setImageData(t);else{var o=new window.Image;o.onload=function(){i.textureCache[a].setImageData(o),n&&n()},o.onerror=function(){},o.crossOrigin="Anonymous",o.src=t}return this.textureCache[a]}},{key:"getOrCreateCanvas",value:function(){return this.offscreenCanvas.getOrCreateCanvas()}},{key:"getOrCreateGradient",value:function(e){var t=this.generateCacheKey(e),r=e.type,n=e.x0,a=e.y0,o=e.x1,s=e.y1,u=e.steps,l=e.width,c=e.height,f=this.gradientCache[t],d=this.offscreenCanvas.getOrCreateCanvas(),h=this.offscreenCanvas.getOrCreateContext();if(!f){if(d.width=l,d.height=c,r===i.qx.LinearGradient)f=h.createLinearGradient(n*l,a*c,o*l,s*c);else if(r===i.qx.RadialGradient){var _=Math.sqrt(l*l+c*c)/2;f=h.createRadialGradient(n*l,a*c,0,o*l,s*c,e.r1*_)}u.forEach((function(e){var t,r=M(e,2),n=r[0],i=r[1];null===(t=f)||void 0===t||t.addColorStop(Number(n),i)})),this.gradientCache[t]=f}d.src=t,f&&(h.fillStyle=f,h.fillRect(0,0,l,c))}},{key:"generateCacheKey",value:function(e){var t=e.type,r=e.x0,n=e.y0,i=e.x1,a=e.y1,o=e.r1,s=e.steps,u=e.width,l=e.height;return"gradient-".concat(t,"-").concat(r,"-").concat(n,"-").concat(i,"-").concat(a,"-").concat(o||0,"-").concat(u,"-").concat(l,"-").concat(s.map((function(e){return e.join("")})).join("-"))}},{key:"destroy",value:function(){for(var e in this.textureCache)this.textureCache[e].destroy();this.textureCache={},this.gradientCache={}}}]),e}();(0,n.gn)([(0,o.f3)(i.jB),(0,n.w6)("design:type",i.jB)],$r.prototype,"offscreenCanvas",void 0),$r=(0,n.gn)([(0,o.ri)()],$r);var en=function(){function e(){g(this,e),this.lights=[],this.fog=void 0}return m(e,[{key:"addLight",value:function(e){this.lights.push(e),this.sortLights()}},{key:"removeLight",value:function(e){var t=this.lights.indexOf(e);this.lights.splice(t,1),this.sortLights()}},{key:"addFog",value:function(e){this.fog=e}},{key:"removeFog",value:function(e){this.fog=null}},{key:"getFog",value:function(){return this.fog}},{key:"getAllLights",value:function(){return this.lights}},{key:"getDefines",value:function(){var e={USE_LIGHT:!!this.lights.length};return this.lights.forEach((function(t){e[t.define]||(e[t.define]=0),e[t.define]++})),e}},{key:"sortLights",value:function(){this.lights.sort((function(e,t){return e.order-t.order}))}}]),e}();en=(0,n.gn)([(0,o.ri)()],en);var tn=o.J3.defineToken("RendererFactory"),rn=o.J3.defineToken("ShapeRenderer"),nn=o.J3.defineToken("MeshFactory"),an=[[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]];function on(e,t){return"#define ".concat(e," ").concat(t)}function sn(e){var t={};return e.replace(/^\s*#define\s*(\S*)\s*(\S*)\s*$/gm,(function(e,r,n){var i=Number(n);return t[r]=isNaN(i)?n:i,""})),t}function un(e,t){var r=[];return e.replace(/^\s*layout\(location\s*=\s*(\S*)\)\s*attribute\s*\S+\s*(.*);$/gm,(function(e,n,i){var a=Number(n);return r.push({location:isNaN(a)?t[n]:a,name:i}),""})),r}function ln(e){var t=[],r=[];return e.replace(/\s*struct\s*(.*)\s*{((?:\s*.*\s*)*?)};/g,(function(e,t,n){var i=[];return n.trim().split("\n").forEach((function(e){var t=e.trim().split(/\s+/),r=M(t,2),n=r[0],a=r[1];i.push({type:n.trim(),name:a.replace(";","").trim()})})),r.push({type:t.trim(),uniforms:i}),""})),e.replace(/\s*uniform\s*.*\s*{((?:\s*.*\s*)*?)};/g,(function(e,n){return n.trim().split("\n").forEach((function(e){var n=e.trim().split(" "),i=M(n,2),a=i[0],o=void 0===a?"":a,s=i[1],u=void 0===s?"":s,l=u.indexOf("[")>-1;if(u=u.replace(";","").replace("[","").trim(),!o.startsWith("#")){if(o){var c=r.find((function(e){return o===e.type}));if(c)if(l)for(var f=function(e){c.uniforms.forEach((function(r){t.push("".concat(u,"[").concat(e,"].").concat(r.name))}))},d=0;d<5;d++)f(d);else c.uniforms.forEach((function(e){t.push("".concat(u,".").concat(e.name))}))}u&&t.push(u)}})),""})),t}function cn(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a="#version 100"===e.glslVersion,o=e.supportMRT&&!!i.MRT,s=r.split("\n").map((function(e){return e.replace(/[/][/].*$/,"")})).filter((function(e){var t=!e||/^\s+$/.test(e);return!t})),u="";null!==n&&(u=L(n.entries()).map((function(e){var t=M(e,2),r=t[0],n=t[1];return on(r,n)})).join("\n"));var l=s.find((function(e){return e.startsWith("precision")}))||"precision mediump float;",c=s.filter((function(e){return!e.startsWith("precision")})).join("\n"),f="";if(e.viewportOrigin===fe.UpperLeft&&(f+="".concat(on("VIEWPORT_ORIGIN_TL","1"),"\n")),e.clipSpaceNearZ===de.Zero&&(f+="".concat(on("CLIPSPACE_NEAR_ZERO","1"),"\n")),e.explicitBindingLocations){var d=0,h=0,_=0;c=c.replace(/^(layout\((.*)\))?\s*uniform(.+{)$/gm,(function(e,t,r,n){var i=r?"".concat(r,", "):"";return"layout(".concat(i,"set = ").concat(d,", binding = ").concat(h++,") uniform ").concat(n)})),d++,h=0,Pe(e.separateSamplerTextures),c=c.replace(/uniform sampler2D (.*);/g,(function(e,r){return"frag"===t?"\nlayout(set = ".concat(d,", binding = ").concat(h++,") uniform texture2D T_").concat(r,";\nlayout(set = ").concat(d,", binding = ").concat(h++,") uniform sampler S_").concat(r,";\n"):""})),c=c.replace("frag"===t?/^\b(varying|in)\b/gm:/^\b(varying|out)\b/gm,(function(e,t){return"layout(location = ".concat(_++,") ").concat(t)})),f+="".concat(on("gl_VertexID","gl_VertexIndex"),"\n")}e.separateSamplerTextures?(c=c.replace(/\bPD_SAMPLER_2D\((.*?)\)/g,(function(e,t){return"texture2D T_P_".concat(t,", sampler S_P_").concat(t)})),c=c.replace(/\bPU_SAMPLER_2D\((.*?)\)/g,(function(e,t){return"SAMPLER_2D(P_".concat(t,")")})),c=c.replace(/\bPP_SAMPLER_2D\((.*?)\)/g,(function(e,t){return"T_".concat(t,", S_").concat(t)})),c=c.replace(/\bSAMPLER_2D\((.*?)\)/g,(function(e,t){return"sampler2D(T_".concat(t,", S_").concat(t,")")}))):(c=c.replace(/\bPD_SAMPLER_2D\((.*?)\)/g,(function(e,t){return"sampler2D P_".concat(t)})),c=c.replace(/\bPU_SAMPLER_2D\((.*?)\)/g,(function(e,t){return"SAMPLER_2D(P_".concat(t,")")})),c=c.replace(/\bPP_SAMPLER_2D\((.*?)\)/g,(function(e,t){return t})),c=c.replace(/\bSAMPLER_2D\((.*?)\)/g,(function(e,t){return t})));var p=c.includes("gl_FragColor"),v="\n".concat(e.glslVersion,"\n").concat(a&&o?"#extension GL_EXT_draw_buffers : require":"","\n").concat(a&&"frag"===t?"#extension GL_OES_standard_derivatives : enable":"","\n").concat(l,"\n#define ").concat(t.toUpperCase(),"\n").concat(a?"":"\n#define attribute in\n#define varying ".concat("vert"===t?"out":"in","\n"),"\n#define main").concat("vert"===t?"VS":"PS"," main\n").concat(f,"\n").concat(p&&"\n".concat("frag"===t&&o?"#define gl_FragColor gbuf_color\nlayout(location = 0) out vec4 gbuf_color;\nlayout(location = 1) out vec4 gbuf_picking;\n":"","\n")||"","\n").concat(u,"\n").concat(c,"\n").trim();if(e.explicitBindingLocations&&"frag"===t&&(v=v.replace(/^\b(out)\b/gm,(function(e,t){return"layout(location = 0) ".concat(t)}))),a){if(v=v.replace(/\s*uniform\s*.*\s*{((?:\s*.*\s*)*?)};/g,(function(e,t){return t.trim().replace(/^.*$/gm,(function(e){var t=e.trim();return t.startsWith("#")?t:e?"uniform ".concat(t):""}))})),o&&"frag"===t){var E=[];v=v.replace(/^layout\(location\s*=\s*\d*\)\s*out\s*vec4\s*(.*);$/gm,(function(e,t){return E.push(t),""})),v=v.replace(/^\s*void\s*main\(\)\s*{\s*$/gm,(function(){return"void main() {\n  ".concat(E.map((function(e){return"vec4 ".concat(e,";")})).join("\n"),"\n")}));var R=v.lastIndexOf("}");v=v.substring(0,R)+"gbuf_color = gl_FragColor;\n".concat(E.map((function(e,t){return"gl_FragData[".concat(t,"] = ").concat(e,";\n")})).join("\n"))+v.substring(R)}v=v.replace(/^\s*layout\((.*)\)/gm,"");var g,T=Y(an);try{for(T.s();!(g=T.n()).done;){var m=M(g.value,2),A=m[0],S=m[1];v=v.replace(A,S)}}catch(y){T.e(y)}finally{T.f()}}return v}function fn(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=cn(e,"vert",t,n,i),o=cn(e,"frag",r,n,i);return{vert:t,frag:r,preprocessedVert:a,preprocessedFrag:o}}function dn(e,t){var r=void 0!==t.defines?t.defines:null,n=void 0!==t.features?t.features:null,i=void 0!==t.both?t.both+t.vert:t.vert,a=void 0!==t.both?t.both+t.frag:t.frag;return fn(e.queryVendorInfo(),i,a,r,n)}var hn=function(){function e(){g(this,e),this.name="(unnamed)",this.preprocessedVert="",this.preprocessedFrag="",this.both="",this.vert="",this.frag="",this.defines=new Map,this.features={MRT:!0}}return m(e,[{key:"definesChanged",value:function(){this.preprocessedVert="",this.preprocessedFrag=""}},{key:"setDefineString",value:function(e,t){if(null!==t){if(this.defines.get(e)===t)return!1;this.defines.set(e,t)}else{if(!this.defines.has(e))return!1;this.defines.delete(e)}return this.definesChanged(),!0}},{key:"setDefineBool",value:function(e,t){return this.setDefineString(e,t?"1":null)}},{key:"getDefineString",value:function(e){return He(this.defines.get(e))}},{key:"getDefineBool",value:function(e){var t=this.getDefineString(e);return null!==t&&Pe("1"===t),null!==t}},{key:"ensurePreprocessed",value:function(e){""===this.preprocessedVert&&(this.preprocessedVert=cn(e,"vert",this.both+this.vert,this.defines,this.features),this.preprocessedFrag=cn(e,"frag",this.both+this.frag,this.defines,this.features))}}]),e}(),_n=function(){function e(){g(this,e),this.name=void 0,this.texture=null,this.sampler=null,this.lateBinding=null,this.width=0,this.height=0,this.lodBias=0}return m(e,[{key:"reset",value:function(){this.texture=null,this.sampler=null,this.lateBinding=null,this.width=0,this.height=0,this.lodBias=0}},{key:"copy",value:function(e){this.texture=e.texture,this.sampler=e.sampler,this.lateBinding=e.lateBinding,this.width=e.width,this.height=e.height,this.lodBias=e.lodBias}}]),e}(),pn=1,vn=function(){function e(){g(this,e),this.renderHelper=void 0,this.rendererFactory=void 0,this.meshFactory=void 0,this.device=void 0,this.renderingService=void 0,this.meshes=[],this.stencilRefCache={}}return m(e,[{key:"render",value:function(e){var t=this;this.meshes.forEach((function(r){r.init(t.device,t.renderingService);var n=r.objects;r.clipPathTarget&&(n=[r.clipPath]);var i=t.renderHelper.renderInstManager.newRenderInst();r.applyRenderInst(i,n),t.renderHelper.renderInstManager.submitRenderInst(i,e),r.objects.forEach((function(e){e.renderable.dirty=!1}))}))}},{key:"attach",value:function(e,t){this.device=e,this.renderingService=t}},{key:"add",value:function(e){var t=this,r=e.renderable3D;if(r&&!r.meshes.length){var n=this.rendererFactory(e.nodeName);n&&n.meshes.forEach((function(i,a){r.meshes[a]=void 0;var o=n.shouldSubmitRenderInst(e,a);if(o){var s=t.meshes.find((function(t){return i===t.constructor&&t.index===a&&t.shouldMerge(e,a)}));s||(s=t.meshFactory(i),s.renderer=n,s.index=a,t.meshes.push(s)),s&&(s.objects.push(e),r.meshes[a]=s,s.geometryDirty=!0)}}))}}},{key:"remove",value:function(e){var t=this,r=e.renderable3D;r&&(r.meshes.forEach((function(r){if(r){var n=r.objects.indexOf(e);n>-1&&(r.objects.splice(n,1),r.geometryDirty=!0),0===r.objects.length&&t.meshes.splice(t.meshes.indexOf(r),1)}})),r.meshes=[])}},{key:"updateAttribute",value:function(e,t,r){var n=this,i=e.renderable3D,a=this.rendererFactory(e.nodeName);a&&a.meshes.forEach((function(o,s){var u=a.shouldSubmitRenderInst(e,s),l=i.meshes.find((function(e){return e&&e.index===s&&e.constructor===o}));u!==!!l&&(l&&(l.objects.splice(l.objects.indexOf(e),1),l.geometryDirty=!0,0===l.objects.length&&n.meshes.splice(n.meshes.indexOf(l),1),i.meshes[i.meshes.indexOf(l)]=void 0),u&&(l=n.meshes.find((function(t){return o===t.constructor&&t.index===s&&t.shouldMerge(e,s)})),l||(l=n.meshFactory(o),l.renderer=a,l.index=s,l.init(n.device,n.renderingService),n.meshes.push(l)),l&&(l.objects.push(e),i.meshes[s]=l))),u&&l&&l.inited&&!l.geometryDirty&&l.updateAttribute(e,t,r)}))}},{key:"changeRenderOrder",value:function(e,t){var r=e.renderable3D;r&&r.meshes.length&&r.meshes.forEach((function(r){if(r&&r.inited&&!r.geometryDirty){var n=r.renderer.shouldSubmitRenderInst(e,r.index);n&&r.inited&&r.changeRenderOrder(e,t)}}))}},{key:"getStencilRef",value:function(e){return this.stencilRefCache[e.entity]||(this.stencilRefCache[e.entity]=pn++),this.stencilRefCache[e.entity]}}]),e}();(0,n.gn)([(0,o.f3)(Jr),(0,n.w6)("design:type",Jr)],vn.prototype,"renderHelper",void 0),(0,n.gn)([(0,o.f3)(tn),(0,n.w6)("design:type",Function)],vn.prototype,"rendererFactory",void 0),(0,n.gn)([(0,o.f3)(nn),(0,n.w6)("design:type",Function)],vn.prototype,"meshFactory",void 0),vn=(0,n.gn)([(0,o.ri)()],vn);var En,Rn=.005,gn=1,Tn=function(){function e(){g(this,e),this.renderHelper=void 0,this.texturePool=void 0,this.camera=void 0,this.lightPool=void 0,this.batchManager=void 0,this.meshFactory=void 0,this.device=void 0,this.renderingService=void 0,this.id=gn++,this.meshes=[],this.clipPathMeshCreated=!1}return m(e,[{key:"shouldSubmitRenderInst",value:function(e,t){return!0}},{key:"beforeUploadUBO",value:function(e,t,r){}},{key:"beforeInitMesh",value:function(e){}},{key:"afterInitMesh",value:function(e){}}]),e}();function mn(e,t,r){var n=e.createBuffer({viewOrSize:Ke(r.byteLength,4)/4,usage:t,hint:ie.Static});return n.setSubData(0,new Uint8Array(r)),n}(0,n.gn)([(0,o.f3)(Jr),(0,n.w6)("design:type",Jr)],Tn.prototype,"renderHelper",void 0),(0,n.gn)([(0,o.f3)($r),(0,n.w6)("design:type",$r)],Tn.prototype,"texturePool",void 0),(0,n.gn)([(0,o.f3)(i.Rh),(0,n.w6)("design:type",i.V1)],Tn.prototype,"camera",void 0),(0,n.gn)([(0,o.f3)(en),(0,n.w6)("design:type",en)],Tn.prototype,"lightPool",void 0),(0,n.gn)([(0,o.f3)(vn),(0,n.w6)("design:type",vn)],Tn.prototype,"batchManager",void 0),(0,n.gn)([(0,o.f3)(nn),(0,n.w6)("design:type",Function)],Tn.prototype,"meshFactory",void 0),Tn=(0,n.gn)([(0,o.b2)()],Tn),function(e){e[e["MODEL_MATRIX0"]=0]="MODEL_MATRIX0",e[e["MODEL_MATRIX1"]=1]="MODEL_MATRIX1",e[e["MODEL_MATRIX2"]=2]="MODEL_MATRIX2",e[e["MODEL_MATRIX3"]=3]="MODEL_MATRIX3",e[e["COLOR"]=4]="COLOR",e[e["STROKE_COLOR"]=5]="STROKE_COLOR",e[e["PACKED_STYLE1"]=6]="PACKED_STYLE1",e[e["PACKED_STYLE2"]=7]="PACKED_STYLE2",e[e["PICKING_COLOR"]=8]="PICKING_COLOR",e[e["ANCHOR"]=9]="ANCHOR",e[e["MAX"]=10]="MAX"}(En||(En={}));var An=function(e){S(r,e);var t=F(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return g(this,r),n=t.call(this),n.device=void 0,n.props=void 0,n.drawMode=re.Triangles,n.vertexBuffers=[],n.vertices=[],n.indexBuffer=void 0,n.indices=void 0,n.inputLayoutDescriptor={vertexBufferDescriptors:[],vertexAttributeDescriptors:[],indexBufferFormat:Ee.U32_R},n.vertexCount=0,n.instancedCount=0,n.indexStart=0,n.primitiveStart=0,n.dirty=!0,n.meshes=[],n.device=e,n.props=i,n}return m(r,[{key:"validate",value:function(e){return!0}},{key:"build",value:function(e){}},{key:"setIndexBuffer",value:function(e){return this.indexBuffer&&this.indexBuffer.destroy(),this.indexBuffer=mn(this.device,ne.INDEX,new Uint32Array(ArrayBuffer.isView(e)?e.buffer:e).buffer),this.indices=e,this}},{key:"setVertexBuffer",value:function(e){var t=this,r=e.bufferIndex,n=e.byteStride,i=e.frequency,a=e.attributes,o=e.data;this.inputLayoutDescriptor.vertexBufferDescriptors[r]={byteStride:n,frequency:i},this.vertices[r]=o,a.forEach((function(e){var n=e.format,i=e.bufferByteOffset,a=e.location,o=e.divisor,s=e.byteStride,u=t.inputLayoutDescriptor.vertexAttributeDescriptors.find((function(e){return e.bufferIndex===r&&e.location===a}));u?(u.format=n,u.bufferByteOffset=i,u.byteStride=s,u.divisor=o):t.inputLayoutDescriptor.vertexAttributeDescriptors.push({format:n,bufferIndex:r,bufferByteOffset:i,location:a,byteStride:s,divisor:o})})),this.vertexBuffers[r]&&this.vertexBuffers[r].destroy();var s=mn(this.device,ne.VERTEX,o.buffer);return this.vertexBuffers[r]=s,this}},{key:"getVertexBuffer",value:function(e){return this.vertexBuffers[e]}},{key:"updateVertexBuffer",value:function(e,t,r,n){var a=this.inputLayoutDescriptor.vertexBufferDescriptors[e].byteStride,o=this.inputLayoutDescriptor.vertexAttributeDescriptors.find((function(e){return e.location===t}));if(o){var s=this.getVertexBuffer(e),u=r*a;s.setSubData(o.bufferByteOffset+u,n)}this.meshes.forEach((function(e){e.emit(i.Dk.ATTRIBUTE_CHANGED,{attributeName:"geometry"})}))}},{key:"updateIndices",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.indexBuffer&&this.indexBuffer.setSubData(t,ArrayBuffer.isView(e)?e:new Uint32Array(e)),this}},{key:"destroy",value:function(){this.vertexBuffers.forEach((function(e){e&&e.destroy()})),this.indexBuffer&&this.indexBuffer.destroy(),this.inputLayoutDescriptor.vertexAttributeDescriptors=[],this.inputLayoutDescriptor.vertexBufferDescriptors=[],this.indexBuffer=void 0,this.vertexBuffers=[],this.indices=void 0,this.vertices=[],this.vertexCount=0,this.instancedCount=0}}]),r}(u.EventEmitter);function Sn(e){return!(!e||!e.type)}var yn,Cn=function(){function e(t,r){g(this,e),this.device=void 0,this.props={},this.meshes=[],this.defines={},this.uniforms={},this.uniformNames=void 0,this.uboBuffer=[],this.textures={},this.samplers=[],this.programDirty=!0,this.textureDirty=!0,this.geometryDirty=!0;var n=it(ct),i=n.cullMode,a=n.depthCompare,o=n.depthWrite,s=n.stencilCompare,u=n.stencilWrite,l=n.stencilPassOp,c=n.frontFace,f=n.polygonOffset,d=n.attachmentsState;this.device=t,this.props=v({cullMode:i,depthTest:!0,depthCompare:a,depthWrite:o,stencilCompare:s,stencilWrite:u,stencilPassOp:l,frontFace:c,polygonOffset:f,attachmentsState:d,blendEquation:J.Add,blendEquationAlpha:J.Add,blendSrc:Q.SrcAlpha,blendDst:Q.OneMinusSrcAlpha,blendSrcAlpha:Q.Zero,blendDstAlpha:Q.One,dithering:!1,wireframe:!1,wireframeColor:"black",wireframeLineWidth:1,vertexShader:"",fragmentShader:""},r),this.compile()}return m(e,[{key:"cullMode",get:function(){return this.props.cullMode},set:function(e){this.props.cullMode=e}},{key:"frontFace",get:function(){return this.props.frontFace},set:function(e){this.props.frontFace=e}},{key:"blendEquation",get:function(){return this.props.blendEquation},set:function(e){this.props.blendEquation=e}},{key:"blendEquationAlpha",get:function(){return this.props.blendEquationAlpha},set:function(e){this.props.blendEquationAlpha=e}},{key:"blendSrc",get:function(){return this.props.blendSrc},set:function(e){this.props.blendSrc=e}},{key:"blendDst",get:function(){return this.props.blendDst},set:function(e){this.props.blendDst=e}},{key:"blendSrcAlpha",get:function(){return this.props.blendSrcAlpha},set:function(e){this.props.blendSrcAlpha=e}},{key:"blendDstAlpha",get:function(){return this.props.blendDstAlpha},set:function(e){this.props.blendDstAlpha=e}},{key:"depthCompare",get:function(){return this.props.depthCompare},set:function(e){this.props.depthCompare=e}},{key:"depthTest",get:function(){return this.props.depthTest},set:function(e){this.props.depthTest=e}},{key:"depthWrite",get:function(){return this.props.depthWrite},set:function(e){this.props.depthWrite=e}},{key:"stencilCompare",get:function(){return this.props.stencilCompare},set:function(e){this.props.stencilCompare=e}},{key:"stencilWrite",get:function(){return this.props.stencilWrite},set:function(e){this.props.stencilWrite=e}},{key:"stencilPassOp",get:function(){return this.props.stencilPassOp},set:function(e){this.props.stencilPassOp=e}},{key:"stencilRef",get:function(){return this.props.stencilRef},set:function(e){this.props.stencilRef=e}},{key:"polygonOffset",get:function(){return this.props.polygonOffset},set:function(e){this.props.polygonOffset=e}},{key:"dithering",get:function(){return this.props.dithering},set:function(e){this.props.dithering=e}},{key:"wireframe",get:function(){return this.props.wireframe},set:function(e){this.props.wireframe!==e&&(this.geometryDirty=!0,this.programDirty=!0,this.props.wireframe=e),this.defines.USE_WIREFRAME=!!e}},{key:"wireframeColor",get:function(){return this.props.wireframeColor},set:function(e){this.props.wireframeColor=e}},{key:"wireframeLineWidth",get:function(){return this.props.wireframeLineWidth},set:function(e){this.props.wireframeLineWidth=e}},{key:"vertexShader",get:function(){return this.props.vertexShader},set:function(e){this.props.vertexShader!==e&&(this.programDirty=!0,this.props.vertexShader=e,this.compile())}},{key:"fragmentShader",get:function(){return this.props.fragmentShader},set:function(e){this.props.fragmentShader!==e&&(this.programDirty=!0,this.props.fragmentShader=e,this.compile())}},{key:"compile",value:function(){var e=this;this.props.fragmentShader.replace(/^\s*uniform\s*sampler2D\s*(.*)\s*;$/gm,(function(t,r){return e.samplers.push(r),""})),this.uniformNames=ln(this.props.fragmentShader)}},{key:"setUniforms",value:function(e){var t=this;Object.keys(e).forEach((function(r){var n=e[r],i=t.textures[r];i&&i!==n&&(t.textureDirty=!0),Sn(n)?(t.textures[r]=n,t.textureDirty=!0):t.uniforms[r]=n,(0,s.UM)(e[r])&&(delete t.textures[r],delete t.uniforms[r])})),this.meshes.forEach((function(e){e.emit(i.Dk.ATTRIBUTE_CHANGED,{attributeName:"material"})}))}}]),e}(),Bn=function(e){S(r,e);var t=F(r);function r(e,n){var i;return g(this,r),i=t.call(this,e,v({},n)),i.defines=v(v({},i.defines),{},{USE_UV:!1,USE_MAP:!1,USE_WIREFRAME:!1,USE_FOG:!1,USE_LIGHT:!1}),i}return r}(Cn),On=1,xn="FillTextureMapping";(function(e){e[e["INSTANCED"]=0]="INSTANCED",e[e["MAX"]=1]="MAX"})(yn||(yn={}));var Dn=function(){function e(){g(this,e),this.id=On++,this.renderer=void 0,this.index=-1,this.renderHelper=void 0,this.texturePool=void 0,this.camera=void 0,this.lightPool=void 0,this.device=void 0,this.renderingService=void 0,this.objects=[],this.material=void 0,this.geometry=void 0,this.clipPath=void 0,this.clipPathTarget=void 0,this.inputState=void 0,this.program=new hn,this.programDescriptorSimpleWithOrig=void 0,this.geometryDirty=!0,this.materialDirty=!0,this.inputStateDirty=!0,this.textureMappings=[],this.samplerEntries=void 0,this.inited=!1}return m(e,[{key:"instance",get:function(){return this.objects[0]}},{key:"init",value:function(e,t){this.inited||(this.renderer.beforeInitMesh(this),this.device=e,this.renderingService=t,this.material=new Bn(this.device),this.geometry=new An(this.device),this.inited=!0,this.renderer.afterInitMesh(this))}},{key:"shouldMerge",value:function(e,t){return!this.instance||this.instance.nodeName===e.nodeName&&!e.parsedStyle.clipPath}},{key:"createGeometry",value:function(e){var t=this,r=Fr(),n=Fr(),a=[];e.forEach((function(e){var o,s=e.parsedStyle,u=s.fill,l=s.stroke,c=s.opacity,f=s.fillOpacity,d=s.strokeOpacity,h=s.lineWidth,_=void 0===h?0:h,p=(s.lineDash,s.anchor),v=s.visibility,E=[0,0,0,0];(null===u||void 0===u?void 0:u.type)===i.qx.Constant&&(E=u.value);var R=[0,0,0,0];(null===l||void 0===l?void 0:l.type)===i.qx.Constant&&(R=l.value),t.clipPathTarget?(Pr(r,e.getLocalTransform()),E=[1,1,1,1],Lr(r,t.clipPathTarget.getWorldTransform(),r)):Pr(r,e.getWorldTransform()),Lr(n,t.camera.getViewTransform(),r);var g=(null===(o=e.renderable3D)||void 0===o?void 0:o.encodedPickingColor)||[0,0,0];a.push.apply(a,L(r).concat(L(E),L(R),[c,f,d,_,"visible"===v?1:0,0,0,0],L(g),[e.sortable.renderOrder*Rn,p[0],p[1]]))})),this.geometry.instancedCount=e.length,this.geometry.setVertexBuffer({bufferIndex:yn.INSTANCED,byteStride:152,frequency:ae.PerInstance,attributes:[{format:Ee.F32_RGBA,bufferByteOffset:0,location:En.MODEL_MATRIX0,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:16,location:En.MODEL_MATRIX1,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:32,location:En.MODEL_MATRIX2,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:48,location:En.MODEL_MATRIX3,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:64,location:En.COLOR,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:80,location:En.STROKE_COLOR,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:96,location:En.PACKED_STYLE1,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:112,location:En.PACKED_STYLE2,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:128,location:En.PICKING_COLOR,divisor:1},{format:Ee.F32_RG,bufferByteOffset:144,location:En.ANCHOR,divisor:1}],data:new Float32Array(a)})}},{key:"destroy",value:function(){this.geometry&&this.geometry.destroy(),this.inputState&&this.inputState.destroy()}},{key:"applyRenderInst",value:function(e,t){var r=this,n=this.lightPool.getAllLights(),i=this.lightPool.getFog(),a=!!i,o=!!n.length;this.material.defines.USE_WIREFRAME;if(a===this.material.defines.USE_FOG&&o===this.material.defines.USE_LIGHT||(this.material.programDirty=!0),this.material.defines.USE_FOG=a,this.material.defines.USE_LIGHT=o,this.material.defines=v(v({},this.material.defines),this.lightPool.getDefines()),this.clipPathTarget||this.clipPath?this.clipPathTarget?(this.material.stencilWrite=!0,this.material.depthWrite=!1,this.material.stencilCompare=q.Always,this.material.stencilPassOp=le.Replace):(this.material.stencilWrite=!1,this.material.depthWrite=!0,this.material.stencilCompare=q.Equal,this.material.stencilPassOp=le.Keep):this.material.stencilWrite=!1,this.material.textureDirty||this.materialDirty){this.textureMappings=[];var s=this.createFillGradientTextureMapping(t);s&&(this.material.defines.USE_UV=!0,this.material.defines.USE_MAP=!0,this.textureMappings.push(s))}(this.material.programDirty||this.materialDirty)&&(this.createMaterial(t),Object.keys(this.material.defines).forEach((function(e){var t=r.material.defines[e];"number"===typeof t?r.program.setDefineString(e,"".concat(t)):r.program.setDefineBool(e,t)})),this.program.vert=this.material.vertexShader,this.program.frag=this.material.fragmentShader,this.programDescriptorSimpleWithOrig=dn(this.device,this.program),this.material.programDirty=!1),(this.material.textureDirty||this.materialDirty)&&(Object.keys(this.material.textures).sort((function(e,t){return r.material.samplers.indexOf(e)-r.material.samplers.indexOf(t)})).forEach((function(e){var t=new _n;t.name=e,t.texture=r.material.textures[e],r.device.setResourceName(t.texture,"Material Texture "+e),t.sampler=r.renderHelper.getCache().createSampler({wrapS:$.Clamp,wrapT:$.Clamp,minFilter:ee.Point,magFilter:ee.Bilinear,mipFilter:te.Linear,minLOD:0,maxLOD:0}),r.textureMappings.push(t)})),this.material.textureDirty=!1,this.materialDirty=!1),this.material.geometryDirty&&(this.geometryDirty=!0,this.inputStateDirty=!0,this.material.geometryDirty=!1),(this.geometryDirty||this.geometry.dirty)&&(this.geometry&&this.geometry.destroy(),this.createGeometry(t),this.material.wireframe&&this.generateWireframe(this.geometry),this.geometryDirty=!1,this.geometry.dirty=!1,this.inputStateDirty=!0);var u=this.renderHelper.getCache().createInputLayout(this.geometry.inputLayoutDescriptor),l=this.renderHelper.getCache().createProgramSimple(this.programDescriptorSimpleWithOrig),c=!!this.geometry.indexBuffer;this.inputStateDirty&&(this.inputState&&this.inputState.destroy(),this.inputState=this.device.createInputState(u,this.geometry.vertexBuffers.map((function(e){return{buffer:e,byteOffset:0}})),c?{buffer:this.geometry.indexBuffer,byteOffset:0}:null,l),this.inputStateDirty=!1),e.setProgram(l),e.setInputLayoutAndState(u,this.inputState),this.renderer.beforeUploadUBO(e,this,this.index),this.uploadUBO(e),c?e.drawIndexesInstanced(this.geometry.vertexCount,this.geometry.instancedCount,this.geometry.indexStart):e.drawPrimitives(this.geometry.vertexCount,this.geometry.primitiveStart),e.sortKey=Dr(yr.OPAQUE,t[0].sortable.renderOrder)}},{key:"updateBatchedAttribute",value:function(e,t,r,n){var a=["opacity","fillOpacity","strokeOpacity","lineWidth"];if("fill"===r){var o=e.parsedStyle.fill,s=this.textureMappings.findIndex((function(e){return e.name===xn})),u=[0,0,0,0];if((null===o||void 0===o?void 0:o.type)===i.qx.Constant)u=o.value,this.geometry.updateVertexBuffer(yn.INSTANCED,En.COLOR,t,new Uint8Array(new Float32Array(L(u)).buffer)),s>=0&&this.textureMappings.splice(s,-1);else{var l=this.createFillGradientTextureMapping([e]);s>=0&&this.textureMappings.splice(s,1,l),this.material.textureDirty=!0}}else if("stroke"===r){var c=e.parsedStyle.stroke,f=[0,0,0,0];(null===c||void 0===c?void 0:c.type)===i.qx.Constant&&(f=c.value),this.geometry.updateVertexBuffer(yn.INSTANCED,En.STROKE_COLOR,t,new Uint8Array(new Float32Array(L(f)).buffer))}else if(a.indexOf(r)>-1){var d=e.parsedStyle,h=d.opacity,_=d.fillOpacity,p=d.strokeOpacity,v=d.lineWidth,E=void 0===v?0:v;this.geometry.updateVertexBuffer(yn.INSTANCED,En.PACKED_STYLE1,t,new Uint8Array(new Float32Array([h,_,p,E]).buffer))}else if("modelMatrix"===r){var R=Pr(Fr(),e.getWorldTransform());this.geometry.updateVertexBuffer(yn.INSTANCED,En.MODEL_MATRIX0,t,new Uint8Array(new Float32Array(R).buffer))}else if("anchor"===r){var g=e.parsedStyle.anchor;this.geometry.updateVertexBuffer(yn.INSTANCED,En.ANCHOR,t,new Uint8Array(new Float32Array([g[0],g[1]]).buffer))}else if("visibility"===r){var T=e.parsedStyle.visibility;this.geometry.updateVertexBuffer(yn.INSTANCED,En.PACKED_STYLE2,t,new Uint8Array(new Float32Array(["visible"===T?1:0]).buffer))}}},{key:"updateAttribute",value:function(e,t,r){"clipPath"===t&&this.clipPath&&(this.geometryDirty=!0)}},{key:"changeRenderOrder",value:function(e,t){var r,n=this.objects.indexOf(e),i=(null===(r=e.renderable3D)||void 0===r?void 0:r.encodedPickingColor)||[0,0,0];this.geometry.updateVertexBuffer(yn.INSTANCED,En.PICKING_COLOR,n,new Uint8Array(new Float32Array([].concat(L(i),[t*Rn])).buffer))}},{key:"generateWireframe",value:function(e){for(var t=e.indices,r=e.indices.length,n=e.vertices.map((function(e){return e.slice()})),i=1;i<e.vertexBuffers.length;i++){var a=e.inputLayoutDescriptor.vertexBufferDescriptors[i].byteStride;e.vertices[i]=new Float32Array(a/4*r)}for(var o=0,s=new Uint32Array(r),u=0;u<r;u++){for(var l=t[u],c=1;c<e.vertices.length;c++)for(var f=e.inputLayoutDescriptor.vertexBufferDescriptors[c].byteStride,d=f/4,h=0;h<d;h++)e.vertices[c][o*d+h]=n[c][l*d+h];s[u]=o,o++}for(var _=function(t){if(4===t)return"continue";var r=e.inputLayoutDescriptor.vertexBufferDescriptors[t],n=r.frequency,i=r.byteStride,a=e.inputLayoutDescriptor.vertexAttributeDescriptors.find((function(e){var r=e.bufferIndex;return r===t}));if(a){var o=a.location,s=a.bufferIndex,u=a.bufferByteOffset,l=a.format,c=a.divisor;e.setVertexBuffer({bufferIndex:s,byteStride:i,frequency:n,attributes:[{format:l,bufferByteOffset:u,location:o,divisor:c}],data:e.vertices[t]})}},p=1;p<e.vertexBuffers.length;p++)_(p);for(var v=new Float32Array(3*r),E=0;E<r;)for(var R=0;R<3;R++){var g=s[E++];v[3*g+R]=1}e.setVertexBuffer({bufferIndex:4,byteStride:12,frequency:ae.PerVertex,attributes:[{format:Ee.F32_RGB,bufferByteOffset:0,location:Number(this.material.defines.BARYCENTRIC)}],data:v}),e.setIndexBuffer(s)}},{key:"beforeUploadUBO",value:function(e,t,r){}},{key:"uploadUBO",value:function(e){var t=this,r=1,n=this.material,a=this.lightPool.getAllLights(),o=this.lightPool.getFog(),s=!!o,u=!!a.length,l=n.defines.USE_WIREFRAME,c=[];if(l){var f=(0,i.lu)(n.wireframeColor).value;c.push({name:"u_WireframeLineColor",value:f.slice(0,3)}),c.push({name:"u_WireframeLineWidth",value:n.wireframeLineWidth})}if(s&&this.uploadFog(c,o),this.uploadMaterial(c,n),u){var d={};a.forEach((function(e){d[e.define]||(d[e.define]=-1),d[e.define]++,e.uploadUBO(c,d[e.define])}))}c.sort((function(e,r){return t.material.uniformNames.indexOf(e.name)-t.material.uniformNames.indexOf(r.name)})),e.setUniforms(r,c);var h=n.depthCompare,_=n.depthWrite,p=n.stencilCompare,v=n.stencilWrite,E=n.stencilPassOp,R=n.stencilRef,g=n.cullMode,T=n.frontFace,m=n.polygonOffset,A=n.blendEquation,S=n.blendEquationAlpha,y=n.blendSrc,C=n.blendDst,B=n.blendSrcAlpha,O=n.blendDstAlpha;e.setMegaStateFlags({attachmentsState:[{channelWriteMask:this.material.stencilWrite?ue.None:ue.AllChannels,rgbBlendState:{blendMode:A,blendSrcFactor:y,blendDstFactor:C},alphaBlendState:{blendMode:S,blendSrcFactor:B,blendDstFactor:O}}],depthCompare:h,depthWrite:_,stencilCompare:p,stencilWrite:v,stencilPassOp:E,stencilRef:R,cullMode:g,frontFace:T,polygonOffset:m}),e.setBindingLayouts([{numUniformBuffers:r,numSamplers:this.textureMappings.length,samplerEntries:this.samplerEntries}]),e.setSamplerBindingsFromTextureMappings(this.textureMappings)}},{key:"uploadFog",value:function(e,t){var r=t.parsedStyle,n=r.type,a=r.fill,o=r.start,s=r.end,u=r.density;if((null===a||void 0===a?void 0:a.type)===i.qx.Constant){var l=a.value;e.push({name:"u_FogInfos",value:[n,o,s,u]}),e.push({name:"u_FogColor",value:l})}}},{key:"uploadMaterial",value:function(e,t){var r=Object.keys(t.uniforms).map((function(e){return{name:e,value:t.uniforms[e]}}));e.push.apply(e,L(r))}},{key:"createFillGradientTextureMapping",value:function(e){var t=this,r=e[0],n=r.nodeName===i.X3.Line?r.parsedStyle.stroke:r.parsedStyle.fill;if(n&&(n.type===i.qx.Pattern||n.type===i.qx.LinearGradient||n.type===i.qx.RadialGradient)){var a;this.program.setDefineBool("USE_UV",!0),this.program.setDefineBool("USE_MAP",!0),n.type===i.qx.LinearGradient||n.type===i.qx.RadialGradient?(this.texturePool.getOrCreateGradient(v(v({type:n.type},n.value),{},{width:128,height:128})),a=this.texturePool.getOrCreateCanvas()):a=n.value.src;var o=new _n;return o.name=xn,o.texture=this.texturePool.getOrCreateTexture(this.device,a,Ae(Ee.U8_RGBA_NORM,1,1,1),(function(){e.forEach((function(e){e.renderable.dirty=!0,t.renderingService.dirtify()}))})),this.device.setResourceName(o.texture,"Fill Texture"+this.id),o.sampler=this.renderHelper.getCache().createSampler({wrapS:$.Repeat,wrapT:$.Repeat,minFilter:ee.Point,magFilter:ee.Bilinear,mipFilter:te.Linear,minLOD:0,maxLOD:0}),o}return null}}]),e}();(0,n.gn)([(0,o.f3)(Jr),(0,n.w6)("design:type",Jr)],Dn.prototype,"renderHelper",void 0),(0,n.gn)([(0,o.f3)($r),(0,n.w6)("design:type",$r)],Dn.prototype,"texturePool",void 0),(0,n.gn)([(0,o.f3)(i.Rh),(0,n.w6)("design:type",i.V1)],Dn.prototype,"camera",void 0),(0,n.gn)([(0,o.f3)(en),(0,n.w6)("design:type",en)],Dn.prototype,"lightPool",void 0),Dn=(0,n.gn)([(0,o.b2)()],Dn);var Nn,Fn,Pn="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\n\nlayout(location = 0) attribute vec4 a_ModelMatrix0;\nlayout(location = 1) attribute vec4 a_ModelMatrix1;\nlayout(location = 2) attribute vec4 a_ModelMatrix2;\nlayout(location = 3) attribute vec4 a_ModelMatrix3;\nlayout(location = 4) attribute vec4 a_Color;\nlayout(location = 5) attribute vec4 a_StrokeColor;\nlayout(location = 6) attribute vec4 a_StylePacked1;\nlayout(location = 7) attribute vec4 a_StylePacked2;\nlayout(location = 8) attribute vec4 a_PickingColor;\nlayout(location = 9) attribute vec2 a_Anchor;\n\nvarying vec4 v_PickingResult;\nvarying vec4 v_Color;\nvarying vec4 v_StrokeColor;\nvarying vec4 v_StylePacked1;\nvarying vec4 v_StylePacked2;\n\n#define COLOR_SCALE 1. / 255.\nvoid setPickingColor(vec3 pickingColor) {\n  v_PickingResult.rgb = pickingColor * COLOR_SCALE;\n}\nvec4 project(vec4 pos, mat4 pm, mat4 vm, mat4 mm) {\n  return pm * vm * mm * pos;\n}\n\nlayout(location = 10) attribute vec2 a_Extrude;\nlayout(location = 11) attribute vec4 a_StylePacked3;\nlayout(location = 12) attribute vec2 a_Size;\n#ifdef USE_UV\n  layout(location = 13) attribute vec2 a_Uv;\n  varying vec2 v_Uv;\n#endif\n\nvarying vec4 v_Data;\nvarying vec2 v_Radius;\nvarying vec4 v_StylePacked3;\n\nvoid main() {\n  mat4 u_ModelMatrix = mat4(a_ModelMatrix0, a_ModelMatrix1, a_ModelMatrix2, a_ModelMatrix3);\nvec4 u_StrokeColor = a_StrokeColor;\nfloat u_Opacity = a_StylePacked1.x;\nfloat u_FillOpacity = a_StylePacked1.y;\nfloat u_StrokeOpacity = a_StylePacked1.z;\nfloat u_StrokeWidth = a_StylePacked1.w;\nfloat u_ZIndex = a_PickingColor.w;\n\nsetPickingColor(a_PickingColor.xyz);\n\nv_Color = a_Color;\nv_StrokeColor = a_StrokeColor;\nv_StylePacked1 = a_StylePacked1;\nv_StylePacked2 = a_StylePacked2;\n\n#ifdef CLIPSPACE_NEAR_ZERO\n    gl_Position.z = gl_Position.z * 0.5 + 0.5;\n#endif\n  #ifdef USE_UV\n  v_Uv = a_Uv;\n  #ifdef VIEWPORT_ORIGIN_TL\n    v_Uv.y = 1.0 - v_Uv.y;\n  #endif\n#endif\n\n  float antialiasblur = 1.0 / (a_Size.x + u_StrokeWidth);\n\n  bool omitStroke = a_StylePacked3.z == 1.0;\n  vec2 radius = a_Size + vec2(omitStroke ? 0.0 : u_StrokeWidth / 2.0);\n  vec2 offset = (a_Extrude + vec2(1.0) - 2.0 * a_Anchor.xy) * radius;\n\n  gl_Position = project(vec4(offset, u_ZIndex, 1.0), u_ProjectionMatrix, u_ViewMatrix, u_ModelMatrix);\n  \n  v_Radius = radius;\n  v_Data = vec4(a_Extrude, antialiasblur, a_StylePacked3.x);\n  v_StylePacked3 = a_StylePacked3;\n}",In="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\n\nvarying vec4 v_PickingResult;\nvarying vec4 v_Color;\nvarying vec4 v_StrokeColor;\nvarying vec4 v_StylePacked1;\nvarying vec4 v_StylePacked2;\n#ifdef USE_UV\n  varying vec2 v_Uv;\n#endif\n#ifdef USE_MAP\n  uniform sampler2D u_Map;\n#endif\n\nvarying vec4 v_Data;\nvarying vec2 v_Radius;\nvarying vec4 v_StylePacked3;\n\n/**\n * 2D signed distance field functions\n * @see http://www.iquilezles.org/www/articles/distfunctions2d/distfunctions2d.htm\n */\n\nfloat sdCircle(vec2 p, float r) {\n  return length(p) - r;\n}\n\n// @see http://www.iquilezles.org/www/articles/ellipsoids/ellipsoids.htm\nfloat sdEllipsoidApproximated(vec2 p, vec2 r) {\n  float k0 = length(p / r);\n  float k1 = length(p / (r * r));\n  return k0 * (k0 - 1.0) / k1;\n}\n\nvoid main() {\n  int shape = int(floor(v_Data.w + 0.5));\n\n  vec4 u_Color = v_Color;\nvec4 u_StrokeColor = v_StrokeColor;\nfloat u_Opacity = v_StylePacked1.x;\nfloat u_FillOpacity = v_StylePacked1.y;\nfloat u_StrokeOpacity = v_StylePacked1.z;\nfloat u_StrokeWidth = v_StylePacked1.w;\nfloat u_Visible = v_StylePacked2.x;\n\ngbuf_picking = vec4(v_PickingResult.rgb, 1.0);\n\nif (u_Visible < 1.0) {\n    discard;\n}\n  #ifdef USE_MAP\n  vec4 texelColor = texture(SAMPLER_2D(u_Map), v_Uv);\n  u_Color = texelColor;\n#endif\n\n  bool omitStroke = v_StylePacked3.z == 1.0;\n\n  float antialiasblur = v_Data.z;\n  float antialiased_blur = -max(0.0, antialiasblur);\n  vec2 r = (v_Radius - (omitStroke ? 0.0 : u_StrokeWidth)) / v_Radius;\n\n  float outer_df;\n  float inner_df;\n  // 'circle', 'ellipse', 'rect'\n  if (shape == 0) {\n    outer_df = sdCircle(v_Data.xy, 1.0);\n    inner_df = sdCircle(v_Data.xy, r.x);\n  } else if (shape == 1) {\n    outer_df = sdEllipsoidApproximated(v_Data.xy, vec2(1.0));\n    inner_df = sdEllipsoidApproximated(v_Data.xy, r);\n  }\n\n  float opacity_t = smoothstep(0.0, antialiased_blur, outer_df);\n\n  float color_t = u_StrokeWidth < 0.01 ? 0.0 : smoothstep(\n    antialiased_blur,\n    0.0,\n    inner_df\n  );\n\n  // vec2 imagecoord = mod(v_Uv, 0.1);\n  // vec4 texel = texture(SAMPLER_2D(u_Map), imagecoord);\n  // u_Color = texel;\n\n  vec4 diffuseColor = u_Color;\n\n  vec4 strokeColor = (u_StrokeColor == vec4(0) || omitStroke) ? vec4(0.0) : u_StrokeColor;\n\n  gl_FragColor = mix(vec4(diffuseColor.rgb, diffuseColor.a * u_FillOpacity), strokeColor * u_StrokeOpacity, color_t);\n  gl_FragColor.a = gl_FragColor.a * u_Opacity * opacity_t;\n\n  if (gl_FragColor.a < 0.001)\n    discard;\n}";(function(e){e[e["EXTRUDE_UV"]=1]="EXTRUDE_UV",e[e["SIZE"]=2]="SIZE",e[e["PACKED_STYLE3"]=3]="PACKED_STYLE3"})(Nn||(Nn={})),function(e){e[e["EXTRUDE"]=10]="EXTRUDE",e[e["PACKED_STYLE3"]=11]="PACKED_STYLE3",e[e["SIZE"]=12]="SIZE",e[e["UV"]=13]="UV"}(Fn||(Fn={}));var Mn=[i.X3.Circle,i.X3.Ellipse],bn=function(e){S(r,e);var t=F(r);function r(){return g(this,r),t.apply(this,arguments)}return m(r,[{key:"shouldMerge",value:function(e,t){var n=I(y(r.prototype),"shouldMerge",this).call(this,e,t);return!!n&&(!this.needDrawStrokeSeparately(e)&&!this.needDrawStrokeSeparately(this.instance))}},{key:"createMaterial",value:function(e){this.material.vertexShader=Pn,this.material.fragmentShader=In}},{key:"createGeometry",value:function(e){var t=this;I(y(r.prototype),"createGeometry",this).call(this,e);var n=[],i=[],a=[],o=[];e.forEach((function(e,r){var s=e,u=4*r,l=s.parsedStyle.radius,c=t.shouldOmitStroke(s.parsedStyle),f=t.getSize(e.attributes,s.nodeName);i.push.apply(i,L(f)),a.push(Mn.indexOf(s.nodeName),l||0,c?1:0,0),n.push(-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1),o.push(0+u,2+u,1+u,0+u,3+u,2+u)})),this.geometry.setIndexBuffer(new Uint32Array(o)),this.geometry.vertexCount=6,this.geometry.setVertexBuffer({bufferIndex:Nn.EXTRUDE_UV,byteStride:16,frequency:ae.PerVertex,attributes:[{format:Ee.F32_RG,bufferByteOffset:0,location:Fn.EXTRUDE},{format:Ee.F32_RG,bufferByteOffset:8,location:Fn.UV}],data:new Float32Array(n)}),this.geometry.setVertexBuffer({bufferIndex:Nn.SIZE,byteStride:8,frequency:ae.PerInstance,attributes:[{format:Ee.F32_RG,bufferByteOffset:0,location:Fn.SIZE,divisor:1}],data:new Float32Array(i)}),this.geometry.setVertexBuffer({bufferIndex:Nn.PACKED_STYLE3,byteStride:16,frequency:ae.PerInstance,attributes:[{format:Ee.F32_RGBA,bufferByteOffset:0,location:Fn.PACKED_STYLE3,divisor:1}],data:new Float32Array(a)})}},{key:"updateAttribute",value:function(e,t,n){I(y(r.prototype),"updateAttribute",this).call(this,e,t,n);var i=this.objects.indexOf(e);if(this.updateBatchedAttribute(e,i,t,n),"r"===t||"rx"===t||"ry"===t||"lineWidth"===t){var a=this.getSize(e.attributes,e.nodeName),o=M(a,2),s=o[0],u=o[1],l=[s,u];this.geometry.updateVertexBuffer(Nn.SIZE,Fn.SIZE,i,new Uint8Array(new Float32Array([].concat(l)).buffer))}else if("stroke"===t||"lineDash"===t||"strokeOpacity"===t){var c=e,f=this.shouldOmitStroke(c.parsedStyle);this.geometry.updateVertexBuffer(Nn.PACKED_STYLE3,Fn.PACKED_STYLE3,i,new Uint8Array(new Float32Array([Mn.indexOf(e.nodeName),e.parsedStyle.radius||0,f?1:0,0]).buffer))}}},{key:"getSize",value:function(e,t){var r=[0,0];return t===i.X3.Circle?r=[e.r,e.r]:t===i.X3.Ellipse&&(r=[e.rx,e.ry]),r}},{key:"shouldOmitStroke",value:function(e){var t=e.lineDash,r=e.stroke,n=e.strokeOpacity;return!(!r||!(t&&t.length&&t.every((function(e){return 0!==e}))||1!==n))}},{key:"needDrawStrokeSeparately",value:function(e){var t=e.parsedStyle,r=t.stroke,n=t.lineDash,i=t.lineWidth,a=t.strokeOpacity;return r&&i>0&&(a<1||n&&n.length&&n.every((function(e){return 0!==e})))}}]),r}(Dn);bn=(0,n.gn)([(0,o.b2)()],bn);var Ln,Un,kn,Gn="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\n\nlayout(location = 0) attribute vec4 a_ModelMatrix0;\nlayout(location = 1) attribute vec4 a_ModelMatrix1;\nlayout(location = 2) attribute vec4 a_ModelMatrix2;\nlayout(location = 3) attribute vec4 a_ModelMatrix3;\nlayout(location = 4) attribute vec4 a_Color;\nlayout(location = 5) attribute vec4 a_StrokeColor;\nlayout(location = 6) attribute vec4 a_StylePacked1;\nlayout(location = 7) attribute vec4 a_StylePacked2;\nlayout(location = 8) attribute vec4 a_PickingColor;\nlayout(location = 9) attribute vec2 a_Anchor;\n\nvarying vec4 v_PickingResult;\nvarying vec4 v_Color;\nvarying vec4 v_StrokeColor;\nvarying vec4 v_StylePacked1;\nvarying vec4 v_StylePacked2;\n\n#define COLOR_SCALE 1. / 255.\nvoid setPickingColor(vec3 pickingColor) {\n  v_PickingResult.rgb = pickingColor * COLOR_SCALE;\n}\nvec4 project(vec4 pos, mat4 pm, mat4 vm, mat4 mm) {\n  return pm * vm * mm * pos;\n}\n\nlayout(location = 10) attribute vec3 a_Position;\nlayout(location = 11) attribute vec3 a_PointA;\nlayout(location = 12) attribute vec3 a_PointB;\nlayout(location = 13) attribute float a_Cap;\n#ifdef USE_UV\n  layout(location = 14) attribute vec2 a_Uv;\n  varying vec2 v_Uv;\n#endif\nlayout(location = 15) attribute vec4 a_Dash;\n\nvarying vec4 v_Dash;\n// varying vec2 v_Normal;\n\nvoid main() {\n  mat4 u_ModelMatrix = mat4(a_ModelMatrix0, a_ModelMatrix1, a_ModelMatrix2, a_ModelMatrix3);\nvec4 u_StrokeColor = a_StrokeColor;\nfloat u_Opacity = a_StylePacked1.x;\nfloat u_FillOpacity = a_StylePacked1.y;\nfloat u_StrokeOpacity = a_StylePacked1.z;\nfloat u_StrokeWidth = a_StylePacked1.w;\nfloat u_ZIndex = a_PickingColor.w;\n\nsetPickingColor(a_PickingColor.xyz);\n\nv_Color = a_Color;\nv_StrokeColor = a_StrokeColor;\nv_StylePacked1 = a_StylePacked1;\nv_StylePacked2 = a_StylePacked2;\n\n#ifdef CLIPSPACE_NEAR_ZERO\n    gl_Position.z = gl_Position.z * 0.5 + 0.5;\n#endif\n  #ifdef USE_UV\n  v_Uv = a_Uv;\n  #ifdef VIEWPORT_ORIGIN_TL\n    v_Uv.y = 1.0 - v_Uv.y;\n  #endif\n#endif\n\n  float isBillboard = a_Dash.w;\n  if (isBillboard < 0.5) {\n    vec2 xBasis = a_PointB.xy - a_PointA.xy;\n    vec2 yBasis = normalize(vec2(-xBasis.y, xBasis.x));\n\n    vec2 point = a_PointA.xy + xBasis * a_Position.x + yBasis * u_StrokeWidth * a_Position.y;\n    point = point - a_Anchor.xy * abs(xBasis);\n\n    // round & square\n    if (a_Cap > 1.0) {\n      point += sign(a_Position.x - 0.5) * normalize(xBasis) * vec2(u_StrokeWidth / 2.0);\n    }\n\n    gl_Position = project(vec4(point, u_ZIndex, 1.0), u_ProjectionMatrix, u_ViewMatrix, u_ModelMatrix);\n  } else {\n    // clip space\n    vec4 clip0 = project(vec4(a_PointA, 1.0), u_ProjectionMatrix, u_ViewMatrix, u_ModelMatrix);\n    vec4 clip1 = project(vec4(a_PointB, 1.0), u_ProjectionMatrix, u_ViewMatrix, u_ModelMatrix);\n    // screen space\n    vec2 screen0 = u_Viewport * (0.5 * clip0.xy / clip0.w + 0.5);\n    vec2 screen1 = u_Viewport * (0.5 * clip1.xy / clip1.w + 0.5);\n    vec2 xBasis = normalize(screen1 - screen0);\n    vec2 yBasis = vec2(-xBasis.y, xBasis.x);\n    vec2 pt0 = screen0 + u_StrokeWidth * (a_Position.x * xBasis + a_Position.y * yBasis);\n    vec2 pt1 = screen1 + u_StrokeWidth * (a_Position.x * xBasis + a_Position.y * yBasis);\n    vec2 pt = mix(pt0, pt1, a_Position.z);\n    vec4 clip = mix(clip0, clip1, a_Position.z);\n    gl_Position = vec4(clip.w * (2.0 * pt / u_Viewport - 1.0), clip.z, clip.w);\n  }\n\n  v_Dash = vec4(a_Position.x, a_Dash.xyz);\n}",wn="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\n\nvarying vec4 v_PickingResult;\nvarying vec4 v_Color;\nvarying vec4 v_StrokeColor;\nvarying vec4 v_StylePacked1;\nvarying vec4 v_StylePacked2;\n#ifdef USE_UV\n  varying vec2 v_Uv;\n#endif\n#ifdef USE_MAP\n  uniform sampler2D u_Map;\n#endif\n\nvarying vec4 v_Dash;\n// varying vec2 v_Normal;\n\nvoid main() {\n  vec4 u_Color = v_Color;\nvec4 u_StrokeColor = v_StrokeColor;\nfloat u_Opacity = v_StylePacked1.x;\nfloat u_FillOpacity = v_StylePacked1.y;\nfloat u_StrokeOpacity = v_StylePacked1.z;\nfloat u_StrokeWidth = v_StylePacked1.w;\nfloat u_Visible = v_StylePacked2.x;\n\ngbuf_picking = vec4(v_PickingResult.rgb, 1.0);\n\nif (u_Visible < 1.0) {\n    discard;\n}\n  #ifdef USE_MAP\n  vec4 texelColor = texture(SAMPLER_2D(u_Map), v_Uv);\n  u_Color = texelColor;\n#endif\n\n  gl_FragColor = u_StrokeColor;\n  #ifdef USE_MAP\n      gl_FragColor = u_Color;\n  #endif\n\n  // float blur = 1. - smoothstep(0.98, 1., length(v_Normal));\n  float u_dash_offset = v_Dash.y;\n  float u_dash_array = v_Dash.z;\n  float u_dash_ratio = v_Dash.w;\n  gl_FragColor.a = gl_FragColor.a\n    // * blur\n    * u_Opacity * u_StrokeOpacity\n    * ceil(mod(v_Dash.x + u_dash_offset, u_dash_array) - (u_dash_array * u_dash_ratio));\n}",Wn=[0,-.5,0,0,0,1,-.5,1,1,0,1,.5,1,1,1,0,.5,0,0,1];(function(e){e[e["POSITION_UV"]=1]="POSITION_UV",e[e["POINT_CAP_DASH"]=2]="POINT_CAP_DASH"})(Un||(Un={})),function(e){e[e["POSITION"]=10]="POSITION",e[e["POINTA"]=11]="POINTA",e[e["POINTB"]=12]="POINTB",e[e["CAP"]=13]="CAP",e[e["UV"]=14]="UV",e[e["DASH"]=15]="DASH"}(kn||(kn={}));var Xn=(Ln={},A(Ln,i.$o.Butt,1),A(Ln,i.$o.Round,2),A(Ln,i.$o.Square,3),Ln),Vn=function(e){S(r,e);var t=F(r);function r(){return g(this,r),t.apply(this,arguments)}return m(r,[{key:"shouldMerge",value:function(e,t){var n=I(y(r.prototype),"shouldMerge",this).call(this,e,t);if(!n)return!1;var a=this.instance;if(a.nodeName===i.X3.Line){var o=a.parsedStyle.stroke,s=e.parsedStyle.stroke;if(o.type!==s.type)return!1;if(o.type!==i.qx.Constant&&s.type!==i.qx.Constant)return o.value.hash===s.value.hash}return!0}},{key:"createMaterial",value:function(e){this.material.vertexShader=Gn,this.material.fragmentShader=wn}},{key:"createGeometry",value:function(e){var t=this;I(y(r.prototype),"createGeometry",this).call(this,e);var n=[],i=[],a=0;e.forEach((function(e){var r=e,o=r.parsedStyle,s=o.x1,u=o.y1,l=o.x2,c=o.y2,f=o.z1,d=o.z2,h=o.defX,_=o.defY,p=o.lineCap,v=o.isBillboard,E=t.calcDash(e),R=E.dashOffset,g=E.dashSegmentPercent,T=E.dashRatioInEachSegment;n.push(s-h,u-_,f,l-h,c-_,d,Xn[p],R,g,T,v?1:0),i.push(0+a,2+a,1+a,0+a,3+a,2+a),a+=4})),this.geometry.setIndexBuffer(new Uint32Array(i)),this.geometry.vertexCount=6,this.geometry.setVertexBuffer({bufferIndex:Un.POSITION_UV,byteStride:20,frequency:ae.PerInstance,attributes:[{format:Ee.F32_RGB,bufferByteOffset:0,location:kn.POSITION,divisor:0},{format:Ee.F32_RG,bufferByteOffset:12,location:kn.UV,divisor:0}],data:new Float32Array(Wn)}),this.geometry.setVertexBuffer({bufferIndex:Un.POINT_CAP_DASH,byteStride:44,frequency:ae.PerInstance,attributes:[{format:Ee.F32_RGB,bufferByteOffset:0,location:kn.POINTA,divisor:1},{format:Ee.F32_RGB,bufferByteOffset:12,location:kn.POINTB,divisor:1},{format:Ee.F32_R,bufferByteOffset:24,location:kn.CAP,divisor:1},{format:Ee.F32_RGBA,bufferByteOffset:28,location:kn.DASH,divisor:1}],data:new Float32Array(n)})}},{key:"updateAttribute",value:function(e,t,n){I(y(r.prototype),"updateAttribute",this).call(this,e,t,n);var i=this.objects.indexOf(e);this.updateBatchedAttribute(e,i,t,n);var a=e.parsedStyle,o=a.x1,s=a.y1,u=a.x2,l=a.y2,c=a.z1,f=a.z2,d=a.defX,h=a.defY,_=a.lineCap;if("x1"===t||"y1"===t||"x2"===t||"y2"===t||"z1"===t||"z2"===t)this.geometry.updateVertexBuffer(Un.POINT_CAP_DASH,kn.POINTA,i,new Uint8Array(new Float32Array([o-d,s-h,c,u-d,l-h,f]).buffer));else if("lineDashOffset"===t||"lineDash"===t){var p=this.calcDash(e),v=p.dashOffset,E=p.dashSegmentPercent,R=p.dashRatioInEachSegment;this.geometry.updateVertexBuffer(Un.POINT_CAP_DASH,kn.DASH,i,new Uint8Array(new Float32Array([v,E,R]).buffer))}else"lineCap"===t&&this.geometry.updateVertexBuffer(Un.POINT_CAP_DASH,kn.CAP,i,new Uint8Array(new Float32Array([Xn[_]]).buffer))}},{key:"calcDash",value:function(e){var t=e.parsedStyle,r=t.lineDash,n=t.lineDashOffset,i=void 0===n?0:n,a=e.getTotalLength(),o=0,s=1,u=0;if(r&&r.length){o=i/a;var l=r.reduce((function(e,t){return e+t}),0);s=l/a,u=r[0]/l}return{dashOffset:o,dashSegmentPercent:s,dashRatioInEachSegment:u}}}]),r}(Dn);function Hn(e,t,r,n){var i=e-r,a=t-n;return Math.sqrt(i*i+a*a)}function Yn(e,t){return Math.abs(e-t)<.001}function Kn(e,t){var r=(0,s.VV)(e),n=(0,s.VV)(t),i=(0,s.Fp)(e),a=(0,s.Fp)(t);return{x:r,y:n,width:i-r,height:a-n}}function zn(e){return(e+2*Math.PI)%(2*Math.PI)}Vn=(0,n.gn)([(0,o.b2)()],Vn);var qn={box:function(e,t,r,n){return Kn([e,r],[t,n])},length:function(e,t,r,n){return Hn(e,t,r,n)},pointAt:function(e,t,r,n,i){return{x:(1-i)*e+i*r,y:(1-i)*t+i*n}},pointDistance:function(e,t,r,n,i,a){var o=(r-e)*(i-e)+(n-t)*(a-t);if(o<0)return Hn(e,t,i,a);var s=(r-e)*(r-e)+(n-t)*(n-t);return o>s?Hn(r,n,i,a):this.pointToLine(e,t,r,n,i,a)},pointToLine:function(e,t,r,n,i,a){var o=[r-e,n-t];if(Xr(o,[0,0]))return Math.sqrt((i-e)*(i-e)+(a-t)*(a-t));var s=[-o[1],o[0]];wr(s,s);var u=[i-e,a-t];return Math.abs(Wr(u,s))},tangentAngle:function(e,t,r,n){return Math.atan2(n-t,r-e)}},Zn=1e-4;function jn(e,t,r,n,i,a){var o=-1,s=1/0,u=[r,n],l=20;a&&a>200&&(l=a/10);for(var c=1/l,f=c/10,d=0;d<=l;d++){var h=d*c,_=[i.apply(null,e.concat([h])),i.apply(null,t.concat([h]))],p=Hn(u[0],u[1],_[0],_[1]);p<s&&(o=h,s=p)}if(0===o)return{x:e[0],y:t[0]};if(1===o){var v=e.length;return{x:e[v-1],y:t[v-1]}}s=1/0;for(d=0;d<32;d++){if(f<Zn)break;var E=o-f,R=o+f;_=[i.apply(null,e.concat([E])),i.apply(null,t.concat([E]))],p=Hn(u[0],u[1],_[0],_[1]);if(E>=0&&p<s)o=E,s=p;else{var g=[i.apply(null,e.concat([R])),i.apply(null,t.concat([R]))],T=Hn(u[0],u[1],g[0],g[1]);R<=1&&T<s?(o=R,s=T):f*=.5}}return{x:i.apply(null,e.concat([o])),y:i.apply(null,t.concat([o]))}}function Qn(e,t){for(var r=0,n=e.length,i=0;i<n;i++){var a=e[i],o=t[i],s=e[(i+1)%n],u=t[(i+1)%n];r+=Hn(a,o,s,u)}return r/2}function Jn(e,t,r,n,i){var a=1-i;return a*a*a*e+3*t*i*a*a+3*r*i*i*a+n*i*i*i}function $n(e,t,r,n,i){var a=1-i;return 3*(a*a*(t-e)+2*a*i*(r-t)+i*i*(n-r))}function ei(e,t,r,n){var i,a,o,s=-3*e+9*t-9*r+3*n,u=6*e-12*t+6*r,l=3*t-3*e,c=[];if(Yn(s,0))Yn(u,0)||(i=-l/u,i>=0&&i<=1&&c.push(i));else{var f=u*u-4*s*l;Yn(f,0)?c.push(-u/(2*s)):f>0&&(o=Math.sqrt(f),i=(-u+o)/(2*s),a=(-u-o)/(2*s),i>=0&&i<=1&&c.push(i),a>=0&&a<=1&&c.push(a))}return c}function ti(e,t,r,n,i,a,o,s,u){var l=Jn(e,r,i,o,u),c=Jn(t,n,a,s,u),f=qn.pointAt(e,t,r,n,u),d=qn.pointAt(r,n,i,a,u),h=qn.pointAt(i,a,o,s,u),_=qn.pointAt(f.x,f.y,d.x,d.y,u),p=qn.pointAt(d.x,d.y,h.x,h.y,u);return[[e,t,f.x,f.y,_.x,_.y,l,c],[l,c,p.x,p.y,h.x,h.y,o,s]]}function ri(e,t,r,i,a,o,s,u,l){if(0===l)return Qn([e,r,a,s],[t,i,o,u]);var c=ti(e,t,r,i,a,o,s,u,.5),f=(0,n.ev)((0,n.ev)([],(0,n.CR)(c[0]),!1),[l-1],!1),d=(0,n.ev)((0,n.ev)([],(0,n.CR)(c[1]),!1),[l-1],!1);return ri.apply(null,f)+ri.apply(null,d)}var ni,ii={extrema:ei,box:function(e,t,r,n,i,a,o,s){for(var u=[e,o],l=[t,s],c=ei(e,r,i,o),f=ei(t,n,a,s),d=0;d<c.length;d++)u.push(Jn(e,r,i,o,c[d]));for(d=0;d<f.length;d++)l.push(Jn(t,n,a,s,f[d]));return Kn(u,l)},length:function(e,t,r,n,i,a,o,s){return ri(e,t,r,n,i,a,o,s,3)},nearestPoint:function(e,t,r,n,i,a,o,s,u,l,c){return jn([e,r,i,o],[t,n,a,s],u,l,Jn,c)},pointDistance:function(e,t,r,n,i,a,o,s,u,l,c){var f=this.nearestPoint(e,t,r,n,i,a,o,s,u,l,c);return Hn(f.x,f.y,u,l)},interpolationAt:Jn,pointAt:function(e,t,r,n,i,a,o,s,u){return{x:Jn(e,r,i,o,u),y:Jn(t,n,a,s,u)}},divide:function(e,t,r,n,i,a,o,s,u){return ti(e,t,r,n,i,a,o,s,u)},tangentAngle:function(e,t,r,n,i,a,o,s,u){var l=$n(e,r,i,o,u),c=$n(t,n,a,s,u);return zn(Math.atan2(c,l))}},ai="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\nlayout(std140) uniform ub_ObjectParams {\n  mat4 u_ModelMatrix;\n  vec4 u_Color;\n  vec4 u_StrokeColor;\n  float u_StrokeWidth;\n  float u_Opacity;\n  float u_FillOpacity;\n  float u_StrokeOpacity;\n  float u_Expand;\n  float u_MiterLimit;\n  float u_ScaleMode;\n  float u_Alignment;\n  vec3 u_PickingColor;\n  float u_Dash;\n  float u_Gap;\n  float u_DashOffset;\n  float u_Visible;\n  float u_ZIndex;\n};\n\nlayout(location = 0) attribute vec2 a_Prev;\nlayout(location = 1) attribute vec2 a_Point1;\nlayout(location = 2) attribute vec2 a_Point2;\nlayout(location = 3) attribute vec2 a_Next;\nlayout(location = 4) attribute float a_VertexJoint;\nlayout(location = 5) attribute float a_VertexNum;\nlayout(location = 6) attribute float a_Travel;\n\nconst float FILL = 1.0;\nconst float BEVEL = 4.0;\nconst float MITER = 8.0;\nconst float ROUND = 12.0;\nconst float JOINT_CAP_BUTT = 16.0;\nconst float JOINT_CAP_SQUARE = 18.0;\nconst float JOINT_CAP_ROUND = 20.0;\nconst float FILL_EXPAND = 24.0;\nconst float CAP_BUTT = 1.0;\nconst float CAP_SQUARE = 2.0;\nconst float CAP_ROUND = 3.0;\nconst float CAP_BUTT2 = 4.0;\n\nvarying vec4 v_Distance;\nvarying vec4 v_Arc;\nvarying float v_Type;\nvarying float v_Travel;\n\nvarying vec4 v_PickingResult;\n#define COLOR_SCALE 1. / 255.\nvoid setPickingColor(vec3 pickingColor) {\n  v_PickingResult.rgb = pickingColor * COLOR_SCALE;\n}\n\nvec2 doBisect(\n  vec2 norm, float len, vec2 norm2, float len2, float dy, float inner\n) {\n  vec2 bisect = (norm + norm2) / 2.0;\n  bisect /= dot(norm, bisect);\n  vec2 shift = dy * bisect;\n  if (inner > 0.5) {\n    if (len < len2) {\n      if (abs(dy * (bisect.x * norm.y - bisect.y * norm.x)) > len) {\n        return dy * norm;\n      }\n    } else {\n      if (abs(dy * (bisect.x * norm2.y - bisect.y * norm2.x)) > len2) {\n        return dy * norm;\n      }\n    }\n  }\n  return dy * bisect;\n}\n\nvoid main() {\n  vec2 pointA = (u_ModelMatrix * vec4(a_Point1, 0., 1.0)).xy;\n  vec2 pointB = (u_ModelMatrix * vec4(a_Point2, 0., 1.0)).xy;\n\n  vec2 xBasis = pointB - pointA;\n  float len = length(xBasis);\n  vec2 forward = xBasis / len;\n  vec2 norm = vec2(forward.y, -forward.x);\n\n  float type = a_VertexJoint;\n  float lineWidth = u_StrokeWidth;\n\n  if (u_ScaleMode > 2.5) {\n      lineWidth *= length(u_ModelMatrix * vec4(1.0, 0.0, 0.0, 0.0));\n  } else if (u_ScaleMode > 1.5) {\n      lineWidth *= length(u_ModelMatrix * vec4(0.0, 1.0, 0.0, 0.0));\n  } else if (u_ScaleMode > 0.5) {\n      vec2 avgDiag = (u_ModelMatrix * vec4(1.0, 1.0, 0.0, 0.0)).xy;\n      lineWidth *= sqrt(dot(avgDiag, avgDiag) * 0.5);\n  }\n  float capType = floor(type / 32.0);\n  type -= capType * 32.0;\n  v_Arc = vec4(0.0);\n  lineWidth *= 0.5;\n  float lineAlignment = 2.0 * u_Alignment - 1.0;\n\n  vec2 pos;\n\n  if (capType == CAP_ROUND) {\n      if (a_VertexNum < 3.5) {\n      gl_Position = vec4(0.0, 0.0, 0.0, 1.0);\n      return;\n      }\n      type = JOINT_CAP_ROUND;\n      capType = 0.0;\n  }\n\n  if (type >= BEVEL) {\n      float dy = lineWidth + u_Expand;\n      float inner = 0.0;\n      if (a_VertexNum >= 1.5) {\n      dy = -dy;\n      inner = 1.0;\n      }\n\n      vec2 base, next, xBasis2, bisect;\n      float flag = 0.0;\n      float sign2 = 1.0;\n      if (a_VertexNum < 0.5 || a_VertexNum > 2.5 && a_VertexNum < 3.5) {\n      next = (u_ModelMatrix * vec4(a_Prev, 0.0, 1.0)).xy;\n      base = pointA;\n      flag = type - floor(type / 2.0) * 2.0;\n      sign2 = -1.0;\n\n      } else {\n      next = (u_ModelMatrix * vec4(a_Next, 0.0, 1.0)).xy;\n      base = pointB;\n      if (type >= MITER && type < MITER + 3.5) {\n          flag = step(MITER + 1.5, type);\n          // check miter limit here?\n      }\n      }\n      xBasis2 = next - base;\n      float len2 = length(xBasis2);\n      vec2 norm2 = vec2(xBasis2.y, -xBasis2.x) / len2;\n      float D = norm.x * norm2.y - norm.y * norm2.x;\n      if (D < 0.0) {\n      inner = 1.0 - inner;\n      }\n      norm2 *= sign2;\n\n      if (abs(lineAlignment) > 0.01) {\n      float shift = lineWidth * lineAlignment;\n      pointA += norm * shift;\n      pointB += norm * shift;\n      if (abs(D) < 0.01) {\n          base += norm * shift;\n      } else {\n          base += doBisect(norm, len, norm2, len2, shift, 0.0);\n      }\n      }\n\n      float collinear = step(0.0, dot(norm, norm2));\n      v_Type = 0.0;\n      float dy2 = -1000.0;\n      float dy3 = -1000.0;\n      if (abs(D) < 0.01 && collinear < 0.5) {\n      if (type >= ROUND && type < ROUND + 1.5) {\n          type = JOINT_CAP_ROUND;\n      }\n      //TODO: BUTT here too\n      }\n\n      if (a_VertexNum < 3.5) {\n      if (abs(D) < 0.01) {\n          pos = dy * norm;\n      } else {\n          if (flag < 0.5 && inner < 0.5) {\n          pos = dy * norm;\n          } else {\n          pos = doBisect(norm, len, norm2, len2, dy, inner);\n          }\n      }\n      if (capType >= CAP_BUTT && capType < CAP_ROUND) {\n          float extra = step(CAP_SQUARE, capType) * lineWidth;\n          vec2 back = -forward;\n          if (a_VertexNum < 0.5 || a_VertexNum > 2.5) {\n          pos += back * (u_Expand + extra);\n          dy2 = u_Expand;\n          } else {\n          dy2 = dot(pos + base - pointA, back) - extra;\n          }\n      }\n      if (type >= JOINT_CAP_BUTT && type < JOINT_CAP_SQUARE + 0.5) {\n          float extra = step(JOINT_CAP_SQUARE, type) * lineWidth;\n          if (a_VertexNum < 0.5 || a_VertexNum > 2.5) {\n          dy3 = dot(pos + base - pointB, forward) - extra;\n          } else {\n          pos += forward * (u_Expand + extra);\n          dy3 = u_Expand;\n          if (capType >= CAP_BUTT) {\n              dy2 -= u_Expand + extra;\n          }\n          }\n      }\n      } else if (type >= JOINT_CAP_ROUND && type < JOINT_CAP_ROUND + 1.5) {\n      if (inner > 0.5) {\n          dy = -dy;\n          inner = 0.0;\n      }\n      vec2 d2 = abs(dy) * forward;\n      if (a_VertexNum < 4.5) {\n          dy = -dy;\n          pos = dy * norm;\n      } else if (a_VertexNum < 5.5) {\n          pos = dy * norm;\n      } else if (a_VertexNum < 6.5) {\n          pos = dy * norm + d2;\n          v_Arc.x = abs(dy);\n      } else {\n          dy = -dy;\n          pos = dy * norm + d2;\n          v_Arc.x = abs(dy);\n      }\n      dy2 = 0.0;\n      v_Arc.y = dy;\n      v_Arc.z = 0.0;\n      v_Arc.w = lineWidth;\n      v_Type = 3.0;\n      } else if (abs(D) < 0.01) {\n      pos = dy * norm;\n      } else {\n      if (type >= ROUND && type < ROUND + 1.5) {\n          if (inner > 0.5) {\n          dy = -dy;\n          inner = 0.0;\n          }\n          if (a_VertexNum < 4.5) {\n          pos = doBisect(norm, len, norm2, len2, -dy, 1.0);\n          } else if (a_VertexNum < 5.5) {\n          pos = dy * norm;\n          } else if (a_VertexNum > 7.5) {\n          pos = dy * norm2;\n          } else {\n          pos = doBisect(norm, len, norm2, len2, dy, 0.0);\n          float d2 = abs(dy);\n          if (length(pos) > abs(dy) * 1.5) {\n              if (a_VertexNum < 6.5) {\n              pos.x = dy * norm.x - d2 * norm.y;\n              pos.y = dy * norm.y + d2 * norm.x;\n              } else {\n              pos.x = dy * norm2.x + d2 * norm2.y;\n              pos.y = dy * norm2.y - d2 * norm2.x;\n              }\n          }\n          }\n          vec2 norm3 = normalize(norm + norm2);\n          float sign = step(0.0, dy) * 2.0 - 1.0;\n          v_Arc.x = sign * dot(pos, norm3);\n          v_Arc.y = pos.x * norm3.y - pos.y * norm3.x;\n          v_Arc.z = dot(norm, norm3) * lineWidth;\n          v_Arc.w = lineWidth;\n          dy = -sign * dot(pos, norm);\n          dy2 = -sign * dot(pos, norm2);\n          dy3 = v_Arc.z - v_Arc.x;\n          v_Type = 3.0;\n      } else {\n          float hit = 0.0;\n          if (type >= BEVEL && type < BEVEL + 1.5) {\n          if (dot(norm, norm2) > 0.0) {\n              type = MITER;\n          }\n          }\n          if (type >= MITER && type < MITER + 3.5) {\n          if (inner > 0.5) {\n              dy = -dy;\n              inner = 0.0;\n          }\n          float sign = step(0.0, dy) * 2.0 - 1.0;\n          pos = doBisect(norm, len, norm2, len2, dy, 0.0);\n          if (length(pos) > abs(dy) * u_MiterLimit) {\n              type = BEVEL;\n          } else {\n              if (a_VertexNum < 4.5) {\n              dy = -dy;\n              pos = doBisect(norm, len, norm2, len2, dy, 1.0);\n              } else if (a_VertexNum < 5.5) {\n              pos = dy * norm;\n              } else if (a_VertexNum > 6.5) {\n              pos = dy * norm2;\n              }\n              v_Type = 1.0;\n              dy = -sign * dot(pos, norm);\n              dy2 = -sign * dot(pos, norm2);\n              hit = 1.0;\n          }\n          }\n          if (type >= BEVEL && type < BEVEL + 1.5) {\n          if (inner > 0.5) {\n              dy = -dy;\n              inner = 0.0;\n          }\n          float d2 = abs(dy);\n          vec2 pos3 = vec2(dy * norm.x - d2 * norm.y, dy * norm.y + d2 * norm.x);\n          vec2 pos4 = vec2(dy * norm2.x + d2 * norm2.y, dy * norm2.y - d2 * norm2.x);\n          if (a_VertexNum < 4.5) {\n              pos = doBisect(norm, len, norm2, len2, -dy, 1.0);\n          } else if (a_VertexNum < 5.5) {\n              pos = dy * norm;\n          } else if (a_VertexNum > 7.5) {\n              pos = dy * norm2;\n          } else {\n              if (a_VertexNum < 6.5) {\n              pos = pos3;\n              } else {\n              pos = pos4;\n              }\n          }\n          vec2 norm3 = normalize(norm + norm2);\n          float sign = step(0.0, dy) * 2.0 - 1.0;\n          dy = -sign * dot(pos, norm);\n          dy2 = -sign * dot(pos, norm2);\n          dy3 = (-sign * dot(pos, norm3)) + lineWidth;\n          v_Type = 4.0;\n          hit = 1.0;\n          }\n          if (hit < 0.5) {\n          gl_Position = vec4(0.0, 0.0, 0.0, 1.0);\n          return;\n          }\n      }\n      }\n      pos += base;\n      v_Distance = vec4(dy, dy2, dy3, lineWidth) * u_DevicePixelRatio;\n      v_Arc = v_Arc * u_DevicePixelRatio;\n      v_Travel = a_Travel + dot(pos - pointA, vec2(-norm.y, norm.x));\n  }\n\n  gl_Position = u_ProjectionMatrix * u_ViewMatrix * vec4(pos, u_ZIndex, 1.0);\n\n  setPickingColor(u_PickingColor.xyz);\n}",oi="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\nlayout(std140) uniform ub_ObjectParams {\n  mat4 u_ModelMatrix;\n  vec4 u_Color;\n  vec4 u_StrokeColor;\n  float u_StrokeWidth;\n  float u_Opacity;\n  float u_FillOpacity;\n  float u_StrokeOpacity;\n  float u_Expand;\n  float u_MiterLimit;\n  float u_ScaleMode;\n  float u_Alignment;\n  vec3 u_PickingColor;\n  float u_Dash;\n  float u_Gap;\n  float u_DashOffset;\n  float u_Visible;\n  float u_ZIndex;\n};\n\nvarying vec4 v_Distance;\nvarying vec4 v_Arc;\nvarying float v_Type;\nvarying float v_Travel;\n\nvarying vec4 v_PickingResult;\n\nvoid main(){\n  if (u_Visible < 1.0) {\n    discard;\n  }\n\n  gbuf_picking = vec4(v_PickingResult.rgb, 1.0);\n\n  float alpha = 1.0;\n  float lineWidth = v_Distance.w;\n  if (v_Type < 0.5) {\n    float left = max(v_Distance.x - 0.5, -v_Distance.w);\n    float right = min(v_Distance.x + 0.5, v_Distance.w);\n    float near = v_Distance.y - 0.5;\n    float far = min(v_Distance.y + 0.5, 0.0);\n    float top = v_Distance.z - 0.5;\n    float bottom = min(v_Distance.z + 0.5, 0.0);\n    alpha = max(right - left, 0.0) * max(bottom - top, 0.0) * max(far - near, 0.0);\n  } else if (v_Type < 1.5) {\n    float a1 = clamp(v_Distance.x + 0.5 - lineWidth, 0.0, 1.0);\n    float a2 = clamp(v_Distance.x + 0.5 + lineWidth, 0.0, 1.0);\n    float b1 = clamp(v_Distance.y + 0.5 - lineWidth, 0.0, 1.0);\n    float b2 = clamp(v_Distance.y + 0.5 + lineWidth, 0.0, 1.0);\n    alpha = a2 * b2 - a1 * b1;\n  } else if (v_Type < 2.5) {\n    alpha *= max(min(v_Distance.x + 0.5, 1.0), 0.0);\n    alpha *= max(min(v_Distance.y + 0.5, 1.0), 0.0);\n    alpha *= max(min(v_Distance.z + 0.5, 1.0), 0.0);\n  } else if (v_Type < 3.5) {\n    float a1 = clamp(v_Distance.x + 0.5 - lineWidth, 0.0, 1.0);\n    float a2 = clamp(v_Distance.x + 0.5 + lineWidth, 0.0, 1.0);\n    float b1 = clamp(v_Distance.y + 0.5 - lineWidth, 0.0, 1.0);\n    float b2 = clamp(v_Distance.y + 0.5 + lineWidth, 0.0, 1.0);\n    float alpha_miter = a2 * b2 - a1 * b1;\n    float alpha_plane = max(min(v_Distance.z + 0.5, 1.0), 0.0);\n    float d = length(v_Arc.xy);\n    float circle_hor = max(min(v_Arc.w, d + 0.5) - max(-v_Arc.w, d - 0.5), 0.0);\n    float circle_vert = min(v_Arc.w * 2.0, 1.0);\n    float alpha_circle = circle_hor * circle_vert;\n    alpha = min(alpha_miter, max(alpha_circle, alpha_plane));\n  } else {\n    float a1 = clamp(v_Distance.x + 0.5 - lineWidth, 0.0, 1.0);\n    float a2 = clamp(v_Distance.x + 0.5 + lineWidth, 0.0, 1.0);\n    float b1 = clamp(v_Distance.y + 0.5 - lineWidth, 0.0, 1.0);\n    float b2 = clamp(v_Distance.y + 0.5 + lineWidth, 0.0, 1.0);\n    alpha = a2 * b2 - a1 * b1;\n    alpha *= max(min(v_Distance.z + 0.5, 1.0), 0.0);\n  }\n\n  if (u_Dash + u_Gap > 1.0) {\n    float travel = mod(v_Travel + u_Gap * 0.5 + u_DashOffset, u_Dash + u_Gap) - (u_Gap * 0.5);\n    float left = max(travel - 0.5, -0.5);\n    float right = min(travel + 0.5, u_Gap + 0.5);\n    alpha *= max(0.0, right - left);\n  }\n\n  gl_FragColor = u_StrokeColor;\n  gl_FragColor.a *= alpha * u_Opacity * u_StrokeOpacity;\n}";(function(e){e[e["NONE"]=0]="NONE",e[e["FILL"]=1]="FILL",e[e["JOINT_BEVEL"]=4]="JOINT_BEVEL",e[e["JOINT_MITER"]=8]="JOINT_MITER",e[e["JOINT_ROUND"]=12]="JOINT_ROUND",e[e["JOINT_CAP_BUTT"]=16]="JOINT_CAP_BUTT",e[e["JOINT_CAP_SQUARE"]=18]="JOINT_CAP_SQUARE",e[e["JOINT_CAP_ROUND"]=20]="JOINT_CAP_ROUND",e[e["FILL_EXPAND"]=24]="FILL_EXPAND",e[e["CAP_BUTT"]=32]="CAP_BUTT",e[e["CAP_SQUARE"]=64]="CAP_SQUARE",e[e["CAP_ROUND"]=96]="CAP_ROUND",e[e["CAP_BUTT2"]=128]="CAP_BUTT2"})(ni||(ni={}));var si,ui,li=2,ci=3;(function(e){e[e["a_Prev"]=0]="a_Prev",e[e["a_Point1"]=1]="a_Point1",e[e["a_Point2"]=2]="a_Point2",e[e["a_Next"]=3]="a_Next",e[e["a_VertexJoint"]=4]="a_VertexJoint",e[e["a_VertexNum"]=5]="a_VertexNum",e[e["a_Travel"]=6]="a_Travel"})(si||(si={})),function(e){e["MODEL_MATRIX"]="u_ModelMatrix",e["COLOR"]="u_Color",e["STROKE_COLOR"]="u_StrokeColor",e["STROKE_WIDTH"]="u_StrokeWidth",e["OPACITY"]="u_Opacity",e["FILL_OPACITY"]="u_FillOpacity",e["STROKE_OPACITY"]="u_StrokeOpacity",e["EXPAND"]="u_Expand",e["MITER_LIMIT"]="u_MiterLimit",e["SCALE_MODE"]="u_ScaleMode",e["ALIGNMENT"]="u_Alignment",e["PICKING_COLOR"]="u_PickingColor",e["DASH"]="u_Dash",e["GAP"]="u_Gap",e["DASH_OFFSET"]="u_DashOffset",e["VISIBLE"]="u_Visible",e["Z_INDEX"]="u_ZIndex"}(ui||(ui={}));var fi=function(e){S(r,e);var t=F(r);function r(){return g(this,r),t.apply(this,arguments)}return m(r,[{key:"shouldMerge",value:function(e,t){return!1}},{key:"updateAttribute",value:function(e,t,n){I(y(r.prototype),"updateAttribute",this).call(this,e,t,n);var a=e.parsedStyle,o=(a.fill,a.stroke),s=a.opacity,u=a.fillOpacity,l=a.strokeOpacity,c=a.lineWidth,f=a.anchor,d=a.lineDash,h=void 0===d?[]:d,_=a.lineDashOffset,p=void 0===_?0:_,v=a.visibility;if("lineJoin"===t||"lineCap"===t||"lineDash"===t||e.nodeName===i.X3.Circle&&"r"===t||e.nodeName===i.X3.Ellipse&&("rx"===t||"ry"===t)||e.nodeName===i.X3.Rect&&("width"===t||"height"===t||"radius"===t)||e.nodeName===i.X3.Line&&("x1"===t||"y1"===t||"x2"===t||"y2"===t)||e.nodeName===i.X3.Polyline&&"points"===t||e.nodeName===i.X3.Polygon&&"points"===t||e.nodeName===i.X3.Path&&"path"===t)this.material.geometryDirty=!0,this.material.programDirty=!0;else if("stroke"===t){var E=[0,0,0,0];(null===o||void 0===o?void 0:o.type)===i.qx.Constant&&(E=o.value),this.material.setUniforms(A({},ui.STROKE_COLOR,E))}else if("opacity"===t)this.material.setUniforms(A({},ui.OPACITY,s));else if("fillOpacity"===t)this.material.setUniforms(A({},ui.FILL_OPACITY,u));else if("strokeOpacity"===t)this.material.setUniforms(A({},ui.STROKE_OPACITY,l));else if("lineWidth"===t)this.material.setUniforms(A({},ui.STROKE_WIDTH,c));else if("anchor"===t||"modelMatrix"===t){var R=0,g=0,T=e.getGeometryBounds();if(T){var m=T.halfExtents;R=-m[0]*f[0]*2,g=-m[1]*f[1]*2}var S=Fr();Lr(S,e.getWorldTransform(),br(S,kr(R,g,0))),this.material.setUniforms(A({},ui.MODEL_MATRIX,S))}else if("visibility"===t)this.material.setUniforms(A({},ui.VISIBLE,"visible"===v?1:0));else if("lineDash"===t){var C;this.material.setUniforms((C={},A(C,ui.DASH,h[0]||0),A(C,ui.GAP,h[1]||0),C))}else"lineDashOffset"===t&&this.material.setUniforms(A({},ui.DASH_OFFSET,p))}},{key:"changeRenderOrder",value:function(e,t){this.material&&this.material.setUniforms(A({},ui.Z_INDEX,t*Rn))}},{key:"createMaterial",value:function(e){var t,r;this.material.vertexShader=ai,this.material.fragmentShader=oi;var n=e[0],a=n.parsedStyle,o=a.fill,s=a.stroke,u=a.opacity,l=a.fillOpacity,c=a.strokeOpacity,f=a.lineWidth,d=a.anchor,h=a.lineDash,_=void 0===h?[]:h,p=a.lineDashOffset,v=void 0===p?0:p,E=a.visibility,R=[0,0,0,0];(null===o||void 0===o?void 0:o.type)===i.qx.Constant&&(R=o.value);var g=[0,0,0,0];(null===s||void 0===s?void 0:s.type)===i.qx.Constant&&(g=s.value);var T=(null===(t=n.renderable3D)||void 0===t?void 0:t.encodedPickingColor)||[0,0,0],m=0,S=0,y=n.getGeometryBounds();if(y){var C=y.halfExtents;m=-C[0]*d[0]*2,S=-C[1]*d[1]*2}var B=Fr();Lr(B,n.getWorldTransform(),br(B,kr(m,S,0))),this.material.setUniforms((r={},A(r,ui.MODEL_MATRIX,B),A(r,ui.COLOR,R),A(r,ui.STROKE_COLOR,g),A(r,ui.STROKE_WIDTH,f),A(r,ui.OPACITY,u),A(r,ui.FILL_OPACITY,l),A(r,ui.STROKE_OPACITY,c),A(r,ui.EXPAND,1),A(r,ui.MITER_LIMIT,5),A(r,ui.SCALE_MODE,1),A(r,ui.ALIGNMENT,.5),A(r,ui.PICKING_COLOR,T),A(r,ui.DASH,_[0]||0),A(r,ui.GAP,_[1]||0),A(r,ui.DASH_OFFSET,v),A(r,ui.VISIBLE,"visible"===E?1:0),A(r,ui.Z_INDEX,n.sortable.renderOrder*Rn),r)),this.material.cullMode=j.None}},{key:"createGeometry",value:function(e){var t=e[0],r=Ei(t),n=r.pointsBuffer,i=r.travelBuffer,a=r.instancedCount;this.geometry.setVertexBuffer({bufferIndex:0,byteStride:48,frequency:ae.PerInstance,attributes:[{format:Ee.F32_RG,bufferByteOffset:0,byteStride:12,location:si.a_Prev,divisor:1},{format:Ee.F32_RG,bufferByteOffset:12,byteStride:12,location:si.a_Point1,divisor:1},{format:Ee.F32_R,bufferByteOffset:20,byteStride:12,location:si.a_VertexJoint,divisor:1},{format:Ee.F32_RG,bufferByteOffset:24,byteStride:12,location:si.a_Point2,divisor:1},{format:Ee.F32_RG,bufferByteOffset:36,byteStride:12,location:si.a_Next,divisor:1}],data:new Float32Array(n)}),this.geometry.setVertexBuffer({bufferIndex:1,byteStride:4,frequency:ae.PerInstance,attributes:[{format:Ee.F32_R,bufferByteOffset:0,byteStride:4,location:si.a_VertexNum,divisor:0}],data:new Float32Array([0,1,2,3,4,5,6,7,8])}),this.geometry.setVertexBuffer({bufferIndex:2,byteStride:4,frequency:ae.PerInstance,attributes:[{format:Ee.F32_R,bufferByteOffset:0,byteStride:4,location:si.a_Travel,divisor:1}],data:new Float32Array(i)}),this.geometry.vertexCount=15,this.geometry.instancedCount=a,this.geometry.setIndexBuffer(new Uint32Array([0,2,1,0,3,2,4,6,5,4,7,6,4,7,8]))}}]),r}(Dn);function di(e,t,r,n,i,a,o){var s=o[o.length-2],u=o[o.length-1];o.length-=2;var l=ii.length(s,u,e,t,r,n,i,a),c=vi(l),f=0,d=0,h=0,_=0,p=0;o.push(s,u);for(var v=1,E=0;v<=c;++v)E=v/c,f=1-E,d=f*f,h=d*f,_=E*E,p=_*E,o.push(h*s+3*d*E*e+3*f*_*r+p*i,h*u+3*d*E*t+3*f*_*n+p*a)}fi=(0,n.gn)([(0,o.b2)()],fi);var hi=10,_i=8,pi=2048;function vi(e){var t=Math.ceil(e/hi);return t<_i?t=_i:t>pi&&(t=pi),t}function Ei(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.parsedStyle,n=r.lineCap,a=r.lineJoin,o=r.defX,s=r.defY,u=[],l=[];if(e.nodeName===i.X3.Polyline||e.nodeName===i.X3.Polygon){if(u=e.parsedStyle.points.points.reduce((function(e,t){return e.push(t[0]-o,t[1]-s),e}),[]),e.nodeName===i.X3.Polygon){if(t)return l=c()(u,[],2),{pointsBuffer:u,travelBuffer:[],triangles:l,instancedCount:Math.round(u.length/li)};var f;u.push(u[0],u[1]),(f=u).push.apply(f,L(Ti(u[0],u[1],u[2],u[3])))}}else if(e.nodeName===i.X3.Path||e.nodeName===i.X3.Circle||e.nodeName===i.X3.Ellipse||e.nodeName===i.X3.Rect){var d;e.nodeName!==i.X3.Path?(d=(0,i.cP)((0,i.YR)(e)),o=d.rect.x,s=d.rect.y):d=e.parsedStyle.path;var h=d,_=h.zCommandIndexes,p=L(d.curve).map((function(e,t){return _.includes(t)?["Z"]:e})),v=-1;if(p.forEach((function(t){var r=b(t),n=r[0],a=r.slice(1);if("M"===n)v=u.length,u.push(a[0]-o,a[1]-s);else if("C"===n)di(a[0]-o,a[1]-s,a[2]-o,a[3]-s,a[4]-o,a[5]-s,u);else if("Z"===n&&(e.nodeName===i.X3.Path||e.nodeName===i.X3.Rect)){var l;u.push(u[v],u[v+1]),(l=u).push.apply(l,L(Ti(u[v],u[v+1],u[v+2],u[v+3])))}})),t)return l=c()(u,[],2),{pointsBuffer:u,travelBuffer:[],triangles:l,instancedCount:Math.round(u.length/li)}}var E=Ri(a),R=gi(n),g=R;R===ni.CAP_ROUND&&(g=ni.JOINT_CAP_ROUND),R===ni.CAP_BUTT&&(g=ni.JOINT_CAP_BUTT),R===ni.CAP_SQUARE&&(g=ni.JOINT_CAP_SQUARE);for(var T=(Math.round(0/li)+2)*ci,m=0,A=[],S=[],y=0;y<u.length;y+=li)y>1&&(m+=Math.sqrt(Math.pow(u[y]-u[y-2],2)+Math.pow(u[y+1]-u[y+1-2],2))),S.push(m),A[T++]=u[y],A[T++]=u[y+1],A[T]=E,0==y&&R!==ni.CAP_ROUND&&(A[T]+=R),y+2*li>=u.length?A[T]+=g-E:y+li>=u.length&&(A[T]=0),T++;A[T++]=u[u.length-4],A[T++]=u[u.length-3],A[T++]=0,A[0]=u[0],A[1]=u[1],A[2]=0,A[3]=u[2],A[4]=u[3],A[5]=R===ni.CAP_ROUND?R:0;var C=Math.round(u.length/li);return{pointsBuffer:A,travelBuffer:S,triangles:l,instancedCount:C}}function Ri(e){var t;switch(e){case i.S.Bevel:t=ni.JOINT_BEVEL;break;case i.S.Round:t=ni.JOINT_ROUND;break;default:t=ni.JOINT_MITER;break}return t}function gi(e){var t;switch(e){case i.$o.Square:t=ni.CAP_SQUARE;break;case i.$o.Round:t=ni.CAP_ROUND;break;default:t=ni.CAP_BUTT;break}return t}function Ti(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t,i=[r-e,n-t],a=.01;return[e+i[0]*a,t+i[1]*a]}var mi,Ai="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\nlayout(std140) uniform ub_ObjectParams {\n  mat4 u_ModelMatrix;\n  vec4 u_Color;\n  vec3 u_PickingColor;\n  float u_Opacity;\n  float u_FillOpacity;\n  float u_Visible;\n  float u_ZIndex;\n};\n\nlayout(location = 0) attribute vec2 a_Position;\n\nvarying vec4 v_PickingResult;\n#define COLOR_SCALE 1. / 255.\nvoid setPickingColor(vec3 pickingColor) {\n  v_PickingResult.rgb = pickingColor * COLOR_SCALE;\n}\n\nvoid main() {\n  gl_Position = u_ProjectionMatrix * u_ViewMatrix * u_ModelMatrix * vec4(a_Position, u_ZIndex, 1.0);\n\n  setPickingColor(u_PickingColor.xyz);\n}",Si="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\nlayout(std140) uniform ub_ObjectParams {\n  mat4 u_ModelMatrix;\n  vec4 u_Color;\n  vec3 u_PickingColor;\n  float u_Opacity;\n  float u_FillOpacity;\n  float u_Visible;\n  float u_ZIndex;\n};\n\nvarying vec4 v_PickingResult;\n\nvoid main(){\n  if (u_Visible < 1.0) {\n    discard;\n  }\n\n  gbuf_picking = vec4(v_PickingResult.rgb, 1.0);\n\n  gl_FragColor = u_Color;\n  gl_FragColor.a = gl_FragColor.a * u_Opacity * u_FillOpacity;\n}";(function(e){e[e["a_Position"]=0]="a_Position"})(mi||(mi={}));var yi=function(e){S(r,e);var t=F(r);function r(){return g(this,r),t.apply(this,arguments)}return m(r,[{key:"shouldMerge",value:function(e,t){return!1}},{key:"createGeometry",value:function(e){var t=e[0],r=Ei(t,!0),n=r.triangles,i=r.pointsBuffer;this.geometry.setVertexBuffer({bufferIndex:0,byteStride:8,frequency:ae.PerVertex,attributes:[{format:Ee.F32_RG,bufferByteOffset:0,byteStride:8,location:mi.a_Position}],data:new Float32Array(i)}),this.geometry.vertexCount=n.length,this.geometry.setIndexBuffer(new Uint32Array(n))}},{key:"createMaterial",value:function(e){var t,r;this.material.vertexShader=Ai,this.material.fragmentShader=Si;var n=e[0],a=n.parsedStyle,o=a.fill,s=a.opacity,u=a.fillOpacity,l=a.anchor,c=a.visibility,f=[0,0,0,0];(null===o||void 0===o?void 0:o.type)===i.qx.Constant&&(f=o.value);var d=(null===(t=n.renderable3D)||void 0===t?void 0:t.encodedPickingColor)||[0,0,0],h=0,_=0,p=n.getGeometryBounds();if(p){var v=p.halfExtents;h=-v[0]*l[0]*2,_=-v[1]*l[1]*2}var E=Fr();Lr(E,n.getWorldTransform(),br(E,kr(h,_,0))),this.material.setUniforms((r={},A(r,ui.MODEL_MATRIX,E),A(r,ui.COLOR,f),A(r,ui.PICKING_COLOR,d),A(r,ui.OPACITY,s),A(r,ui.FILL_OPACITY,u),A(r,ui.VISIBLE,"visible"===c?1:0),A(r,ui.Z_INDEX,n.sortable.renderOrder*Rn),r))}},{key:"updateAttribute",value:function(e,t,n){I(y(r.prototype),"updateAttribute",this).call(this,e,t,n);var a=e.parsedStyle,o=a.fill,s=a.opacity,u=a.fillOpacity,l=a.anchor,c=a.visibility;if("lineJoin"===t||"lineCap"===t||e.nodeName===i.X3.Rect&&("width"===t||"height"===t||"radius"===t)||e.nodeName===i.X3.Line&&("x1"===t||"y1"===t||"x2"===t||"y2"===t)||e.nodeName===i.X3.Polyline&&"points"===t||e.nodeName===i.X3.Polygon&&"points"===t||e.nodeName===i.X3.Path&&"path"===t)this.material.geometryDirty=!0,this.material.programDirty=!0;else if("fill"===t){var f=[0,0,0,0];(null===o||void 0===o?void 0:o.type)===i.qx.Constant&&(f=o.value),this.material.setUniforms(A({},ui.COLOR,f))}else if("opacity"===t)this.material.setUniforms(A({},ui.OPACITY,s));else if("fillOpacity"===t)this.material.setUniforms(A({},ui.FILL_OPACITY,u));else if("anchor"===t||"modelMatrix"===t){var d=0,h=0,_=e.getGeometryBounds();if(_){var p=_.halfExtents;d=-p[0]*l[0]*2,h=-p[1]*l[1]*2}var v=Fr();Lr(v,e.getWorldTransform(),br(v,kr(d,h,0))),this.material.setUniforms(A({},ui.MODEL_MATRIX,v))}else"visibility"===t&&this.material.setUniforms(A({},ui.VISIBLE,"visible"===c?1:0))}},{key:"changeRenderOrder",value:function(e,t){this.material&&this.material.setUniforms(A({},ui.Z_INDEX,t*Rn))}}]),r}(Dn);yi=(0,n.gn)([(0,o.b2)()],yi);var Ci,Bi="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\nlayout(location = 0) attribute vec4 a_ModelMatrix0;\nlayout(location = 1) attribute vec4 a_ModelMatrix1;\nlayout(location = 2) attribute vec4 a_ModelMatrix2;\nlayout(location = 3) attribute vec4 a_ModelMatrix3;\nlayout(location = 4) attribute vec4 a_Color;\nlayout(location = 5) attribute vec4 a_StrokeColor;\nlayout(location = 6) attribute vec4 a_StylePacked1;\nlayout(location = 7) attribute vec4 a_StylePacked2;\nlayout(location = 8) attribute vec4 a_PickingColor;\nlayout(location = 9) attribute vec2 a_Anchor;\n\nvarying vec4 v_PickingResult;\nvarying vec4 v_Color;\nvarying vec4 v_StrokeColor;\nvarying vec4 v_StylePacked1;\nvarying vec4 v_StylePacked2;\n\n#define COLOR_SCALE 1. / 255.\nvoid setPickingColor(vec3 pickingColor) {\n  v_PickingResult.rgb = pickingColor * COLOR_SCALE;\n}\nvec4 project(vec4 pos, mat4 pm, mat4 vm, mat4 mm) {\n  return pm * vm * mm * pos;\n}\n\nlayout(location = 10) attribute vec2 a_Size;\n\n#ifdef USE_UV\n  layout(location = 11) attribute vec2 a_Uv;\n  varying vec2 v_Uv;\n#endif\n\nvoid main() {\n  mat4 u_ModelMatrix = mat4(a_ModelMatrix0, a_ModelMatrix1, a_ModelMatrix2, a_ModelMatrix3);\nvec4 u_StrokeColor = a_StrokeColor;\nfloat u_Opacity = a_StylePacked1.x;\nfloat u_FillOpacity = a_StylePacked1.y;\nfloat u_StrokeOpacity = a_StylePacked1.z;\nfloat u_StrokeWidth = a_StylePacked1.w;\nfloat u_ZIndex = a_PickingColor.w;\n\nsetPickingColor(a_PickingColor.xyz);\n\nv_Color = a_Color;\nv_StrokeColor = a_StrokeColor;\nv_StylePacked1 = a_StylePacked1;\nv_StylePacked2 = a_StylePacked2;\n\n#ifdef CLIPSPACE_NEAR_ZERO\n    gl_Position.z = gl_Position.z * 0.5 + 0.5;\n#endif\n\n  vec2 offset = (a_Uv - a_Anchor.xy) * a_Size;\n\n  gl_Position = project(vec4(offset, u_ZIndex, 1.0), u_ProjectionMatrix, u_ViewMatrix, u_ModelMatrix);\n\n  #ifdef USE_UV\n  v_Uv = a_Uv;\n  #ifdef VIEWPORT_ORIGIN_TL\n    v_Uv.y = 1.0 - v_Uv.y;\n  #endif\n#endif\n\n}",Oi="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\n\nvarying vec4 v_PickingResult;\nvarying vec4 v_Color;\nvarying vec4 v_StrokeColor;\nvarying vec4 v_StylePacked1;\nvarying vec4 v_StylePacked2;\n#ifdef USE_UV\n  varying vec2 v_Uv;\n#endif\n#ifdef USE_MAP\n  uniform sampler2D u_Map;\n#endif\n\nvoid main() {\n  vec4 u_Color = v_Color;\nvec4 u_StrokeColor = v_StrokeColor;\nfloat u_Opacity = v_StylePacked1.x;\nfloat u_FillOpacity = v_StylePacked1.y;\nfloat u_StrokeOpacity = v_StylePacked1.z;\nfloat u_StrokeWidth = v_StylePacked1.w;\nfloat u_Visible = v_StylePacked2.x;\n\ngbuf_picking = vec4(v_PickingResult.rgb, 1.0);\n\nif (u_Visible < 1.0) {\n    discard;\n}\n  #ifdef USE_MAP\n  vec4 texelColor = texture(SAMPLER_2D(u_Map), v_Uv);\n  u_Color = texelColor;\n#endif\n\n  gl_FragColor = u_Color;\n  gl_FragColor.a = gl_FragColor.a * u_Opacity;\n}";(function(e){e[e["SIZE"]=10]="SIZE",e[e["UV"]=11]="UV"})(Ci||(Ci={}));var xi=function(e){S(r,e);var t=F(r);function r(){return g(this,r),t.apply(this,arguments)}return m(r,[{key:"shouldMerge",value:function(e,t){var n=I(y(r.prototype),"shouldMerge",this).call(this,e,t);return!!n&&this.instance.parsedStyle.img===e.parsedStyle.img}},{key:"createMaterial",value:function(e){var t=this,r=e[0],n=r.parsedStyle.img;this.material.defines.USE_UV=!0,this.material.defines.USE_MAP=!0,this.material.vertexShader=Bi,this.material.fragmentShader=Oi;var i=this.texturePool.getOrCreateTexture(this.device,n,void 0,(function(){e.forEach((function(e){var r=e.renderable;r.dirty=!0,t.renderingService.dirtify()}))}));this.material.setUniforms({u_Map:i})}},{key:"createGeometry",value:function(e){I(y(r.prototype),"createGeometry",this).call(this,e);var t=[],n=[],i=[];e.forEach((function(e,r){var a=e,o=4*r,s=a.parsedStyle,u=s.width,l=s.height;t.push(u,l),n.push(0,0,1,0,1,1,0,1),i.push(0+o,2+o,1+o,0+o,3+o,2+o)})),this.geometry.setIndexBuffer(new Uint32Array(i)),this.geometry.vertexCount=6,this.geometry.setVertexBuffer({bufferIndex:1,byteStride:8,frequency:ae.PerVertex,attributes:[{format:Ee.F32_RG,bufferByteOffset:0,location:Ci.UV}],data:new Float32Array(n)}),this.geometry.setVertexBuffer({bufferIndex:2,byteStride:8,frequency:ae.PerInstance,attributes:[{format:Ee.F32_RG,bufferByteOffset:0,location:Ci.SIZE}],data:new Float32Array(t)})}},{key:"updateAttribute",value:function(e,t,n){var i=this;I(y(r.prototype),"updateAttribute",this).call(this,e,t,n);var a=this.objects.indexOf(e);this.updateBatchedAttribute(e,a,t,n);var o=e,s=o.parsedStyle,u=s.width,l=s.height;if("width"===t||"height"===t)this.geometry.updateVertexBuffer(2,Ci.SIZE,a,new Uint8Array(new Float32Array([u,l]).buffer));else if("img"===t){var c=this.texturePool.getOrCreateTexture(this.device,n,void 0,(function(){var t=e.renderable;t.dirty=!0,i.renderingService.dirtify()}));this.material.setUniforms({u_Map:c})}}}]),r}(Dn);function Di(e,t,r,n){var i=t.width,a=t.height;if(n){if(n.length!==i*a*r)throw new RangeError("mismatched image size")}else n=new Uint8Array(i*a*r);return e.width=i,e.height=a,e.data=n,e}function Ni(e,t,r){var n=t.width,i=t.height;if(n!==e.width||i!==e.height){var a=Di({},{width:n,height:i},r);Fi(e,a,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,n),height:Math.min(e.height,i)},r),e.width=n,e.height=i,e.data=a.data}}function Fi(e,t,r,n,i,a){if(0===i.width||0===i.height)return t;if(i.width>e.width||i.height>e.height||r.x>e.width-i.width||r.y>e.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>t.width||i.height>t.height||n.x>t.width-i.width||n.y>t.height-i.height)throw new RangeError("out of range destination coordinates for image copy");for(var o=e.data,s=t.data,u=0;u<i.height;u++)for(var l=((r.y+u)*e.width+r.x)*a,c=((n.y+u)*t.width+n.x)*a,f=0;f<i.width*a;f++)s[c+f]=o[l+f];return t}xi=(0,n.gn)([(0,o.b2)()],xi);var Pi=function(){function e(t,r){g(this,e),this.width=void 0,this.height=void 0,this.data=void 0,Di(this,t,1,r)}return m(e,[{key:"resize",value:function(e){Ni(this,e,1)}},{key:"clone",value:function(){return new e({width:this.width,height:this.height},new Uint8Array(this.data))}}],[{key:"copy",value:function(e,t,r,n,i){Fi(e,t,r,n,i,1)}}]),e}();function Ii(e){var t,r=0,n=0,i=Y(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;r+=a.w*a.h,n=Math.max(n,a.w)}}catch(v){i.e(v)}finally{i.f()}e.sort((function(e,t){return t.h-e.h}));var o,s=Math.max(Math.ceil(Math.sqrt(r/.95)),n),u=[{x:0,y:0,w:s,h:1/0}],l=0,c=0,f=Y(e);try{for(f.s();!(o=f.n()).done;)for(var d=o.value,h=u.length-1;h>=0;h--){var _=u[h];if(!(d.w>_.w||d.h>_.h)){if(d.x=_.x,d.y=_.y,c=Math.max(c,d.y+d.h),l=Math.max(l,d.x+d.w),d.w===_.w&&d.h===_.h){var p=u.pop();h<u.length&&(u[h]=p)}else d.h===_.h?(_.x+=d.w,_.w-=d.w):d.w===_.w?(_.y+=d.h,_.h-=d.h):(u.push({x:_.x+d.w,y:_.y,w:_.w-d.w,h:d.h}),_.y+=d.h,_.h-=d.h);break}}}catch(v){f.e(v)}finally{f.f()}return{w:l,h:c,fill:r/(l*c)||0}}var Mi=1,bi=function e(t){g(this,e),this.image=void 0,this.positions=void 0;var r={},n=[];for(var i in t){var a=t[i],o=r[i]={};for(var s in a){var u=a[+s];if(u&&0!==u.bitmap.width&&0!==u.bitmap.height){var l={x:0,y:0,w:u.bitmap.width+2*Mi,h:u.bitmap.height+2*Mi};n.push(l),o[s]={rect:l,metrics:u.metrics}}}}var c=Ii(n),f=c.w,d=c.h,h=new Pi({width:f||1,height:d||1});for(var _ in t){var p=t[_];for(var v in p){var E=p[+v];if(E&&0!==E.bitmap.width&&0!==E.bitmap.height){var R=r[_][v].rect;Pi.copy(E.bitmap,h,{x:0,y:0},{x:R.x+Mi,y:R.y+Mi},E.bitmap)}}}this.image=h,this.positions=r},Li=24,Ui=3,ki=Li,Gi=Ui,wi=8,Wi=.25;function Xi(){for(var e=[],t=32;t<128;t++)e.push(String.fromCharCode(t));return e}var Vi=function(){function e(){g(this,e),this.sdfGeneratorCache={},this.textMetricsCache={},this.glyphAtlas=void 0,this.glyphMap={},this.glyphAtlasTexture=void 0}return m(e,[{key:"getMap",value:function(){return this.glyphMap}},{key:"getAtlas",value:function(){return this.glyphAtlas}},{key:"getAtlasTexture",value:function(){return this.glyphAtlasTexture}},{key:"layout",value:function(e,t,r,n,i,a,o){var s=this,u=[],l=a,c=o,f="right"===n||"end"===n?1:"left"===n||"start"===n?0:.5;return e.forEach((function(e){var n=u.length;Array.from(e).forEach((function(e){var r=s.glyphMap[t],n=e.charCodeAt(0),a=r&&r[n];a&&(u.push({glyph:n,x:l,y:c,scale:1,fontStack:t}),l+=a.metrics.advance+i)}));for(var a=l-i,o=n;o<u.length;o++)u[o].x=u[o].x-f*a;l=0,c+=r})),u}},{key:"generateAtlas",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",a=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,s=[];this.glyphMap[t]||(s=Xi());var u=Object.keys(this.glyphMap[t]||{});if(Array.from(new Set(a.split(""))).forEach((function(e){-1===u.indexOf(e.charCodeAt(0).toString())&&s.push(e)})),s.length){var l=s.map((function(a){return e.generateSDF(t,r,n.toString(),i,a)})).reduce((function(e,t){return e[t.id]=t,e}),{});this.glyphMap[t]=v(v({},this.glyphMap[t]),l),this.glyphAtlas=new bi(this.glyphMap);var c=this.glyphAtlas.image,f=c.width,d=c.height,h=c.data;this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.glyphAtlasTexture=o.createTexture(v(v({},Ae(Ee.ALPHA,f,d,1)),{},{pixelStore:{unpackFlipY:!1,unpackAlignment:1},immutable:!1})),this.glyphAtlasTexture.setImageData([h],0)}}},{key:"generateSDF",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,a=i.charCodeAt(0),o=this.sdfGeneratorCache[e];o||(o=this.sdfGeneratorCache[e]=new d({fontSize:ki,fontFamily:t,fontWeight:r,fontStyle:n,buffer:Gi,radius:wi,cutoff:Wi})),this.textMetricsCache[e]||(this.textMetricsCache[e]={}),this.textMetricsCache[e][i]||(this.textMetricsCache[e][i]=o.ctx.measureText(i).width);var s=o.draw(i),u=s.data,l=s.width,c=s.height,f=s.glyphWidth,h=s.glyphHeight,_=s.glyphLeft,p=s.glyphTop,v=s.glyphAdvance;return{id:a,bitmap:new Pi({width:l,height:c},u),metrics:{width:f,height:h,left:_,top:p-Li+Ui,advance:v}}}}]),e}();function Hi(e,t){for(var r=[],n=0;n<e.length;n++){var i=e[n],a=t[i.fontStack],o=a&&a[i.glyph];if(o){var s=o.rect;if(s){var u=1,l=Ui+u,c=o.metrics.advance*i.scale/2,f=[0,0],d=[i.x+c,i.y],h=(o.metrics.left-l)*i.scale-c+d[0],_=(-o.metrics.top-l)*i.scale+d[1],p=h+s.w*i.scale,v=_+s.h*i.scale,E={x:h,y:_},R={x:p,y:_},g={x:h,y:v},T={x:p,y:v};r.push({tl:E,tr:R,bl:g,br:T,tex:s,glyphOffset:f})}}}return r}Vi=(0,n.gn)([(0,o.b2)()],Vi);var Yi,Ki,zi="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\nlayout(std140) uniform ub_ObjectParams {\n  vec2 u_SDFMapSize;\n  float u_FontSize;\n  float u_GammaScale;\n  float u_StrokeBlur;\n  float u_HasStroke;\n};\n\nlayout(location = 0) attribute vec4 a_ModelMatrix0;\nlayout(location = 1) attribute vec4 a_ModelMatrix1;\nlayout(location = 2) attribute vec4 a_ModelMatrix2;\nlayout(location = 3) attribute vec4 a_ModelMatrix3;\nlayout(location = 4) attribute vec4 a_Color;\nlayout(location = 5) attribute vec4 a_StrokeColor;\nlayout(location = 6) attribute vec4 a_StylePacked1;\nlayout(location = 7) attribute vec4 a_StylePacked2;\nlayout(location = 8) attribute vec4 a_PickingColor;\nlayout(location = 9) attribute vec2 a_Anchor;\n\nvarying vec4 v_PickingResult;\nvarying vec4 v_Color;\nvarying vec4 v_StrokeColor;\nvarying vec4 v_StylePacked1;\nvarying vec4 v_StylePacked2;\n\n#define COLOR_SCALE 1. / 255.\nvoid setPickingColor(vec3 pickingColor) {\n  v_PickingResult.rgb = pickingColor * COLOR_SCALE;\n}\nvec4 project(vec4 pos, mat4 pm, mat4 vm, mat4 mm) {\n  return pm * vm * mm * pos;\n}\n\nlayout(location = 10) attribute vec2 a_Tex;\nlayout(location = 11) attribute vec2 a_Offset;\n\nvarying vec2 v_UV;\nvarying float v_GammaScale;\n\nvoid main() {\n  mat4 u_ModelMatrix = mat4(a_ModelMatrix0, a_ModelMatrix1, a_ModelMatrix2, a_ModelMatrix3);\nvec4 u_StrokeColor = a_StrokeColor;\nfloat u_Opacity = a_StylePacked1.x;\nfloat u_FillOpacity = a_StylePacked1.y;\nfloat u_StrokeOpacity = a_StylePacked1.z;\nfloat u_StrokeWidth = a_StylePacked1.w;\nfloat u_ZIndex = a_PickingColor.w;\n\nsetPickingColor(a_PickingColor.xyz);\n\nv_Color = a_Color;\nv_StrokeColor = a_StrokeColor;\nv_StylePacked1 = a_StylePacked1;\nv_StylePacked2 = a_StylePacked2;\n\n#ifdef CLIPSPACE_NEAR_ZERO\n    gl_Position.z = gl_Position.z * 0.5 + 0.5;\n#endif\n\n  v_UV = a_Tex / u_SDFMapSize;\n\n  float fontScale = u_FontSize / 24.;\n\n  gl_Position = project(vec4(a_Offset * fontScale, u_ZIndex, 1.0), u_ProjectionMatrix, u_ViewMatrix, u_ModelMatrix);\n  v_GammaScale = gl_Position.w;\n}",qi="#define GLSLIFY 1\nlayout(std140) uniform ub_SceneParams {\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewMatrix;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_Viewport;\n  float u_IsOrtho;\n};\nlayout(std140) uniform ub_ObjectParams {\n  vec2 u_SDFMapSize;\n  float u_FontSize;\n  float u_GammaScale;\n  float u_StrokeBlur;\n  float u_HasStroke;\n};\n\nvarying vec4 v_PickingResult;\nvarying vec4 v_Color;\nvarying vec4 v_StrokeColor;\nvarying vec4 v_StylePacked1;\nvarying vec4 v_StylePacked2;\n\nvarying vec2 v_UV;\nvarying float v_GammaScale;\n\nuniform sampler2D u_SDFMap;\n\n#define SDF_PX 8.0\n\nvoid main() {\n  vec4 u_Color = v_Color;\nvec4 u_StrokeColor = v_StrokeColor;\nfloat u_Opacity = v_StylePacked1.x;\nfloat u_FillOpacity = v_StylePacked1.y;\nfloat u_StrokeOpacity = v_StylePacked1.z;\nfloat u_StrokeWidth = v_StylePacked1.w;\nfloat u_Visible = v_StylePacked2.x;\n\ngbuf_picking = vec4(v_PickingResult.rgb, 1.0);\n\nif (u_Visible < 1.0) {\n    discard;\n}\n\n  float dist = texture(SAMPLER_2D(u_SDFMap), v_UV).a;\n\n  float EDGE_GAMMA = 0.105 / u_DevicePixelRatio;\n  float fontScale = u_FontSize / 24.0;\n  highp float gamma = EDGE_GAMMA / (fontScale * u_GammaScale);\n  lowp vec4 color = u_Color;\n  lowp float buff = (256.0 - 64.0) / 256.0;\n  float opacity = u_FillOpacity;\n  if (u_HasStroke > 0.5 && u_StrokeWidth > 0.0) {\n    color = u_StrokeColor;\n    gamma = (u_StrokeBlur * 1.19 / SDF_PX + EDGE_GAMMA) / (fontScale * u_GammaScale);\n    buff = (6.0 - u_StrokeWidth / fontScale / 2.0) / SDF_PX;\n    opacity = u_StrokeOpacity;\n  }\n\n  highp float gamma_scaled = gamma * v_GammaScale;\n  highp float alpha = smoothstep(buff - gamma_scaled, buff + gamma_scaled, dist);\n\n  opacity *= alpha * u_Opacity;\n  if (opacity < 0.001) {\n    discard;\n  }\n\n  gl_FragColor = color;\n  gl_FragColor.a *= opacity;\n}";(function(e){e[e["a_Tex"]=10]="a_Tex",e[e["a_Offset"]=11]="a_Offset"})(Yi||(Yi={})),function(e){e["SDF_MAP"]="u_SDFMap",e["SDF_MAP_SIZE"]="u_SDFMapSize",e["FONT_SIZE"]="u_FontSize",e["GAMMA_SCALE"]="u_GammaScale",e["STROKE_BLUR"]="u_StrokeBlur",e["HAS_STROKE"]="u_HasStroke"}(Ki||(Ki={}));var Zi=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.glyphManager=void 0,e}return m(r,[{key:"shouldMerge",value:function(e,t){var n=I(y(r.prototype),"shouldMerge",this).call(this,e,t);if(!n)return!1;if(this.index!==t)return!1;var i=this.instance,a=["fontSize","fontFamily","fontWeight","textBaseline","letterSpacing"];return i.parsedStyle.metrics.font===e.parsedStyle.metrics.font&&!a.some((function(t){return i.parsedStyle[t]!==e.parsedStyle[t]}))}},{key:"createGeometry",value:function(e){var t=this,r=this.instance,n=r.parsedStyle,i=n.textBaseline,a=n.fontSize,o=void 0===a?0:a,s=n.letterSpacing,u=void 0===s?0:s,l=Li/o,c=[],f=[],d=[],h=0;e.forEach((function(e){var r=e.parsedStyle.metrics,n=r.font,a=r.lines,o=r.height,s=r.lineHeight,_=0;"middle"===i?_=-o/2:"bottom"===i?_=-o:"top"===i||"hanging"===i?_=0:"alphabetic"===i?_=.25*s-o:"ideographic"===i&&(_=-o);var p=t.glyphManager.getAtlas(),v=t.buildTextBuffers({object:e,lines:a,fontStack:n,lineHeight:l*s,offsetX:2*l,offsetY:l*_,letterSpacing:l*u,glyphAtlas:p,indicesOffset:h}),E=v.indicesOffset,R=v.indexBuffer,g=v.charUVOffsetBuffer,T=v.charPackedBuffer;h=E,d.push.apply(d,L(T)),f.push.apply(f,L(g)),c.push.apply(c,L(R))})),this.geometry.vertexCount=c.length,this.geometry.setIndexBuffer(new Uint32Array(c)),this.geometry.setVertexBuffer({bufferIndex:0,byteStride:144,frequency:ae.PerVertex,attributes:[{format:Ee.F32_RGBA,bufferByteOffset:0,location:En.MODEL_MATRIX0},{format:Ee.F32_RGBA,bufferByteOffset:16,location:En.MODEL_MATRIX1},{format:Ee.F32_RGBA,bufferByteOffset:32,location:En.MODEL_MATRIX2},{format:Ee.F32_RGBA,bufferByteOffset:48,location:En.MODEL_MATRIX3},{format:Ee.F32_RGBA,bufferByteOffset:64,location:En.COLOR},{format:Ee.F32_RGBA,bufferByteOffset:80,location:En.STROKE_COLOR},{format:Ee.F32_RGBA,bufferByteOffset:96,location:En.PACKED_STYLE1},{format:Ee.F32_RGBA,bufferByteOffset:112,location:En.PACKED_STYLE2},{format:Ee.F32_RGBA,bufferByteOffset:128,location:En.PICKING_COLOR}],data:new Float32Array(d)}),this.geometry.setVertexBuffer({bufferIndex:1,byteStride:16,frequency:ae.PerVertex,attributes:[{format:Ee.F32_RG,bufferByteOffset:0,location:Yi.a_Tex},{format:Ee.F32_RG,bufferByteOffset:8,location:Yi.a_Offset}],data:new Float32Array(f)})}},{key:"createMaterial",value:function(e){var t;this.material.vertexShader=zi,this.material.fragmentShader=qi,this.material.cullMode=j.Back;var r=this.instance,n=r.parsedStyle,i=n.fontSize,a=void 0===i?0:i,o=n.fontFamily,s=void 0===o?"":o,u=n.fontWeight,l=void 0===u?"normal":u,c=n.fontStyle,f=n.metrics,d=f.font,h=e.map((function(e){return e.parsedStyle.text})).join("");this.glyphManager.generateAtlas(d,s,l,c,h,this.device);var _=this.glyphManager.getAtlasTexture(),p=this.glyphManager.getAtlas();this.device.setResourceName(_,"TextSDF Texture");var v=p.image,E=v.width,R=v.height;this.material.setUniforms((t={},A(t,Ki.SDF_MAP,_),A(t,Ki.SDF_MAP_SIZE,[E,R]),A(t,Ki.FONT_SIZE,a),A(t,Ki.GAMMA_SCALE,1),A(t,Ki.STROKE_BLUR,.2),A(t,Ki.HAS_STROKE,this.index),t))}},{key:"changeRenderOrder",value:function(e,t){this.material&&(this.material.programDirty=!0,this.material.geometryDirty=!0)}},{key:"updateAttribute",value:function(e,t,r){"text"===t||"fontFamily"===t||"fontSize"===t||"fontWeight"===t||"fontStyle"===t||"fontVariant"===t||"textBaseline"===t||"letterSpacing"===t||"wordWrapWidth"===t||"lineHeight"===t||"wordWrap"===t||"textAlign"===t||"modelMatrix"===t||"visibility"===t?(this.material.programDirty=!0,this.material.geometryDirty=!0,this.material.textureDirty=!0):"fill"!==t&&"fillOpacity"!==t&&"stroke"!==t&&"strokeOpacity"!==t&&"opacity"!==t&&"lineWidth"!==t&&"visibility"!==t||(this.material.geometryDirty=!0)}},{key:"buildTextBuffers",value:function(e){var t,r=e.object,n=e.lines,a=e.fontStack,o=e.lineHeight,s=e.letterSpacing,u=e.offsetX,l=e.offsetY,c=e.glyphAtlas,f=e.indicesOffset,d=r.parsedStyle.textAlign,h=void 0===d?"start":d,_=r.parsedStyle,p=_.fill,v=_.stroke,E=_.opacity,R=_.fillOpacity,g=_.strokeOpacity,T=_.lineWidth,m=_.visibility,A=[0,0,0,0];(null===p||void 0===p?void 0:p.type)===i.qx.Constant&&(A=p.value);var S=[0,0,0,0];(null===v||void 0===v?void 0:v.type)===i.qx.Constant&&(S=v.value);var y=(null===(t=r.renderable3D)||void 0===t?void 0:t.encodedPickingColor)||[0,0,0],C=Pr(Fr(),r.getWorldTransform()),B=[],O=[],x=[],D=f,N=this.glyphManager.layout(n,a,o,h,s,u,l),F=Hi(N,c.positions);return F.forEach((function(e){var t=[].concat(L(C),L(A),L(S),[E,R,g,T,"visible"===m?1:0,0,0,0],L(y),[r.sortable.renderOrder*Rn]);B.push.apply(B,L(t).concat(L(t),L(t),L(t))),O.push(e.tex.x,e.tex.y,e.tl.x,e.tl.y),O.push(e.tex.x+e.tex.w,e.tex.y,e.tr.x,e.tr.y),O.push(e.tex.x+e.tex.w,e.tex.y+e.tex.h,e.br.x,e.br.y),O.push(e.tex.x,e.tex.y+e.tex.h,e.bl.x,e.bl.y),x.push(0+D,2+D,1+D),x.push(2+D,0+D,3+D),D+=4})),{indexBuffer:x,charUVOffsetBuffer:O,charPackedBuffer:B,indicesOffset:D}}}]),r}(Dn);(0,n.gn)([(0,o.f3)(Vi),(0,n.w6)("design:type",Vi)],Zi.prototype,"glyphManager",void 0),Zi=(0,n.gn)([(0,o.b2)()],Zi);var ji=["style"],Qi=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.style,a=x(e,ji);return g(this,r),n=t.call(this,v({type:r.tag,style:v({},i)},a)),n.style.geometry.meshes.push(D(n)),n.style.material.meshes.push(D(n)),n}return m(r,[{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this);var e=this.style.geometry.meshes,t=e.indexOf(this);e.splice(t,1),e=this.style.material.meshes,t=e.indexOf(this),e.splice(t,1)}}]),r}(i.s$);Qi.tag="mesh";var Ji=function(e){S(r,e);var t=F(r);function r(){return g(this,r),t.apply(this,arguments)}return m(r,[{key:"shouldMerge",value:function(e,t){var n=I(y(r.prototype),"shouldMerge",this).call(this,e,t);return!!n&&(this.instance.nodeName!==Qi.tag||this.instance.parsedStyle.material===e.parsedStyle.material&&this.instance.parsedStyle.geometry===e.parsedStyle.geometry)}},{key:"updateAttribute",value:function(e,t,n){I(y(r.prototype),"updateAttribute",this).call(this,e,t,n);var i=this.objects.indexOf(e);this.updateBatchedAttribute(e,i,t,n)}},{key:"createMaterial",value:function(e){var t=this.instance.parsedStyle.material;this.material=t}},{key:"createGeometry",value:function(e){var t=this.instance.parsedStyle.geometry;this.geometry=t,I(y(r.prototype),"createGeometry",this).call(this,e),this.geometry.build(e)}}]),r}(Dn);Ji=(0,n.gn)([(0,o.b2)()],Ji);var $i=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.meshes=[bn,fi],e}return m(r,[{key:"shouldSubmitRenderInst",value:function(e,t){return 1!==t||this.needDrawStrokeSeparately(e)}},{key:"needDrawStrokeSeparately",value:function(e){var t=e.parsedStyle,r=t.stroke,n=t.lineDash,i=t.lineWidth,a=t.strokeOpacity;return r&&i>0&&(a<1||n&&n.length&&n.every((function(e){return 0!==e})))}}]),r}(Tn);$i=(0,n.gn)([(0,o.b2)({token:[{token:rn,named:i.X3.Circle},{token:rn,named:i.X3.Ellipse}]})],$i);var ea=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.meshes=[yi,fi],e}return m(r,[{key:"shouldSubmitRenderInst",value:function(e,t){var r=e.parsedStyle,n=r.strokeOpacity,a=r.lineDash,o=r.lineWidth,s=e.nodeName;if(0===t&&e.nodeName===i.X3.Polyline)return!1;if(1===t){if(0===n||0===o)return!1;var u=a&&a.length&&a.every((function(e){return 0!==e}));if(s===i.X3.Circle||s===i.X3.Ellipse)return u}return!0}}]),r}(Tn);ea=(0,n.gn)([(0,o.b2)({token:[{token:rn,named:i.X3.Polyline},{token:rn,named:i.X3.Path},{token:rn,named:i.X3.Polygon},{token:rn,named:i.X3.Rect}]})],ea);var ta=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.meshes=[],e}return m(r,[{key:"shouldSubmitRenderInst",value:function(e,t){return!0}}]),r}(Tn);ta=(0,n.gn)([(0,o.b2)({token:[{token:rn,named:i.X3.Group}]})],ta);var ra=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.meshes=[xi],e}return m(r,[{key:"shouldSubmitRenderInst",value:function(e,t){return!0}}]),r}(Tn);ra=(0,n.gn)([(0,o.b2)({token:[{token:rn,named:i.X3.Image}]})],ra);var na=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.meshes=[Zi,Zi],e}return m(r,[{key:"shouldSubmitRenderInst",value:function(e,t){var r=e.parsedStyle,n=r.stroke,i=r.lineWidth,a=!(!n||!i);return!(!a&&0===t)}},{key:"beforeUploadUBO",value:function(e,t,r){t.material.setUniforms(A({},Ki.HAS_STROKE,1-t.index))}}]),r}(Tn);na=(0,n.gn)([(0,o.b2)({token:[{token:rn,named:i.X3.Text}]})],na);var ia=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.meshes=[Vn],e}return m(r,[{key:"shouldSubmitRenderInst",value:function(e,t){return!0}}]),r}(Tn);ia=(0,n.gn)([(0,o.b2)({token:{token:rn,named:i.X3.Line}})],ia);var aa=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.meshes=[Ji],e}return r}(Tn);aa=(0,n.gn)([(0,o.b2)({token:[{token:rn,named:Qi.tag}]})],aa);var oa="WebGLRendererPluginOptions",sa=function(e){S(r,e);var t=F(r);function r(){var e;g(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e.vert=Vr.fullscreenVS,e.frag=Vr.fullscreenBlitOneTexPS,e.features={MRT:!1},e}return r}(hn),ua=function(){function e(t){var r=t.id,n=t.device;g(this,e),this.id=void 0,this.name=void 0,this.device=void 0,this.id=r,this.device=n,null!==this.device.resourceCreationTracker&&this.device.resourceCreationTracker.trackResourceCreated(this)}return m(e,[{key:"destroy",value:function(){null!==this.device.resourceCreationTracker&&this.device.resourceCreationTracker.trackResourceDestroyed(this)}}]),e}(),la=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Bindings,n.uniformBufferBindings=void 0,n.samplerBindings=void 0;var s=o.bindingLayout,u=o.uniformBufferBindings,l=o.samplerBindings;Pe(u.length>=s.numUniformBuffers),Pe(l.length>=s.numSamplers);for(var c=0;c<s.numUniformBuffers;c++)Pe(u[c].wordCount>0);return n.uniformBufferBindings=o.uniformBufferBindings,n.samplerBindings=o.samplerBindings,n}return r}(ua);function ca(e){return"undefined"!==typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||Boolean(e&&2===e._version)}function fa(e){var t=Be(e);switch(t){case _e.BC1:case _e.BC2:case _e.BC3:case _e.BC4_UNORM:case _e.BC4_SNORM:case _e.BC5_UNORM:case _e.BC5_SNORM:return!0;default:return!1}}function da(e){var t=Oe(e);if(t&ve.Normalized)return!1;var r=Be(e);return r===_e.S8||r===_e.S16||r===_e.S32||(r===_e.U8||r===_e.U16||r===_e.U32)}function ha(e){switch(e){case ie.Static:return Te.STATIC_DRAW;case ie.Dynamic:return Te.DYNAMIC_DRAW}}function _a(e){return e&ne.INDEX?Te.ELEMENT_ARRAY_BUFFER:e&ne.VERTEX?Te.ARRAY_BUFFER:e&ne.UNIFORM?Te.UNIFORM_BUFFER:void 0}function pa(e){switch(e){case re.Triangles:return Te.TRIANGLES;case re.Points:return Te.POINTS;case re.TriangleStrip:return Te.TRIANGLE_STRIP;case re.Lines:return Te.LINES;case re.LineStrip:return Te.LINE_STRIP;default:throw new Error("Unknown primitive topology mode")}}function va(e){switch(e){case _e.U8:return Te.UNSIGNED_BYTE;case _e.U16:return Te.UNSIGNED_SHORT;case _e.U32:return Te.UNSIGNED_INT;case _e.S8:return Te.BYTE;case _e.S16:return Te.SHORT;case _e.S32:return Te.INT;case _e.F16:return Te.HALF_FLOAT;case _e.F32:return Te.FLOAT;default:throw"whoops"}}function Ea(e){switch(e){case pe.R:return 1;case pe.RG:return 2;case pe.RGB:return 3;case pe.RGBA:return 4}}function Ra(e){var t=Be(e),r=Ce(e),n=Oe(e),i=va(t),a=Ea(r),o=!!(n&ve.Normalized);return{size:a,type:i,normalized:o}}function ga(e){switch(e){case Ee.U8_R:return Te.UNSIGNED_BYTE;case Ee.U16_R:return Te.UNSIGNED_SHORT;case Ee.U32_R:return Te.UNSIGNED_INT;default:throw"whoops"}}function Ta(e){switch(e){case $.Clamp:return Te.CLAMP_TO_EDGE;case $.Repeat:return Te.REPEAT;case $.Mirror:return Te.MIRRORED_REPEAT;default:throw"whoops"}}function ma(e,t){if(t===te.Linear&&e===ee.Bilinear)return Te.LINEAR_MIPMAP_LINEAR;if(t===te.Linear&&e===ee.Point)return Te.NEAREST_MIPMAP_LINEAR;if(t===te.Nearest&&e===ee.Bilinear)return Te.LINEAR_MIPMAP_NEAREST;if(t===te.Nearest&&e===ee.Point)return Te.NEAREST_MIPMAP_NEAREST;if(t===te.NoMip&&e===ee.Bilinear)return Te.LINEAR;if(t===te.NoMip&&e===ee.Point)return Te.NEAREST;throw new Error("Unknown texture filter mode")}function Aa(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=e;return r.gl_buffer_pages[t/r.pageByteSize|0]}function Sa(e){var t=e;return t.gl_texture}function ya(e){var t=e;return t.gl_sampler}function Ca(e,t){e.name=t,e.__SPECTOR_Metadata={name:t}}function Ba(e,t){var r=[];while(1){var n=t.exec(e);if(!n)break;r.push(n)}return r}function Oa(e){return e.blendMode==J.Add&&e.blendSrcFactor==Q.One&&e.blendDstFactor===Q.Zero}function xa(e){switch(e){case he.OcclusionConservative:return Te.ANY_SAMPLES_PASSED_CONSERVATIVE;default:throw"whoops"}}function Da(e){if(e===oe.n2D)return Te.TEXTURE_2D;if(e===oe.n2DArray)return Te.TEXTURE_2D_ARRAY;if(e===oe.Cube)return Te.TEXTURE_CUBE_MAP;if(e===oe.n3D)return Te.TEXTURE_3D;throw"whoops"}var Na,Fa=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Buffer,n.gl_buffer_pages=void 0,n.gl_target=void 0,n.usage=void 0,n.byteSize=void 0,n.pageByteSize=void 0;var u=o.viewOrSize,l=o.usage,c=o.hint,f=a.uniformBufferMaxPageByteSize,d=a.gl,h=l&ne.UNIFORM;h||(ca(d)?d.bindVertexArray(null):a.OES_vertex_array_object.bindVertexArrayOES(null));var _,p=(0,s.hj)(u)?4*u:4*u.byteLength;if(n.gl_buffer_pages=[],h){Pe(p%f===0);var v=p;while(v>0)n.gl_buffer_pages.push(n.createBufferPage(Math.min(v,f),l,c)),v-=f;_=f}else n.gl_buffer_pages.push(n.createBufferPage(p,l,c)),_=p;return n.pageByteSize=_,n.byteSize=p,n.usage=l,n.gl_target=_a(l),h||(ca(d)?d.bindVertexArray(n.device.currentBoundVAO):a.OES_vertex_array_object.bindVertexArrayOES(n.device.currentBoundVAO)),n}return m(r,[{key:"setSubData",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.byteLength-r,i=this.device.gl,a=this.gl_target,o=this.byteSize,s=this.pageByteSize;if(ca(i)&&a===i.UNIFORM_BUFFER){if(e%s!==0)throw new Error("Assert fail: (dstByteOffset [".concat(e,"] % dstPageByteSize [").concat(s,"]) === 0"));if(n%s!==0)throw new Error("Assert fail: (byteSize [".concat(n,"] % dstPageByteSize [").concat(s,"]) === 0"))}if(!(e+n<=o))throw new Error("Assert fail: (dstByteOffset [".concat(e,"] + byteSize [").concat(n,"]) <= dstByteSize [").concat(o,"], gl_target ").concat(a));var u=e+n,l=e,c=e%s;while(l<u){var f=ca(i)?i.COPY_WRITE_BUFFER:this.gl_target;i.bindBuffer(f,Aa(this,l)),ca(i)?i.bufferSubData(f,c,t,r,Math.min(u-l,s)):i.bufferSubData(f,c,t),l+=s,c=0,r+=s,this.device.debugGroupStatisticsBufferUpload()}}},{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this);for(var e=0;e<this.gl_buffer_pages.length;e++)this.gl_buffer_pages[e].ubo||this.device.gl.deleteBuffer(this.gl_buffer_pages[e])}},{key:"createBufferPage",value:function(e,t,r){var n=this.device.gl,i=t&ne.UNIFORM;if(!ca(n)&&i)return{ubo:!0};var a=this.device.ensureResourceExists(n.createBuffer()),o=_a(t),s=ha(r);return n.bindBuffer(o,a),n.bufferData(o,e,s),a}}]),r}(ua),Pa=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.InputLayout,n.vertexAttributeDescriptors=void 0,n.vertexBufferDescriptors=void 0,n.indexBufferFormat=void 0;var s=o.vertexAttributeDescriptors,u=o.vertexBufferDescriptors,l=o.indexBufferFormat;return Pe(l===Ee.U16_R||l===Ee.U32_R||null===l),n.vertexAttributeDescriptors=s,n.vertexBufferDescriptors=u,n.indexBufferFormat=l,n}return r}(ua),Ia=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.inputLayout,u=e.vertexBuffers,l=e.indexBufferBinding,c=e.program;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.InputState,n.vao=void 0,n.indexBufferByteOffset=void 0,n.indexBufferType=void 0,n.indexBufferCompByteSize=void 0,n.inputLayout=void 0,n.vertexBuffers=void 0;var f=n.device.gl,d=n.device.ensureResourceExists(ca(f)?f.createVertexArray():a.OES_vertex_array_object.createVertexArrayOES());ca(f)?f.bindVertexArray(d):a.OES_vertex_array_object.bindVertexArrayOES(d),a.currentBoundVAO=d;for(var h=0;h<o.vertexAttributeDescriptors.length;h++){var _,p=o.vertexAttributeDescriptors[h],v=p.format,E=p.divisor,R=void 0===E?1:E,T=p.byteStride,m=p.bufferByteOffset,A=p.bufferIndex,S=ca(f)?p.location:null===(_=c.attributes[p.location])||void 0===_?void 0:_.location;if(!(0,s.UM)(S)){da(v);var y=Ra(v),C=y.size,B=y.type,O=y.normalized,x=u[A];if(null===x)continue;var D=Ie(o.vertexBufferDescriptors[A]),N=x.buffer;Pe(!!(N.usage&ne.VERTEX)),f.bindBuffer(f.ARRAY_BUFFER,Aa(x.buffer));var F=x.byteOffset+m;f.vertexAttribPointer(S,C,B,O,T||D.byteStride,F),D.frequency===ae.PerInstance&&(ca(f)?f.vertexAttribDivisor(S,R):a.ANGLE_instanced_arrays.vertexAttribDivisorANGLE(S,R)),f.enableVertexAttribArray(S)}}var P=null,I=null,M=null;if(null!==l){var b=l.buffer;Pe(!!(b.usage&ne.INDEX)),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,Aa(l.buffer)),P=ga(Ie(o.indexBufferFormat)),I=De(o.indexBufferFormat),M=l.byteOffset}return ca(f)?f.bindVertexArray(null):a.OES_vertex_array_object.bindVertexArrayOES(null),a.currentBoundVAO=null,n.vao=d,n.indexBufferByteOffset=M,n.indexBufferType=P,n.indexBufferCompByteSize=I,n.inputLayout=o,n.vertexBuffers=u,n}return m(r,[{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this),this.device.currentBoundVAO===this.vao&&(ca(this.device.gl)?(this.device.gl.bindVertexArray(null),this.device.gl.deleteVertexArray(this.vao)):(this.device.OES_vertex_array_object.bindVertexArrayOES(null),this.device.OES_vertex_array_object.deleteVertexArrayOES(this.vao)),this.device.currentBoundVAO=null)}}]),r}(ua),Ma=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor,s=e.fake;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Texture,n.gl_texture=void 0,n.gl_target=void 0,n.pixelFormat=void 0,n.width=void 0,n.height=void 0,n.depth=void 0,n.numLevels=void 0,n.immutable=void 0,n.pixelStore=void 0,n.mipmaps=void 0,n.formatKind=void 0,n.textureIndex=void 0;var u,l,c=n.device.gl,f=n.clampNumLevels(o);if(n.immutable=!!o.immutable,n.pixelStore=o.pixelStore,n.pixelFormat=o.pixelFormat,n.formatKind=Fe(o.pixelFormat),n.width=o.width,n.height=o.height,n.depth=o.depth,n.mipmaps=f>=1,!s){l=n.device.ensureResourceExists(c.createTexture());var d=n.device.translateTextureType(o.pixelFormat),h=n.device.translateTextureInternalFormat(o.pixelFormat);if(n.device.setActiveTexture(c.TEXTURE0),n.device.currentTextures[0]=null,n.preprocessImage(),o.dimension===oe.n2D){if(u=Te.TEXTURE_2D,c.bindTexture(u,l),n.immutable)if(ca(c))c.texStorage2D(u,f,h,o.width,o.height);else{var _=(h===Te.DEPTH_COMPONENT||n.isNPOT(),0);c.texImage2D(u,_,h,o.width,o.height,0,h,d,null),n.mipmaps&&n.isNPOT()&&(n.mipmaps=!1,c.texParameteri(Te.TEXTURE_2D,Te.TEXTURE_MIN_FILTER,Te.LINEAR),c.texParameteri(Te.TEXTURE_2D,Te.TEXTURE_WRAP_S,Te.CLAMP_TO_EDGE),c.texParameteri(Te.TEXTURE_2D,Te.TEXTURE_WRAP_T,Te.CLAMP_TO_EDGE))}Pe(1===o.depth)}else if(o.dimension===oe.n2DArray)u=Te.TEXTURE_2D_ARRAY,c.bindTexture(u,l),ca(c)&&c.texStorage3D(u,f,h,o.width,o.height,o.depth);else if(o.dimension===oe.n3D)u=Te.TEXTURE_3D,c.bindTexture(u,l),ca(c)&&c.texStorage3D(u,f,h,o.width,o.height,o.depth);else{if(o.dimension!==oe.Cube)throw"whoops";u=Te.TEXTURE_CUBE_MAP,c.bindTexture(u,l),ca(c)&&c.texStorage2D(u,f,h,o.width,o.height),Pe(6===o.depth)}}return n.gl_texture=l,n.gl_target=u,n.numLevels=f,n}return m(r,[{key:"setImageData",value:function(e,t){var r,n,i=this.device.gl,a=(fa(this.pixelFormat),this.gl_target===Te.TEXTURE_3D||(this.gl_target,Te.TEXTURE_2D_ARRAY),this.gl_target,Te.TEXTURE_CUBE_MAP,Array.isArray(e));this.device.setActiveTexture(i.TEXTURE0),this.device.currentTextures[0]=null,a?(r=this.width,n=this.height):(r=e.width,n=e.height,this.width=r,this.height=n),i.bindTexture(this.gl_target,this.gl_texture);var o=this.device.translateTextureFormat(this.pixelFormat),s=this.device.translateTextureType(this.pixelFormat);this.preprocessImage(),this.immutable?i.texSubImage2D(this.gl_target,0,0,0,r,n,o,s,a?e[0]:e):ca(i)?i.texImage2D(this.gl_target,0,o,r,n,0,o,s,a?e[0]:e):a?i.texImage2D(this.gl_target,0,o,r,n,0,o,s,e[0]):i.texImage2D(this.gl_target,0,o,o,s,e),this.mipmaps&&this.generateMipmap()}},{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this),this.device.gl.deleteTexture(Sa(this))}},{key:"clampNumLevels",value:function(e){if(e.dimension===oe.n2DArray&&e.depth>1){var t=Be(e.pixelFormat);if(t===_e.BC1)for(var r=e.width,n=e.height,i=0;i<e.numLevels;i++){if(r<=2||n<=2)return i-1;r=Math.max(r/2|0,1),n=Math.max(n/2|0,1)}}return e.numLevels}},{key:"preprocessImage",value:function(){var e=this.device.gl;this.pixelStore&&(this.pixelStore.unpackFlipY&&e.pixelStorei(Te.UNPACK_FLIP_Y_WEBGL,!0),this.pixelStore.packAlignment&&e.pixelStorei(Te.PACK_ALIGNMENT,this.pixelStore.packAlignment),this.pixelStore.unpackAlignment&&e.pixelStorei(Te.UNPACK_ALIGNMENT,this.pixelStore.unpackAlignment))}},{key:"generateMipmap",value:function(){var e=this.device.gl;return!ca(e)&&this.isNPOT()||this.gl_texture&&this.gl_target&&(e.bindTexture(this.gl_target,this.gl_texture),e.generateMipmap(this.gl_target),e.texParameteri(Te.TEXTURE_2D,Te.TEXTURE_MIN_FILTER,Te.NEAREST_MIPMAP_LINEAR),e.bindTexture(this.gl_target,null)),this}},{key:"isNPOT",value:function(){var e=this.device.gl;return!ca(e)&&(!Xe(this.width)||!Xe(this.height))}}]),r}(ua);(function(e){e[e["NeedsCompile"]=0]="NeedsCompile",e[e["Compiling"]=1]="Compiling",e[e["NeedsBind"]=2]="NeedsBind",e[e["ReadyToUse"]=3]="ReadyToUse"})(Na||(Na={}));var ba=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Program,n.gl_program=void 0,n.gl_shader_vert=void 0,n.gl_shader_frag=void 0,n.compileState=void 0,n.descriptor=void 0,n.uniformSetters={},n.attributes=[];var s=n.device.gl;return n.descriptor=o,n.gl_program=n.device.ensureResourceExists(s.createProgram()),n.gl_shader_vert=null,n.gl_shader_frag=null,n.compileState=Na.NeedsCompile,n.tryCompileProgram(),n}return m(r,[{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this),this.device.gl.deleteProgram(this.gl_program),this.device.gl.deleteShader(this.gl_shader_vert),this.device.gl.deleteShader(this.gl_shader_frag)}},{key:"tryCompileProgram",value:function(){Pe(this.compileState===Na.NeedsCompile);var e=this.descriptor,t=this.device.gl;null!==this.gl_shader_vert&&t.deleteShader(this.gl_shader_vert),null!==this.gl_shader_frag&&t.deleteShader(this.gl_shader_frag),this.gl_shader_vert=this.compileShader(e.preprocessedVert,t.VERTEX_SHADER),this.gl_shader_frag=this.compileShader(e.preprocessedFrag,t.FRAGMENT_SHADER),t.attachShader(this.gl_program,this.gl_shader_vert),t.attachShader(this.gl_program,this.gl_shader_frag),t.linkProgram(this.gl_program),this.compileState=Na.Compiling,ca(t)||(this.readUniformLocationsFromLinkedProgram(),this.readAttributesFromLinkedProgram())}},{key:"readAttributesFromLinkedProgram",value:function(){for(var e=this,t=this.device.gl,r=t.getProgramParameter(this.gl_program,t.ACTIVE_ATTRIBUTES),n=sn(this.descriptor.preprocessedVert),i=un(this.descriptor.vert,n),a=function(r){var n,a=t.getActiveAttrib(e.gl_program,r),o=a.name,u=a.type,l=a.size,c=t.getAttribLocation(e.gl_program,o),f=null===(n=i.find((function(e){return e.name===o})))||void 0===n?void 0:n.location;c>=0&&!(0,s.UM)(f)&&(e.attributes[f]={name:o,location:c,type:u,size:l})},o=0;o<r;o++)a(o)}},{key:"readUniformLocationsFromLinkedProgram",value:function(){for(var e=this.device.gl,t=e.getProgramParameter(this.gl_program,e.ACTIVE_UNIFORMS),r=0;r<t;r++){var n=e.getActiveUniform(this.gl_program,r),i=Wt(n.name),a=i.name,o=e.getUniformLocation(this.gl_program,a);if(this.uniformSetters[a]=Xt(e,o,n),n&&n.size>1)for(var s=0;s<n.size;s++)o=e.getUniformLocation(this.gl_program,"".concat(a,"[").concat(s,"]")),this.uniformSetters["".concat(a,"[").concat(s,"]")]=Xt(e,o,n)}}},{key:"compileShader",value:function(e,t){var r=this.device.gl,n=this.device.ensureResourceExists(r.createShader(t));return r.shaderSource(n,e),r.compileShader(n),n}},{key:"setUniforms",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.device.gl;if(!ca(t)){var r=!1;for(var n in e){r||(t.useProgram(this.gl_program),r=!0);var i=e[n],a=this.uniformSetters[n];if(a){var o=i;o instanceof Ma&&(o=o.textureIndex),a(o)}}}return this}}]),r}(ua);function La(e){var t=0;return e&se.Sampled&&(t|=Re.TEXTURE_BINDING|Re.COPY_DST),e&se.RenderTarget&&(t|=Re.RENDER_ATTACHMENT|Re.TEXTURE_BINDING|Re.COPY_SRC|Re.COPY_DST),t}function Ua(e){if(e===Ee.U8_RGBA_RT)return"bgra8unorm";if(e===Ee.U8_RGBA_NORM)return"rgba8unorm";if(e===Ee.U8_RG_NORM)return"rg8unorm";if(e===Ee.U32_R)return"r32uint";if(e===Ee.D24)return"depth24plus";if(e===Ee.D24_S8)return"depth24plus-stencil8";if(e===Ee.D32F)return"depth32float";if(e===Ee.D32F_S8)return"depth32float-stencil8";if(e===Ee.BC1)return"bc1-rgba-unorm";if(e===Ee.BC1_SRGB)return"bc1-rgba-unorm-srgb";if(e===Ee.BC2)return"bc2-rgba-unorm";if(e===Ee.BC2_SRGB)return"bc2-rgba-unorm-srgb";if(e===Ee.BC3)return"bc3-rgba-unorm";if(e===Ee.BC3_SRGB)return"bc3-rgba-unorm-srgb";if(e===Ee.BC4_SNORM)return"bc4-r-snorm";if(e===Ee.BC4_UNORM)return"bc4-r-unorm";if(e===Ee.BC5_SNORM)return"bc5-rg-snorm";if(e===Ee.BC5_UNORM)return"bc5-rg-unorm";throw"whoops"}function ka(e){if(e===oe.n2D)return"2d";if(e===oe.Cube)return"3d";if(e===oe.n2DArray)return"3d";if(e===oe.n3D)return"3d";throw"whoops"}function Ga(e){if(e===$.Clamp)return"clamp-to-edge";if(e===$.Repeat)return"repeat";if(e===$.Mirror)return"mirror-repeat";throw"whoops"}function wa(e){if(e===ee.Bilinear)return"linear";if(e===ee.Point)return"nearest";throw"whoops"}function Wa(e){if(e===te.Linear)return"linear";if(e===te.Nearest)return"nearest";if(e===te.NoMip)return"nearest";throw"whoops"}function Xa(e){if(e===ce.Float)return"float";if(e===ce.Depth)return"depth";throw"whoops"}function Va(e){if(e===oe.n2D)return"2d";if(e===oe.n2DArray)return"2d-array";if(e===oe.n3D)return"3d";if(e===oe.Cube)return"cube";throw"whoops"}function Ha(e){return{sampleType:Xa(e.formatKind),viewDimension:Va(e.dimension)}}function Ya(e){var t=e;return t.gpuBuffer}function Ka(e){var t=e;return t.gpuSampler}function za(e){var t=e;return t.querySet}function qa(e){if(e===he.OcclusionConservative)return"occlusion";throw"whoops"}function Za(e){switch(e){case re.Triangles:return"triangle-list";case re.Points:return"point-list";case re.TriangleStrip:return"triangle-strip";case re.Lines:return"line-list";case re.LineStrip:return"line-strip";default:throw new Error("Unknown primitive topology mode")}}function ja(e){if(e===j.None)return"none";if(e===j.Front)return"front";if(e===j.Back)return"back";throw"whoops"}function Qa(e){if(e===Z.CCW)return"ccw";if(e===Z.CW)return"cw";throw"whoops"}function Ja(e,t){return{topology:Za(e),cullMode:ja(t.cullMode),frontFace:Qa(t.frontFace)}}function $a(e){if(e===Q.Zero)return"zero";if(e===Q.One)return"one";if(e===Q.Src)return"src";if(e===Q.OneMinusSrc)return"one-minus-src";if(e===Q.Dst)return"dst";if(e===Q.OneMinusDst)return"one-minus-dst";if(e===Q.SrcAlpha)return"src-alpha";if(e===Q.OneMinusSrcAlpha)return"one-minus-src-alpha";if(e===Q.DstAlpha)return"dst-alpha";if(e===Q.OneMinusDstAlpha)return"one-minus-dst-alpha";throw"whoops"}function eo(e){if(e===J.Add)return"add";if(e===J.Subtract)return"subtract";if(e===J.ReverseSubtract)return"reverse-subtract";throw"whoops"}function to(e){return{operation:eo(e.blendMode),srcFactor:$a(e.blendSrcFactor),dstFactor:$a(e.blendDstFactor)}}function ro(e,t){return{format:Ua(t),blend:{color:to(e.rgbBlendState),alpha:to(e.alphaBlendState)},writeMask:e.channelWriteMask}}function no(e,t){return t.attachmentsState.map((function(t,r){return ro(t,e[r])}))}function io(e){if(e===q.Never)return"never";if(e===q.Less)return"less";if(e===q.Equal)return"equal";if(e===q.LessEqual)return"less-equal";if(e===q.Greater)return"greater";if(e===q.NotEqual)return"not-equal";if(e===q.GreaterEqual)return"greater-equal";if(e===q.Always)return"always";throw"whoops"}function ao(e,t){if(null!==e)return{format:Ua(e),depthWriteEnabled:t.depthWrite,depthCompare:io(t.depthCompare),depthBias:t.polygonOffset?1:0,depthBiasSlopeScale:t.polygonOffset?1:0}}function oo(e){if(null!==e){if(e===Ee.U16_R)return"uint16";if(e===Ee.U32_R)return"uint32";throw"whoops"}}function so(e){if(e===ae.PerVertex)return"vertex";if(e===ae.PerInstance)return"instance";throw"whoops"}function uo(e){if(e===Ee.U8_R)return"uint8x2";if(e===Ee.U8_RG)return"uint8x2";if(e===Ee.U8_RGB)return"uint8x4";if(e===Ee.U8_RGBA)return"uint8x4";if(e===Ee.U8_RGBA_NORM)return"unorm8x4";if(e===Ee.S8_RGB_NORM)return"snorm8x4";if(e===Ee.S8_RGBA_NORM)return"snorm8x4";if(e===Ee.S16_RG)return"uint16x2";if(e===Ee.F32_R)return"float32";if(e===Ee.F32_RG)return"float32x2";if(e===Ee.F32_RGB)return"float32x3";if(e===Ee.F32_RGBA)return"float32x4";throw"whoops"}function lo(e){var t=Be(e);switch(t){case _e.BC1:case _e.BC2:case _e.BC3:case _e.BC4_SNORM:case _e.BC4_UNORM:case _e.BC5_SNORM:case _e.BC5_UNORM:return!0}return!1}function co(e){var t=Be(e);switch(t){case _e.BC1:case _e.BC2:case _e.BC3:case _e.BC4_SNORM:case _e.BC4_UNORM:case _e.BC5_SNORM:case _e.BC5_UNORM:return 4}return 1}function fo(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0;switch(e){case Ee.S8_R:case Ee.S8_R_NORM:case Ee.S8_RG_NORM:case Ee.S8_RGB_NORM:case Ee.S8_RGBA_NORM:var i=(ArrayBuffer,new Int8Array(t));return n&&i.set(new Int8Array(n)),i;case Ee.U8_R:case Ee.U8_R_NORM:case Ee.U8_RG:case Ee.U8_RG_NORM:case Ee.U8_RGB:case Ee.U8_RGB_NORM:case Ee.U8_RGB_SRGB:case Ee.U8_RGBA:case Ee.U8_RGBA_NORM:case Ee.U8_RGBA_SRGB:var a=(ArrayBuffer,new Uint8Array(t));return n&&a.set(new Uint8Array(n)),a;case Ee.S16_R:case Ee.S16_RG:case Ee.S16_RG_NORM:case Ee.S16_RGB_NORM:case Ee.S16_RGBA:case Ee.S16_RGBA_NORM:var o=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(r?t/2:t);return n&&o.set(new Int16Array(n)),o;case Ee.U16_R:case Ee.U16_RGB:case Ee.U16_RGBA_5551:case Ee.U16_RGBA_NORM:case Ee.U16_RG_NORM:case Ee.U16_R_NORM:var s=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(r?t/2:t);return n&&s.set(new Uint16Array(n)),s;case Ee.S32_R:var u=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(r?t/4:t);return n&&u.set(new Int32Array(n)),u;case Ee.U32_R:case Ee.U32_RG:var l=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(r?t/4:t);return n&&l.set(new Uint32Array(n)),l;case Ee.F32_R:case Ee.F32_RG:case Ee.F32_RGB:case Ee.F32_RGBA:var c=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(r?t/4:t);return n&&c.set(new Float32Array(n)),c}var f=(ArrayBuffer,new Uint8Array(t));return n&&f.set(new Uint8Array(n)),f}function ho(e){var t=(32768&e)>>15,r=(31744&e)>>10,n=1023&e;return 0===r?(t?-1:1)*Math.pow(2,-14)*(n/Math.pow(2,10)):31==r?n?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,r-15)*(1+n/Math.pow(2,10))}var _o=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.QueryPool,n.gl_query_type=void 0,n.gl_query=void 0;var s=n.device.gl;if(ca(s)){var u=o.elemCount,l=o.type;n.gl_query=Qe(u,(function(){return n.device.ensureResourceExists(s.createQuery())})),n.gl_query_type=xa(l)}return n}return m(r,[{key:"queryResultOcclusion",value:function(e){var t=this.device.gl;if(ca(t)){var r=this.gl_query[e];return t.getQueryParameter(r,t.QUERY_RESULT_AVAILABLE)?!!t.getQueryParameter(r,t.QUERY_RESULT):null}return null}},{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this),za(this).destroy()}}]),r}(ua),po=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device;return g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Readback,n.gl_pbo=null,n.gl_sync=null,n}return m(r,[{key:"clientWaitAsync",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,n=this.device.gl;return new Promise((function(i,a){function o(){var u=n.clientWaitSync(e,t,0);u!=n.WAIT_FAILED?u!=n.TIMEOUT_EXPIRED?i():setTimeout(o,(0,s.uZ)(r,0,n.MAX_CLIENT_WAIT_TIMEOUT_WEBGL)):a()}o()}))}},{key:"getBufferSubDataAsync",value:function(){var e=R(regeneratorRuntime.mark((function e(t,r,n,i){var a,o,s,u=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(a=u.length>4&&void 0!==u[4]?u[4]:0,o=u.length>5&&void 0!==u[5]?u[5]:i.byteLength||0,s=this.device.gl,!ca(s)){e.next=12;break}return this.gl_sync=s.fenceSync(s.SYNC_GPU_COMMANDS_COMPLETE,0),s.flush(),e.next=8,this.clientWaitAsync(this.gl_sync,0,10);case 8:return s.bindBuffer(t,r),s.getBufferSubData(t,n,i,a,o),s.bindBuffer(t,null),e.abrupt("return",i);case 12:case"end":return e.stop()}}),e,this)})));function t(t,r,n,i){return e.apply(this,arguments)}return t}()},{key:"readTexture",value:function(){var e=R(regeneratorRuntime.mark((function e(t,r,n,i,a,o){var s,u,l,c,f,d,h,_=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(s=_.length>6&&void 0!==_[6]?_[6]:0,u=_.length>7&&void 0!==_[7]?_[7]:o.byteLength||0,l=this.device.gl,c=t,f=this.device.translateTextureFormat(c.pixelFormat),d=this.device.translateTextureType(c.pixelFormat),h=Ne(c.pixelFormat),!ca(l)){e.next=20;break}return this.gl_pbo=this.device.ensureResourceExists(l.createBuffer()),l.bindBuffer(l.PIXEL_PACK_BUFFER,this.gl_pbo),l.bufferData(l.PIXEL_PACK_BUFFER,u,l.STREAM_READ),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.bindFramebuffer(Te.READ_FRAMEBUFFER,this.device.readbackFramebuffer),l.framebufferTexture2D(Te.READ_FRAMEBUFFER,Te.COLOR_ATTACHMENT0,Te.TEXTURE_2D,c.gl_texture,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,this.gl_pbo),l.readPixels(r,n,i,a,f,d,s*h),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),e.abrupt("return",this.getBufferSubDataAsync(l.PIXEL_PACK_BUFFER,this.gl_pbo,0,o,s,u));case 20:return l.bindFramebuffer(Te.FRAMEBUFFER,this.device.readbackFramebuffer),l.framebufferTexture2D(Te.FRAMEBUFFER,Te.COLOR_ATTACHMENT0,Te.TEXTURE_2D,c.gl_texture,0),l.pixelStorei(l.PACK_ALIGNMENT,4),l.readPixels(r,n,i,a,l.RGBA,d,o),e.abrupt("return",Promise.resolve(o));case 25:case"end":return e.stop()}}),e,this)})));function t(t,r,n,i,a,o){return e.apply(this,arguments)}return t}()},{key:"readBuffer",value:function(){var e=R(regeneratorRuntime.mark((function e(t,r,n,i,a){var o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(o=this.device.gl,!ca(o)){e.next=3;break}return e.abrupt("return",this.getBufferSubDataAsync(o.ARRAY_BUFFER,Aa(t,r),r,n,i,a));case 3:return e.abrupt("return",Promise.reject());case 4:case"end":return e.stop()}}),e,this)})));function t(t,r,n,i,a){return e.apply(this,arguments)}return t}()},{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this),ca(this.device.gl)&&(null!==this.gl_sync&&this.device.gl.deleteSync(this.gl_sync),null!==this.gl_pbo&&this.device.gl.deleteBuffer(this.gl_pbo))}}]),r}(ua),vo=function(){function e(t){var r=t.id,n=t.device;g(this,e),this.type=void 0,this.id=void 0,this.name=void 0,this.device=void 0,this.id=r,this.device=n}return m(e,[{key:"destroy",value:function(){}}]),e}(),Eo={formatKind:ce.Float,dimension:oe.n2D},Ro=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Bindings,n.bindingLayout=void 0,n.gpuBindGroup=void 0;var s=o.pipeline,u=o.bindingLayout;Pe(!!s);n._createBindGroupLayout(u);for(var l=[[],[]],c=0,f=0;f<u.storageEntries.length;f++){var d=o.storageBufferBindings[f];Pe(d.wordCount>0);var h={buffer:Ya(d.buffer),offset:0,size:d.wordCount<<2};l[0].push({binding:c++,resource:h})}for(var _=0;_<u.numUniformBuffers;_++){var p=o.uniformBufferBindings[_];Pe(p.wordCount>0);var v={buffer:Ya(p.buffer),offset:0,size:p.wordCount<<2};l[0].push({binding:c++,resource:v})}c=0;for(var E=0;E<u.numSamplers;E++){var R=void 0!==u.samplerEntries?u.samplerEntries[E]:Eo,T=o.samplerBindings[E],m=null!==T.texture?T.texture:n.device.getFallbackTexture(R);Pe(R.dimension===m.dimension),Pe(R.formatKind===Fe(m.pixelFormat));var A=m.gpuTextureView;l[1].push({binding:c++,resource:A});var S=null!==T.sampler?T.sampler:n.device.fallbackSampler,y=Ka(S);l[1].push({binding:c++,resource:y})}return n.gpuBindGroup=l.map((function(e,t){return n.device.device.createBindGroup({layout:s.getBindGroupLayout(t),entries:e})})),n.bindingLayout=o.bindingLayout,n}return m(r,[{key:"_createBindGroupLayout",value:function(e){var t=this.device.bindGroupLayoutCache.get(e);return null===t&&(t=this._createBindGroupLayoutInternal(e),this.device.bindGroupLayoutCache.add(e,t)),t}},{key:"_createBindGroupLayoutInternal",value:function(e){var t=this,r=[[],[]];if(e.storageEntries)for(var n=0;n<e.storageEntries.length;n++)r[0].push({binding:r[0].length,visibility:GPUShaderStage.COMPUTE,buffer:{type:e.storageEntries[n].type}});for(var i=0;i<e.numUniformBuffers;i++)r[0].push({binding:r[0].length,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform",hasDynamicOffset:!0}});for(var a=0;a<e.numSamplers;a++){var o=void 0!==e.samplerEntries?e.samplerEntries[a]:Eo;r[1].push({binding:r[1].length,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:Ha(o)}),r[1].push({binding:r[1].length,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}})}var s=r.map((function(e){return t.device.device.createBindGroupLayout({entries:e})}));return{gpuBindGroupLayout:s}}}]),r}(vo),go=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;return g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.RenderPipeline,n.bindingLayouts=void 0,n.program=void 0,n.drawMode=void 0,n.megaState=void 0,n.inputLayout=void 0,n.colorAttachmentFormats=void 0,n.depthStencilAttachmentFormat=void 0,n.sampleCount=void 0,n.bindingLayouts=n.createBindingLayouts(o.bindingLayouts),n.drawMode=pa(o.topology),n.program=o.program,n.inputLayout=o.inputLayout,n.megaState=o.megaStateDescriptor,n.colorAttachmentFormats=o.colorAttachmentFormats.slice(),n.depthStencilAttachmentFormat=o.depthStencilAttachmentFormat,n.sampleCount=o.sampleCount,n}return m(r,[{key:"createBindingLayouts",value:function(e){for(var t=0,r=0,n=[],i=0;i<e.length;i++){var a=e[i],o=a.numUniformBuffers,s=a.numSamplers,u=a.samplerEntries,l=[];void 0!==u&&Pe(u.length===s);for(var c=0;c<s;c++){var f=void 0!==u?u[c]:Eo,d=f.dimension,h=f.formatKind;l.push({gl_target:Da(d),formatKind:h})}n.push({firstUniformBuffer:t,numUniformBuffers:o,firstSampler:r,numSamplers:s,samplerEntries:l}),t+=o,r+=s}return{numUniformBuffers:t,numSamplers:r,bindingLayoutTables:n}}}]),r}(ua),To=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.RenderTarget,n.gl_renderbuffer=null,n.texture=null,n.pixelFormat=void 0,n.width=void 0,n.height=void 0,n.sampleCount=void 0;var s=n.device.gl,u=o.pixelFormat,l=o.width,c=o.height,f=o.texture,d=o.sampleCount;if(f)n.texture=f;else{n.gl_renderbuffer=n.device.ensureResourceExists(s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,n.gl_renderbuffer);var h=n.device.translateTextureInternalFormat(u);ca(s)&&d>0?s.renderbufferStorageMultisample(Te.RENDERBUFFER,d,h,l,c):s.renderbufferStorage(Te.RENDERBUFFER,h,l,c)}return n.pixelFormat=u,n.width=l,n.height=c,n.sampleCount=d,n}return m(r,[{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this),null!==this.gl_renderbuffer&&this.device.gl.deleteRenderbuffer(this.gl_renderbuffer)}}]),r}(ua),mo=function(){function e(){g(this,e),this.liveObjects=new Set,this.creationStacks=new Map,this.deletionStacks=new Map}return m(e,[{key:"trackResourceCreated",value:function(e){this.creationStacks.set(e,(new Error).stack),this.liveObjects.add(e)}},{key:"trackResourceDestroyed",value:function(e){this.deletionStacks.has(e)&&console.warn("Object double freed:",e,"\n\nCreation stack: ",this.creationStacks.get(e),"\n\nDeletion stack: ",this.deletionStacks.get(e),"\n\nThis stack: ",(new Error).stack),this.deletionStacks.set(e,(new Error).stack),this.liveObjects.delete(e)}},{key:"checkForLeaks",value:function(){var e,t=Y(this.liveObjects.values());try{for(t.s();!(e=t.n()).done;){var r=e.value;console.warn("Object leaked:",r,"Creation stack:",this.creationStacks.get(r))}}catch(n){t.e(n)}finally{t.f()}}},{key:"setResourceLeakCheck",value:function(e,t){t?this.liveObjects.add(e):this.liveObjects.delete(e)}}]),e}(),Ao=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Sampler,n.gl_sampler=void 0,n.descriptor=void 0;var s=n.device.gl;if(ca(s)){var u,l,c=n.device.ensureResourceExists(s.createSampler());s.samplerParameteri(c,Te.TEXTURE_WRAP_S,Ta(o.wrapS)),s.samplerParameteri(c,Te.TEXTURE_WRAP_T,Ta(o.wrapT)),s.samplerParameteri(c,Te.TEXTURE_WRAP_R,Ta(null!==(u=o.wrapQ)&&void 0!==u?u:o.wrapS)),s.samplerParameteri(c,Te.TEXTURE_MIN_FILTER,ma(o.minFilter,o.mipFilter)),s.samplerParameteri(c,Te.TEXTURE_MAG_FILTER,ma(o.magFilter,te.NoMip)),void 0!==o.minLOD&&s.samplerParameterf(c,Te.TEXTURE_MIN_LOD,o.minLOD),void 0!==o.maxLOD&&s.samplerParameterf(c,Te.TEXTURE_MAX_LOD,o.maxLOD),void 0!==o.compareMode&&(s.samplerParameteri(c,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE),s.samplerParameteri(c,s.TEXTURE_COMPARE_FUNC,o.compareMode));var f=null!==(l=o.maxAnisotropy)&&void 0!==l?l:1;f>1&&null!==n.device.EXT_texture_filter_anisotropic&&(Pe(o.minFilter===ee.Bilinear&&o.magFilter===ee.Bilinear&&o.mipFilter===te.Linear),s.samplerParameterf(c,n.device.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,f)),n.gl_sampler=c}else n.descriptor=o;return n}return m(r,[{key:"setTextureParameters",value:function(e,t,r){var n,i=this.device.gl,a=this.descriptor;this.isNPOT(t,r)?i.texParameteri(Te.TEXTURE_2D,Te.TEXTURE_MIN_FILTER,Te.LINEAR):i.texParameteri(e,Te.TEXTURE_MIN_FILTER,ma(a.minFilter,a.mipFilter)),i.texParameteri(Te.TEXTURE_2D,Te.TEXTURE_WRAP_S,Ta(a.wrapS)),i.texParameteri(Te.TEXTURE_2D,Te.TEXTURE_WRAP_T,Ta(a.wrapT)),i.texParameteri(e,Te.TEXTURE_MAG_FILTER,ma(a.magFilter,te.NoMip));var o=null!==(n=a.maxAnisotropy)&&void 0!==n?n:1;o>1&&null!==this.device.EXT_texture_filter_anisotropic&&(Pe(a.minFilter===ee.Bilinear&&a.magFilter===ee.Bilinear&&a.mipFilter===te.Linear),i.texParameteri(e,this.device.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,o))}},{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this),ca(this.device.gl)&&this.device.gl.deleteSampler(ya(this))}},{key:"isNPOT",value:function(e,t){return!Xe(e)||!Xe(t)}}]),r}(ua),So=65536,yo=function(){function e(t,r){g(this,e),this.shaderDebug=!1,this.contextAttributes=void 0,this.OES_vertex_array_object=null,this.ANGLE_instanced_arrays=null,this.OES_texture_float=null,this.OES_draw_buffers_indexed=null,this.WEBGL_draw_buffers=null,this.WEBGL_depth_texture=null,this.WEBGL_compressed_texture_s3tc=null,this.WEBGL_compressed_texture_s3tc_srgb=null,this.EXT_texture_compression_rgtc=null,this.EXT_texture_filter_anisotropic=null,this.KHR_parallel_shader_compile=null,this.EXT_texture_norm16=null,this.scTexture=null,this.scPlatformFramebuffer=null,this.currentActiveTexture=null,this.currentBoundVAO=null,this.currentProgram=null,this.resourceCreationTracker=null,this.resourceUniqueId=0,this.currentColorAttachments=[],this.currentColorResolveTos=[],this.currentDepthStencilAttachment=void 0,this.currentDepthStencilResolveTo=null,this.currentSampleCount=-1,this.currentPipeline=void 0,this.currentInputState=void 0,this.currentMegaState=it(ct),this.currentSamplers=[],this.currentTextures=[],this.currentUniformBuffers=[],this.currentUniformBufferByteOffsets=[],this.currentUniformBufferByteSizes=[],this.currentScissorEnabled=!1,this.currentStencilRef=null,this.currentRenderPassDescriptor=null,this.debugGroupStack=[],this.resolveColorAttachmentsChanged=!1,this.resolveColorReadFramebuffer=void 0,this.resolveColorDrawFramebuffer=void 0,this.resolveDepthStencilAttachmentsChanged=!1,this.resolveDepthStencilReadFramebuffer=void 0,this.resolveDepthStencilDrawFramebuffer=void 0,this.renderPassDrawFramebuffer=void 0,this.readbackFramebuffer=void 0,this.fallbackTexture2D=void 0,this.fallbackTexture2DDepth=void 0,this.fallbackTexture2DArray=void 0,this.fallbackTexture3D=void 0,this.fallbackTextureCube=void 0,this.platformString=void 0,this.glslVersion=void 0,this.explicitBindingLocations=!1,this.separateSamplerTextures=!1,this.viewportOrigin=fe.LowerLeft,this.clipSpaceNearZ=de.NegativeOne,this.supportMRT=!1,this.inBlitRenderPass=!1,this.blitRenderPipeline=void 0,this.blitInputState=void 0,this.blitBindings=void 0,this.uniformBufferMaxPageByteSize=void 0,this.uniformBufferWordAlignment=void 0,this.uniformBufferMaxPageWordSize=void 0,this.supportedSampleCounts=[],this.maxVertexAttribs=void 0,this.gl=void 0,this.gl=t,this.contextAttributes=Ie(t.getContextAttributes()),ca(t)?(this.EXT_texture_norm16=t.getExtension("EXT_texture_norm16"),this.supportMRT=!0):(this.OES_vertex_array_object=t.getExtension("OES_vertex_array_object"),this.ANGLE_instanced_arrays=t.getExtension("ANGLE_instanced_arrays"),this.OES_texture_float=t.getExtension("OES_texture_float"),this.WEBGL_draw_buffers=t.getExtension("WEBGL_draw_buffers"),this.WEBGL_depth_texture=t.getExtension("WEBGL_depth_texture"),t.getExtension("EXT_frag_depth"),t.getExtension("OES_element_index_uint"),t.getExtension("OES_standard_derivatives"),this.WEBGL_draw_buffers&&(this.supportMRT=!0)),this.WEBGL_compressed_texture_s3tc=t.getExtension("WEBGL_compressed_texture_s3tc"),this.WEBGL_compressed_texture_s3tc_srgb=t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.EXT_texture_compression_rgtc=t.getExtension("EXT_texture_compression_rgtc"),this.EXT_texture_filter_anisotropic=t.getExtension("EXT_texture_filter_anisotropic"),this.KHR_parallel_shader_compile=t.getExtension("KHR_parallel_shader_compile"),this.OES_draw_buffers_indexed=t.getExtension("OES_draw_buffers_indexed"),ca(t)?(this.platformString="WebGL2",this.glslVersion="#version 300 es"):(this.platformString="WebGL1",this.glslVersion="#version 100"),this.scTexture=new Ma({id:this.getNextUniqueId(),device:this,descriptor:{width:0,height:0,depth:1,dimension:oe.n2D,numLevels:1,usage:se.RenderTarget,pixelFormat:!1===this.contextAttributes.alpha?Ee.U8_RGB_RT:Ee.U8_RGBA_RT},fake:!0}),this.scTexture.formatKind=ce.Float,this.scTexture.gl_target=null,this.scTexture.gl_texture=null,this.resolveColorReadFramebuffer=this.ensureResourceExists(t.createFramebuffer()),this.resolveColorDrawFramebuffer=this.ensureResourceExists(t.createFramebuffer()),this.resolveDepthStencilReadFramebuffer=this.ensureResourceExists(t.createFramebuffer()),this.resolveDepthStencilDrawFramebuffer=this.ensureResourceExists(t.createFramebuffer()),this.renderPassDrawFramebuffer=this.ensureResourceExists(t.createFramebuffer()),this.readbackFramebuffer=this.ensureResourceExists(t.createFramebuffer()),this.fallbackTexture2D=this.createFallbackTexture(oe.n2D,ce.Float),this.fallbackTexture2DDepth=this.createFallbackTexture(oe.n2D,ce.Depth),ca(t),this.currentMegaState.depthCompare=q.Less,this.currentMegaState.depthWrite=!1,this.currentMegaState.attachmentsState[0].channelWriteMask=ue.AllChannels,t.enable(t.DEPTH_TEST),this.checkLimits(),r.shaderDebug&&(this.shaderDebug=!0),r.trackResources&&(this.resourceCreationTracker=new mo)}return m(e,[{key:"createFallbackTexture",value:function(e,t){var r=e===oe.Cube?6:1,n=t===ce.Depth?Ee.D24:Ee.U8_RGBA_NORM,i=this.createTexture({dimension:e,pixelFormat:n,usage:se.Sampled,width:1,height:1,depth:r,numLevels:1,immutable:!0});return t===ce.Float&&i.setImageData([new Uint8Array(4*r)],0),Sa(i)}},{key:"getNextUniqueId",value:function(){return++this.resourceUniqueId}},{key:"checkLimits",value:function(){var e=this.gl;if(this.maxVertexAttribs=e.getParameter(Te.MAX_VERTEX_ATTRIBS),ca(e)){this.uniformBufferMaxPageByteSize=Math.min(e.getParameter(Te.MAX_UNIFORM_BLOCK_SIZE),So),this.uniformBufferWordAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT)/4;var t=e.getInternalformatParameter(e.RENDERBUFFER,e.DEPTH32F_STENCIL8,e.SAMPLES);this.supportedSampleCounts=t?L(t):[]}else this.uniformBufferWordAlignment=64,this.uniformBufferMaxPageByteSize=So;this.uniformBufferMaxPageWordSize=this.uniformBufferMaxPageByteSize/4,this.supportedSampleCounts.includes(1)||this.supportedSampleCounts.push(1),this.supportedSampleCounts.sort((function(e,t){return e-t}))}},{key:"configureSwapChain",value:function(e,t,r){var n=this.scTexture;n.width=e,n.height=t,this.scPlatformFramebuffer=He(r)}},{key:"getDevice",value:function(){return this}},{key:"getCanvas",value:function(){return this.gl.canvas}},{key:"getOnscreenTexture",value:function(){return this.scTexture}},{key:"present",value:function(){var e=this.gl;this.currentMegaState.attachmentsState[0].channelWriteMask!==ue.Alpha&&(e.colorMask(!1,!1,!1,!0),this.currentMegaState.attachmentsState[0].channelWriteMask=ue.Alpha);var t=We.r,r=We.g,n=We.b,i=We.a;ca(e)?e.clearBufferfv(e.COLOR,0,[t,r,n,i]):this.submitBlitRenderPass()}},{key:"translateTextureInternalFormat",value:function(e){switch(e){case Ee.ALPHA:return Te.ALPHA;case Ee.F16_RGBA:return Te.RGBA16F;case Ee.F32_R:return Te.R32F;case Ee.F32_RG:return Te.RG32F;case Ee.F32_RGB:return Te.RGB32F;case Ee.F32_RGBA:return Te.RGBA32F;case Ee.U8_R_NORM:return Te.R8;case Ee.U8_RG_NORM:return Te.RG8;case Ee.U8_RGB_NORM:case Ee.U8_RGB_RT:return Te.RGB8;case Ee.U8_RGB_SRGB:return Te.SRGB8;case Ee.U8_RGBA_NORM:case Ee.U8_RGBA_RT:return ca(this.gl)?Te.RGBA8:Te.RGBA;case Ee.U8_RGBA_SRGB:case Ee.U8_RGBA_RT_SRGB:return Te.SRGB8_ALPHA8;case Ee.U16_R:return Te.R16UI;case Ee.U16_R_NORM:return this.EXT_texture_norm16.R16_EXT;case Ee.U16_RG_NORM:return this.EXT_texture_norm16.RG16_EXT;case Ee.U16_RGBA_NORM:return this.EXT_texture_norm16.RGBA16_EXT;case Ee.U16_RGBA_5551:return Te.RGB5_A1;case Ee.U32_R:return Te.R32UI;case Ee.S8_RGBA_NORM:return Te.RGBA8_SNORM;case Ee.S8_RG_NORM:return Te.RG8_SNORM;case Ee.U16_RGBA_5551:return Te.UNSIGNED_SHORT_5_5_5_1;case Ee.BC1:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ee.BC1_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ee.BC2:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ee.BC2_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ee.BC3:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ee.BC3_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ee.BC4_UNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_RED_RGTC1_EXT;case Ee.BC4_SNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_SIGNED_RED_RGTC1_EXT;case Ee.BC5_UNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_RED_GREEN_RGTC2_EXT;case Ee.BC5_SNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT;case Ee.D32F_S8:return ca(this.gl)?Te.DEPTH32F_STENCIL8:Te.DEPTH_STENCIL;case Ee.D24_S8:return ca(this.gl)?Te.DEPTH24_STENCIL8:Te.DEPTH_STENCIL;case Ee.D32F:return ca(this.gl)?Te.DEPTH_COMPONENT32F:Te.DEPTH_COMPONENT;case Ee.D24:return ca(this.gl)?Te.DEPTH_COMPONENT24:Te.DEPTH_COMPONENT;default:throw"whoops"}}},{key:"translateTextureType",value:function(e){var t=Be(e);switch(t){case _e.U8:return Te.UNSIGNED_BYTE;case _e.U16:return Te.UNSIGNED_SHORT;case _e.U32:return Te.UNSIGNED_INT;case _e.S8:return Te.BYTE;case _e.F16:return Te.HALF_FLOAT;case _e.F32:return Te.FLOAT;case _e.U16_PACKED_5551:return Te.UNSIGNED_SHORT_5_5_5_1;case _e.D32F:return Te.FLOAT;case _e.D24:return ca(this.gl)?Te.UNSIGNED_INT_24_8:Te.UNSIGNED_SHORT;case _e.D24S8:return ca(this.gl)?Te.UNSIGNED_INT_24_8:Te.UNSIGNED_INT_24_8_WEBGL;case _e.D32FS8:return Te.FLOAT_32_UNSIGNED_INT_24_8_REV;default:throw"whoops"}}},{key:"translateTextureFormat",value:function(e){if(fa(e))return this.translateTextureInternalFormat(e);switch(e){case Ee.D24_S8:case Ee.D32F_S8:return Te.DEPTH_STENCIL;case Ee.D24:case Ee.D32F:return Te.DEPTH_COMPONENT}var t=da(e),r=Ce(e);switch(r){case pe.A:return Te.ALPHA;case pe.R:return t?Te.RED_INTEGER:Te.RED;case pe.RG:return t?Te.RG_INTEGER:Te.RG;case pe.RGB:return t?Te.RGB_INTEGER:Te.RGB;case pe.RGBA:return Te.RGBA}}},{key:"setActiveTexture",value:function(e){this.currentActiveTexture!==e&&(this.gl.activeTexture(e),this.currentActiveTexture=e)}},{key:"bindVAO",value:function(e){this.currentBoundVAO!==e&&(ca(this.gl)?this.gl.bindVertexArray(e):this.OES_vertex_array_object.bindVertexArrayOES(e),this.currentBoundVAO=e)}},{key:"programCompiled",value:function(e){Pe(e.compileState!==Na.NeedsCompile),e.compileState===Na.Compiling&&(e.compileState=Na.NeedsBind,this.shaderDebug&&this.checkProgramCompilationForErrors(e))}},{key:"useProgram",value:function(e){this.currentProgram!==e&&(this.programCompiled(e),this.gl.useProgram(e.gl_program),this.currentProgram=e)}},{key:"ensureResourceExists",value:function(e){if(null===e){var t=this.gl.getError();throw new Error("Created resource is null; GL error encountered: ".concat(t))}return e}},{key:"createBuffer",value:function(e){return new Fa({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createTexture",value:function(e){return new Ma({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createSampler",value:function(e){return new Ao({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createRenderTarget",value:function(e){return new To({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createRenderTargetFromTexture",value:function(e){var t=e.pixelFormat,r=e.width,n=e.height,i=e.numLevels;return Pe(1===i),this.createRenderTarget({pixelFormat:t,width:r,height:n,sampleCount:1,texture:e})}},{key:"createProgram",value:function(e){return e.ensurePreprocessed(this.queryVendorInfo()),this.createProgramSimple(e)}},{key:"createProgramSimple",value:function(e){return new ba({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createBindings",value:function(e){var t=e.bindingLayout,r=e.uniformBufferBindings,n=e.samplerBindings;return Pe(r.length>=t.numUniformBuffers),Pe(n.length>=t.numSamplers),new la({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createInputLayout",value:function(e){return new Pa({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createInputState",value:function(e,t,r,n){var i=e;return new Ia({id:this.getNextUniqueId(),device:this,inputLayout:i,vertexBuffers:t,indexBufferBinding:r,program:n})}},{key:"createRenderPipeline",value:function(e){return new go({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createComputePass",value:function(e){throw new Error("Method not implemented.")}},{key:"createComputePipeline",value:function(e){throw new Error("Method not implemented.")}},{key:"createReadback",value:function(){return new po({id:this.getNextUniqueId(),device:this})}},{key:"createQueryPool",value:function(e,t){return new _o({id:this.getNextUniqueId(),device:this,descriptor:{type:e,elemCount:t}})}},{key:"createRenderPass",value:function(e){Pe(null===this.currentRenderPassDescriptor),this.currentRenderPassDescriptor=e;var t=e.colorAttachment,r=e.colorClearColor,n=e.colorResolveTo,i=e.depthStencilAttachment,a=e.depthClearValue,o=e.stencilClearValue,s=e.depthStencilResolveTo;this.setRenderPassParametersBegin(t.length);for(var u=0;u<t.length;u++)this.setRenderPassParametersColor(u,t[u],n[u]);this.setRenderPassParametersDepthStencil(i,s),this.validateCurrentAttachments();for(var l=0;l<t.length;l++){var c=r[l];"load"!==c&&this.setRenderPassParametersClearColor(l,c.r,c.g,c.b,c.a)}return this.setRenderPassParametersClearDepthStencil(a,o),this}},{key:"submitPass",value:function(e){Pe(null!==this.currentRenderPassDescriptor),this.endPass(),this.currentRenderPassDescriptor=null}},{key:"copySubTexture2D",value:function(e,t,r,n,i,a){var o=this.gl,s=e,u=n;Pe(1===u.numLevels),Pe(1===s.numLevels),ca(o)&&(s===this.scTexture?o.bindFramebuffer(o.DRAW_FRAMEBUFFER,this.scPlatformFramebuffer):(o.bindFramebuffer(o.DRAW_FRAMEBUFFER,this.resolveColorDrawFramebuffer),this.bindFramebufferAttachment(o.DRAW_FRAMEBUFFER,o.COLOR_ATTACHMENT0,s)),o.bindFramebuffer(o.READ_FRAMEBUFFER,this.resolveColorReadFramebuffer),this.bindFramebufferAttachment(o.READ_FRAMEBUFFER,o.COLOR_ATTACHMENT0,u),o.blitFramebuffer(i,a,i+u.width,a+u.height,t,r,t+u.width,r+u.height,o.COLOR_BUFFER_BIT,o.LINEAR),o.bindFramebuffer(o.READ_FRAMEBUFFER,null),o.bindFramebuffer(o.DRAW_FRAMEBUFFER,null))}},{key:"queryLimits",value:function(){return this}},{key:"queryTextureFormatSupported",value:function(e){switch(e){case Ee.BC1_SRGB:case Ee.BC2_SRGB:case Ee.BC3_SRGB:return null!==this.WEBGL_compressed_texture_s3tc_srgb;case Ee.BC1:case Ee.BC2:case Ee.BC3:return null!==this.WEBGL_compressed_texture_s3tc;case Ee.BC4_UNORM:case Ee.BC4_SNORM:case Ee.BC5_UNORM:case Ee.BC5_SNORM:return null!==this.EXT_texture_compression_rgtc;default:return!0}}},{key:"queryProgramReady",value:function(e){var t,r=this.gl;if(e.compileState===Na.NeedsCompile)throw"whoops";return e.compileState===Na.Compiling?(t=null===this.KHR_parallel_shader_compile||r.getProgramParameter(e.gl_program,this.KHR_parallel_shader_compile.COMPLETION_STATUS_KHR),t&&this.programCompiled(e),t):e.compileState===Na.NeedsBind||e.compileState===Na.ReadyToUse}},{key:"queryPipelineReady",value:function(e){var t=e;return this.queryProgramReady(t.program)}},{key:"queryPlatformAvailable",value:function(){return this.gl.isContextLost()}},{key:"queryVendorInfo",value:function(){return this}},{key:"queryRenderPass",value:function(e){return this.currentRenderPassDescriptor}},{key:"queryRenderTarget",value:function(e){var t=e;return t}},{key:"setResourceName",value:function(e,t){if(e.name=t,e.type===z.Buffer)for(var r=e.gl_buffer_pages,n=0;n<r.length;n++)Ca(r[n],"".concat(t," Page ").concat(n));else if(e.type===z.Texture)Ca(Sa(e),t);else if(e.type===z.Sampler)Ca(ya(e),t);else if(e.type===z.RenderTarget){var i=e.gl_renderbuffer;null!==i&&Ca(i,t)}else e.type===z.InputState&&Ca(e.vao,t)}},{key:"setResourceLeakCheck",value:function(e,t){null!==this.resourceCreationTracker&&this.resourceCreationTracker.setResourceLeakCheck(e,t)}},{key:"checkForLeaks",value:function(){null!==this.resourceCreationTracker&&this.resourceCreationTracker.checkForLeaks()}},{key:"pushDebugGroup",value:function(e){this.debugGroupStack.push(e)}},{key:"popDebugGroup",value:function(){this.debugGroupStack.pop()}},{key:"programPatched",value:function(e,t){Pe(this.shaderDebug)}},{key:"getBufferData",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this.gl;ca(n)&&(n.bindBuffer(n.COPY_READ_BUFFER,Aa(e,4*r)),n.getBufferSubData(n.COPY_READ_BUFFER,4*r,t))}},{key:"debugGroupStatisticsDrawCall",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].drawCallCount+=e}},{key:"debugGroupStatisticsBufferUpload",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].bufferUploadCount+=e}},{key:"debugGroupStatisticsTextureBind",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].textureBindCount+=e}},{key:"debugGroupStatisticsTriangles",value:function(e){for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].triangleCount+=e}},{key:"reportShaderError",value:function(e,t){var r=this.gl,n=r.getShaderParameter(e,r.COMPILE_STATUS);if(!n){console.error(Je(t));var i=r.getExtension("WEBGL_debug_shaders");i&&console.error(i.getTranslatedShaderSource(e)),console.error(r.getShaderInfoLog(e))}return n}},{key:"checkProgramCompilationForErrors",value:function(e){var t=this.gl,r=e.gl_program;if(!t.getProgramParameter(r,t.LINK_STATUS)){var n=e.descriptor;if(!this.reportShaderError(e.gl_shader_vert,n.preprocessedVert))return;if(!this.reportShaderError(e.gl_shader_frag,n.preprocessedFrag))return;console.error(t.getProgramInfoLog(e.gl_program))}}},{key:"bindFramebufferAttachment",value:function(e,t,r){var n=this.gl;null===r?n.framebufferRenderbuffer(e,t,n.RENDERBUFFER,null):r.type===z.RenderTarget?null!==r.gl_renderbuffer?n.framebufferRenderbuffer(e,t,n.RENDERBUFFER,r.gl_renderbuffer):null!==r.texture&&n.framebufferTexture2D(e,t,Te.TEXTURE_2D,Sa(r.texture),0):r.type===z.Texture&&n.framebufferTexture2D(e,t,Te.TEXTURE_2D,Sa(r),0)}},{key:"bindFramebufferDepthStencilAttachment",value:function(e,t){var r=this.gl,n=null!==t?Oe(t.pixelFormat):ve.Depth|ve.Stencil,i=!!(n&ve.Depth),a=!!(n&ve.Stencil);i&&a?this.bindFramebufferAttachment(e,r.DEPTH_STENCIL_ATTACHMENT,t):i?(this.bindFramebufferAttachment(e,r.DEPTH_ATTACHMENT,t),this.bindFramebufferAttachment(e,r.STENCIL_ATTACHMENT,null)):a&&(this.bindFramebufferAttachment(e,r.STENCIL_ATTACHMENT,t),this.bindFramebufferAttachment(e,r.DEPTH_ATTACHMENT,null))}},{key:"validateCurrentAttachments",value:function(){for(var e=-1,t=-1,r=-1,n=0;n<this.currentColorAttachments.length;n++){var i=this.currentColorAttachments[n];null!==i&&(-1===e?(e=i.sampleCount,t=i.width,r=i.height):(Pe(e===i.sampleCount),Pe(t===i.width),Pe(r===i.height)))}null!==this.currentDepthStencilAttachment&&(-1===e?(e=this.currentDepthStencilAttachment.sampleCount,t=this.currentDepthStencilAttachment.width,r=this.currentDepthStencilAttachment.height):(Pe(e===this.currentDepthStencilAttachment.sampleCount),Pe(t===this.currentDepthStencilAttachment.width),Pe(r===this.currentDepthStencilAttachment.height))),this.currentSampleCount=e}},{key:"setRenderPassParametersBegin",value:function(e){var t=this.gl;if(ca(t)?t.bindFramebuffer(Te.DRAW_FRAMEBUFFER,this.renderPassDrawFramebuffer):this.inBlitRenderPass||t.bindFramebuffer(Te.FRAMEBUFFER,this.renderPassDrawFramebuffer),!this.inBlitRenderPass)for(var r=e;r<this.currentColorAttachments.length;r++){var n=ca(t)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,i=ca(t)?Te.COLOR_ATTACHMENT0:Te.COLOR_ATTACHMENT0_WEBGL;t.framebufferRenderbuffer(n,i+r,Te.RENDERBUFFER,null),t.framebufferTexture2D(n,i+r,Te.TEXTURE_2D,null,0)}this.currentColorAttachments.length=e,ca(t)?t.drawBuffers([Te.COLOR_ATTACHMENT0,Te.COLOR_ATTACHMENT1,Te.COLOR_ATTACHMENT2,Te.COLOR_ATTACHMENT3]):this.inBlitRenderPass||this.WEBGL_draw_buffers.drawBuffersWEBGL([Te.COLOR_ATTACHMENT0_WEBGL,Te.COLOR_ATTACHMENT1_WEBGL,Te.COLOR_ATTACHMENT2_WEBGL,Te.COLOR_ATTACHMENT3_WEBGL])}},{key:"setRenderPassParametersColor",value:function(e,t,r){var n=this.gl;this.currentColorAttachments[e]!==t&&(this.currentColorAttachments[e]=t,this.bindFramebufferAttachment(ca(n)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,(ca(n)?Te.COLOR_ATTACHMENT0:Te.COLOR_ATTACHMENT0_WEBGL)+e,t),this.resolveColorAttachmentsChanged=!0),this.currentColorResolveTos[e]!==r&&(this.currentColorResolveTos[e]=r,null!==r&&(this.resolveColorAttachmentsChanged=!0))}},{key:"setRenderPassParametersDepthStencil",value:function(e,t){var r=this.gl;this.currentDepthStencilAttachment!==e&&(this.currentDepthStencilAttachment=e,this.inBlitRenderPass||this.bindFramebufferDepthStencilAttachment(ca(r)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,this.currentDepthStencilAttachment),this.resolveDepthStencilAttachmentsChanged=!0),this.currentDepthStencilResolveTo!==t&&(this.currentDepthStencilResolveTo=t,null!==t&&(this.resolveDepthStencilAttachmentsChanged=!0))}},{key:"setRenderPassParametersClearColor",value:function(e,t,r,n,i){var a=this.gl;if(null!==this.OES_draw_buffers_indexed){var o=this.currentMegaState.attachmentsState[e];o.channelWriteMask!==ue.AllChannels&&(this.OES_draw_buffers_indexed.colorMaskiOES(e,!0,!0,!0,!0),o.channelWriteMask=ue.AllChannels)}else{var s=this.currentMegaState.attachmentsState[0];s.channelWriteMask!==ue.AllChannels&&(a.colorMask(!0,!0,!0,!0),s.channelWriteMask=ue.AllChannels)}this.setScissorEnabled(!1),ca(a)?a.clearBufferfv(a.COLOR,e,[t,r,n,i]):(a.clearColor(t,r,n,i),a.clear(a.COLOR_BUFFER_BIT))}},{key:"setRenderPassParametersClearDepthStencil",value:function(e,t){var r=this.gl;"load"!==e&&(Pe(null!==this.currentDepthStencilAttachment),this.currentMegaState.depthWrite||(r.depthMask(!0),this.currentMegaState.depthWrite=!0),ca(r)?r.clearBufferfv(r.DEPTH,0,[e]):(r.clearDepth(e),r.clear(r.DEPTH_BUFFER_BIT))),"load"!==t&&(Pe(null!==this.currentDepthStencilAttachment),this.currentMegaState.stencilWrite||(r.enable(r.STENCIL_TEST),r.stencilMask(255),this.currentMegaState.stencilWrite=!0),ca(r)?r.clearBufferiv(r.STENCIL,0,[t]):(r.clearStencil(t),r.clear(r.STENCIL_BUFFER_BIT)))}},{key:"setBindings",value:function(e,t,r){var n=this.gl;Pe(e<this.currentPipeline.bindingLayouts.bindingLayoutTables.length);var i=this.currentPipeline.bindingLayouts.bindingLayoutTables[e],a=t.uniformBufferBindings,o=t.samplerBindings;Pe(a.length>=i.numUniformBuffers),Pe(o.length>=i.numSamplers),Pe(r.length>=a.length);for(var s=0;s<a.length;s++){var u=a[s];if(0!==u.wordCount){var l=i.firstUniformBuffer+s,c=u.buffer,f=r[s],d=4*u.wordCount;if(c!==this.currentUniformBuffers[l]||f!==this.currentUniformBufferByteOffsets[l]||d!==this.currentUniformBufferByteSizes[l]){var h=f%c.pageByteSize,_=c.gl_buffer_pages[f/c.pageByteSize|0];Pe(h+d<=c.pageByteSize),ca(n)&&n.bindBufferRange(n.UNIFORM_BUFFER,l,_,h,d),this.currentUniformBuffers[l]=c,this.currentUniformBufferByteOffsets[l]=f,this.currentUniformBufferByteSizes[l]=d}}}for(var p=0;p<i.numSamplers;p++){var v=o[p],E=i.firstSampler+p,R=i.samplerEntries[p],g=null!==v&&null!==v.sampler?ya(v.sampler):null,T=null!==v&&null!==v.texture?Sa(v.texture):null;if(this.currentSamplers[E]!==g&&(ca(n)&&n.bindSampler(E,g),this.currentSamplers[E]=g),this.currentTextures[E]!==T){if(this.setActiveTexture(n.TEXTURE0+E),null!==T){v.texture.textureIndex=E;var m,A=Ie(v).texture,S=A.gl_target,y=(A.formatKind,A.width),C=A.height;if(n.bindTexture(S,T),!ca(n))null===(m=v.sampler)||void 0===m||m.setTextureParameters(S,y,C);this.debugGroupStatisticsTextureBind(),Pe(R.gl_target===S)}else n.bindTexture(R.gl_target,this.getFallbackTexture(R));this.currentTextures[E]=T}}}},{key:"setViewport",value:function(e,t,r,n){var i=this.gl;i.viewport(e,t,r,n)}},{key:"setScissor",value:function(e,t,r,n){var i=this.gl;this.setScissorEnabled(!0),i.scissor(e,t,r,n)}},{key:"applyAttachmentStateIndexed",value:function(e,t,r){var n=this.gl,i=this.OES_draw_buffers_indexed;t.channelWriteMask!==r.channelWriteMask&&(i.colorMaskiOES(e,!!(r.channelWriteMask&ue.Red),!!(r.channelWriteMask&ue.Green),!!(r.channelWriteMask&ue.Blue),!!(r.channelWriteMask&ue.Alpha)),t.channelWriteMask=r.channelWriteMask);var a=t.rgbBlendState.blendMode!==r.rgbBlendState.blendMode||t.alphaBlendState.blendMode!==r.alphaBlendState.blendMode,o=t.rgbBlendState.blendSrcFactor!==r.rgbBlendState.blendSrcFactor||t.alphaBlendState.blendSrcFactor!==r.alphaBlendState.blendSrcFactor||t.rgbBlendState.blendDstFactor!==r.rgbBlendState.blendDstFactor||t.alphaBlendState.blendDstFactor!==r.alphaBlendState.blendDstFactor;(o||a)&&(Oa(t.rgbBlendState)&&Oa(t.alphaBlendState)?i.enableiOES(e,n.BLEND):Oa(r.rgbBlendState)&&Oa(r.alphaBlendState)&&i.disableiOES(e,n.BLEND)),a&&(i.blendEquationSeparateiOES(e,r.rgbBlendState.blendMode,r.alphaBlendState.blendMode),t.rgbBlendState.blendMode=r.rgbBlendState.blendMode,t.alphaBlendState.blendMode=r.alphaBlendState.blendMode),o&&(i.blendFuncSeparateiOES(e,r.rgbBlendState.blendSrcFactor,r.rgbBlendState.blendDstFactor,r.alphaBlendState.blendSrcFactor,r.alphaBlendState.blendDstFactor),t.rgbBlendState.blendSrcFactor=r.rgbBlendState.blendSrcFactor,t.alphaBlendState.blendSrcFactor=r.alphaBlendState.blendSrcFactor,t.rgbBlendState.blendDstFactor=r.rgbBlendState.blendDstFactor,t.alphaBlendState.blendDstFactor=r.alphaBlendState.blendDstFactor)}},{key:"applyAttachmentState",value:function(e,t){var r=this.gl;e.channelWriteMask!==t.channelWriteMask&&(r.colorMask(!!(t.channelWriteMask&ue.Red),!!(t.channelWriteMask&ue.Green),!!(t.channelWriteMask&ue.Blue),!!(t.channelWriteMask&ue.Alpha)),e.channelWriteMask=t.channelWriteMask);var n=e.rgbBlendState.blendMode!==t.rgbBlendState.blendMode||e.alphaBlendState.blendMode!==t.alphaBlendState.blendMode,i=e.rgbBlendState.blendSrcFactor!==t.rgbBlendState.blendSrcFactor||e.alphaBlendState.blendSrcFactor!==t.alphaBlendState.blendSrcFactor||e.rgbBlendState.blendDstFactor!==t.rgbBlendState.blendDstFactor||e.alphaBlendState.blendDstFactor!==t.alphaBlendState.blendDstFactor;(i||n)&&(Oa(e.rgbBlendState)&&Oa(e.alphaBlendState)?r.enable(r.BLEND):Oa(t.rgbBlendState)&&Oa(t.alphaBlendState)&&r.disable(r.BLEND)),n&&(r.blendEquationSeparate(t.rgbBlendState.blendMode,t.alphaBlendState.blendMode),e.rgbBlendState.blendMode=t.rgbBlendState.blendMode,e.alphaBlendState.blendMode=t.alphaBlendState.blendMode),i&&(r.blendFuncSeparate(t.rgbBlendState.blendSrcFactor,t.rgbBlendState.blendDstFactor,t.alphaBlendState.blendSrcFactor,t.alphaBlendState.blendDstFactor),e.rgbBlendState.blendSrcFactor=t.rgbBlendState.blendSrcFactor,e.alphaBlendState.blendSrcFactor=t.alphaBlendState.blendSrcFactor,e.rgbBlendState.blendDstFactor=t.rgbBlendState.blendDstFactor,e.alphaBlendState.blendDstFactor=t.alphaBlendState.blendDstFactor)}},{key:"setMegaState",value:function(e){var t=this.gl,r=this.currentMegaState;if(null!==this.OES_draw_buffers_indexed)for(var n=0;n<e.attachmentsState.length;n++)this.applyAttachmentStateIndexed(n,r.attachmentsState[0],e.attachmentsState[0]);else Pe(1===e.attachmentsState.length),this.applyAttachmentState(r.attachmentsState[0],e.attachmentsState[0]);Me(r.blendConstant,e.blendConstant)||(t.blendColor(e.blendConstant.r,e.blendConstant.g,e.blendConstant.b,e.blendConstant.a),be(r.blendConstant,e.blendConstant)),r.depthCompare!==e.depthCompare&&(t.depthFunc(e.depthCompare),r.depthCompare=e.depthCompare),r.depthWrite!==e.depthWrite&&(t.depthMask(e.depthWrite),r.depthWrite=e.depthWrite),r.stencilWrite!==e.stencilWrite&&(t.stencilMask(e.stencilWrite?255:0),r.stencilWrite=e.stencilWrite),r.stencilPassOp!==e.stencilPassOp&&(t.stencilOp(t.KEEP,t.KEEP,e.stencilPassOp),r.stencilPassOp=e.stencilPassOp),r.stencilRef===e.stencilRef&&r.stencilCompare===e.stencilCompare||(r.stencilCompare=e.stencilCompare,this.setStencilRef(e.stencilRef)),r.cullMode!==e.cullMode&&(r.cullMode===j.None?t.enable(t.CULL_FACE):e.cullMode===j.None&&t.disable(t.CULL_FACE),e.cullMode===j.Back?t.cullFace(t.BACK):e.cullMode===j.Front?t.cullFace(t.FRONT):e.cullMode===j.FrontAndBack&&t.cullFace(t.FRONT_AND_BACK),r.cullMode=e.cullMode),r.frontFace!==e.frontFace&&(t.frontFace(e.frontFace),r.frontFace=e.frontFace),r.polygonOffset!==e.polygonOffset&&(e.polygonOffset?(t.polygonOffset(1,1),t.enable(t.POLYGON_OFFSET_FILL)):t.disable(t.POLYGON_OFFSET_FILL),r.polygonOffset=e.polygonOffset)}},{key:"validatePipelineFormats",value:function(e){for(var t=0;t<this.currentColorAttachments.length;t++){var r=this.currentColorAttachments[t];null!==r&&Pe(r.pixelFormat===e.colorAttachmentFormats[t])}null!==this.currentDepthStencilAttachment&&Pe(this.currentDepthStencilAttachment.pixelFormat===e.depthStencilAttachmentFormat),-1!==this.currentSampleCount&&Pe(this.currentSampleCount===e.sampleCount)}},{key:"setPipeline",value:function(e){this.currentPipeline=e,this.validatePipelineFormats(this.currentPipeline),this.setMegaState(this.currentPipeline.megaState);var t=this.currentPipeline.program;if(this.useProgram(t),t.compileState===Na.NeedsBind){var r=this.gl,n=t.gl_program,i=t.descriptor,a=Ba(i.preprocessedVert,/uniform (\w+) {([^]*?)}/g);if(ca(r))for(var o=0;o<a.length;o++){var s=M(a[o],3),u=(s[0],s[1]),l=(s[2],r.getUniformBlockIndex(n,u));-1!==l&&4294967295!==l&&r.uniformBlockBinding(n,l,o)}for(var c=Ba(i.preprocessedVert,/^uniform .*sampler\S+ (\w+);\s* \/\/ BINDING=(\d+)$/gm),f=0;f<c.length;f++){var d=M(c[f],3),h=(d[0],d[1]),_=d[2],p=r.getUniformLocation(n,h);r.uniform1i(p,parseInt(_))}t.compileState=Na.ReadyToUse}}},{key:"setInputState",value:function(e){var t=e;this.currentInputState=t,null!==this.currentInputState?(Pe(this.currentPipeline.inputLayout===this.currentInputState.inputLayout),this.bindVAO(this.currentInputState.vao)):(Pe(null===this.currentPipeline.inputLayout),this.bindVAO(null))}},{key:"setStencilRef",value:function(e){this.currentStencilRef=e,this.applyStencil()}},{key:"draw",value:function(e,t){var r=this.gl,n=this.currentPipeline;r.drawArrays(n.drawMode,t,e),this.debugGroupStatisticsDrawCall(),this.debugGroupStatisticsTriangles(e/3)}},{key:"drawIndexed",value:function(e,t){var r=this.gl,n=this.currentPipeline,i=this.currentInputState,a=Ie(i.indexBufferByteOffset)+t*Ie(i.indexBufferCompByteSize);r.drawElements(n.drawMode,e,Ie(i.indexBufferType),a),this.debugGroupStatisticsDrawCall(),this.debugGroupStatisticsTriangles(e/3)}},{key:"drawIndexedInstanced",value:function(e,t,r){var n,i=this.gl,a=this.currentPipeline,o=this.currentInputState,s=Ie(o.indexBufferByteOffset)+t*Ie(o.indexBufferCompByteSize),u=[a.drawMode,e,Ie(o.indexBufferType),s,r];ca(i)?i.drawElementsInstanced.apply(i,u):(n=this.ANGLE_instanced_arrays).drawElementsInstancedANGLE.apply(n,u);this.debugGroupStatisticsDrawCall(),this.debugGroupStatisticsTriangles(e/3*r)}},{key:"beginOcclusionQuery",value:function(e){var t=this.gl;if(ca(t)){var r=this.currentRenderPassDescriptor.occlusionQueryPool;t.beginQuery(r.gl_query_type,r.gl_query[e])}}},{key:"endOcclusionQuery",value:function(e){var t=this.gl;if(ca(t)){var r=this.currentRenderPassDescriptor.occlusionQueryPool;t.endQuery(r.gl_query_type)}}},{key:"beginDebugGroup",value:function(e){}},{key:"endDebugGroup",value:function(){}},{key:"pipelineQueryReady",value:function(e){var t=e;return this.queryProgramReady(t.program)}},{key:"pipelineForceReady",value:function(e){}},{key:"endPass",value:function(){for(var e=this.gl,t=!1,r=0;r<this.currentColorAttachments.length;r++){var n=this.currentColorResolveTos[r];if(null!==n){var i=Ie(this.currentColorAttachments[r]);Pe(i.width===n.width&&i.height===n.height),Pe(i.pixelFormat===n.pixelFormat),e.disable(Te.SCISSOR_TEST),ca(e)&&e.bindFramebuffer(Te.READ_FRAMEBUFFER,this.resolveColorReadFramebuffer),n===this.scTexture?(e.bindFramebuffer(ca(e)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,this.scPlatformFramebuffer),this.resolveColorAttachmentsChanged&&ca(e)&&this.bindFramebufferAttachment(Te.READ_FRAMEBUFFER,Te.COLOR_ATTACHMENT0,i),ca(e)?e.blitFramebuffer(0,0,i.width,i.height,0,0,n.width,n.height,Te.COLOR_BUFFER_BIT,Te.LINEAR):e.bindTexture(Te.TEXTURE_2D,i.texture.gl_texture),t=!0):(e.bindFramebuffer(ca(e)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,this.resolveColorDrawFramebuffer),this.resolveColorAttachmentsChanged&&(this.bindFramebufferAttachment(ca(e)?Te.READ_FRAMEBUFFER:Te.FRAMEBUFFER,ca(e)?Te.COLOR_ATTACHMENT0:Te.COLOR_ATTACHMENT0_WEBGL,i),e.framebufferTexture2D(ca(e)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,ca(e)?Te.COLOR_ATTACHMENT0:Te.COLOR_ATTACHMENT0_WEBGL,Te.TEXTURE_2D,n.gl_texture,0)),ca(e)&&e.blitFramebuffer(0,0,i.width,i.height,0,0,n.width,n.height,e.COLOR_BUFFER_BIT,e.LINEAR),e.bindFramebuffer(ca(e)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,null),t=!0),ca(e)&&e.bindFramebuffer(Te.READ_FRAMEBUFFER,null)}}this.resolveColorAttachmentsChanged=!1;var a=this.currentDepthStencilAttachment,o=this.currentDepthStencilResolveTo;null!==a&&null!==o&&(Pe(a.width===o.width&&a.height===o.height),e.disable(e.SCISSOR_TEST),e.bindFramebuffer(ca(e)?Te.READ_FRAMEBUFFER:Te.FRAMEBUFFER,this.resolveDepthStencilReadFramebuffer),e.bindFramebuffer(ca(e)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,this.resolveDepthStencilDrawFramebuffer),this.resolveDepthStencilAttachmentsChanged&&(this.bindFramebufferDepthStencilAttachment(ca(e)?Te.READ_FRAMEBUFFER:Te.FRAMEBUFFER,a),this.bindFramebufferDepthStencilAttachment(ca(e)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,o)),ca(e)&&e.blitFramebuffer(0,0,a.width,a.height,0,0,o.width,o.height,e.DEPTH_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(ca(e)?Te.READ_FRAMEBUFFER:Te.FRAMEBUFFER,null),e.bindFramebuffer(ca(e)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,null),t=!0),this.resolveDepthStencilAttachmentsChanged=!1,t||e.bindFramebuffer(ca(e)?Te.DRAW_FRAMEBUFFER:Te.FRAMEBUFFER,null)}},{key:"setScissorEnabled",value:function(e){if(this.currentScissorEnabled!==e){var t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),this.currentScissorEnabled=e}}},{key:"applyStencil",value:function(){null!==this.currentStencilRef&&this.gl.stencilFunc(this.currentMegaState.stencilCompare,this.currentStencilRef,255)}},{key:"getFallbackTexture",value:function(e){var t=e.gl_target,r=e.formatKind;if(t===Te.TEXTURE_2D)return r===ce.Depth?this.fallbackTexture2DDepth:this.fallbackTexture2D;if(t===Te.TEXTURE_2D_ARRAY)return this.fallbackTexture2DArray;if(t===Te.TEXTURE_3D)return this.fallbackTexture3D;if(t===Te.TEXTURE_CUBE_MAP)return this.fallbackTextureCube;throw"whoops"}},{key:"submitBlitRenderPass",value:function(){if(!this.blitRenderPipeline){var e=mn(this,ne.VERTEX,new Float32Array([-4,-4,4,-4,0,4]).buffer),t=this.createInputLayout({vertexBufferDescriptors:[{byteStride:8,frequency:ae.PerVertex}],vertexAttributeDescriptors:[{format:Ee.F32_RG,bufferIndex:0,bufferByteOffset:0,location:0}],indexBufferFormat:null}),r=[{numSamplers:1,numUniformBuffers:0}],n=this.createProgram(v(v({},dn(this,new sa)),{},{ensurePreprocessed:function(){},associate:function(){}}));this.blitInputState=this.createInputState(t,[{buffer:e,byteOffset:0}],null,n),this.blitRenderPipeline=this.createRenderPipeline({topology:re.Triangles,sampleCount:1,program:n,bindingLayouts:r,colorAttachmentFormats:[Ee.U8_RGBA_RT],depthStencilAttachmentFormat:null,inputLayout:t,megaStateDescriptor:ct});var i=this.currentColorAttachments[0].texture;this.blitBindings=this.createBindings({bindingLayout:r[0],samplerBindings:[{sampler:null,texture:i,lateBinding:null}],uniformBufferBindings:[]}),n.setUniforms({u_Texture:i})}this.inBlitRenderPass=!0;var a=this.createRenderPass({colorAttachment:[this.currentColorAttachments[0]],colorResolveTo:[this.getOnscreenTexture()],colorClearColor:[Ge],colorStore:[!0],depthStencilAttachment:null,depthStencilResolveTo:null,depthStencilStore:!0,depthClearValue:"load",stencilClearValue:"load",occlusionQueryPool:null}),o=this.getCanvas(),s=o.width,u=o.height;a.setPipeline(this.blitRenderPipeline),a.setBindings(0,this.blitBindings,[0]),a.setInputState(this.blitInputState),a.setViewport(0,0,s,u),a.draw(3,0),this.submitPass(a),this.inBlitRenderPass=!1}}]),e}();function Co(e){return void 0!==e.byteLength}var Bo=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Buffer,n.gpuBuffer=void 0,n.size=void 0,n.view=void 0,n.usage=void 0;var s=o.usage,u=o.viewOrSize,l=Co(u)?u.byteLength+3&-4:u+3&-4;n.usage=s,n.usage&ne.MAP_READ&&(n.usage=ne.MAP_READ|ne.COPY_DST);var c=Co(u);if(n.size=Co(u)?u.byteLength:u,n.view=Co(u)?u:null,n.gpuBuffer=n.device.device.createBuffer({usage:n.usage,size:l,mappedAtCreation:c}),c){var f=n.gpuBuffer.getMappedRange();new u.constructor(f).set(u),n.gpuBuffer.unmap()}return n}return m(r,[{key:"setSubData",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=this.gpuBuffer;n=n||t.byteLength,n=Math.min(n,this.size-e);var a=t.byteOffset+r,o=a+n,s=n+3&-4;if(s!==n){var u=new Uint8Array(t.buffer.slice(a,o));t=new Uint8Array(s),t.set(u),r=0,a=0,o=s,n=s}var l=15728640,c=0;while(o-(a+c)>l)this.device.device.queue.writeBuffer(i,e+c,t.buffer,a+c,l),c+=l;this.device.device.queue.writeBuffer(i,e+c,t.buffer,a+c,n-c)}},{key:"destroy",value:function(){I(y(r.prototype),"destroy",this).call(this),this.gpuBuffer.destroy()}}]),r}(vo),Oo=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.InputLayout,n.buffers=void 0,n.indexFormat=void 0;for(var s=[],u=0;u<o.vertexBufferDescriptors.length;u++){var l=o.vertexBufferDescriptors[u];if(null!==l){var c=l.byteStride,f=so(l.frequency),d=[];s[u]={arrayStride:c,stepMode:f,attributes:d}}}for(var h=0;h<o.vertexAttributeDescriptors.length;h++){var _=o.vertexAttributeDescriptors[h],p=Ie(s[_.bufferIndex]),v={shaderLocation:_.location,format:uo(_.format),offset:_.bufferByteOffset};p.attributes.push(v)}return n.indexFormat=oo(o.indexBufferFormat),n.buffers=s,n}return r}(vo),xo=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;return g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Program,n.descriptor=void 0,n.vertexStage=null,n.fragmentStage=null,n.computeStage=null,n.descriptor=o,o.preprocessedVert&&(n.vertexStage=n.createShaderStage(o.preprocessedVert,"vertex")),o.preprocessedFrag&&(n.fragmentStage=n.createShaderStage(o.preprocessedFrag,"fragment")),o.preprocessedCompute&&(n.computeStage=n.createShaderStage(o.preprocessedCompute,"compute")),n}return m(r,[{key:"createShaderStage",value:function(e,t){var r=!1,n=e;if("compute"!==t)try{n=this.device.glsl_compile(e,t,r)}catch(u){throw console.error(u,e),"whoops"}for(var i=function(){var e=o[a];if(!n.includes(e))return"continue";n=n.replace("var T_".concat(e,": texture_2d<f32>;"),"var T_".concat(e,": texture_depth_2d;")),n=n.replace(new RegExp("textureSample\\(T_".concat(e,"(.*)\\);$"),"gm"),(function(t,r){return"vec4<f32>(textureSample(T_".concat(e).concat(r,"), 0.0, 0.0, 0.0);")}))},a=0,o=["u_TextureFramebufferDepth"];a<o.length;a++)i();var s=this.device.device.createShaderModule({code:n});return{module:s,entryPoint:"main"}}}]),r}(vo),Do=function(){function e(){g(this,e),this.commandEncoder=null,this.descriptor=void 0,this.gpuRenderPassEncoder=null,this.gpuRenderPassDescriptor=void 0,this.gpuColorAttachments=void 0,this.gpuDepthStencilAttachment=void 0,this.gfxColorAttachment=[],this.gfxColorResolveTo=[],this.gfxDepthStencilAttachment=null,this.gfxDepthStencilResolveTo=null,this.gpuColorAttachments=[],this.gpuDepthStencilAttachment={view:null,depthLoadValue:"load",depthStoreOp:"store",stencilLoadValue:"load",stencilStoreOp:"store"},this.gpuRenderPassDescriptor={colorAttachments:this.gpuColorAttachments,depthStencilAttachment:this.gpuDepthStencilAttachment}}return m(e,[{key:"setRenderPassDescriptor",value:function(e){this.descriptor=e,this.gpuRenderPassDescriptor.colorAttachments=this.gpuColorAttachments;var t=e.colorAttachment.length;this.gfxColorAttachment.length=t,this.gfxColorResolveTo.length=t;for(var r=0;r<e.colorAttachment.length;r++){var n=e.colorAttachment[r],i=e.colorResolveTo[r];if(null===n&&null!==i&&(n=i,i=null),this.gfxColorAttachment[r]=n,this.gfxColorResolveTo[r]=i,null===n){this.gpuColorAttachments.length=r,this.gfxColorAttachment.length=r,this.gfxColorResolveTo.length=r;break}void 0===this.gpuColorAttachments[r]&&(this.gpuColorAttachments[r]={});var a=this.gpuColorAttachments[r];a.view=n.gpuTextureView,a.loadValue=e.colorClearColor[r],a.storeOp=e.colorStore[r]?"store":"discard",a.resolveTarget=void 0,null!==i&&(n.sampleCount>1?a.resolveTarget=i.gpuTextureView:a.storeOp="store")}if(this.gfxDepthStencilAttachment=e.depthStencilAttachment,this.gfxDepthStencilResolveTo=e.depthStencilResolveTo,null!==e.depthStencilAttachment){var o=e.depthStencilAttachment,s=this.gpuDepthStencilAttachment;s.view=o.gpuTextureView,s.depthLoadValue=e.depthClearValue,s.stencilLoadValue=e.stencilClearValue,s.depthStoreOp=e.depthStencilStore?"store":"discard",s.stencilStoreOp=e.depthStencilStore?"store":"discard",this.gpuRenderPassDescriptor.depthStencilAttachment=this.gpuDepthStencilAttachment,null!==this.gfxDepthStencilResolveTo&&(s.depthStoreOp="store",s.stencilStoreOp="store")}else this.gpuRenderPassDescriptor.depthStencilAttachment=void 0;this.gpuRenderPassDescriptor.occlusionQuerySet=null!==e.occlusionQueryPool?za(e.occlusionQueryPool):void 0}},{key:"beginRenderPass",value:function(e){Pe(null===this.gpuRenderPassEncoder),this.setRenderPassDescriptor(e),this.gpuRenderPassEncoder=this.commandEncoder.beginRenderPass(this.gpuRenderPassDescriptor)}},{key:"setViewport",value:function(e,t,r,n){this.gpuRenderPassEncoder.setViewport(e,t,r,n,0,1)}},{key:"setScissor",value:function(e,t,r,n){this.gpuRenderPassEncoder.setScissorRect(e,t,r,n)}},{key:"setPipeline",value:function(e){var t=e,r=Ie(t.gpuRenderPipeline);this.gpuRenderPassEncoder.setPipeline(r)}},{key:"setInputState",value:function(e){if(null!==e){var t=e;if(null!==t.indexBuffer){var r=t.inputLayout,n=t.indexBuffer;this.gpuRenderPassEncoder.setIndexBuffer(Ya(n.buffer),Ie(r.indexFormat),n.byteOffset)}for(var i=0;i<t.vertexBuffers.length;i++){var a=t.vertexBuffers[i];null!==a&&this.gpuRenderPassEncoder.setVertexBuffer(i,Ya(a.buffer),a.byteOffset)}}}},{key:"setBindings",value:function(e,t,r){var n=t;this.gpuRenderPassEncoder.setBindGroup(e+0,n.gpuBindGroup[0],r.slice(0,n.bindingLayout.numUniformBuffers)),this.gpuRenderPassEncoder.setBindGroup(e+1,n.gpuBindGroup[1])}},{key:"setStencilRef",value:function(e){this.gpuRenderPassEncoder.setStencilReference(e)}},{key:"draw",value:function(e,t){this.gpuRenderPassEncoder.draw(e,1,t,0)}},{key:"drawIndexed",value:function(e,t){this.gpuRenderPassEncoder.drawIndexed(e,1,t,0,0)}},{key:"drawIndexedInstanced",value:function(e,t,r){this.gpuRenderPassEncoder.drawIndexed(e,r,t,0,0)}},{key:"beginOcclusionQuery",value:function(e){this.gpuRenderPassEncoder.beginOcclusionQuery(e)}},{key:"endOcclusionQuery",value:function(e){this.gpuRenderPassEncoder.endOcclusionQuery()}},{key:"beginDebugGroup",value:function(e){void 0!==this.gpuRenderPassEncoder.pushDebugGroup&&this.gpuRenderPassEncoder.pushDebugGroup(e)}},{key:"endDebugGroup",value:function(){void 0!==this.gpuRenderPassEncoder.popDebugGroup&&this.gpuRenderPassEncoder.popDebugGroup()}},{key:"finish",value:function(){this.gpuRenderPassEncoder.endPass(),this.gpuRenderPassEncoder=null;for(var e=0;e<this.gfxColorAttachment.length;e++){var t=this.gfxColorAttachment[e],r=this.gfxColorResolveTo[e];null!==t&&null!==r&&1===t.sampleCount&&this.copyAttachment(r,t)}return null!==this.gfxDepthStencilAttachment&&null!==this.gfxDepthStencilResolveTo&&(this.gfxDepthStencilAttachment.sampleCount>1||this.copyAttachment(this.gfxDepthStencilResolveTo,this.gfxDepthStencilAttachment)),this.commandEncoder.finish()}},{key:"copyAttachment",value:function(e,t){Pe(1===t.sampleCount);var r={texture:t.gpuTexture},n={texture:e.gpuTexture};Pe(t.width===e.width),Pe(t.height===e.height),Pe(!!(t.usage&Re.COPY_SRC)),Pe(!!(e.usage&Re.COPY_DST)),this.commandEncoder.copyTextureToTexture(r,n,[e.width,e.height,1])}}]),e}(),No=function(e){S(r,e);var t=F(r);function r(e){var n,i,a,o=e.id,s=e.device,u=e.descriptor;g(this,r),a=t.call(this,{id:o,device:s}),a.type=z.Sampler,a.gpuSampler=void 0;var l=u.minLOD,c=u.mipFilter===te.NoMip?u.minLOD:u.maxLOD,f=null!==(n=u.maxAnisotropy)&&void 0!==n?n:1;return f>1&&Pe(u.minFilter===ee.Bilinear&&u.magFilter===ee.Bilinear&&u.mipFilter===te.Linear),a.gpuSampler=a.device.device.createSampler({addressModeU:Ga(u.wrapS),addressModeV:Ga(u.wrapT),addressModeW:Ga(null!==(i=u.wrapQ)&&void 0!==i?i:u.wrapS),lodMinClamp:l,lodMaxClamp:c,minFilter:wa(u.minFilter),magFilter:wa(u.magFilter),mipmapFilter:Wa(u.mipFilter),maxAnisotropy:f}),a}return r}(vo),Fo=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor,s=e.skipCreate;return g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Texture,n.pixelFormat=void 0,n.dimension=void 0,n.format=void 0,n.width=void 0,n.height=void 0,n.depthOrArrayLayers=void 0,n.numLevels=void 0,n.sampleCount=void 0,n.usage=void 0,n.gpuTexture=void 0,n.gpuTextureView=void 0,n.device.createTextureShared({pixelFormat:o.pixelFormat,dimension:o.dimension,width:o.width,height:o.height,depthOrArrayLayers:o.depth,numLevels:o.numLevels,usage:o.usage,sampleCount:1},D(n),s),n}return m(r,[{key:"setImageData",value:function(e,t){}},{key:"destroy",value:function(){this.gpuTexture.destroy()}}]),r}(vo),Po=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.inputLayout,s=e.vertexBuffers,u=e.indexBuffer;return g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.InputState,n.inputLayout=void 0,n.vertexBuffers=void 0,n.indexBuffer=void 0,n.inputLayout=o,n.vertexBuffers=s,n.indexBuffer=u,n}return r}(vo),Io=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;return g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.RenderPipeline,n.descriptor=void 0,n.isCreating=!1,n.isCreatingAsync=!1,n.gpuRenderPipeline=null,n.descriptor=o,n.device.ensureRenderPipeline(D(n)),n}return m(r,[{key:"getBindGroupLayout",value:function(e){return this.gpuRenderPipeline.getBindGroupLayout(e)}}]),r}(vo),Mo=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device;return g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.Readback,n}return m(r,[{key:"readTexture",value:function(e,t,r,n,i,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=e,l=0,c=this.getBlockInformationFromFormat(u.format),f=Math.ceil(n/c.width)*c.length,d=256*Math.ceil(f/256),h=d*i,_=this.device.createBuffer({usage:ne.STORAGE|ne.MAP_READ|ne.COPY_DST,hint:ie.Static,viewOrSize:h}),p=this.device.device.createCommandEncoder();return p.copyTextureToBuffer({texture:u.gpuTexture,mipLevel:0,origin:{x:t,y:r,z:Math.max(l,0)}},{buffer:_.gpuBuffer,offset:0,bytesPerRow:d},{width:n,height:i,depthOrArrayLayers:1}),this.device.device.queue.submit([p.finish()]),this.readBuffer(_,h,a,o,s,u.pixelFormat)}},{key:"readBuffer",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Ee.U8_RGB,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],s=e,u=i||s.size,l=n||s.view,c=l&&l.constructor&&l.constructor.BYTES_PER_ELEMENT||De(a),f=s;if(!(s.usage&ne.MAP_READ&&s.usage&ne.COPY_DST)){var d=this.device.device.createCommandEncoder();f=this.device.createBuffer({usage:ne.STORAGE|ne.MAP_READ|ne.COPY_DST,hint:ie.Static,viewOrSize:u}),d.copyBufferToBuffer(s.gpuBuffer,r,f.gpuBuffer,0,u),this.device.device.queue.submit([d.finish()])}return new Promise((function(e,n){f.gpuBuffer.mapAsync(ge.READ,r,u).then((function(){var n=f.gpuBuffer.getMappedRange(r,u),i=l;if(o)i=null===i?fo(a,u,!0,n):fo(a,i.buffer,void 0,n);else if(null===i)switch(c){case 1:i=new Uint8Array(u),i.set(new Uint8Array(n));break;case 2:i=t.getHalfFloatAsFloatRGBAArrayBuffer(u/2,n);break;case 4:i=new Float32Array(u/4),i.set(new Float32Array(n));break}else switch(c){case 1:i=new Uint8Array(i.buffer),i.set(new Uint8Array(n));break;case 2:i=t.getHalfFloatAsFloatRGBAArrayBuffer(u/2,n,l);break;case 4:var s=l&&l.constructor||Float32Array;i=new s(i.buffer),i.set(new s(n));break}f.gpuBuffer.unmap(),e(i)}),(function(e){return n(e)}))}))}},{key:"getHalfFloatAsFloatRGBAArrayBuffer",value:function(e,t,r){r||(r=new Float32Array(e));var n=new Uint16Array(t);while(e--)r[e]=ho(n[e]);return r}},{key:"getBlockInformationFromFormat",value:function(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2unorm":case"rg11b10ufloat":return{width:1,height:1,length:4};case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth16unorm":return{width:1,height:1,length:2};case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float":return{width:1,height:1,length:4};case"depth24unorm-stencil8":return{width:1,height:1,length:4};case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc5-rg-unorm":case"bc5-rg-snorm":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":return{width:4,height:4,length:8}}}}]),r}(vo),bo=function(){function e(){g(this,e),this.commandEncoder=null,this.descriptor=void 0,this.gpuComputePassDescriptor=void 0,this.gpuComputePassEncoder=null}return m(e,[{key:"dispatch",value:function(e,t,r){this.gpuComputePassEncoder.dispatch(e,t,r)}},{key:"finish",value:function(){return this.gpuComputePassEncoder.endPass(),this.gpuComputePassEncoder=null,this.commandEncoder.finish()}},{key:"beginComputePass",value:function(e){Pe(null===this.gpuComputePassEncoder),this.setComputePassDescriptor(e),this.gpuComputePassEncoder=this.commandEncoder.beginComputePass(this.gpuComputePassDescriptor)}},{key:"setPipeline",value:function(e){var t=e,r=Ie(t.gpuComputePipeline);this.gpuComputePassEncoder.setPipeline(r)}},{key:"setBindings",value:function(e,t){var r=t;this.gpuComputePassEncoder.setBindGroup(e,r.gpuBindGroup[0])}},{key:"setComputePassDescriptor",value:function(e){this.descriptor=e}}]),e}(),Lo=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.ComputePipeline,n.descriptor=void 0,n.gpuComputePipeline=null,n.descriptor=o;var s=o.program,u=s.computeStage;if(null===u)return N(n);var l={compute:v({},u)};return n.gpuComputePipeline=n.device.device.createComputePipeline(l),void 0!==n.name&&(n.gpuComputePipeline.label=n.name),n}return m(r,[{key:"getBindGroupLayout",value:function(e){return this.gpuComputePipeline.getBindGroupLayout(e)}}]),r}(vo),Uo="\nstruct VertexOutput {\n  [[builtin(position)]] pos: vec4<f32>;\n};\n\n[[stage(vertex)]]\nfn vs([[builtin(vertex_index)]] index: u32) -> VertexOutput {\n  var out: VertexOutput;\n  out.pos.x = select(-1.0, 3.0, index == 1u);\n  out.pos.y = select(-1.0, 3.0, index == 2u);\n  out.pos.z = 1.0;\n  out.pos.w = 1.0;\n  return out;\n}\n",ko=function(){function e(t){g(this,e),this.shaderModule=void 0,this.pipeline=void 0,this.shaderText="\n".concat(Uo,"\n\nstruct FragmentOutput { [[location(0)]] color: vec4<f32>; };\n\n[[stage(fragment)]]\nfn fs() -> FragmentOutput {\n  return FragmentOutput(vec4<f32>(1.0, 0.0, 1.0, 1.0));\n}\n");var r="bgra8unorm";this.shaderModule=t.createShaderModule({code:this.shaderText}),this.pipeline=t.createRenderPipeline({vertex:{module:this.shaderModule,entryPoint:"vs"},fragment:{module:this.shaderModule,entryPoint:"fs",targets:[{format:r,writeMask:8}]}})}return m(e,[{key:"render",value:function(e,t){var r=e.createCommandEncoder(),n=r.beginRenderPass({colorAttachments:[{view:t,loadValue:"load",storeOp:"store"}]});n.setPipeline(this.pipeline),n.draw(3),n.endPass(),e.queue.submit([r.finish()])}}]),e}(),Go=function(e){S(r,e);var t=F(r);function r(e){var n,i=e.id,a=e.device,o=e.descriptor;g(this,r),n=t.call(this,{id:i,device:a}),n.type=z.QueryPool,n.querySet=void 0;var s=o.elemCount,u=o.type;return n.querySet=n.device.device.createQuerySet({type:qa(u),count:s}),n}return m(r,[{key:"queryResultOcclusion",value:function(e){return!0}}]),r}(vo),wo=function(){function e(t,r,n,i,a){g(this,e),this.swapChainWidth=0,this.swapChainHeight=0,this.swapChainTextureUsage=Re.RENDER_ATTACHMENT|Re.COPY_DST,this._resourceUniqueId=0,this.renderPassPool=[],this.computePassPool=[],this.bindGroupLayoutCache=new sr(pt,ar),this.fallbackTexture2D=void 0,this.fallbackTexture2DDepth=void 0,this.fallbackTexture2DArray=void 0,this.fallbackTexture3D=void 0,this.fallbackTextureCube=void 0,this.fallbackSampler=void 0,this.featureTextureCompressionBC=!1,this.fullscreenAlphaClear=void 0,this.platformString="WebGPU",this.glslVersion="#version 440",this.explicitBindingLocations=!0,this.separateSamplerTextures=!0,this.viewportOrigin=fe.UpperLeft,this.clipSpaceNearZ=de.Zero,this.supportsSyncPipelineCompilation=!1,this.supportMRT=!0,this.adapter=void 0,this.device=void 0,this.canvas=void 0,this.canvasContext=void 0,this.glsl_compile=void 0,this.adapter=t,this.device=r,this.canvas=n,this.canvasContext=i,this.glsl_compile=a,this.fallbackTexture2D=this.createFallbackTexture(oe.n2D,ce.Float),this.fallbackTexture2DDepth=this.createFallbackTexture(oe.n2D,ce.Depth),this.fallbackTexture2DArray=this.createFallbackTexture(oe.n2DArray,ce.Float),this.fallbackTexture3D=this.createFallbackTexture(oe.n3D,ce.Float),this.fallbackTextureCube=this.createFallbackTexture(oe.Cube,ce.Float),this.fallbackSampler=this.createSampler({wrapS:$.Clamp,wrapT:$.Clamp,minFilter:ee.Point,magFilter:ee.Point,mipFilter:te.NoMip}),this.device.features&&(this.featureTextureCompressionBC=this.device.features.has("texture-compression-bc")),this.device.onuncapturederror=function(e){console.error(e.error)},this.fullscreenAlphaClear=new ko(this.device)}return m(e,[{key:"configureSwapChain",value:function(e,t){this.swapChainWidth===e&&this.swapChainHeight===t||(this.swapChainWidth=e,this.swapChainHeight=t,this.canvasContext.configure({device:this.device,format:"bgra8unorm",usage:this.swapChainTextureUsage}))}},{key:"getOnscreenTexture",value:function(){var e=this.canvasContext.getCurrentTexture(),t=e.createView(),r=new Fo({id:0,device:this,descriptor:{pixelFormat:Ee.U8_RGBA_RT,width:this.swapChainWidth,height:this.swapChainHeight,depth:0,dimension:oe.n2D,numLevels:1,usage:this.swapChainTextureUsage},skipCreate:!0});return r.depthOrArrayLayers=1,r.sampleCount=1,r.gpuTexture=e,r.gpuTextureView=t,r}},{key:"getDevice",value:function(){return this}},{key:"getCanvas",value:function(){return this.canvas}},{key:"present",value:function(){this.fullscreenAlphaClear.render(this.device,this.canvasContext.getCurrentTexture().createView())}},{key:"getNextUniqueId",value:function(){return++this._resourceUniqueId}},{key:"createBuffer",value:function(e){return new Bo({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createTexture",value:function(e){return new Fo({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createSampler",value:function(e){return new No({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createRenderTarget",value:function(e){var t=new Fo({id:this.getNextUniqueId(),device:this,descriptor:v(v({},e),{},{dimension:oe.n2D,numLevels:1,depth:1,usage:se.RenderTarget})});return t.depthOrArrayLayers=1,t.type=z.RenderTarget,t}},{key:"createRenderTargetFromTexture",value:function(e){var t=e.pixelFormat,r=e.width,n=e.height,i=e.depthOrArrayLayers,a=e.sampleCount,o=e.numLevels,s=e.gpuTexture,u=e.gpuTextureView,l=e.usage;Pe(!!(l&Re.RENDER_ATTACHMENT));var c=new Fo({id:this.getNextUniqueId(),device:this,descriptor:{pixelFormat:t,width:r,height:n,depth:i,dimension:oe.n2D,numLevels:o,usage:l},skipCreate:!0});return c.depthOrArrayLayers=i,c.sampleCount=a,c.gpuTexture=s,c.gpuTextureView=u,c}},{key:"createProgram",value:function(e){return e.ensurePreprocessed(this),this.createProgramSimple(e)}},{key:"createProgramSimple",value:function(e){return new xo({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createTextureShared",value:function(e,t,r){var n={width:e.width,height:e.height,depthOrArrayLayers:e.depthOrArrayLayers},i=e.numLevels,a=Ua(e.pixelFormat),o=ka(e.dimension),s=La(e.usage);if(t.format=a,t.dimension=e.dimension,t.pixelFormat=e.pixelFormat,t.width=e.width,t.height=e.height,t.depthOrArrayLayers=e.depthOrArrayLayers,t.numLevels=i,t.usage=s,t.sampleCount=1,!r){var u=this.device.createTexture({size:n,mipLevelCount:i,format:a,dimension:o,usage:s}),l=u.createView();t.gpuTexture=u,t.gpuTextureView=l}}},{key:"getFallbackTexture",value:function(e){var t=e.dimension,r=e.formatKind;if(t===oe.n2D)return r===ce.Depth?this.fallbackTexture2DDepth:this.fallbackTexture2D;if(t===oe.n2DArray)return this.fallbackTexture2DArray;if(t===oe.n3D)return this.fallbackTexture3D;if(t===oe.Cube)return this.fallbackTextureCube;throw"whoops"}},{key:"createFallbackTexture",value:function(e,t){var r=e===oe.Cube?6:1,n=t===ce.Float?Ee.U8_RGBA_NORM:Ee.D24;return this.createTexture({dimension:e,pixelFormat:n,usage:se.Sampled,width:1,height:1,depth:r,numLevels:1})}},{key:"createBindings",value:function(e){return e.pipeline,new Ro({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createInputLayout",value:function(e){return new Oo({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createInputState",value:function(e,t,r){return new Po({id:this.getNextUniqueId(),device:this,inputLayout:e,vertexBuffers:t,indexBuffer:r})}},{key:"createComputePipeline",value:function(e){return new Lo({id:this.getNextUniqueId(),device:this,descriptor:e})}},{key:"createRenderPipeline",value:function(e){return new Io({id:this.getNextUniqueId(),device:this,descriptor:v({},e)})}},{key:"createQueryPool",value:function(e,t){return new Go({id:this.getNextUniqueId(),device:this,descriptor:{type:e,elemCount:t}})}},{key:"ensureRenderPipeline",value:function(e){if(!e.isCreating&&null===e.gpuRenderPipeline){var t=e.descriptor,r=t.program,n=r.vertexStage,i=r.fragmentStage;if(null!==n&&null!==i){var a=Ja(t.topology,t.megaStateDescriptor),o=no(t.colorAttachmentFormats,t.megaStateDescriptor),s=ao(t.depthStencilAttachmentFormat,t.megaStateDescriptor),u=void 0;null!==t.inputLayout&&(u=t.inputLayout.buffers);var l=t.sampleCount;e.isCreating=!0;var c={vertex:v(v({},n),{},{buffers:u}),primitive:a,depthStencil:s,multisample:{count:l},fragment:v(v({},i),{},{targets:o})};e.gpuRenderPipeline=this.device.createRenderPipeline(c),void 0!==e.name&&(e.gpuRenderPipeline.label=e.name)}}}},{key:"createReadback",value:function(){return new Mo({id:this.getNextUniqueId(),device:this})}},{key:"destroyRenderTarget",value:function(e){var t=e;t.gpuTexture.destroy()}},{key:"createRenderPass",value:function(e){var t=this.renderPassPool.pop();return void 0===t&&(t=new Do),t.commandEncoder=this.device.createCommandEncoder(),t.beginRenderPass(e),t}},{key:"createComputePass",value:function(e){var t=this.computePassPool.pop();return void 0===t&&(t=new bo),t.commandEncoder=this.device.createCommandEncoder(),t.beginComputePass(e),t}},{key:"submitPass",value:function(e){var t=this.device.queue,r=e,n=r.finish();t.submit([n]),r.commandEncoder=null,r instanceof Do?this.renderPassPool.push(r):this.computePassPool.push(r)}},{key:"copySubTexture2D",value:function(e,t,r,n,i,a){var o=this.device.createCommandEncoder(),s=e,u=n,l={texture:u.gpuTexture,origin:[i,a,0]},c={texture:s.gpuTexture,origin:[t,r,0]};Pe(!!(u.usage&Re.COPY_SRC)),Pe(!!(s.usage&Re.COPY_DST)),o.copyTextureToTexture(l,c,[u.width,u.height,1]),this.device.queue.submit([o.finish()])}},{key:"queryLimits",value:function(){return{uniformBufferMaxPageWordSize:4096,uniformBufferWordAlignment:64,supportedSampleCounts:[1]}}},{key:"queryTextureFormatSupported",value:function(e,t,r){if(lo(e)){if(!this.featureTextureCompressionBC)return!1;var n=co(e);return t%n===0&&r%n===0&&this.featureTextureCompressionBC}return!0}},{key:"queryPipelineReady",value:function(e){var t=e;return this.ensureRenderPipeline(t),null!==t.gpuRenderPipeline}},{key:"queryPlatformAvailable",value:function(){return!0}},{key:"queryVendorInfo",value:function(){return this}},{key:"queryRenderPass",value:function(e){var t=e;return t.descriptor}},{key:"queryRenderTarget",value:function(e){var t=e;return t}},{key:"setResourceName",value:function(e,t){if(e.name=t,e.type===z.Buffer){var r=e;r.gpuBuffer.label=t}else if(e.type===z.Texture){var n=e;n.gpuTexture.label=t,n.gpuTextureView.label=t}else if(e.type===z.RenderTarget){var i=e;i.gpuTexture.label=t,i.gpuTextureView.label=t}else if(e.type===z.Sampler){var a=e;a.gpuSampler.label=t}else if(e.type===z.RenderPipeline){var o=e;null!==o.gpuRenderPipeline&&(o.gpuRenderPipeline.label=t)}}},{key:"setResourceLeakCheck",value:function(e,t){}},{key:"checkForLeaks",value:function(){}},{key:"programPatched",value:function(e){}},{key:"pushDebugGroup",value:function(e){}},{key:"popDebugGroup",value:function(){}},{key:"pipelineQueryReady",value:function(e){var t=e;return null!==t.gpuRenderPipeline}},{key:"pipelineForceReady",value:function(e){}}]),e}(),Wo=function(){function e(t){g(this,e),this.pixelFormat=void 0,this.width=0,this.height=0,this.sampleCount=0,this.colorClearColor="load",this.depthClearValue="load",this.stencilClearValue="load",this.pixelFormat=t}return m(e,[{key:"setDimensions",value:function(e,t,r){this.width=e,this.height=t,this.sampleCount=r}},{key:"copyDimensions",value:function(e){this.width=e.width,this.height=e.height,this.sampleCount=e.sampleCount}}]),e}();function Xo(e){return{colorClearColor:e,depthClearValue:1,stencilClearValue:0}}var Vo,Ho=Xo(We);function Yo(e){if(e===Er.Color0)return Ee.U8_RGBA_RT;if(e===Er.DepthStencil)return Ee.D24_S8;throw"whoops"}function Ko(e){return e.antialiasingMode===Vo.MSAAx4?4:1}function zo(e,t){var r=Ko(t);e.setDimensions(t.backbufferWidth,t.backbufferHeight,r)}function qo(e,t,r){var n=Yo(e),i=new Wo(n);return zo(i,t),null!==r&&(i.colorClearColor=r.colorClearColor,i.depthClearValue=r.depthClearValue,i.stencilClearValue=r.stencilClearValue),i}(function(e){e[e["None"]=0]="None",e[e["FXAA"]=1]="FXAA",e[e["MSAAx4"]=2]="MSAAx4"})(Vo||(Vo={}));var Zo=["style"],jo=function(e){S(r,e);var t=F(r);function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.style,i=x(e,Zo);return g(this,r),t.call(this,v({type:r.tag,style:v({intensity:Math.PI},n)},i))}return r}(i.s$);jo.tag="light";var Qo,Jo=["style"];(function(e){e[e["NONE"]=0]="NONE",e[e["EXP"]=1]="EXP",e[e["EXP2"]=2]="EXP2",e[e["LINEAR"]=3]="LINEAR"})(Qo||(Qo={}));var $o,es,ts,rs,ns=function(e){S(r,e);var t=F(r);function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.style,i=x(e,Jo);return g(this,r),t.call(this,v({type:r.tag,style:v({type:Qo.NONE,fill:"black",start:1,end:1e3,density:0},n)},i))}return r}(i.s$);ns.tag="fog",function(e){e["PROJECTION_MATRIX"]="u_ProjectionMatrix",e["VIEW_MATRIX"]="u_ViewMatrix",e["CAMERA_POSITION"]="u_CameraPosition",e["DEVICE_PIXEL_RATIO"]="u_DevicePixelRatio",e["VIEWPORT"]="u_Viewport",e["IS_ORTHO"]="u_IsOrtho"}(rs||(rs={}));var is,as,os,ss=(es=$o=function(){function e(){g(this,e),this.canvasConfig=void 0,this.contextService=void 0,this.renderingContext=void 0,this.camera=void 0,this.pluginOptions=void 0,this.pickingIdGenerator=void 0,this.renderHelper=void 0,this.lightPool=void 0,this.texturePool=void 0,this.batchManager=void 0,this.renderingService=void 0,this.device=void 0,this.swapChain=void 0,this.renderLists={world:new Zr},this.builder=void 0,this.pickingTexture=void 0}return m(e,[{key:"getDevice",value:function(){return this.device}},{key:"apply",value:function(e){var t=this;this.renderingService=e,e.hooks.init.tapPromise(ts.tag,R(regeneratorRuntime.mark((function s(){var u,l,c,f;return regeneratorRuntime.wrap((function(s){while(1)switch(s.prev=s.next){case 0:return t.renderingContext.root.addEventListener(i.Dk.MOUNTED,r),t.renderingContext.root.addEventListener(i.Dk.UNMOUNTED,n),t.renderingContext.root.addEventListener(i.Dk.ATTRIBUTE_CHANGED,a),t.renderingContext.root.addEventListener(i.Dk.RENDER_ORDER_CHANGED,o),t.canvasConfig.renderer.getConfig().enableDirtyRectangleRendering=!1,u=t.contextService.getDomElement(),l=t.canvasConfig,c=l.width,f=l.height,t.contextService.resize(c,f),s.next=10,t.createSwapChain(u);case 10:t.device=t.swapChain.getDevice(),t.renderHelper.setDevice(t.device),t.renderHelper.renderInstManager.disableSimpleMode(),t.swapChain.configureSwapChain(u.width,u.height),t.renderingContext.root.ownerDocument.defaultView.on(i.$6.RESIZE,(function(){t.swapChain.configureSwapChain(u.width,u.height)})),t.batchManager.attach(t.device,e);case 16:case"end":return s.stop()}}),s)})))),e.hooks.destroy.tap(ts.tag,(function(){t.renderHelper.destroy(),t.renderingContext.root.removeEventListener(i.Dk.MOUNTED,r),t.renderingContext.root.removeEventListener(i.Dk.UNMOUNTED,n),t.renderingContext.root.removeEventListener(i.Dk.ATTRIBUTE_CHANGED,a),t.renderingContext.root.removeEventListener(i.Dk.RENDER_ORDER_CHANGED,o)})),e.hooks.beginFrame.tap(ts.tag,(function(){var e=t.swapChain.getCanvas(),r=t.renderHelper.renderInstManager;t.builder=t.renderHelper.renderGraph.newGraphBuilder();var n=t.canvasConfig.background?Ue.apply(void 0,L((0,i.lu)(t.canvasConfig.background).value)):we,a={backbufferWidth:e.width,backbufferHeight:e.height,antialiasingMode:Vo.None},o=qo(Er.Color0,a,Xo(n)),s=qo(Er.DepthStencil,a,Ho),u=t.builder.createRenderTargetID(o,"Main Render Target"),l=t.builder.createRenderTargetID(s,"Main Depth"),c=t.builder.createRenderTargetID(o,"Picking Render Target");t.builder.pushPass((function(e){e.setDebugName("Main Render Pass"),e.attachRenderTargetID(Er.Color0,u),e.attachRenderTargetID(Er.Color1,c),e.attachRenderTargetID(Er.DepthStencil,l),e.exec((function(e){r.drawListOnPassRenderer(t.renderLists.world,e)})),e.post((function(e){t.pickingTexture=e.getRenderTargetTexture(Er.Color1)}))})),t.builder.resolveRenderTargetToExternalTexture(u,t.swapChain.getOnscreenTexture())})),e.hooks.endFrame.tap(ts.tag,(function(){var e=t.renderHelper.renderInstManager,r=t.renderHelper.pushTemplateRenderInst();r.setBindingLayouts([{numUniformBuffers:2,numSamplers:0}]),r.setMegaStateFlags(st({depthWrite:!0},{rgbBlendMode:J.Add,alphaBlendMode:J.Add,rgbBlendSrcFactor:Q.SrcAlpha,alphaBlendSrcFactor:Q.Zero,rgbBlendDstFactor:Q.OneMinusSrcAlpha,alphaBlendDstFactor:Q.One}));var n=t.canvasConfig,i=n.width,a=n.height;r.setUniforms(0,[{name:rs.PROJECTION_MATRIX,value:t.camera.getPerspective()},{name:rs.VIEW_MATRIX,value:t.camera.getViewTransform()},{name:rs.CAMERA_POSITION,value:t.camera.getPosition()},{name:rs.DEVICE_PIXEL_RATIO,value:t.contextService.getDPR()},{name:rs.VIEWPORT,value:[i,a]},{name:rs.IS_ORTHO,value:t.camera.isOrtho()?1:0}]),e.setCurrentRenderInstList(t.renderLists.world),t.batchManager.render(t.renderLists.world),e.popTemplateRenderInst(),t.renderLists.world.renderInsts.length>0&&t.renderHelper.prepareToRender(),t.renderHelper.renderGraph.execute(),e.resetRenderInsts(),t.swapChain.present()}));var r=function(e){var r=e.target;if(r.nodeName!==jo.tag)if(r.nodeName!==ns.tag){var n=new K,i=t.pickingIdGenerator.getId(r);n.pickingId=i,n.encodedPickingColor=t.pickingIdGenerator.encodePickingColor(i),r.renderable3D=n,t.batchManager.add(r)}else t.lightPool.addFog(r);else t.lightPool.addLight(r)},n=function(e){var r=e.target;r.nodeName!==jo.tag?r.nodeName!==ns.tag?(t.batchManager.remove(r),delete r.renderable3D):t.lightPool.removeFog(r):t.lightPool.removeLight(r)},a=function(e){var r=e.target,n=e.detail,i=n.attributeName,a=n.newValue;t.batchManager.updateAttribute(r,i,a)},o=function(e){var r=e.target,n=e.detail.renderOrder;t.batchManager.changeRenderOrder(r,n)}}},{key:"createSwapChain",value:function(){var e=R(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=this.pluginOptions.targets,!r.includes("webgpu")){e.next=5;break}return e.next=4,this.createSwapChainForWebGPU(t);case 4:this.swapChain=e.sent;case 5:this.swapChain||(this.swapChain=this.createSwapChainForWebGL(t,r));case 6:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"createSwapChainForWebGL",value:function(e,t){var r,n={antialias:!1,preserveDrawingBuffer:!1,stencil:!0};return this.handleContextEvents(e),t.includes("webgl2")&&(r=e.getContext("webgl2",n)||e.getContext("experimental-webgl2",n)),!r&&t.includes("webgl1")&&(r=e.getContext("webgl",n)||e.getContext("experimental-webgl",n)),new yo(r,{shaderDebug:!0,trackResources:!0})}},{key:"createSwapChainForWebGPU",value:function(){var e=R(regeneratorRuntime.mark((function e(t){var r,n,i,a,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(void 0!==navigator.gpu){e.next=2;break}return e.abrupt("return",null);case 2:return r=null,e.prev=3,e.next=6,navigator.gpu.requestAdapter();case 6:r=e.sent,e.next=12;break;case 9:e.prev=9,e.t0=e["catch"](3),console.log(e.t0);case 12:if(null!==r){e.next=14;break}return e.abrupt("return",null);case 14:return n=["depth24unorm-stencil8","depth32float-stencil8","texture-compression-bc"],i=n.filter((function(e){return r.features.has(e)})),e.next=18,r.requestDevice({requiredFeatures:i});case 18:if(a=e.sent,null!==a){e.next=21;break}return e.abrupt("return",null);case 21:if(o=t.getContext("webgpu"),o){e.next=24;break}return e.abrupt("return",null);case 24:return e.abrupt("return",new wo(r,a,t,o,(function(){})));case 25:case"end":return e.stop()}}),e,null,[[3,9]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleContextEvents",value:function(e){var t=this.pluginOptions,r=t.onContextLost,n=t.onContextRestored,i=t.onContextCreationError;i&&e.addEventListener("webglcontextcreationerror",i,!1),r&&e.addEventListener("webglcontextlost",r,!1),n&&e.addEventListener("webglcontextrestored",n,!1)}},{key:"pickByRectangle",value:function(){var e=R(regeneratorRuntime.mark((function e(t){var r,n,i,a,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=[],n=this.device.createReadback(),!this.pickingTexture){e.next=10;break}return e.next=5,n.readTexture(this.pickingTexture,t.x,t.y,t.width,t.height,new Uint8Array(t.width*t.height*4));case 5:i=e.sent,a=-1,!i||0===i[0]&&0===i[1]&&0===i[2]||(a=this.pickingIdGenerator.decodePickingColor(i)),a>-1&&(o=this.pickingIdGenerator.getById(a),o&&o.interactive&&-1===r.indexOf(o)&&r.push(o)),n.destroy();case 10:return e.abrupt("return",r);case 11:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"loadTexture",value:function(e,t,r){var n=this;return this.texturePool.getOrCreateTexture(this.device,e,t,(function(){n.renderingService.dirtify(),r&&r()}))}}]),e}(),$o.tag="RenderGraphPlugin",ts=es);(0,n.gn)([(0,o.f3)(i.VJ),(0,n.w6)("design:type",Object)],ss.prototype,"canvasConfig",void 0),(0,n.gn)([(0,o.f3)(i.Ob),(0,n.w6)("design:type",Object)],ss.prototype,"contextService",void 0),(0,n.gn)([(0,o.f3)(i.xh),(0,n.w6)("design:type",Object)],ss.prototype,"renderingContext",void 0),(0,n.gn)([(0,o.f3)(i.Rh),(0,n.w6)("design:type",i.V1)],ss.prototype,"camera",void 0),(0,n.gn)([(0,o.f3)(oa),(0,n.w6)("design:type",Object)],ss.prototype,"pluginOptions",void 0),(0,n.gn)([(0,o.f3)(me),(0,n.w6)("design:type",me)],ss.prototype,"pickingIdGenerator",void 0),(0,n.gn)([(0,o.f3)(Jr),(0,n.w6)("design:type",Jr)],ss.prototype,"renderHelper",void 0),(0,n.gn)([(0,o.f3)(en),(0,n.w6)("design:type",en)],ss.prototype,"lightPool",void 0),(0,n.gn)([(0,o.f3)($r),(0,n.w6)("design:type",$r)],ss.prototype,"texturePool",void 0),(0,n.gn)([(0,o.f3)(vn),(0,n.w6)("design:type",vn)],ss.prototype,"batchManager",void 0),ss=ts=(0,n.gn)([(0,o.ri)({contrib:i.yg})],ss);var us=(as=is=function(){function e(){g(this,e),this.canvasConfig=void 0,this.sceneGraphService=void 0,this.contextService=void 0,this.renderGraphPlugin=void 0}return m(e,[{key:"apply",value:function(e){var t=this;e.hooks.pick.tapPromise(os.tag,function(){var e=R(regeneratorRuntime.mark((function e(r){var n,a,o,u,l,c,f,d,h,_,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=r.position,a=n.viewportX,o=n.viewportY,u=t.contextService.getDPR(),l=t.canvasConfig.width*u,c=t.canvasConfig.height*u,f=a*u,d=o*u,!(f>l||f<0||d>c||d<0)){e.next=9;break}return r.picked=null,e.abrupt("return",r);case 9:return e.next=11,t.renderGraphPlugin.pickByRectangle(new i.Ae((0,s.uZ)(Math.round(f),0,l-1),(0,s.uZ)(Math.round(c-(o+1)*u),0,c-1),1,1));case 11:return h=e.sent,_=M(h,1),p=_[0],r.picked=p||null,e.abrupt("return",r);case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}}]),e}(),is.tag="PickingPlugin",os=as);(0,n.gn)([(0,o.f3)(i.VJ),(0,n.w6)("design:type",Object)],us.prototype,"canvasConfig",void 0),(0,n.gn)([(0,o.f3)(i.aF),(0,n.w6)("design:type",Object)],us.prototype,"sceneGraphService",void 0),(0,n.gn)([(0,o.f3)(i.Ob),(0,n.w6)("design:type",Object)],us.prototype,"contextService",void 0),(0,n.gn)([(0,o.f3)(ss),(0,n.w6)("design:type",ss)],us.prototype,"renderGraphPlugin",void 0),us=os=(0,n.gn)([(0,o.ri)({contrib:i.yg})],us);var ls=(0,o.Yl)((function(e){e,e(Jr),e($r),e(en),e(Vi),e(me),e(vn),e(ss),e(us),e(bn),e(Vn),e(fi),e(yi),e(xi),e(Zi),e(Ji),e({token:nn,useFactory:function(e){return function(t){return e.container.isBound(t)&&e.container.get(t)||null}}}),e($i),e(ea),e(ra),e(ia),e(na),e(aa),e({token:tn,useFactory:function(e){return function(t){return e.container.isBoundNamed(rn,t)&&e.container.getNamed(rn,t)||null}}})})),cs=function(){function e(t){g(this,e),this.options=void 0,this.container=void 0,this.options=t}return m(e,[{key:"init",value:function(e){this.container=e,e.register({token:oa,useValue:v({targets:["webgl2","webgl1"]},this.options)}),e.load(ls,!0)}},{key:"destroy",value:function(e){e.remove(Jr),e.remove($r),e.remove(Vi),e.remove(me),e.remove($i),e.remove(ea),e.remove(ia),e.remove(ra),e.remove(na),e.remove(aa),e.remove(rn),e.remove(tn),e.remove(bn),e.remove(Vn),e.remove(fi),e.remove(yi),e.remove(xi),e.remove(Zi),e.remove(Ji),e.remove(nn),e.remove(ss),e.remove(us),e.remove(oa)}},{key:"getDevice",value:function(){return this.container.get(ss).getDevice()}},{key:"loadTexture",value:function(e,t,r){return this.container.get(ss).loadTexture(e,t,r)}}]),e}(),fs="undefined"!==typeof window&&"undefined"!==typeof window.document,ds="px";function hs(e,t,r){fs&&(e.style.width=t+ds,e.style.height=r+ds)}var _s=function(){function e(){}return e.prototype.init=function(){var e=this.canvasConfig,t=e.container,r=e.canvas,n=e.devicePixelRatio;if(r)this.$canvas=r;else if(t&&(this.$container=(0,s.HD)(t)?document.getElementById(t):t,this.$container)){var i=document.createElement("canvas");this.$container.appendChild(i),this.$container.style.position||(this.$container.style.position="relative"),this.$canvas=i}var a=n||fs&&window.devicePixelRatio||1;a=a>=1?Math.ceil(a):1,this.dpr=a},e.prototype.getDomElement=function(){return this.$canvas},e.prototype.getContext=function(){return this.context},e.prototype.getBoundingClientRect=function(){var e;return null===(e=this.$container)||void 0===e?void 0:e.getBoundingClientRect()},e.prototype.destroy=function(){this.$container&&this.$canvas&&this.$canvas.parentNode&&this.$container.removeChild(this.$canvas)},e.prototype.resize=function(e,t){if(this.$canvas){var r=this.getDPR();this.$canvas.width=r*e,this.$canvas.height=r*t,hs(this.$canvas,e,t)}},e.prototype.getDPR=function(){return this.dpr},e.prototype.applyCursorStyle=function(e){this.$container&&(this.$container.style.cursor=e)},(0,n.gn)([(0,o.f3)(i.VJ),(0,n.w6)("design:type",Object)],e.prototype,"canvasConfig",void 0),e=(0,n.gn)([(0,o.ri)({token:i.Ob})],e),e}(),ps=(0,o.Yl)((function(e){e(_s)})),vs=function(){function e(){}return e.prototype.init=function(e){e.load(ps,!0)},e.prototype.destroy=function(e){e.remove(_s)},e}();(function(e){function t(t){var r,n=e.call(this,t)||this;return n.registerPlugin(new vs),n.renderGraphPlugin=new cs((null===t||void 0===t?void 0:t.targets)?{targets:t.targets}:{}),n.registerPlugin(n.renderGraphPlugin),!1!==(null===(r=null===t||void 0===t?void 0:t.plugins)||void 0===r?void 0:r.enableDOMInteraction)&&n.registerPlugin(new a.S),n}(0,n.ZT)(t,e),t.prototype.getDevice=function(){return this.renderGraphPlugin.getDevice()},t.prototype.loadTexture=function(e,t,r){return this.renderGraphPlugin.loadTexture(e,t,r)}})(i.I8)},9187:function(e){"use strict";function t(e,t,n){n=n||2;var a,o,s,u,c,f,d,h=t&&t.length,_=h?t[0]*n:e.length,p=r(e,0,_,n,!0),v=[];if(!p||p.next===p.prev)return v;if(h&&(p=l(e,t,p,n)),e.length>80*n){a=s=e[0],o=u=e[1];for(var E=n;E<_;E+=n)c=e[E],f=e[E+1],c<a&&(a=c),f<o&&(o=f),c>s&&(s=c),f>u&&(u=f);d=Math.max(s-a,u-o),d=0!==d?1/d:0}return i(p,v,n,a,o,d),v}function r(e,t,r,n,i){var a,o;if(i===P(e,t,r,n)>0)for(a=t;a<r;a+=n)o=D(a,e[a],e[a+1],o);else for(a=r-n;a>=t;a-=n)o=D(a,e[a],e[a+1],o);return o&&m(o,o.next)&&(N(o),o=o.next),o}function n(e,t){if(!e)return e;t||(t=e);var r,n=e;do{if(r=!1,n.steiner||!m(n,n.next)&&0!==T(n.prev,n,n.next))n=n.next;else{if(N(n),n=t=n.prev,n===n.next)break;r=!0}}while(r||n!==t);return t}function i(e,t,r,l,c,f,d){if(e){!d&&f&&_(e,l,c,f);var h,p,v=e;while(e.prev!==e.next)if(h=e.prev,p=e.next,f?o(e,l,c,f):a(e))t.push(h.i/r),t.push(e.i/r),t.push(p.i/r),N(e),e=p.next,v=p.next;else if(e=p,e===v){d?1===d?(e=s(n(e),t,r),i(e,t,r,l,c,f,2)):2===d&&u(e,t,r,l,c,f):i(n(e),t,r,l,c,f,1);break}}}function a(e){var t=e.prev,r=e,n=e.next;if(T(t,r,n)>=0)return!1;var i=e.next.next;while(i!==e.prev){if(R(t.x,t.y,r.x,r.y,n.x,n.y,i.x,i.y)&&T(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function o(e,t,r,n){var i=e.prev,a=e,o=e.next;if(T(i,a,o)>=0)return!1;var s=i.x<a.x?i.x<o.x?i.x:o.x:a.x<o.x?a.x:o.x,u=i.y<a.y?i.y<o.y?i.y:o.y:a.y<o.y?a.y:o.y,l=i.x>a.x?i.x>o.x?i.x:o.x:a.x>o.x?a.x:o.x,c=i.y>a.y?i.y>o.y?i.y:o.y:a.y>o.y?a.y:o.y,f=v(s,u,t,r,n),d=v(l,c,t,r,n),h=e.prevZ,_=e.nextZ;while(h&&h.z>=f&&_&&_.z<=d){if(h!==e.prev&&h!==e.next&&R(i.x,i.y,a.x,a.y,o.x,o.y,h.x,h.y)&&T(h.prev,h,h.next)>=0)return!1;if(h=h.prevZ,_!==e.prev&&_!==e.next&&R(i.x,i.y,a.x,a.y,o.x,o.y,_.x,_.y)&&T(_.prev,_,_.next)>=0)return!1;_=_.nextZ}while(h&&h.z>=f){if(h!==e.prev&&h!==e.next&&R(i.x,i.y,a.x,a.y,o.x,o.y,h.x,h.y)&&T(h.prev,h,h.next)>=0)return!1;h=h.prevZ}while(_&&_.z<=d){if(_!==e.prev&&_!==e.next&&R(i.x,i.y,a.x,a.y,o.x,o.y,_.x,_.y)&&T(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function s(e,t,r){var i=e;do{var a=i.prev,o=i.next.next;!m(a,o)&&A(a,i,i.next,o)&&B(a,o)&&B(o,a)&&(t.push(a.i/r),t.push(i.i/r),t.push(o.i/r),N(i),N(i.next),i=e=o),i=i.next}while(i!==e);return n(i)}function u(e,t,r,a,o,s){var u=e;do{var l=u.next.next;while(l!==u.prev){if(u.i!==l.i&&g(u,l)){var c=x(u,l);return u=n(u,u.next),c=n(c,c.next),i(u,t,r,a,o,s),void i(c,t,r,a,o,s)}l=l.next}u=u.next}while(u!==e)}function l(e,t,i,a){var o,s,u,l,d,h=[];for(o=0,s=t.length;o<s;o++)u=t[o]*a,l=o<s-1?t[o+1]*a:e.length,d=r(e,u,l,a,!1),d===d.next&&(d.steiner=!0),h.push(E(d));for(h.sort(c),o=0;o<h.length;o++)i=f(h[o],i),i=n(i,i.next);return i}function c(e,t){return e.x-t.x}function f(e,t){var r=d(e,t);if(!r)return t;var i=x(r,e),a=n(r,r.next);return n(i,i.next),t===r?a:t}function d(e,t){var r,n=t,i=e.x,a=e.y,o=-1/0;do{if(a<=n.y&&a>=n.next.y&&n.next.y!==n.y){var s=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(a===n.y)return n;if(a===n.next.y)return n.next}r=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!r)return null;if(i===o)return r;var u,l=r,c=r.x,f=r.y,d=1/0;n=r;do{i>=n.x&&n.x>=c&&i!==n.x&&R(a<f?i:o,a,c,f,a<f?o:i,a,n.x,n.y)&&(u=Math.abs(a-n.y)/(i-n.x),B(n,e)&&(u<d||u===d&&(n.x>r.x||n.x===r.x&&h(r,n)))&&(r=n,d=u)),n=n.next}while(n!==l);return r}function h(e,t){return T(e.prev,e,t.prev)<0&&T(t.next,e,e.next)<0}function _(e,t,r,n){var i=e;do{null===i.z&&(i.z=v(i.x,i.y,t,r,n)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,p(i)}function p(e){var t,r,n,i,a,o,s,u,l=1;do{r=e,e=null,a=null,o=0;while(r){for(o++,n=r,s=0,t=0;t<l;t++)if(s++,n=n.nextZ,!n)break;u=l;while(s>0||u>0&&n)0!==s&&(0===u||!n||r.z<=n.z)?(i=r,r=r.nextZ,s--):(i=n,n=n.nextZ,u--),a?a.nextZ=i:e=i,i.prevZ=a,a=i;r=n}a.nextZ=null,l*=2}while(o>1);return e}function v(e,t,r,n,i){return e=32767*(e-r)*i,t=32767*(t-n)*i,e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e|t<<1}function E(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function R(e,t,r,n,i,a,o,s){return(i-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(n-s)-(r-o)*(t-s)>=0&&(r-o)*(a-s)-(i-o)*(n-s)>=0}function g(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!C(e,t)&&(B(e,t)&&B(t,e)&&O(e,t)&&(T(e.prev,e,t.prev)||T(e,t.prev,t))||m(e,t)&&T(e.prev,e,e.next)>0&&T(t.prev,t,t.next)>0)}function T(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function m(e,t){return e.x===t.x&&e.y===t.y}function A(e,t,r,n){var i=y(T(e,t,r)),a=y(T(e,t,n)),o=y(T(r,n,e)),s=y(T(r,n,t));return i!==a&&o!==s||(!(0!==i||!S(e,r,t))||(!(0!==a||!S(e,n,t))||(!(0!==o||!S(r,e,n))||!(0!==s||!S(r,t,n)))))}function S(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function y(e){return e>0?1:e<0?-1:0}function C(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&A(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}function B(e,t){return T(e.prev,e,e.next)<0?T(e,t,e.next)>=0&&T(e,e.prev,t)>=0:T(e,t,e.prev)<0||T(e,e.next,t)<0}function O(e,t){var r=e,n=!1,i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!==r.next.y>a&&r.next.y!==r.y&&i<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==e);return n}function x(e,t){var r=new F(e.i,e.x,e.y),n=new F(t.i,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=i,i.prev=r,n.next=r,r.prev=n,a.next=n,n.prev=a,n}function D(e,t,r,n){var i=new F(e,t,r);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function N(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function F(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function P(e,t,r,n){for(var i=0,a=t,o=r-n;a<r;a+=n)i+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return i}e.exports=t,e.exports.default=t,t.deviation=function(e,t,r,n){var i=t&&t.length,a=i?t[0]*r:e.length,o=Math.abs(P(e,0,a,r));if(i)for(var s=0,u=t.length;s<u;s++){var l=t[s]*r,c=s<u-1?t[s+1]*r:e.length;o-=Math.abs(P(e,l,c,r))}var f=0;for(s=0;s<n.length;s+=3){var d=n[s]*r,h=n[s+1]*r,_=n[s+2]*r;f+=Math.abs((e[d]-e[_])*(e[h+1]-e[d+1])-(e[d]-e[h])*(e[_+1]-e[d+1]))}return 0===o&&0===f?0:Math.abs((f-o)/o)},t.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},n=0,i=0;i<e.length;i++){for(var a=0;a<e[i].length;a++)for(var o=0;o<t;o++)r.vertices.push(e[i][a][o]);i>0&&(n+=e[i-1].length,r.holes.push(n))}return r}}}]);